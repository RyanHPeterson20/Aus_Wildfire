---
title: "IODsst_2019"
author: "Ryan Peterson"
date: "2025-08-31"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Library}
#.nc files
suppressMessages(library(ncdf4))
suppressMessages(library(terra))

# date/data mgmt
suppressMessages(library(lubridate))
suppressMessages(library(abind))

#visualization and interpolation
suppressMessages(library(fields))
suppressMessages(library(colorspace))
suppressMessages(library(RColorBrewer)) #colorRampPalette
suppressMessages(library(scales)) #for adjusting opacity

#matlab function (e.g. detrend)
suppressMessages(library(pracma))
```

Baseline Exploration:
1. Mean state change 1982 to 2015, 2019

Extend from 2015 to 2019:
1. replicate the GODAS 2019 point from fig 1 (cai et al 2019)
2. replicate data up to 2019 from 2025 Indian Ocean paper


```{r load_functions}
setwd("~/CO_AUS/Aus_CO-main/pIOD")

source("pIOD_functions.R") #sst.anom and eof functions
```

```{r load_data}
setwd("~/CO_AUS/Aus_CO-main/pIOD")
#load in preped data products
load("sstGODAS.rda") #load sst.GODAS data
load("sstOISST.rda")
load("sstORAS.rda")
load("sstSODA.rda")
```


```{r setup}
#indian ocean region
wide_maxLon <- 120
wide_minLon <- 30
wide_maxLat <- 20
wide_minLat <- -20

#pIOD (40, -5) X (100, 5)
pIOD_maxLon <- 100
pIOD_minLon <- 40 
pIOD_maxLat <- 5
pIOD_minLat <- -5

#indian ocean grid
lon.wide <- seq(wide_minLon, wide_maxLon, by = 1)
lat.wide <- seq(wide_minLat, wide_maxLat, by = 1)

#grid list from 
grid.list <- list(x = lon.wide,
                  y = lat.wide)
```


# GODAS Data Prep

## Import Data

```{r GODAS_import}
setwd("~/CO_AUS/Aus_CO-main")

#GODAS data only (yearly .nc 1982-2015)
#1982
nc.GODAS.1982 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1982.nc")

#1983
nc.GODAS.1983 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1983.nc")

#1984
nc.GODAS.1984 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1984.nc")

#1985
nc.GODAS.1985 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1985.nc")

#1986
nc.GODAS.1986 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1986.nc")

#1987
nc.GODAS.1987 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1987.nc")

#1988
nc.GODAS.1988 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1988.nc")

#1989
nc.GODAS.1989 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1989.nc")

#1990
nc.GODAS.1990 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1990.nc")

#1991
nc.GODAS.1991 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1991.nc")

#1992
nc.GODAS.1992 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1992.nc")

#1993
nc.GODAS.1993 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1993.nc")

#1994
nc.GODAS.1994 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1994.nc")

#1995
nc.GODAS.1995 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1995.nc")

#1996
nc.GODAS.1996 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1996.nc")

#1997
nc.GODAS.1997 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1997.nc")

#1998
nc.GODAS.1998 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1998.nc")

#1999
nc.GODAS.1999 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1999.nc")

#2000
nc.GODAS.2000 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2000.nc")

#2001
nc.GODAS.2001 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2001.nc")

#2002
nc.GODAS.2002 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2002.nc")

#2003
nc.GODAS.2003 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2003.nc")

#2004
nc.GODAS.2004 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2004.nc")

#2005
nc.GODAS.2005 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2005.nc")

#2006
nc.GODAS.2006 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2006.nc")

#2007
nc.GODAS.2007 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2007.nc")

#2008
nc.GODAS.2008 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2008.nc")

#2009
nc.GODAS.2009 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2009.nc")

#2010
nc.GODAS.2010 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2010.nc")

#2011
nc.GODAS.2011 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2011.nc")

#2012
nc.GODAS.2012 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2012.nc")

#2013
nc.GODAS.2013 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2013.nc")

#2014
nc.GODAS.2014 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2014.nc")

#2015
nc.GODAS.2015 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2015.nc")

```

```{r additional_GODAS_import}
#include back to 1980
#1980
nc.GODAS.1980 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1980.nc")

#1981
nc.GODAS.1981 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1981.nc")

#include up to 2019
#2016
nc.GODAS.2016 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2016.nc")

#2017
nc.GODAS.2017 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2017.nc")

#2018
nc.GODAS.2018 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2018.nc")

#2019
nc.GODAS.2019 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2019.nc")
```

## Prep Functions

```{r prep_functions}
#sorting/extraction of godas .nc data
godas_prep <- function(nc.data){
  
  #extract lon.lat
  lon.grid.temp <- nc.data[["dim"]][["lon"]][["vals"]]
  lat.grid.temp <- nc.data[["dim"]][["lat"]][["vals"]]
  
  #reorder lon for 
  lon.grid.temp[lon.grid.temp >= 180] <- lon.grid.temp[lon.grid.temp >= 180] - 360
  lon.order.temp <- order(lon.grid.temp)
  
  lon.grid.temp <- lon.grid.temp[lon.order.temp]
  
  #reorder lat
  lat.order.temp <- order(lat.grid.temp, decreasing = TRUE)
  lat.grid.temp <- lat.grid.temp[lat.order.temp]
  
  #times for months
  times.temp <- ncvar_get(nc.data, "time") # days since 1800-01-01 00:00:0.0
  times.temp <- as_datetime("1800-01-01T00:00:00") + days(times.temp)
  
  #temps, as array (lon, lat, level, time)
  #TODO adjust from K to c (K - 273.15)
  sst.temp <- ncvar_get(nc.data, "pottmp")
  sst.temp <- sst.temp[lon.order.temp, lat.order.temp, 1, ] #level: depth 5m
  
  #adjust to C from K (c = K - 273.15)
  sst.temp <- sst.temp - 273.15
  
  #return lon, lat, time, sst
  return(list(
    lon = lon.grid.temp,
    lat = lat.grid.temp,
    time = times.temp,
    sst = sst.temp))
}


```

## Cleaning w/o Interpolation

```{r data_cleaning}
#data cleaning 
godas_list <- list(nc.GODAS.1982, nc.GODAS.1983, nc.GODAS.1984, nc.GODAS.1985, nc.GODAS.1986, 
                   nc.GODAS.1987, nc.GODAS.1988, nc.GODAS.1989, nc.GODAS.1990, nc.GODAS.1991,
                   nc.GODAS.1992, nc.GODAS.1993, nc.GODAS.1994, nc.GODAS.1995, nc.GODAS.1996,
                   nc.GODAS.1997, nc.GODAS.1998, nc.GODAS.1999, nc.GODAS.2000, nc.GODAS.2001,
                   nc.GODAS.2002, nc.GODAS.2003, nc.GODAS.2004, nc.GODAS.2005, nc.GODAS.2006,
                   nc.GODAS.2007, nc.GODAS.2008, nc.GODAS.2009, nc.GODAS.2010, nc.GODAS.2011,
                   nc.GODAS.2012, nc.GODAS.2013, nc.GODAS.2014, nc.GODAS.2015, nc.GODAS.2016,
                   nc.GODAS.2017, nc.GODAS.2018, nc.GODAS.2019)

#get lon, lat, sst, and times
sst.GODAS.w2019 <- NULL
for (i in 1:length(godas_list)) {
  nc.temp <- godas_list[[i]] 
  
  temp.nc.godas <- godas_prep(nc.temp)
  temp.lon <- temp.nc.godas$lon
  temp.lat <- temp.nc.godas$lat
  temp.sst <- temp.nc.godas$sst
  
  #get reduce range (indian ocean region)
  new.lon <- temp.lon[temp.lon <= wide_maxLon & temp.lon >= wide_minLon]
  lon.range <- range(which(temp.lon <= wide_maxLon & temp.lon >= wide_minLon))
  new.lat <- temp.lat[temp.lat <= wide_maxLat & temp.lat >= wide_minLat]
  lat.range <- range(which(temp.lat <= wide_maxLat & temp.lat >= wide_minLat))
  
  #assign
  sst.temp <- temp.sst[lon.range[1]:lon.range[2], lat.range[1]:lat.range[2], ]
  
  sst.GODAS.w2019 <- abind(sst.GODAS.w2019, sst.temp, along = 3)
}

GODAS.lon <- new.lon
GODAS.lat <- new.lat


rm(nc.GODAS.1982, nc.GODAS.1983, nc.GODAS.1984, nc.GODAS.1985, nc.GODAS.1986, 
                   nc.GODAS.1987, nc.GODAS.1988, nc.GODAS.1989, nc.GODAS.1990, nc.GODAS.1991,
                   nc.GODAS.1992, nc.GODAS.1993, nc.GODAS.1994, nc.GODAS.1995, nc.GODAS.1996,
                   nc.GODAS.1997, nc.GODAS.1998, nc.GODAS.1999, nc.GODAS.2000, nc.GODAS.2001,
                   nc.GODAS.2002, nc.GODAS.2003, nc.GODAS.2004, nc.GODAS.2005, nc.GODAS.2006,
                   nc.GODAS.2007, nc.GODAS.2008, nc.GODAS.2009, nc.GODAS.2010, nc.GODAS.2011,
                   nc.GODAS.2012, nc.GODAS.2013, nc.GODAS.2014, nc.GODAS.2015)

dim(sst.GODAS.w2019)


```


# SST Anom Prep


## Get SON Avg


```{r extra_clean}

ny<- dim(sst.GODAS.new2)[2]

sst.GODAS.new2 <- sst.GODAS.new2[,ny:1,]

```

### Interpolate (pre SON avg.)

```{r interp_functions}
sst.interp <- function(sst, sst.lon, sst.lat, grid.list){
  
  #get dime
  dim.sst <- dim(sst)
  
  nx <- dim.sst[1]
  ny <- dim.sst[2]
  nt <- dim.sst[3]
  
  #interpolate 
  sst.interp <- NULL
  for (j in seq_len(nt)) {
    sst.obj <-  list(x = sst.lon, y = sst.lat, z = sst[,,j])
  
    temp.interp <- interp.surface.grid(sst.obj, grid.list)
    sst.interp <- abind(sst.interp, temp.interp$z, along = 3)
  }
  
  return(sst.interp)
}
```


```{r interp}
#TODO: functionalize this

#get dimen
dim.GODAS <- dim(sst.GODAS.new2)
dim.OISST <- dim(sst.OISST.new2)
dim.SODA <- dim(sst.SODA.new2)
dim.ORAS <- dim(sst.ORAS.new2)

#GODAS interpolate
nx <- dim.GODAS[1]
ny <- dim.GODAS[2]
nt <- dim.GODAS[3]

#GODAS lat: new.lat, lon: new.lon 
GODAS.interp <- NULL
for (j in seq_len(nt)) {
  GODAS.obj <-  list(x = GODAS.lon, y = GODAS.lat, z = sst.GODAS.new2[,,j])

  temp.interp <- interp.surface.grid(GODAS.obj, grid.list)
  GODAS.interp <- abind(GODAS.interp, temp.interp$z, along = 3)
}


#ORAS interpolate
nx <- dim.ORAS[1]
ny <- dim.ORAS[2]
nt <- dim.ORAS[3]

#ORAS lat: oras.lat, lon: oras.lon 

ORAS.interp <- NULL
for (j in seq_len(nt)) {
  ORAS.obj <-  list(x = oras.lon, y = oras.lat, z = sst.ORAS.new2[,,j])

  temp.interp <- interp.surface.grid(ORAS.obj, grid.list)
  ORAS.interp <- abind(ORAS.interp, temp.interp$z, along = 3)
}


#OISST interpolate
nx <- dim.OISST[1]
ny <- dim.OISST[2]
nt <- dim.OISST[3]

#OISST lat: lat.values.base, lon: lon.values.base 

OISST.interp <- NULL
for (j in seq_len(nt)) {
  OISST.obj <-  list(x = lon.values.base, y = lat.values.base, z = sst.OISST.new2[,,j])

  temp.interp <- interp.surface.grid(OISST.obj, grid.list)
  OISST.interp <- abind(OISST.interp, temp.interp$z, along = 3)
}


#SODA interpolate
nx <- dim.SODA[1]
ny <- dim.SODA[2]
nt <- dim.SODA[3]

#SODA lat: lat.values.soda, lon: lon.values.soda 

SODA.interp <- NULL
for (j in seq_len(nt)) {
  SODA.obj <-  list(x = lon.values.soda, y = lat.values.soda, z = sst.SODA.new2[,,j])

  temp.interp <- interp.surface.grid(SODA.obj, grid.list)
  SODA.interp <- abind(SODA.interp, temp.interp$z, along = 3)
}

dim(GODAS.interp)
dim(OISST.interp)
dim(ORAS.interp)
dim(SODA.interp)
```

```{r son_avg}
#get son average post interpolate
son.GODAS.interp <- son.avg(GODAS.interp)
son.ORAS.interp <- son.avg(ORAS.interp, son.only = TRUE)
son.OISST.interp <-  son.avg(OISST.interp)
son.SODA.interp <- son.avg(SODA.interp)

#dim check
dim(son.GODAS.interp)
dim(son.ORAS.interp)
dim(son.OISST.interp)
dim(son.SODA.interp)
```

## SON SST Avg

```{r SON_avgs}
#sst.GODAS.new2
son.GODAS.avg <- son.avg(sst.GODAS.new2)

#sst.ORAS.new2
son.ORAS.avg <- son.avg(sst.ORAS.new2, son.only = TRUE)

#sst.OISST.new2
son.OISST.avg <-  son.avg(sst.OISST.new2)

#sst.SODA.new2
son.SODA.avg <- son.avg(sst.SODA.new2)

#dim check
dim(son.GODAS.avg)
dim(son.ORAS.avg)
dim(son.OISST.avg)
dim(son.SODA.avg)
```

```{r lsm}
#get lsm mask
#TODO: create updated LSM that resembles that in the papers

```


### Interpolate (post SON Avg.)

```{r son.avg_interp}
son.GODAS.interp2 <- sst.interp(son.GODAS.avg, GODAS.lon, GODAS.lat, grid.list)
son.ORAS.interp2 <- sst.interp(son.ORAS.avg, oras.lon, oras.lat, grid.list)
son.OISST.interp2 <- sst.interp(son.OISST.avg, lon.values.base, lat.values.base, grid.list)
son.SODA.interp2 <- sst.interp(son.SODA.avg, lon.values.soda, lat.values.soda, grid.list)

#dim check
dim(son.GODAS.interp2)
dim(son.ORAS.interp2)
dim(son.OISST.interp2)
dim(son.SODA.interp2)
```


## Get SST Anoms (GODAS 2019)

(get sst anomalies)

```{r get_anoms}
#use sst.anom function
sst.anom.godas2 <- sst.anoms(sst.GODAS.w2019, quadratic = FALSE)

```


## Interpolation

```{r interpolate_anoms}
dim.GODAS <- dim(sst.GODAS.w2019)

#GODAS Interpolat
nx <- dim.GODAS[1]
ny <- dim.GODAS[2]
nt <- nrow(sst.anom.godas2$anom)

#GODAS lat: new.lat, lon: new.lon 
GODAS.new <- array(sst.anom.godas2$anom, dim = c(nt, ny, nx)) 
GODAS.new <- aperm(GODAS.new, c(3, 2, 1)) #as [nx, ny, nt]

GODAS.anom2 <- NULL
for (j in seq_len(nt)) {
  GODAS.obj <-  list(x = new.lon, y = new.lat, z = GODAS.new[,,j])

  temp.interp <- interp.surface.grid(GODAS.obj, grid.list)
  GODAS.anom2 <- abind(GODAS.anom2, temp.interp$z, along = 3)
}

dim(GODAS.anom2)
```

### Figures

```{r anom_figues}
#get dimensions
nx <- dim(GODAS.anom2)[1]
ny <- dim(GODAS.anom2)[2]

anom.temp <- GODAS.anom2[,,]

#sst.temp <- matrix(anom.temp, nrow = ny, ncol = nx)

abs.max <- max(abs(anom.temp), na.rm = TRUE)
abs.range <- c(-abs.max, abs.max)
cols.ryb <- rev(colorRampPalette(brewer.pal(11, "RdYlBu"))(14))
breaks.dumb <- c(abs.range[1], seq(-2.4,2.4, 0.4), abs.range[2])


imagePlot(list(x = grid.list$x, y = grid.list$y, z = anom.temp[,,38]),
          col = cols.ryb, breaks = breaks.dumb, zlim =  range(abs.range),
          xlim = c(40, 120), ylim = c(-10,10),
          xlab = "Lon", ylab = "Lat")
title("GODAS: SON 2019", adj = 0)
world(add = TRUE)


```

## pIOD Range

```{r pIOD}
#location range
lon.values.IOD <- lon.wide[lon.wide <= pIOD_maxLon & lon.wide >= pIOD_minLon]
lon.range.IOD <- range(which(lon.wide <= pIOD_maxLon & lon.wide >= pIOD_minLon))

lat.values.IOD <- lat.wide[lat.wide <= pIOD_maxLat & lat.wide >= pIOD_minLat]
lat.range.IOD <- range(which(lat.wide <= pIOD_maxLat & lat.wide >= pIOD_minLat))

#temp dimension setup
#nt <- 38
#ny <- 41
#nx <- 91

#TODO: adjust for the array
#sst.anom <- array(sst.full.avg, dim = c(nt, ny, nx)) 
#sst.anom <- array(mean_sst, dim = c(nt, ny, nx)) 
sst.anom2 <- aperm(GODAS.anom2, c(3, 2, 1))

sst.anom.pIOD <- sst.anom2[,lat.range.IOD[1]:lat.range.IOD[2],lon.range.IOD[1]:lon.range.IOD[2]]

dim(sst.anom.pIOD)
```



# Oceanic Processes in Ocean Temp Products

Reproducing the work by Yang et al 2020.

Data products:
- ORAâ€S5
- SODA
- GODAS
- OISST

Using data products interpolated onto $1^{\circ} \times 1^{\circ}$ horizontal grid.

Detrend (remove the quadratic trend of monthly data).

```{r dev_block}
#TODO: delete when done

#develop a detrending function (then delete)

#using GODAS as a test case 
sst.monthly <- GODAS.interp

#using the "normal" setup
A.new <- aperm(sst.monthly, perm = c(3, 2, 1))  # reorder data as [time, lat, lon]
  
#get dimensions from reordered array
nx <- dim(A.new)[3]
ny <- dim(A.new)[2] 
nt <- dim(A.new)[1]

#get only son months
nyears <- nt %/% 12

A.temp <- array(A.new, dim = c(12, nyears, ny, nx))

A.son <- A.temp[9:11, , , ] #for son.only A.temp[1:3, , , ] (probably don't even need the re-assign.)


#de-trend data
dim.son <- dim(A.son)
nt <- dim.son[2]

sept <- matrix(A.son[1,,,], nrow = nt, ncol = ny*nx)
oct <- matrix(A.son[2,,,], nrow = nt, ncol = ny*nx)
nov <- matrix(A.son[3,,,], nrow = nt, ncol = ny*nx)

son.list <- list(sept, oct, nov)

son.coef <- NULL
son.resid <- NULL
for (k in 1:length(son.list)) {
  
  son.temp <- son.list[[k]]
  
  test.na <- which(!is.na(son.temp), arr.ind = TRUE) 
  true.index <- unique(test.na[,2])
  
  sst.x <- seq_len(nt) #time "covariates"
  sst.y <- son.temp[ ,true.index] #response variable (sst anoms)
  
  #resid and coef setup
  A.resid <- matrix(NA, nrow = nt, ncol = ny*nx)
  A.coef <- matrix(NA, nrow = 3, ncol = ny*nx)
  
  #quadratic 
  var.fit <- lm(sst.y ~ sst.x + I(sst.x^2))
  A.coef[,true.index] <- var.fit$coefficients[1:3, ]
  A.resid[,true.index] <- var.fit$residuals

  #transform back into array [nt, ny, nx] or [terms, ny, nx]
  son.coef[[k]] <- array(A.coef, dim = c(3, ny, nx)) 
  son.resid[[k]] <- array(A.resid, dim = c(34, ny, nx)) 
}

```

SST anomalies are calculated with respect to the SON climatology of 1982-2015.
-Implies get SON first, then get anoms from SON avg from 1982-2015

```{r son_avg}
#get son average from the above resids (son.resid)

#create new array
son.anom <- abind(son.resid, along = 4)

son.anom.mean <- apply(son.anom, c(1,2,3), mean, na.rm = TRUE)
dim(son.anom.mean)

#get anomalies
dim.son <- dim(son.anom.mean)
nx <- dim.son[3]
ny <- dim.son[2]
nt <- dim.son[1]

var <- matrix(son.anom.mean, nrow = nt, ncol = ny * nx) #from earlier work on detrend
  
#get full period mean
var.mean <- colMeans(var) #TODO: visualize this spatially (transform to [lon, lat])
var <- sweep(var, 2, colMeans(var), "-")

#convert back
godas.sst.anom <- array(var, dim = c(nt, ny, nx))
```

```{r pca}
godas.sst.pIOD <- godas.sst.anom[,lat.range.IOD[1]:lat.range.IOD[2],lon.range.IOD[1]:lon.range.IOD[2]]

godas.pca <- sst.eof(godas.sst.pIOD, kmode = 2)

#TODO: regress the full Indian ocean region onto the sst anoms then get pct, etc.

#first normalize PCs

godas.pc.norm <- scale(godas.pca$PC)

pc1.godas <- -godas.pc.norm[,1]
pc2.godas <- -godas.pc.norm[,2]


#PC1 v. PC2 plot 
plot(pc1.godas, pc2.godas, pch = 19, col = "navyblue", xlim = c(-2,4), ylim = c(-3, 5),
     xlab = "PC1", ylab = "PC2", cex = 1)
points(pc1.godas[c(13,16,25)], pc2.godas[c(13,16,25)], pch = 19, col = "red1", cex =1)
points(pc1.godas[c(1,6,34)], pc2.godas[c(1,6,34)], pch = 19, col = "darkgreen", cex = 1)
abline(h = 0.5, lty = 2, lwd = 1)
abline(v = 1, lty = 2, lwd = 1)

```



# PCA

(move up the 1982-2015 'baseline' pca up to here, that is, load it here)

```{r baseline_pca}
#load in previous pca work
setwd("~/CO_AUS/Aus_CO-main/pIOD")
load("pca_newest.rda") #loads in pca.pIOD

#standardize PCs
pc.std.IOD <- scale(pca.pIOD$PC, center = TRUE, scale = TRUE)

PC1 <- -pc.std.IOD[,1]
PC2 <- pc.std.IOD[,2]

#1994 PCs
loc.1994 <- c(PC1[13], PC2[13])

#new indices
s.index <- (PC1 + PC2)/sqrt(2)
m.index <- (PC1 - PC2)/sqrt(2)

plot(1:34, s.index, type = "l", col = "firebrick", ylim=c(-2,5))
lines(1:34, m.index, col = "darkgreen")
abline(h=c(1.5, 1.25), lty = 2, col = c("firebrick", "darkgreen"))

#PC1 v. PC2 plot 
plot(PC1, PC2, pch = 19, col = "navyblue", xlim = c(-2,4), ylim = c(-3, 5),
     xlab = "PC1", ylab = "PC2", cex = 1)
points(PC1[c(13,16,25)], PC2[c(13,16,25)], pch = 19, col = "red1", cex =1)
points(PC1[c(1,6,34)], PC2[c(1,6,34)], pch = 19, col = "darkgreen", cex = 1)
abline(h = 0.5, lty = 2, lwd = 1)
abline(v = 1, lty = 2, lwd = 1)
```

## SON SST Patterns

```{r fig1a_1b}
#TODO: get exact fig 1a, 1b working
```


## PCA: 1982-2019 SST Anoms

```{r pca}
#eof functions
pca.iod.2019 <- sst.eof(sst.anom.pIOD, kmode = 2)

#TODO: update names from here so we don't have any confusion
pc.std.godas <- scale(pca.iod.2019$PC, center = TRUE, scale = TRUE)

#TODO: clean this up once we decide which direction to go in. 
#pc.std.IOD[,1] <- scale(pca.pIOD$PC[,1], center = TRUE, scale = TRUE)
#pc.std.IOD[,2] <- scale(pca.pIOD$PC[,2], center = TRUE, scale = TRUE)

PC1.godas <- -pc.std.godas[,1]
PC2.godas <- pc.std.godas[,2]

s.index.godas <- (PC1.godas + PC2.godas)/sqrt(2)
m.index.godas <- (PC1.godas - PC2.godas)/sqrt(2)

plot(1:38, s.index.godas, type = "l", col = "firebrick", ylim=c(-2,5))
lines(1:38, m.index.godas, col = "darkgreen")
abline(h=c(1.5, 1.25), lty = 2, col = c("firebrick", "darkgreen"))

PC1.godas[38] #2019
PC2.godas[38]

PC1.godas[13] #1994
PC2.godas[13]

plot(PC1.godas, PC2.godas, pch = 21, col = "black",
     bg = alpha("cyan",.65), xlim = c(-2,4), ylim = c(-3, 5),
     xlab = "PC1", ylab = "PC2", cex = 5)
points(PC1.godas[c(13,16,25)], PC2.godas[c(13,16,25)], pch = 21, col = "black",
       bg = alpha("red1",.75), cex = 5)
points(PC1.godas[c(1,6,34)], PC2.godas[c(1,6,34)], pch = 21, col = "black",
       bg = alpha("seagreen1",.65), cex = 5)
points(PC1.godas[38], PC2.godas[38], pch = 21, col = "black",
       bg = alpha("firebrick4",.65), cex = 5)
abline(h = 0.5, lty = 2, lwd = 4)
abline(v = 1, lty = 2, lwd = 4)
```

## PCA: GODAS SST Anoms

```{r pca_godas}
#TODO: set-up godas data and repeat
```


## Regress 2019

"...the black dot marks the 2019 pIOD, obtained by regressing the SST anomaly pattern over the tropical Indian Ocean in 2019 from the GODAS dataset onto the EOF1 and EOF2 patterns;" Fig 1 (cai et al, 2021).


We need: 
- SST anomaly pattern 

Regress the 2019 data onto eof1 and eof2 (loadings) of the baseline PCA. 

```{r regress_setup}
#select 2019 sst anoms
anom.2019 <- GODAS.anom2[,,38] #full regional 

sst.anom2 <- aperm(GODAS.anom2, c(3, 2, 1))
sst.2019.pIOD <- sst.anom2[38, lat.range.IOD[1]:lat.range.IOD[2], lon.range.IOD[1]:lon.range.IOD[2]] #pIOD (equitorial IOD)

#alternate pIOD (equitorial IOD)
sst.2019.iod <- GODAS.anom2[lon.range.IOD[1]:lon.range.IOD[2], lat.range.IOD[1]:lat.range.IOD[2], 38] #[lon, lat, year = 2019]
nx <- dim(sst.2019.iod)[1]
ny <- dim(sst.2019.iod)[2]

#setup eof and anom vectors
iod.eof <- pca.pIOD$EOF

#temp matrix (for comparison to sst.2019.iod, sst.anom matrix)
eof1.mat <- matrix(iod.eof[,1], nrow = nx, ncol = ny, byrow = TRUE)
eof2.mat <- matrix(iod.eof[,2], nrow = nx, ncol = ny, byrow = TRUE)

#move back to vector
sst.2019.vec <- as.vector(sst.2019.iod)
eof1.vec <- as.vector(eof1.mat)
eof2.vec <- as.vector(eof2.mat)

```

```{r regress_eof}
test.na <- is.finite(sst.2019.vec) & is.finite(eof1.vec) & is.finite(eof2.vec)

y <- sst.2019.vec[test.na]
X <- cbind(eof1.vec[test.na], eof2.vec[test.na])

a1 <- sum(y * eof1.vec[test.na])
a2 <- sum(y * eof2.vec[test.na])

#get pc mean and std dev
#pc.iod <- pca.pIOD$PC
pc.iod <- pca.iod.2019$PC
#pc.mean <- mean(rbind(pc.iod, c(a1, a2)))
#pc.std <- sd(rbind(pc.iod, c(a1, a2)))

pc.mean <- mean(pc.iod)
pc.std <- sd(pc.iod)

pc1.2019 <- -(a1-pc.mean)/pc.std
pc2.2019 <- (a2-pc.mean)/pc.std


#TODO: add in baseline (fig 1c)
plot(PC1, PC2, pch = 19, col = "navyblue", xlim = c(-2,4), ylim = c(-3, 5),
     xlab = "PC1", ylab = "PC2", cex = 1)
points(PC1[c(13,16,25)], PC2[c(13,16,25)], pch = 19, col = "red1", cex =1)
points(PC1[c(1,6,34)], PC2[c(1,6,34)], pch = 19, col = "darkgreen", cex = 1)
points(pc1.2019, pc2.2019, pch = 19, col = "black", cex =1.25)
abline(h = 0.5, lty = 2, lwd = 1)
abline(v = 1, lty = 2, lwd = 1)


#overlay
plot(PC1, PC2, pch = 21, col = "black",
     bg = alpha("cyan",.65), xlim = c(-2,4), ylim = c(-3, 5),
     xlab = "PC1", ylab = "PC2", cex = 5)
points(PC1[c(13,16,25)], PC2[c(13,16,25)], pch = 21, col = "black",
       bg = alpha("red1",.75), cex = 5)
points(PC1[c(1,6,34)], PC2[c(1,6,34)], pch = 21, col = "black",
       bg = alpha("seagreen1",.65), cex = 5)
points(pc1.2019, pc2.2019, pch = 21, col = "black",
       bg = alpha("plum2",.65), cex = 5)
abline(h = 0.5, lty = 2, lwd = 4)
abline(v = 1, lty = 2, lwd = 4)
```


# Visualization

Begin with requested plots (for slides)
- SST SON avg for each product.
-- Repeat for interpolated SON avg (non anom) (e.g. Yang et al, 2020.)

## SST SON Avg. (each product)

```{r range_cols}
#prep:
son.range <- range(son.OISST.avg, son.ORAS.avg, son.GODAS.avg, son.SODA.avg, na.rm = TRUE)
cols.ryb <- rev(colorRampPalette(brewer.pal(11, "RdYlBu"))(12))
breaks.son <- seq(son.range[1], son.range[2], length.out = length(cols.ryb)+1)
```

```{r OISST}
# using lon, lat: lat.values.base, lon.values.base

#1982
k <- 1
imagePlot(list(x = lon.values.base, y = lat.values.base, z = son.OISST.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim =  son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: SON 1982", adj = 0)
world(add = TRUE)

#1998
k <- 17
imagePlot(list(x = lon.values.base, y = lat.values.base, z = son.OISST.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: SON 1998", adj = 0)
world(add = TRUE)

#2015
k <- 34
imagePlot(list(x = lon.values.base, y = lat.values.base, z = son.OISST.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: SON 2015", adj = 0)
world(add = TRUE)

```

```{r ORAS}
# oras.lon, oras.lat


#1982
k <- 1
imagePlot(list(x = oras.lon, y = oras.lat, z = son.ORAS.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS: SON 1982", adj = 0)
world(add = TRUE)


#1998
k <- 17
imagePlot(list(x = oras.lon, y = oras.lat, z = son.ORAS.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS: SON 1998", adj = 0)
world(add = TRUE)


#2015
k <- 34
imagePlot(list(x = oras.lon, y = oras.lat, z = son.ORAS.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS: SON 2015", adj = 0)
world(add = TRUE)


```

```{r GODAS}

#, GODAS.lon, GODAS.lat

#1982
k <- 1
imagePlot(list(x = GODAS.lon, y = rev(GODAS.lat), z = son.GODAS.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim =  son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: SON 1982", adj = 0)
world(add = TRUE)

#1998
k <- 17
imagePlot(list(x = GODAS.lon, y = rev(GODAS.lat), z = son.GODAS.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: SON 1998", adj = 0)
world(add = TRUE)

#2015
k <- 34
imagePlot(list(x = GODAS.lon, y = rev(GODAS.lat), z = son.GODAS.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: SON 2015", adj = 0)
world(add = TRUE)
```

```{r SODA}
#lon.values.soda, lat.values.soda


#1982
k <- 1
imagePlot(list(x = lon.values.soda, y = lat.values.soda, z = son.SODA.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim =  son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA: SON 1982", adj = 0)
world(add = TRUE)

#1998
k <- 17
imagePlot(list(x = lon.values.soda, y = lat.values.soda, z = son.SODA.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA: SON 1998", adj = 0)
world(add = TRUE)

#2015
k <- 34
imagePlot(list(x = lon.values.soda, y = lat.values.soda, z = son.SODA.avg[,,k]),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA: SON 2015", adj = 0)
world(add = TRUE)
```


### Mean Field

```{r fullperiod_mean}
#1982-2015 mean
#OISST
son.OISST.mean <- apply(son.OISST.avg, c(1,2), mean)

imagePlot(list(x = lon.values.base, y = lat.values.base, z = son.OISST.mean),
          col = cols.ryb, breaks = breaks.son, zlim =  son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: Mean 1982-2015", adj = 0)
world(add = TRUE)

#ORAS
son.ORAS.mean <- apply(son.ORAS.avg, c(1,2), mean)

imagePlot(list(x = oras.lon, y = oras.lat, z = son.ORAS.mean),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS:Mean 1982-2015", adj = 0)
world(add = TRUE)

#GODAS
son.GODAS.mean <- apply(son.GODAS.avg, c(1,2), mean)

imagePlot(list(x = GODAS.lon, y = rev(GODAS.lat), z = son.GODAS.mean),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: Mean 1982-2015", adj = 0)
world(add = TRUE)

#SODA
son.SODA.mean <- apply(son.SODA.avg, c(1,2), mean)

imagePlot(list(x = lon.values.soda, y = lat.values.soda, z = son.SODA.mean),
          col = cols.ryb, breaks = breaks.son, zlim =  son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA: Mean 1982-2015", adj = 0)
world(add = TRUE)

```

```{r partialperiod_mean}
#1982-1998 mean
son.OISST.mean1 <- apply(son.OISST.avg[,,1:17], c(1,2), mean)
son.ORAS.mean1 <- apply(son.ORAS.avg[,,1:17], c(1,2), mean)
son.GODAS.mean1 <- apply(son.GODAS.avg[,,1:17], c(1,2), mean)
son.SODA.mean1 <- apply(son.SODA.avg[,,1:17], c(1,2), mean)

#1999-2015 mean
son.OISST.mean2 <- apply(son.OISST.avg[,,18:34], c(1,2), mean)
son.ORAS.mean2 <- apply(son.ORAS.avg[,,18:34], c(1,2), mean)
son.GODAS.mean2 <- apply(son.GODAS.avg[,,18:34], c(1,2), mean)
son.SODA.mean2 <- apply(son.SODA.avg[,,18:34], c(1,2), mean)

#plots
##1982-1998
imagePlot(list(x = lon.values.base, y = lat.values.base, z = son.OISST.mean1),
          col = cols.ryb, breaks = breaks.son, zlim =  son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: Mean 1982-1998", adj = 0)
world(add = TRUE)

imagePlot(list(x = oras.lon, y = oras.lat, z = son.ORAS.mean1),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS:Mean 1982-1998", adj = 0)
world(add = TRUE)

imagePlot(list(x = GODAS.lon, y = rev(GODAS.lat), z = son.GODAS.mean1),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: Mean 1982-1998", adj = 0)
world(add = TRUE)

imagePlot(list(x = lon.values.soda, y = lat.values.soda, z = son.SODA.mean1),
          col = cols.ryb, breaks = breaks.son, zlim =  son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA: Mean 1982-1998", adj = 0)
world(add = TRUE)


##1999-2015
imagePlot(list(x = lon.values.base, y = lat.values.base, z = son.OISST.mean2),
          col = cols.ryb, breaks = breaks.son, zlim =  son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: Mean 1998-2015", adj = 0)
world(add = TRUE)

imagePlot(list(x = oras.lon, y = oras.lat, z = son.ORAS.mean2),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS:Mean 1998-2015", adj = 0)
world(add = TRUE)

imagePlot(list(x = GODAS.lon, y = rev(GODAS.lat), z = son.GODAS.mean2),
          col = cols.ryb, breaks = breaks.son, zlim = son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: Mean 1998-2015", adj = 0)
world(add = TRUE)

imagePlot(list(x = lon.values.soda, y = lat.values.soda, z = son.SODA.mean2),
          col = cols.ryb, breaks = breaks.son, zlim =  son.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA: Mean 1998-2015", adj = 0)
world(add = TRUE)

```

```{r partial_diffs}
#get differenes
son.OISST.diff <- son.OISST.mean2 - son.OISST.mean1
son.ORAS.diff <- son.ORAS.mean2 - son.ORAS.mean1
son.GODAS.diff <- son.GODAS.mean2 - son.GODAS.mean1
son.SODA.diff <- son.SODA.mean2 - son.SODA.mean1


#setup range and colors
#TODO: combine son diffs
diff.max <- max(abs(c(son.GODAS.diff, son.OISST.diff,
                          son.ORAS.diff, son.SODA.diff)), na.rm = TRUE)
diff.range <- c(-diff.max, diff.max)
cols.rb <- rev(colorRampPalette(brewer.pal(11, "RdBu"))(12))
breaks.diff <- seq(diff.range[1], diff.range[2], length.out = length(cols.rb)+1)



imagePlot(list(x = lon.values.base, y = lat.values.base, z = son.OISST.diff),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: Mean Field Difference", adj = 0)
world(add = TRUE)


imagePlot(list(x = oras.lon, y = oras.lat, z = son.ORAS.diff),
          col = cols.rb, breaks = breaks.diff, zlim = diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS: Mean Field Difference", adj = 0)
world(add = TRUE)


imagePlot(list(x = GODAS.lon, y = rev(GODAS.lat), z = son.GODAS.diff),
          col = cols.rb, breaks = breaks.diff, zlim = diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: Mean Field Difference", adj = 0)
world(add = TRUE)

imagePlot(list(x = lon.values.soda, y = lat.values.soda, z = son.SODA.diff),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA: Mean Field Difference", adj = 0)
world(add = TRUE)

```


## SST SON Avg. (interpolated)

Each data product interpolated to a $1^{\circ} \times 1^{\circ}$ grid. 

```{r col_range}
#prep:
interp.range <- range(son.OISST.interp, son.ORAS.interp, son.GODAS.interp, son.SODA.interp, na.rm = TRUE)
cols.ryb <- rev(colorRampPalette(brewer.pal(11, "RdYlBu"))(12))
breaks.interp <- seq(interp.range[1], interp.range[2], length.out = length(cols.ryb)+1)

```

```{r OISST}
#1982
k <- 1
imagePlot(list(x = lon.wide, y = lat.wide, z = son.OISST.interp[,,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: SON 1982", adj = 0)
world(add = TRUE)

#1998
k <- 17
imagePlot(list(x = lon.wide, y = lat.wide, z = son.OISST.interp[,,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: SON 1998", adj = 0)
world(add = TRUE)

#2015
k <- 34
imagePlot(list(x = lon.wide, y = lat.wide, z = son.OISST.interp[,,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: SON 1998", adj = 0)
world(add = TRUE)
```

```{r ORAS}
#1982
k <- 1
imagePlot(list(x = lon.wide, y = lat.wide, z = son.ORAS.interp[,,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS: SON 1982", adj = 0)
world(add = TRUE)

#1998
k <- 17
imagePlot(list(x = lon.wide, y = lat.wide, z = son.ORAS.interp[,,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS: SON 1998", adj = 0)
world(add = TRUE)

#2015
k <- 34
imagePlot(list(x = lon.wide, y = lat.wide, z = son.ORAS.interp[,,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS: SON 1998", adj = 0)
world(add = TRUE)
```

```{r GODAS}
ny <- dim(son.GODAS.interp)[2]

#1982
k <- 1
imagePlot(list(x = lon.wide, y = lat.wide, z = son.GODAS.interp[,ny:1,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: SON 1982", adj = 0)
world(add = TRUE)

#1998
k <- 17
imagePlot(list(x = lon.wide, y = lat.wide, z = son.GODAS.interp[,ny:1,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: SON 1998", adj = 0)
world(add = TRUE)

#2015
k <- 34
imagePlot(list(x = lon.wide, y = lat.wide, z = son.GODAS.interp[,ny:1,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: SON 1998", adj = 0)
world(add = TRUE)
```

```{r SODA}
#1982
k <- 1
imagePlot(list(x = lon.wide, y = lat.wide, z = son.SODA.interp[,,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA: SON 1982", adj = 0)
world(add = TRUE)

#1998
k <- 17
imagePlot(list(x = lon.wide, y = lat.wide, z = son.SODA.interp[,,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA: SON 1998", adj = 0)
world(add = TRUE)

#2015
k <- 34
imagePlot(list(x = lon.wide, y = lat.wide, z = son.SODA.interp[,,k]),
          col = cols.ryb, breaks = breaks.interp, zlim =  interp.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA: SON 1998", adj = 0)
world(add = TRUE)
```


### Data Product Differences (wrt SON Avg)

```{r temp_diff}
#temporary checks on differences between when interpolation occurs
k <- 16
OISST.interp.diff <- son.OISST.interp2[,,k] - son.OISST.interp[,,k]


diff.max <- max(abs(OISST.interp.diff), na.rm = TRUE)
diff.range <- c(-diff.max, diff.max)
cols.rb <- rev(colorRampPalette(brewer.pal(11, "RdBu"))(12))
breaks.diff <- seq(diff.range[1], diff.range[2], length.out = length(cols.rb)+1)

imagePlot(list(x = lon.wide, y = lat.wide, z = OISST.interp.diff),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: SON 1997 Diff", adj = 0)
world(add = TRUE)

```

Note/TODO: somehow represent the below figures in a meaningful way...

```{r OISST_diff}

##1982
k <- 1
OISST.diff1 <- son.OISST.interp[,,k] - son.ORAS.interp[,,k]
OISST.diff2 <- son.OISST.interp[,,k] - son.GODAS.interp[,dim(son.GODAS.interp)[2]:1,k]
OISST.diff3 <- son.OISST.interp[,,k] - son.SODA.interp[,,k]

diff.max <- max(abs(c(OISST.diff1, OISST.diff2, OISST.diff3)), na.rm = TRUE)
diff.range <- c(-diff.max, diff.max)
cols.rb <- rev(colorRampPalette(brewer.pal(11, "RdBu"))(12))
breaks.diff <- seq(diff.range[1], diff.range[2], length.out = length(cols.rb)+1)

#OISST - ORAS
imagePlot(list(x = lon.wide, y = lat.wide, z = OISST.diff1),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST - ORAS: SON 1982 Difference", adj = 0)
world(add = TRUE)

#OISST - GODAS
imagePlot(list(x = lon.wide, y = lat.wide, z = OISST.diff2),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST - GODAS: SON 1982 Difference", adj = 0)
world(add = TRUE)

#OISST - SODA
imagePlot(list(x = lon.wide, y = lat.wide, z = OISST.diff3),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST - SODA: SON 1982 Difference", adj = 0)
world(add = TRUE)

```

```{r ORAS_diff}
##1982
k <- 1
ORAS.diff1 <- son.ORAS.interp[,,k] - son.OISST.interp[,,k]
ORAS.diff2 <- son.ORAS.interp[,,k] - son.GODAS.interp[,dim(son.GODAS.interp)[2]:1,k]
ORAS.diff3 <- son.ORAS.interp[,,k] - son.SODA.interp[,,k]

diff.max <- max(abs(c(ORAS.diff1, ORAS.diff2, ORAS.diff3)), na.rm = TRUE)
diff.range <- c(-diff.max, diff.max)
cols.rb <- rev(colorRampPalette(brewer.pal(11, "RdBu"))(12))
breaks.diff <- seq(diff.range[1], diff.range[2], length.out = length(cols.rb)+1)


#OISST - ORAS
imagePlot(list(x = lon.wide, y = lat.wide, z = ORAS.diff1),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS - OISST: SON 1982 Difference", adj = 0)
world(add = TRUE)

#OISST - GODAS
imagePlot(list(x = lon.wide, y = lat.wide, z = ORAS.diff2),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS - GODAS: SON 1982 Difference", adj = 0)
world(add = TRUE)

#OISST - SODA
imagePlot(list(x = lon.wide, y = lat.wide, z = ORAS.diff3),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS - SODA: SON 1982 Difference", adj = 0)
world(add = TRUE)



```

```{r GODAS_diff}
##1982
k <- 1
GODAS.diff1 <- son.GODAS.interp[,dim(son.GODAS.interp)[2]:1,k] - son.OISST.interp[,,k]
GODAS.diff2 <- son.GODAS.interp[,dim(son.GODAS.interp)[2]:1,k] - son.ORAS.interp[,,k]
GODAS.diff3 <- son.GODAS.interp[,dim(son.GODAS.interp)[2]:1,k] - son.SODA.interp[,,k]

diff.max <- max(abs(c(GODAS.diff1, GODAS.diff2, GODAS.diff3)), na.rm = TRUE)
diff.range <- c(-diff.max, diff.max)
cols.rb <- rev(colorRampPalette(brewer.pal(11, "RdBu"))(12))
breaks.diff <- seq(diff.range[1], diff.range[2], length.out = length(cols.rb)+1)


#OISST - ORAS
imagePlot(list(x = lon.wide, y = lat.wide, z = GODAS.diff1),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS - OISST: SON 1982 Difference", adj = 0)
world(add = TRUE)

#OISST - GODAS
imagePlot(list(x = lon.wide, y = lat.wide, z = GODAS.diff2),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS - ORAS: SON 1982 Difference", adj = 0)
world(add = TRUE)

#OISST - SODA
imagePlot(list(x = lon.wide, y = lat.wide, z = GODAS.diff3),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS - SODA: SON 1982 Difference", adj = 0)
world(add = TRUE)

```

```{r SODA_diff}

##1982
k <- 1
SODA.diff1 <- son.SODA.interp[,,k] - son.OISST.interp[,,k]
SODA.diff2 <- son.SODA.interp[,,k] - son.ORAS.interp[,,k]
SODA.diff3 <- son.SODA.interp[,,k] - son.GODAS.interp[,dim(son.GODAS.interp)[2]:1,k]

diff.max <- max(abs(c(SODA.diff1, SODA.diff2, SODA.diff3)), na.rm = TRUE)
diff.range <- c(-diff.max, diff.max)
cols.rb <- rev(colorRampPalette(brewer.pal(11, "RdBu"))(12))
breaks.diff <- seq(diff.range[1], diff.range[2], length.out = length(cols.rb)+1)


#OISST - ORAS
imagePlot(list(x = lon.wide, y = lat.wide, z = SODA.diff1),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA - OISST: SON 1982 Difference", adj = 0)
world(add = TRUE)

#OISST - GODAS
imagePlot(list(x = lon.wide, y = lat.wide, z = SODA.diff2),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA - ORAS: SON 1982 Difference", adj = 0)
world(add = TRUE)

#OISST - SODA
imagePlot(list(x = lon.wide, y = lat.wide, z = SODA.diff3),
          col = cols.rb, breaks = breaks.diff, zlim =  diff.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA - GODAS: SON 1982 Difference", adj = 0)
world(add = TRUE)


```





