---
title: "cluster_new"
author: "Ryan Peterson"
date: "2025-04-25"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r library}
#libraries
suppressMessages(library(adespatial)) #for constr.hclust
suppressMessages( library(cluster)) #for general cluster/diana
suppressMessages(library(dendextend)) 
suppressMessages( library(factoextra))

suppressMessages(library(scales))

#for constr.hclust example and correct linkages
library(spData) 
library(spdep)

suppressMessages( library(fields))
```

```{r data_import}
# data and functions
setwd("~/CO_AUS/Aus_CO-main/Interactions")

load( "Data/ne_data.rda")
load( "Data/se_data.rda")
load( "Data/bounded_data.rda")
load( "Data/data_matrix.rda")
load( "Data/lag_list.rda")

```

```{r setup}
season_weeks <- c(35:52, 1:14)
season_years <- unique(bounded_resp_df$year)

seasons <- c()
for (i in 1:(length(season_years)-1)) {
  temp_season <- paste0(season_years[i], "-", season_years[i+1])
  #print(temp_season)  
  seasons <- c(seasons, temp_season)
}
rm(i, temp_season)

#center response data
NEbase_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEbase_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)
```


# All Years Clustering

```{r baseline_cluster}
#using default values 
NEconst_clust <- constr.hclust(dist(t(NEbase_matrix)), chron = TRUE) #default with ward.d2 method
SEconst_clust <- constr.hclust(dist(t(SEbase_matrix)), chron = TRUE) #default with ward.d2 method

cutree(NEconst_clust, k =2)
cutree(SEconst_clust, k =2)

SEconst_clust$order <- 1:32
NEconst_clust$order <- 1:32

stats:::plot.hclust(NEconst_clust, hang = -1, labels = FALSE, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "NE Aus : Response Clustering", axes = FALSE, cex.main = 2.0,
                    cex.lab = 1.5)
axis(2)
axis(1, at = 1:32, labels = c(season_weeks[1:32]), 
     las = 3, gap.axis = 0, tck = 0.5, lty = 0, cex.axis = 1.6)


stats:::plot.hclust(SEconst_clust, hang = -1, labels = FALSE, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "SE Aus : Response Clustering", axes = FALSE, cex.main = 2.0,
                    cex.lab = 1.5)
axis(2)
axis(1, at = 1:32, labels = c(season_weeks[1:32]), 
     las = 3, gap.axis = 0, tck = 0.5, lty = 0, cex.axis = 1.6)

#TODO: change from manual to something else later
NE_splits <- list(c(46,47))
SE_splits <- list(c(50,51))
```


```{r function}

#we can replace this with dendlist()

cluster_matrix <- function(NEbase_matrix, SEbase_matrix, temporal = TRUE){

  NEclust_matrix <- matrix(NA, ncol = 32)
  SEclust_matrix <- matrix(NA, ncol = 32)
  
  NE_clust <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal) #default with ward.d2 method
  SE_clust <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal) #default with ward.d2 method
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust, k =2))
  
  #ward.D
  NE_clust1 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "ward.D") # ward.D method
  SE_clust1 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "ward.D") # ward.D method
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust1, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust1, k =2))
  
  #single linkage
  NE_clust2 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "single")
  SE_clust2 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "single") 
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust2, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust2, k =2))
  
  #complete linkage
  NE_clust3 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "complete") 
  SE_clust3 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "complete")
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust3, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust3, k =2))
  
  #flexible w/  beta = -0.25
  NE_clust4 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "flexible", beta = -0.5) 
  SE_clust4 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "flexible", beta = -0.5) 
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust4, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust4, k =2))
  
  #"average" (UPGMA)
  NE_clust5 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "average")
  SE_clust5 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "average")
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust5, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust5, k =2))
  
  #"mcquitty" (WPGMA)
  NE_clust6 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "mcquitty")
  SE_clust6 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "mcquitty")
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust6, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust6, k =2))
  
  #"centroid" (UPGMC)a
  NE_clust7 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "centroid")
  SE_clust7 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "centroid")
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust7, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust7, k =2))
  
  #"median" (WPGMC)
  NE_clust8 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "median")
  SE_clust8 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "median")
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust8, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust8, k =2))
  
  method_names <- c("ward.d2", "ward.D", "single", "complete", "flexible", 
                    "average", "mcquitty", "centroid", "median")
  
  NEclust_matrix <- NEclust_matrix[-1, ]
  SEclust_matrix <- SEclust_matrix[-1, ]
  
  rownames(NEclust_matrix) <- method_names
  rownames(SEclust_matrix) <- method_names

  return(list(NEclust_matrix, SEclust_matrix))
}
```


```{r}
full_cluster <- cluster_matrix(NEbase_matrix, SEbase_matrix, temporal = TRUE)

NEcluster_list <- list()
SEcluster_list <- list()
for (j in 1:19) {
  NEmatrix_new <- scale(resp_matrix[-c(j), 1:32], center = TRUE, scale = FALSE)
  SEmatrix_new <- scale(resp_matrix[-c(j), 33:64], center = TRUE, scale = FALSE)
  
  part_cluster <- cluster_matrix(NEmatrix_new, SEmatrix_new, temporal = FALSE)
  
  NEcluster_list[[paste0("without:", seasons[j])]] <- part_cluster[[1]]
  SEcluster_list[[paste0("without:", seasons[j])]] <- part_cluster[[2]]
}



#cluster_matrix(NEbase_matrix, SEbase_matrix, temporal = FALSE)
```

```{r}
Reduce("+", NEcluster_list) / length(NEcluster_list)

Reduce("+", SEcluster_list) / length(SEcluster_list)
```


Repeat all of this with the dendextend package 

# Agg/Time Analysis

```{r}
hclust_methods <- c("ward.D", "single", "complete", "average", "mcquitty", 
        "median", "centroid", "ward.D2")

NE_dendlist <- dendlist()
SE_dendlist <- dendlist()

for(i in seq_along(hclust_methods)) {
   hc_NEAus <- constr.hclust(dist(t(NEbase_matrix)), method = hclust_methods[i],  chron = TRUE)
   hc_SEAus <- constr.hclust(dist(t(SEbase_matrix)), method = hclust_methods[i],  chron = TRUE)
   
   NE_dendlist <- dendlist(NE_dendlist, as.dendrogram(hc_NEAus))
   SE_dendlist <- dendlist(SE_dendlist, as.dendrogram(hc_SEAus))
}

names(NE_dendlist) <- hclust_methods
names(SE_dendlist) <- hclust_methods

NE_dendlist
SE_dendlist
```

```{r}
NE_dendlist_cor <- cor.dendlist(NE_dendlist)

corrplot::corrplot(NE_dendlist_cor, "pie", "lower")
```

```{r}
NE_dendlist %>% dendlist(which = c(2,7)) %>% ladderize %>% 
   set("branches_k_color", k=2) %>% 
   # untangle(method = "step1side", k_seq = 3:20) %>%
   tanglegram(faster = TRUE)
```


```{r}
get_ordered_2_clusters <- function(dend) {
   cutree(dend, k = 2)[order.dendrogram(dend)]
}

compare_clusters_to <- function(clus) {FM_index(clus, rep(1:2, each = 16), assume_sorted_vectors = TRUE)}

dend_2_clusters <- lapply(NE_dendlist, get_ordered_2_clusters)

clusters_performance <- sapply(dend_2_clusters, compare_clusters_to)
clusters_performance
dotchart(sort(clusters_performance), xlim = c(0.6, 1),
         xlab = "Fowlkes-Mallows Index (from 0 to 1)",
         main = "Perormance of clustering algorithms \n in detecting the 2 species",
         pch = 19)

dend_2_clusters <- lapply(SE_dendlist, get_ordered_2_clusters)

clusters_performance <- sapply(dend_2_clusters, compare_clusters_to)
clusters_performance
dotchart(sort(clusters_performance), xlim = c(0.6, 1),
         xlab = "Fowlkes-Mallows Index (from 0 to 1)",
         main = "Perormance of clustering algorithms \n in detecting the 2 species",
         pch = 19)

```

```{r}
cutree(NE_dendlist$complete, k = 2)
cutree(SE_dendlist$complete, k = 2)
```

## Train/Test 2019

TODO: build in hclust with chron = TRUE, then do some work to comparison between methods.

```{r}
#train data
NEtrain_matrix <- scale(resp_matrix[-c(16:19) ,1:32], center = TRUE, scale = FALSE)
SEtrain_matrix <- scale(resp_matrix[-c(16:19) ,33:64], center = TRUE, scale = FALSE)

#test data
NEtest_matrix <- scale(resp_matrix[16:19 ,1:32], center = TRUE, scale = FALSE)
SEtest_matrix <- scale(resp_matrix[16:19 ,33:64], center = TRUE, scale = FALSE)

NE_train <- dist(t(NEtrain_matrix))
SE_train <- dist(t(SEtrain_matrix))

NE_test <- dist(t(NEtest_matrix))
SE_test <- dist(t(SEtest_matrix))


hclust_methods <- c("ward.D", "single", "complete", "average", "mcquitty", 
        "median", "centroid", "ward.D2")

i <- 2
NEhc_train <- constr.hclust(NE_train, method = hclust_methods[i],  chron = FALSE)
NEhc_test  <- constr.hclust(NE_test, method = hclust_methods[i],  chron = FALSE)

NEd_train <- as.dendrogram(NEhc_train)
NEd_test <-  as.dendrogram(NEhc_test)
NEd_train_test <- dendlist(train = NEd_train, test = NEd_test)

SEhc_train <- constr.hclust(SE_train, method = hclust_methods[i],  chron = FALSE)
SEhc_test  <- constr.hclust(SE_test, method = hclust_methods[i],  chron = FALSE)

SEd_train <- as.dendrogram(SEhc_train)
SEd_test <- as.dendrogram(SEhc_test)
SEd_train_test <- dendlist(train = SEd_train, test = SEd_test)
```

```{r}
Bk_plot(NEd_test, NEd_train, k = 2:16, xlim = c(2,16))
Bk_plot(SEd_test, SEd_train, k = 2:16, xlim = c(2,16))
```

```{r}
pre_tang_d_train_test <- SEd_train_test %>% ladderize %>% # untangle %>%
   set("branches_k_color", k = 7)
train_branches_colors <- get_leaves_branches_col(pre_tang_d_train_test$train)
pre_tang_d_train_test %>% tanglegram(fast = TRUE, color_lines = train_branches_colors)
```



```{r}
#center response data
NEbase_matrix <- scale(resp_matrix[-c(17) ,1:32], center = TRUE, scale = FALSE)
SEbase_matrix <- scale(resp_matrix[-c(17) ,33:64], center = TRUE, scale = FALSE)

hclust_methods <- c("ward.D", "single", "complete", "average", "mcquitty", 
        "median", "centroid", "ward.D2")

NE_dendlist <- dendlist()
SE_dendlist <- dendlist()

for(i in seq_along(hclust_methods)) {
   hc_NEAus <- constr.hclust(dist(t(NEbase_matrix)), method = hclust_methods[i],  chron = FALSE)
   hc_SEAus <- constr.hclust(dist(t(SEbase_matrix)), method = hclust_methods[i],  chron = FALSE)
   
   NE_dendlist <- dendlist(NE_dendlist, as.dendrogram(hc_NEAus))
   SE_dendlist <- dendlist(SE_dendlist, as.dendrogram(hc_SEAus))
}

names(NE_dendlist) <- hclust_methods
names(SE_dendlist) <- hclust_methods

get_ordered_2_clusters <- function(dend) {
   cutree(dend, k = 2)[order.dendrogram(dend)]
}

compare_clusters_to <- function(clus) {FM_index(clus, rep(1:2, each = 16), assume_sorted_vectors = TRUE)}

dend_2_clusters <- lapply(NE_dendlist, get_ordered_2_clusters)

clusters_performance <- sapply(dend_2_clusters, compare_clusters_to)
which.max( clusters_performance)
dotchart(sort(clusters_performance), xlim = c(0.6, 1),
         xlab = "Fowlkes-Mallows Index (from 0 to 1)",
         main = "Perormance of clustering algorithms \n in detecting the 2 species",
         pch = 19)

dend_2_clusters <- lapply(SE_dendlist, get_ordered_2_clusters)

clusters_performance <- sapply(dend_2_clusters, compare_clusters_to)
which.max( clusters_performance)
dotchart(sort(clusters_performance), xlim = c(0.6, 1),
         xlab = "Fowlkes-Mallows Index (from 0 to 1)",
         main = "Perormance of clustering algorithms \n in detecting the 2 species",
         pch = 19)
```




```{r diana}
#top-down clustering
NEyear_div <- diana(NEbase_matrix,  metric = "manhattan")
plot(NEyear_div)
SEyear_div <- diana(SEbase_matrix,  metric = "manhattan")
plot(SEyear_div)


NEweek_div <- diana(t(NEbase_matrix))
plot(NEweek_div, adj = 0)

SEweek_div <- diana(t(SEbase_matrix))
plot(SEweek_div)

NEweek_agg <- agnes(t(NEbase_matrix))
plot(NEweek_agg)

SEweek_agg <- agnes(t(SEbase_matrix))
plot(SEweek_agg)

summary(SEweek_agg)

clusplot(t(SEbase_matrix), )
```

```{r}
NEtest_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEtest_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)

NE_test <- dist(t(NEtest_matrix))
SE_test <- dist(t(SEtest_matrix))


hclust_methods <- c("ward.D", "single", "complete", "average", "mcquitty", 
        "median", "centroid", "ward.D2")

i <- 1
NEhc <- constr.hclust(NE_test, method = hclust_methods[i],  chron = TRUE)
coefHier(NEhc)

fviz_nbclust(t(NEtest_matrix), FUN = hcut, method = "wss")
fviz_nbclust(t(SEtest_matrix), FUN = hcut, method = "wss")


#note use this
fviz_nbclust(t(NEtest_matrix), FUN = hcut, method = "gap_stat")
fviz_nbclust(t(SEtest_matrix), FUN = hcut, method = "gap_stat")

dend_plot <- fviz_dend(NEhc)
dend_data <- attr(dend_plot, "dendrogram")
```


```{r test_links}
dat <- c(41,42,25,38,50,30,41,43,43,41,30,50,38,25,42,41)
coord.dat <- matrix(c(1,3,5,7,2,4,6,8,1,3,5,7,2,4,6,8,
4.4,4.4,4.4,4.4,3.3,3.3,3.3,3.3,
2.2,2.2,2.2,2.2,1.1,1.1,1.1,1.1),16,2)

listW <- nb2listw(tri2nb(coord.dat), style="B")
links.mat.dat <- listw2mat(listW)
neighbors <- listw2sn(listW)[,1:2]

plot(coord.dat, type='n',asp=1)
text(coord.dat, labels=as.character(as.matrix(dat)), pos=3)
for(i in 1:nrow(neighbors))
  lines(rbind(coord.dat[neighbors[i,1],],
  coord.dat[neighbors[i,2],]))

D.dat <- dist(dat)

grpWD2cst_constr_hclust <- constr.hclust(
  D.dat, method="ward.D2",
  neighbors, coord.dat)

grpWD2cst_constr_hclust$coords
```

```{r method_checks}
NEtest_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEtest_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)

NE_test <- dist(t(NEtest_matrix), method = "manhattan")
SE_test <- dist(t(SEtest_matrix), method = "manhattan")

hclust_methods <- c("ward.D", "centroid", "complete", "average")

i <- 3
NEhc1 <- constr.hclust(NE_test, method = hclust_methods[i],  chron = TRUE)
SEhc1 <- constr.hclust(SE_test, method = hclust_methods[i],  chron = TRUE)



NEhc_test <- constr.hclust(NE_test, method = hclust_methods[i],  coords = hc_links)

NE_cut <- cutree(NEhc1, k =2)
NEcut_test <- cutree(NEhc_test, k =2)

SE_cut <- cutree(SEhc1, k =2)

sil_NE <- silhouette(NE_cut, NE_test)
fviz_silhouette(sil_NE, label = TRUE, print.summary = FALSE)

sil_SE <- silhouette(SE_cut, SE_test)
fviz_silhouette(sil_SE, label = TRUE, print.summary = FALSE)

which(sil_NE[, "sil_width"] < 0)
which(sil_SE[, "sil_width"] < 0)

#TODO: when chron false include a circular plot with ordered hclust
#NEhc1$order <- 1:32
#SEhc1$order <- 1:32

coef.hclust(NEhc1)

stats:::plot.hclust(NEhc1, hang = -1, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "NE Aus : ward.D")
rect.hclust(NEhc1, k = 2, border = 2:3)

stats:::plot.hclust(SEhc1, hang = -1, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "SE Aus : ward.D")
rect.hclust(SEhc1, k = 2, border = 2:3)
```


```{r messy_neighbors}
#very messy 
hc_coord <- NEhc1[["coords"]]
test_old <- cell2nb(32, 1, type="rook", torus=TRUE)
test_test <- cell2nb(32, 1, type="rook", torus=FALSE)
test_test[[1]] <- as.integer(c(2,32))
test_test[[32]] <- as.integer(c(31, 1))

testL <-  nb2listw(test_test, style = "B")
week_neighbor <- listw2sn(testL)[,1:2]

NE_hclust <- constr.hclust(
  NE_test, method ="ward.D",
  week_neighbor, hc_coord)


NE_cut <- cutree(NE_hclust, k =3)

sil_NE <- silhouette(NE_cut, NE_test)
fviz_silhouette(sil_NE, label = TRUE, print.summary = FALSE)


SE_hclust <- constr.hclust(
  SE_test, method ="ward.D",
  week_neighbor, hc_coord)

SE_cut <- cutree(SE_hclust, k =3)

sil_SE <- silhouette(SE_cut, SE_test)
fviz_silhouette(sil_SE, label = TRUE, print.summary = FALSE)

```


```{r diana}
NE_test <- dist(t(NEtest_matrix), method = "manhattan")
SE_test <- dist(t(SEtest_matrix), method = "manhattan")

NEyear_div <- diana(t(NEbase_matrix),  metric = "manhattan")
SEyear_div <- diana(t(SEbase_matrix),  metric = "manhattan")

NEcut_div <- cutree(NEyear_div, k = 2)
SEcut_div <- cutree(SEyear_div, k = 2)


NEsil_div <- silhouette(NEcut_div, NE_test)
fviz_silhouette(NEsil_div, label = TRUE, print.summary = FALSE)

SEsil_div <- silhouette(SEcut_div, SE_test)
fviz_silhouette(SEsil_div, label = TRUE, print.summary = FALSE)

```


```{r coeffs}
#div coefs
NEyear_divM <- diana(t(NEbase_matrix),  metric = "manhattan")
SEyear_divM <- diana(t(SEbase_matrix),  metric = "manhattan")

NEyear_divM$dc
SEyear_divM$dc

NEyear_div <- diana(t(NEbase_matrix),  metric = "euclidian")
SEyear_div <- diana(t(SEbase_matrix),  metric = "euclidian")

NEyear_div$dc
SEyear_div$dc


#agglomerative coefs to compare methods
NE_test <- dist(t(NEtest_matrix), method = "manhattan")
SE_test <- dist(t(SEtest_matrix), method = "manhattan")

hclust_methods <- c("ward.D", "single", "complete", "average")

#chron FALSE

agg_coefM <- matrix(NA, nrow = 2)
for (i in 1:4) {
  NEhc_test <- constr.hclust(NE_test, method = hclust_methods[i],  chron = FALSE)
  SEhc_test <- constr.hclust(SE_test, method = hclust_methods[i],  chron = FALSE)
  agg_coefM <- cbind(agg_coefM, c(coef.hclust(NEhc_test), coef.hclust(SEhc_test)))
}

agg_coefM <- agg_coefM[,-1]
colnames(agg_coefM) <- hclust_methods


#chron "TRUE" (using torus)
#NOTE: agg coef does not work for the other method


#chron TRUE

agg_chronM <- matrix(NA, nrow = 2)
for (i in 1:4) {
  NEhc_test <- constr.hclust(NE_test, method = hclust_methods[i],  chron = TRUE)
  SEhc_test <- constr.hclust(SE_test, method = hclust_methods[i],  chron = TRUE)
  agg_chronM <- cbind(agg_chronM, c(coef.hclust(NEhc_test), coef.hclust(SEhc_test)))
}

agg_chronM <- agg_chronM[,-1]
colnames(agg_chronM) <- hclust_methods

```

# LOO Testing

```{r diana_loo}
NE_diana <- matrix(NA, ncol = 32) 
SE_diana <- matrix(NA, ncol = 32) 
  
for (j in 1:19) {
  NEtest_matrix <- scale(resp_matrix[-c(j) ,1:32], center = TRUE, scale = FALSE)
  SEtest_matrix <- scale(resp_matrix[-c(j) ,33:64], center = TRUE, scale = FALSE)

  NE_test <- dist(t(NEtest_matrix), method = "manhattan")
  SE_test <- dist(t(SEtest_matrix), method = "manhattan")
  
  NEyear_div <- diana(t(NEtest_matrix),  metric = "manhattan")
  SEyear_div <- diana(t(SEtest_matrix),  metric = "manhattan")
  
  NEcut_div <- cutree(NEyear_div, k = 2)
  SEcut_div <- cutree(SEyear_div, k = 2)
  
  NE_diana <- rbind(NE_diana, NEcut_div)
  SE_diana <- rbind(SE_diana, SEcut_div)
}

NE_diana <- NE_diana[-1, ]
SE_diana <- SE_diana[-1, ]

NE_means <- colMeans(NE_diana)
SE_means <- colMeans(SE_diana)


plot(1:32, NE_means, pch = 16, ylim = c(0,3), main = "NE Aus - LOO Diana Cluster")
abline(h = c(1,2), lty =2)


plot(1:32, SE_means, pch = 16, ylim = c(0,3), main = "SE Aus - LOO Diana Cluster")
abline(h = c(1,2), lty =2)
```

```{r agg_loo}
#agg chron FALSE
#using Manhattan/ward.D (based on agg coefs)

NE_agg <- matrix(NA, ncol = 32) 
SE_agg <- matrix(NA, ncol = 32) 

NE_agg2 <- matrix(NA, ncol = 32) 
SE_agg2 <- matrix(NA, ncol = 32) 
  
for (j in 1:19) {
  NEtest_matrix <- scale(resp_matrix[-c(j) ,1:32], center = TRUE, scale = FALSE)
  SEtest_matrix <- scale(resp_matrix[-c(j) ,33:64], center = TRUE, scale = FALSE)

  NE_test <- dist(t(NEtest_matrix), method = "manhattan")
  SE_test <- dist(t(SEtest_matrix), method = "manhattan")

  NEhc_agg <- constr.hclust(NE_test, method ="ward.D", chron = FALSE)
  SEhc_agg <- constr.hclust(SE_test, method ="ward.D", chron = FALSE)
  
  NEhc_agg2 <- constr.hclust(NE_test, method ="ward.D", week_neighbor, hc_coord)
  SEhc_agg2 <- constr.hclust(SE_test, method ="ward.D", week_neighbor, hc_coord)
  
  NEcut_agg <- cutree(NEhc_agg, k = 2)
  SEcut_agg <- cutree(SEhc_agg, k = 3)
  
  NEcut_agg2 <- cutree(NEhc_agg2, k = 2)
  SEcut_agg2 <- cutree(SEhc_agg2, k = 3)
  
  NE_agg <- rbind(NE_agg, NEcut_agg)
  SE_agg <- rbind(SE_agg, SEcut_agg)
  
  NE_agg2 <- rbind(NE_agg2, NEcut_agg2)
  SE_agg2 <- rbind(SE_agg2, SEcut_agg2)
}

NE_agg <- NE_agg[-1, ]
SE_agg <- SE_agg[-1, ]

NE_agg2 <- NE_agg2[-1, ]
SE_agg2 <- SE_agg2[-1, ]

NE_agg[16,]
NE_agg2[16,]

SE_agg[19,]
SE_agg2[19,]

plot(1:32, SE_agg[19,])

NEagg_means <- colMeans(NE_agg)
SEagg_means <- colMeans(SE_agg)

NEagg2_means <- colMeans(NE_agg2)
SEagg2_means <- colMeans(SE_agg2)

set.panel(1,2)
plot(1:32, NEagg_means, pch = 16, ylim = c(0,3), main = "NE Aus - LOO Agg Cluster")
abline(h = c(1,2), lty =2)
points(1:32, NEagg2_means, pch = 16, col = "red3")

plot(1:32, NE_means, pch = 16, ylim = c(0,3), main = "NE Aus - LOO Diana Cluster")
abline(h = c(1,2), lty =2)


set.panel(1,2)
plot(1:32, SEagg_means, pch = 16, ylim = c(0,3), main = "SE Aus - LOO Agg Cluster")
abline(h = c(1,2), lty =2)
points(1:32, SEagg2_means, pch = 16, col = "red3")

plot(1:32, SE_means, pch = 16, ylim = c(0,3), main = "SE Aus - LOO Diana Cluster")
abline(h = c(1,2), lty =2)
```


```{r full_loo_compare}
NE_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SE_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)

NE_test <- dist(t(NE_matrix), method = "manhattan")
SE_test <- dist(t(SE_matrix), method = "manhattan")

NEyear_div <- diana(t(NEtest_matrix),  metric = "manhattan")
SEyear_div <- diana(t(SEtest_matrix),  metric = "manhattan")
  
NEcut_div <- cutree(NEyear_div, k = 2)
SEcut_div <- cutree(SEyear_div, k = 2)

NEhc_agg <- constr.hclust(NE_test, method ="ward.D", chron = FALSE)
SEhc_agg <- constr.hclust(SE_test, method ="ward.D", chron = FALSE)

NEhc_agg2 <- constr.hclust(NE_test, method ="ward.D", week_neighbor, hc_coord)
SEhc_agg2 <- constr.hclust(SE_test, method ="ward.D", week_neighbor, hc_coord)

NEhc_agg3 <- constr.hclust(NE_test, method ="ward.D", chron = TRUE)
SEhc_agg3 <- constr.hclust(SE_test, method ="ward.D", chron = TRUE)

NEcut_agg <- cutree(NEhc_agg, k = 2)
SEcut_agg <- cutree(SEhc_agg, k = 2)

NEcut_agg2 <- cutree(NEhc_agg2, k = 2)
SEcut_agg2 <- cutree(SEhc_agg2, k = 2)

NEcut_agg3 <- cutree(NEhc_agg3, k = 2)
SEcut_agg3 <- cutree(SEhc_agg3, k = 2)

plot(1:32, SEcut_agg3)

set.panel(2,2)
plot(1:32, NEcut_agg, pch = 16, ylim = c(0,3), main = "NE Aus - Base Agg Cluster")
abline(h = c(1,2), lty =2)
points(1:32, NEcut_agg2, pch = 16, col = "red3")

plot(1:32, NEcut_div, pch = 16, ylim = c(0,3), main = "NE Aus - Base Diana Cluster")
abline(h = c(1,2), lty =2)

plot(1:32, NEagg_means, pch = 16, ylim = c(0,3), main = "NE Aus - LOO Agg Cluster")
abline(h = c(1,2), lty =2)
points(1:32, NEagg2_means, pch = 16, col = "red3")

plot(1:32, NE_means, pch = 16, ylim = c(0,3), main = "NE Aus - LOO Diana Cluster")
abline(h = c(1,2), lty =2)



set.panel(2,2)
plot(1:32, SEcut_agg, pch = 16, ylim = c(0,3), main = "SE Aus - Base Agg Cluster")
abline(h = c(1,2), lty =2)
points(1:32, SEcut_agg2, pch = 16, col = "red3")

plot(1:32, SEcut_div, pch = 16, ylim = c(0,3), main = "SE Aus - Base Diana Cluster")
abline(h = c(1,2), lty =2)

plot(1:32, SEagg_means, pch = 16, ylim = c(0,3), main = "SE Aus - LOO Agg Cluster")
abline(h = c(1,2), lty =2)
points(1:32, SEagg2_means, pch = 16, col = "red3")

plot(1:32, SE_means, pch = 16, ylim = c(0,3), main = "SE Aus - LOO Diana Cluster")
abline(h = c(1,2), lty =2)

```


```{r compare_sil}
#TODO: relable the xlab so that it gives the weeks and not index
NEdiv_sil <- silhouette(NEcut_div, NE_test)
fviz_silhouette(NEdiv_sil, label = TRUE, print.summary = FALSE)

SEdiv_sil <- silhouette(SEcut_div, SE_test)
fviz_silhouette(SEdiv_sil, label = TRUE, print.summary = FALSE)


NEagg_sil <- silhouette(NEcut_agg, NE_test)
fviz_silhouette(NEagg_sil, label = TRUE, print.summary = FALSE)

SEcut_agg <- cutree(SEhc_agg, k = 3)

SEagg_sil <- silhouette(SEcut_agg, SE_test)
fviz_silhouette(SEagg_sil, label = TRUE, print.summary = FALSE)

#Optimal 2 clusters is here
NEcut_agg2 <- cutree(NEhc_agg2, k = 2)

NEagg2_sil <- silhouette(NEcut_agg2, NE_test)
fviz_silhouette(NEagg2_sil, label = TRUE, print.summary = FALSE)

SEcut_agg2 <- cutree(SEhc_agg2, k = 3) #k=3 is better than 2 (run this if we have time)

SEagg2_sil <- silhouette(SEcut_agg2, SE_test)
fviz_silhouette(SEagg2_sil, label = TRUE, print.summary = FALSE)

#old version of time constrained
NEcut_agg3 <- cutree(NEhc_agg3, k = 4)

NEagg3_sil <- silhouette(NEcut_agg3, NE_test)
fviz_silhouette(NEagg3_sil, label = TRUE, print.summary = FALSE)

SEcut_agg3 <- cutree(SEhc_agg3, k = 4)

SEagg3_sil <- silhouette(SEcut_agg3, SE_test)
fviz_silhouette(SEagg3_sil, label = TRUE, print.summary = FALSE)

```

```{r}
#TODO: adjust ordering so that it kinda makes sense
stats:::plot.hclust(NEhc_agg2, hang = -1, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "NE Aus : ")
rect.hclust(NEhc_agg2, k = 2, border = 2:3)

stats:::plot.hclust(SEhc_agg2, hang = -1, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "SE Aus : ")
rect.hclust(SEhc_agg2, k = 2, border = 2:4)
```


```{r}

#using default values 
NEconst_clust <- constr.hclust(dist(t(NEbase_matrix)), chron = FALSE) #default with ward.d2 method
SEconst_clust <- constr.hclust(dist(t(SEbase_matrix)), chron = FALSE) #default with ward.d2 method

cutree(NEconst_clust, k =2)
cutree(SEconst_clust, k =2)
#SEconst_clust$order <- 1:32
#NEconst_clust$order <- 1:32

stats:::plot.hclust(NEconst_clust, hang = -1, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "NE Aus : Response Clustering")

stats:::plot.hclust(NEconst_clust, hang = -1, labels = FALSE, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "NE Aus : Response Clustering", axes = FALSE, cex.main = 2.0,
                    cex.lab = 1.5)
axis(2)
axis(1, at = 1:32, labels = c(season_weeks[1:32]), 
     las = 3, gap.axis = 0, tck = 0.5, lty = 0, cex.axis = 1.6)


stats:::plot.hclust(SEconst_clust, hang = -1, labels = FALSE, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "SE Aus : Response Clustering", axes = FALSE, cex.main = 2.0,
                    cex.lab = 1.5)
axis(2)
axis(1, at = 1:32, labels = c(season_weeks[1:32]), 
     las = 3, gap.axis = 0, tck = 0.5, lty = 0, cex.axis = 1.6)

```


```{r}
#try pam from cluster
test_pam <- pam(t(SEbase_matrix), k =3, diss = TRUE)
clusplot(t(SEbase_matrix), test_pam$clustering, labels = 3)

summary(test_pam)
```



```{r test_fpd}
suppressMessages( library(FPDclustering))

temp_pdc <- PDC(data = t(NEbase_matrix), k = 2)
summary(temp_pdc)
temp_pdc$centers
temp_pdc$probability

temp_pdc$label

plot(temp_pdc)
```



