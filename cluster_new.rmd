---
title: "cluster_new"
author: "Ryan Peterson"
date: "2025-04-25"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r library}
#libraries
suppressMessages(library(adespatial)) #for constr.hclust
suppressMessages( library(cluster)) #for general cluster/diana
suppressMessages(library(dendextend)) 
suppressMessages( library(factoextra))

suppressMessages(library(scales))
```

```{r data_import}
# data and functions
setwd("~/CO_AUS/Aus_CO-main/Interactions")

load( "Data/ne_data.rda")
load( "Data/se_data.rda")
load( "Data/bounded_data.rda")
load( "Data/data_matrix.rda")
load( "Data/lag_list.rda")

```

```{r setup}
season_weeks <- c(35:52, 1:14)
season_years <- unique(bounded_resp_df$year)

seasons <- c()
for (i in 1:(length(season_years)-1)) {
  temp_season <- paste0(season_years[i], "-", season_years[i+1])
  #print(temp_season)  
  seasons <- c(seasons, temp_season)
}
rm(i, temp_season)

#center response data
NEbase_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEbase_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)
```


# All Years Clustering

```{r baseline_cluster}
#using default values 
NEconst_clust <- constr.hclust(dist(t(NEbase_matrix)), chron = TRUE) #default with ward.d2 method
SEconst_clust <- constr.hclust(dist(t(SEbase_matrix)), chron = TRUE) #default with ward.d2 method

cutree(NEconst_clust, k =2)
cutree(SEconst_clust, k =2)

SEconst_clust$order <- 1:32
NEconst_clust$order <- 1:32

stats:::plot.hclust(NEconst_clust, hang = -1, labels = FALSE, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "NE Aus : Response Clustering", axes = FALSE, cex.main = 2.0,
                    cex.lab = 1.5)
axis(2)
axis(1, at = 1:32, labels = c(season_weeks[1:32]), 
     las = 3, gap.axis = 0, tck = 0.5, lty = 0, cex.axis = 1.6)


stats:::plot.hclust(SEconst_clust, hang = -1, labels = FALSE, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "SE Aus : Response Clustering", axes = FALSE, cex.main = 2.0,
                    cex.lab = 1.5)
axis(2)
axis(1, at = 1:32, labels = c(season_weeks[1:32]), 
     las = 3, gap.axis = 0, tck = 0.5, lty = 0, cex.axis = 1.6)

#TODO: change from manual to something else later
NE_splits <- list(c(46,47))
SE_splits <- list(c(50,51))
```


```{r function}

#we can replace this with dendlist()

cluster_matrix <- function(NEbase_matrix, SEbase_matrix, temporal = TRUE){

  NEclust_matrix <- matrix(NA, ncol = 32)
  SEclust_matrix <- matrix(NA, ncol = 32)
  
  NE_clust <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal) #default with ward.d2 method
  SE_clust <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal) #default with ward.d2 method
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust, k =2))
  
  #ward.D
  NE_clust1 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "ward.D") # ward.D method
  SE_clust1 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "ward.D") # ward.D method
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust1, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust1, k =2))
  
  #single linkage
  NE_clust2 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "single")
  SE_clust2 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "single") 
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust2, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust2, k =2))
  
  #complete linkage
  NE_clust3 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "complete") 
  SE_clust3 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "complete")
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust3, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust3, k =2))
  
  #flexible w/  beta = -0.25
  NE_clust4 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "flexible", beta = -0.5) 
  SE_clust4 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "flexible", beta = -0.5) 
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust4, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust4, k =2))
  
  #"average" (UPGMA)
  NE_clust5 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "average")
  SE_clust5 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "average")
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust5, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust5, k =2))
  
  #"mcquitty" (WPGMA)
  NE_clust6 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "mcquitty")
  SE_clust6 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "mcquitty")
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust6, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust6, k =2))
  
  #"centroid" (UPGMC)a
  NE_clust7 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "centroid")
  SE_clust7 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "centroid")
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust7, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust7, k =2))
  
  #"median" (WPGMC)
  NE_clust8 <- constr.hclust(dist(t(NEbase_matrix)), chron = temporal, method = "median")
  SE_clust8 <- constr.hclust(dist(t(SEbase_matrix)), chron = temporal, method = "median")
  
  NEclust_matrix <- rbind(NEclust_matrix, cutree(NE_clust8, k =2))
  SEclust_matrix <- rbind(SEclust_matrix, cutree(SE_clust8, k =2))
  
  method_names <- c("ward.d2", "ward.D", "single", "complete", "flexible", 
                    "average", "mcquitty", "centroid", "median")
  
  NEclust_matrix <- NEclust_matrix[-1, ]
  SEclust_matrix <- SEclust_matrix[-1, ]
  
  rownames(NEclust_matrix) <- method_names
  rownames(SEclust_matrix) <- method_names

  return(list(NEclust_matrix, SEclust_matrix))
}
```


```{r}
full_cluster <- cluster_matrix(NEbase_matrix, SEbase_matrix, temporal = TRUE)

NEcluster_list <- list()
SEcluster_list <- list()
for (j in 1:19) {
  NEmatrix_new <- scale(resp_matrix[-c(j), 1:32], center = TRUE, scale = FALSE)
  SEmatrix_new <- scale(resp_matrix[-c(j), 33:64], center = TRUE, scale = FALSE)
  
  part_cluster <- cluster_matrix(NEmatrix_new, SEmatrix_new, temporal = FALSE)
  
  NEcluster_list[[paste0("without:", seasons[j])]] <- part_cluster[[1]]
  SEcluster_list[[paste0("without:", seasons[j])]] <- part_cluster[[2]]
}



#cluster_matrix(NEbase_matrix, SEbase_matrix, temporal = FALSE)
```

```{r}
Reduce("+", NEcluster_list) / length(NEcluster_list)

Reduce("+", SEcluster_list) / length(SEcluster_list)
```


Repeat all of this with the dendextend package 

# Agg/Time Analysis

```{r}
hclust_methods <- c("ward.D", "single", "complete", "average", "mcquitty", 
        "median", "centroid", "ward.D2")

NE_dendlist <- dendlist()
SE_dendlist <- dendlist()

for(i in seq_along(hclust_methods)) {
   hc_NEAus <- constr.hclust(dist(t(NEbase_matrix)), method = hclust_methods[i],  chron = TRUE)
   hc_SEAus <- constr.hclust(dist(t(SEbase_matrix)), method = hclust_methods[i],  chron = TRUE)
   
   NE_dendlist <- dendlist(NE_dendlist, as.dendrogram(hc_NEAus))
   SE_dendlist <- dendlist(SE_dendlist, as.dendrogram(hc_SEAus))
}

names(NE_dendlist) <- hclust_methods
names(SE_dendlist) <- hclust_methods

NE_dendlist
SE_dendlist
```

```{r}
NE_dendlist_cor <- cor.dendlist(NE_dendlist)

corrplot::corrplot(NE_dendlist_cor, "pie", "lower")
```

```{r}
NE_dendlist %>% dendlist(which = c(2,7)) %>% ladderize %>% 
   set("branches_k_color", k=2) %>% 
   # untangle(method = "step1side", k_seq = 3:20) %>%
   tanglegram(faster = TRUE)
```


```{r}
get_ordered_2_clusters <- function(dend) {
   cutree(dend, k = 2)[order.dendrogram(dend)]
}

compare_clusters_to <- function(clus) {FM_index(clus, rep(1:2, each = 16), assume_sorted_vectors = TRUE)}

dend_2_clusters <- lapply(NE_dendlist, get_ordered_2_clusters)

clusters_performance <- sapply(dend_2_clusters, compare_clusters_to)
clusters_performance
dotchart(sort(clusters_performance), xlim = c(0.6, 1),
         xlab = "Fowlkes-Mallows Index (from 0 to 1)",
         main = "Perormance of clustering algorithms \n in detecting the 2 species",
         pch = 19)

dend_2_clusters <- lapply(SE_dendlist, get_ordered_2_clusters)

clusters_performance <- sapply(dend_2_clusters, compare_clusters_to)
clusters_performance
dotchart(sort(clusters_performance), xlim = c(0.6, 1),
         xlab = "Fowlkes-Mallows Index (from 0 to 1)",
         main = "Perormance of clustering algorithms \n in detecting the 2 species",
         pch = 19)

```

```{r}
cutree(NE_dendlist$complete, k = 2)
cutree(SE_dendlist$complete, k = 2)
```

## Train/Test 2019

TODO: build in hclust with chron = TRUE, then do some work to comparison between methods.

```{r}
#train data
NEtrain_matrix <- scale(resp_matrix[-c(16:19) ,1:32], center = TRUE, scale = FALSE)
SEtrain_matrix <- scale(resp_matrix[-c(16:19) ,33:64], center = TRUE, scale = FALSE)

#test data
NEtest_matrix <- scale(resp_matrix[16:19 ,1:32], center = TRUE, scale = FALSE)
SEtest_matrix <- scale(resp_matrix[16:19 ,33:64], center = TRUE, scale = FALSE)

NE_train <- dist(t(NEtrain_matrix))
SE_train <- dist(t(SEtrain_matrix))

NE_test <- dist(t(NEtest_matrix))
SE_test <- dist(t(SEtest_matrix))


hclust_methods <- c("ward.D", "single", "complete", "average", "mcquitty", 
        "median", "centroid", "ward.D2")

i <- 2
NEhc_train <- constr.hclust(NE_train, method = hclust_methods[i],  chron = FALSE)
NEhc_test  <- constr.hclust(NE_test, method = hclust_methods[i],  chron = FALSE)

NEd_train <- as.dendrogram(NEhc_train)
NEd_test <-  as.dendrogram(NEhc_test)
NEd_train_test <- dendlist(train = NEd_train, test = NEd_test)

SEhc_train <- constr.hclust(SE_train, method = hclust_methods[i],  chron = FALSE)
SEhc_test  <- constr.hclust(SE_test, method = hclust_methods[i],  chron = FALSE)

SEd_train <- as.dendrogram(SEhc_train)
SEd_test <- as.dendrogram(SEhc_test)
SEd_train_test <- dendlist(train = SEd_train, test = SEd_test)
```

```{r}
Bk_plot(NEd_test, NEd_train, k = 2:16, xlim = c(2,16))
Bk_plot(SEd_test, SEd_train, k = 2:16, xlim = c(2,16))
```

```{r}
pre_tang_d_train_test <- SEd_train_test %>% ladderize %>% # untangle %>%
   set("branches_k_color", k = 7)
train_branches_colors <- get_leaves_branches_col(pre_tang_d_train_test$train)
pre_tang_d_train_test %>% tanglegram(fast = TRUE, color_lines = train_branches_colors)
```



```{r}
#center response data
NEbase_matrix <- scale(resp_matrix[-c(17) ,1:32], center = TRUE, scale = FALSE)
SEbase_matrix <- scale(resp_matrix[-c(17) ,33:64], center = TRUE, scale = FALSE)

hclust_methods <- c("ward.D", "single", "complete", "average", "mcquitty", 
        "median", "centroid", "ward.D2")

NE_dendlist <- dendlist()
SE_dendlist <- dendlist()

for(i in seq_along(hclust_methods)) {
   hc_NEAus <- constr.hclust(dist(t(NEbase_matrix)), method = hclust_methods[i],  chron = FALSE)
   hc_SEAus <- constr.hclust(dist(t(SEbase_matrix)), method = hclust_methods[i],  chron = FALSE)
   
   NE_dendlist <- dendlist(NE_dendlist, as.dendrogram(hc_NEAus))
   SE_dendlist <- dendlist(SE_dendlist, as.dendrogram(hc_SEAus))
}

names(NE_dendlist) <- hclust_methods
names(SE_dendlist) <- hclust_methods

get_ordered_2_clusters <- function(dend) {
   cutree(dend, k = 2)[order.dendrogram(dend)]
}

compare_clusters_to <- function(clus) {FM_index(clus, rep(1:2, each = 16), assume_sorted_vectors = TRUE)}

dend_2_clusters <- lapply(NE_dendlist, get_ordered_2_clusters)

clusters_performance <- sapply(dend_2_clusters, compare_clusters_to)
which.max( clusters_performance)
dotchart(sort(clusters_performance), xlim = c(0.6, 1),
         xlab = "Fowlkes-Mallows Index (from 0 to 1)",
         main = "Perormance of clustering algorithms \n in detecting the 2 species",
         pch = 19)

dend_2_clusters <- lapply(SE_dendlist, get_ordered_2_clusters)

clusters_performance <- sapply(dend_2_clusters, compare_clusters_to)
which.max( clusters_performance)
dotchart(sort(clusters_performance), xlim = c(0.6, 1),
         xlab = "Fowlkes-Mallows Index (from 0 to 1)",
         main = "Perormance of clustering algorithms \n in detecting the 2 species",
         pch = 19)
```




```{r diana}
#top-down clustering
NEyear_div <- diana(NEbase_matrix,  metric = "manhattan")
plot(NEyear_div)
SEyear_div <- diana(SEbase_matrix,  metric = "manhattan")
plot(SEyear_div)


NEweek_div <- diana(t(NEbase_matrix))
plot(NEweek_div, adj = 0)

SEweek_div <- diana(t(SEbase_matrix))
plot(SEweek_div)

NEweek_agg <- agnes(t(NEbase_matrix))
plot(NEweek_agg)

SEweek_agg <- agnes(t(SEbase_matrix))
plot(SEweek_agg)

summary(SEweek_agg)

clusplot(t(SEbase_matrix), )
```

```{r}
NEtest_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEtest_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)

NE_test <- dist(t(NEtest_matrix))
SE_test <- dist(t(SEtest_matrix))


hclust_methods <- c("ward.D", "single", "complete", "average", "mcquitty", 
        "median", "centroid", "ward.D2")

i <- 1
NEhc <- constr.hclust(NE_test, method = hclust_methods[i],  chron = TRUE)
coefHier(NEhc)

fviz_nbclust(t(NEtest_matrix), FUN = hcut, method = "wss")
fviz_nbclust(t(SEtest_matrix), FUN = hcut, method = "wss")


#note use this
fviz_nbclust(t(NEtest_matrix), FUN = hcut, method = "gap_stat")
fviz_nbclust(t(SEtest_matrix), FUN = hcut, method = "gap_stat")

dend_plot <- fviz_dend(NEhc)
dend_data <- attr(dend_plot, "dendrogram")
```

```{r method_checks}
NEtest_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEtest_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)

NE_test <- dist(t(NEtest_matrix), method = "manhattan")
SE_test <- dist(t(SEtest_matrix), method = "manhattan")

hclust_methods <- c("ward.D", "single", "complete", "average")

i <- 1
NEhc1 <- constr.hclust(NE_test, method = hclust_methods[i],  chron = FALSE)
SEhc1 <- constr.hclust(SE_test, method = hclust_methods[i],  chron = FALSE)

cutree(NEhc1, k =2)
cutree(SEhc1, k =2)

#TODO: when chron false include a circular plot with ordered hclust
#NEhc1$order <- 1:32
#SEhc1$order <- 1:32

stats:::plot.hclust(NEhc1,  bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "NE Aus : ward.D")
rect.hclust(NEhc1, k = 2, border = 2:3)

stats:::plot.hclust(SEhc1, hang = -1, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "SE Aus : ward.D")
rect.hclust(SEhc1, k = 2, border = 2:3)
```

```{r}
dend_plot <- fviz_dend(NEhc1)                # create full dendogram
dend_data <- attr(dend_plot, "dendrogram") # extract plot info
dend_cuts <- cut(dend_data, h = 400) 

fviz_dend(dend_cuts$lower[[1]], type = 'circular')
```


```{r agg_coeffs}
#agglomerative coefs to compare methods



```



```{r}

#using default values 
NEconst_clust <- constr.hclust(dist(t(NEbase_matrix)), chron = FALSE) #default with ward.d2 method
SEconst_clust <- constr.hclust(dist(t(SEbase_matrix)), chron = FALSE) #default with ward.d2 method

cutree(NEconst_clust, k =2)
cutree(SEconst_clust, k =2)
#SEconst_clust$order <- 1:32
#NEconst_clust$order <- 1:32

stats:::plot.hclust(NEconst_clust, hang = -1, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "NE Aus : Response Clustering")

stats:::plot.hclust(NEconst_clust, hang = -1, labels = FALSE, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "NE Aus : Response Clustering", axes = FALSE, cex.main = 2.0,
                    cex.lab = 1.5)
axis(2)
axis(1, at = 1:32, labels = c(season_weeks[1:32]), 
     las = 3, gap.axis = 0, tck = 0.5, lty = 0, cex.axis = 1.6)


stats:::plot.hclust(SEconst_clust, hang = -1, labels = FALSE, bty = "n", sub = "", ylab = "",
                    xlab = "Week", main = "SE Aus : Response Clustering", axes = FALSE, cex.main = 2.0,
                    cex.lab = 1.5)
axis(2)
axis(1, at = 1:32, labels = c(season_weeks[1:32]), 
     las = 3, gap.axis = 0, tck = 0.5, lty = 0, cex.axis = 1.6)

```


```{r}
#try pam from cluster
test_pam <- pam(t(SEbase_matrix), k =3, diss = TRUE)
clusplot(t(SEbase_matrix), test_pam$clustering, labels = 3)

summary(test_pam)
```



```{r test_fpd}
suppressMessages( library(FPDclustering))

temp_pdc <- PDC(data = t(NEbase_matrix), k = 2)
summary(temp_pdc)
temp_pdc$centers
temp_pdc$probability

temp_pdc$label

plot(temp_pdc)
```



