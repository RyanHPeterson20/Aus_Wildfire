---
title: "EIO_index"
author: "Ryan Peterson"
date: "2025-09-05"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
#.nc files
suppressMessages(library(ncdf4))
suppressMessages(library(terra))

# date/data mgmt
suppressMessages(library(lubridate))
suppressMessages(library(abind))

#visualization and interpolation
suppressMessages(library(fields))
suppressMessages(library(colorspace))
suppressMessages(library(RColorBrewer)) #colorRampPalette
suppressMessages(library(scales)) #for adjusting opacity

#matlab function (e.g. detrend)
suppressMessages(library(pracma))
```

```{r functions_data}
setwd("~/CO_AUS/Aus_CO-main/pIOD")

source("pIOD_functions.R") #sst.anom and eof functions

#load in preped data products
load("sstGODAS.rda")
load("sstOISST.rda")
load("sstORAS.rda")
load("sstSODA.rda")
```

```{r setup}
#indian ocean region
wide_maxLon <- 120
wide_minLon <- 30
wide_maxLat <- 20
wide_minLat <- -20

#pIOD (40, -5) X (100, 5), EIO region
pIOD_maxLon <- 100
pIOD_minLon <- 40 
pIOD_maxLat <- 5
pIOD_minLat <- -5

#indian ocean grid
lon.wide <- seq(wide_minLon, wide_maxLon, by = 1)
lat.wide <- seq(wide_minLat, wide_maxLat, by = 1)

#grid list from 
grid.list <- list(x = lon.wide,
                  y = lat.wide)

#define pIOD range


```


Let's try this again for the nth time, reproducing results from Cai et al (2021) and Wang et al (2025).

Our aim is to *exactly* reproduce the S- and M-indices that describe positive IOD events in the Equatorial Indian Ocean (EIO).

Outline/Notes:
1. Get SST anomalies for each data product
  a. Get full-period mean and de-meaned anomally
    i. Visualization of spatial means 
  b. Detrend anomalies (w/ linear fit)
    i. 
  c. Seasonal Average
    i. SON (Sept, Oct, Nov)
  d. Alternative SST Anomalies (from previous work that has been very close in the past)
2. Multi-Product Average
  a. Interpolate to grid
    i. Visualization - SON SST Anom for each data product
  b. Product Average
    i. Visualization - SON SST Anom by year (focus on pIOD years)

TODO:
-Double check the godas data from previous files for lat flips

# SST Anomalies 

```{r functions}
#pass in sst.A as [nx, ny, nt]
sst.fullperiod <- function(sst.A){
  sst.A <- aperm(sst.A, c(3,2,1)) #arrange as [nt, ny, nx]

  dim.sst <- dim(sst.A)
  nt <- dim.sst[1]
  ny <- dim.sst[2]
  nx <- dim.sst[3]
  
  sst.mat <- matrix(sst.A, nrow = ny * nx, ncol = nt, byrow = TRUE)
  
  sst.means <- rowMeans(sst.mat)
  sst.anoms <- sweep(sst.mat, 1, rowMeans(sst.mat), "-")
  
  #convert back to [nx, ny]
  out.mean <- matrix(sst.means, nrow = nx, ncol = ny, byrow = TRUE)
  
  #convert back to [nx, ny, nt]
  temp.anom <- array(sst.anoms, dim = c(ny, nx, nt))
  out.anom <- aperm(temp.anom, c(2,1,3))
  
  return(list(mean = out.mean,
              anom = out.anom))
  
}


sst.detrend <- function(sst.anom1, quadratic = FALSE){
  
  sst.anom1 <- aperm(sst.anom1, c(3,2,1)) # as [nt, ny, nx]
  dim.anom <- dim(sst.anom1)
  
  nx <- dim.anom[3]
  ny <- dim.anom[2]
  nt <- dim.anom[1]
  
  anom.mat <- matrix(sst.anom1, nrow = ny * nx, ncol = nt, byrow = TRUE)
  
  test.na <- which(!is.na(anom.mat), arr.ind = TRUE) 
  true.index <- unique(test.na[,1]) #select rows (locations) without NA
  
  
  anom.x <- seq_len(nt) #time "covariates"
  anom.y <- t(anom.mat[true.index, ])
  
  anom.resid <- matrix(NA, nrow = nt, ncol = ny*nx)
  if (quadratic) {
    anom.fit <- lm(anom.y ~ anom.x + I(anom.x^2))
    anom.coef <- matrix(NA, nrow = 3, ncol = ny*nx)
  } else {
    anom.fit <- lm(anom.y ~ anom.x)
    anom.coef <- matrix(NA, nrow = 2, ncol = ny*nx)
  }
  
  anom.coef[,true.index] <- anom.fit$coefficients
  anom.resid[,true.index] <- anom.fit$residuals
  
  temp.coef <- array(anom.coef, dim = c(nrow(anom.coef), ny, nx))
  out.coef <- aperm(temp.coef, c(3,2,1))
  
  temp.resid <- array(anom.resid, dim = c(nt, ny, nx))
  out.resid <- aperm(temp.resid, c(3,2,1))
  
  return(list(coefs = out.coef,
              resid = out.resid))
}

son.avg <- function(sst.anom2){
  
  sst.anom2 <- aperm(sst.anom2, c(3, 2, 1))  # reorder data as [nt, ny, nx]
  dim.anom <- dim(sst.anom2)
  
  nx <- dim.anom[3]
  ny <- dim.anom[2]
  nt <- dim.anom[1]
  
  nyears <- nt %/% 12
  #reshape data array
  sst.temp <- array(sst.anom2, dim = c(12, nyears, ny, nx))
  sst.son <- apply(sst.temp[9:11, , , ], c(2,3,4), mean, na.rm = TRUE) #already at correct subset
  
  out.son <- aperm(sst.son, c(3,2,1))
  return(out.son)
}

```

## Full-Period Mean

```{r mean_base}
#determining anomalies from cai et al code
sst.GODAS.new2 <- sst.GODAS.new2[ ,dim(sst.GODAS.new2)[2]:1, ] #flip lat for godas data set

#dim checks
dim(sst.GODAS.new2)
dim(sst.ORAS.new3)
dim(sst.OISST.new2)
dim(sst.SODA.new2)

temp.godas.out <- sst.fullperiod(sst.GODAS.new2)
sst.godas.mean <- temp.godas.out$mean
sst.godas.anom <- temp.godas.out$anom

temp.oras.out <- sst.fullperiod(sst.ORAS.new3)
sst.oras.mean <- temp.oras.out$mean
sst.oras.anom <- temp.oras.out$anom

temp.oisst.out <- sst.fullperiod(sst.OISST.new2)
sst.oisst.mean <- temp.oisst.out$mean
sst.oisst.anom <- temp.oisst.out$anom

temp.soda.out <- sst.fullperiod(sst.SODA.new2)
sst.soda.mean <- temp.soda.out$mean
sst.soda.anom <- temp.soda.out$anom

rm(temp.godas.out, temp.oras.out, temp.oisst.out, temp.soda.out)

```

### Visualization - Spatial Means

(TODO: get full mean field, and change between times)

```{r means_fig}

#TODO: update with better figures after we finalize

imagePlot(list(x = GODAS.lon, y = rev(GODAS.lat), z = sst.godas.mean),
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: Mean 1982-2015", adj = 0)
world(add = TRUE)


```

## Linear Fit and De-trend

```{r detrend}
temp.godas.out <- sst.detrend(sst.godas.anom)
sst.godas.coef <- temp.godas.out$coefs
sst.godas.resid <- temp.godas.out$resid

temp.oras.out <- sst.detrend(sst.oras.anom)
sst.oras.coef <- temp.oras.out$coefs
sst.oras.resid <- temp.oras.out$resid

temp.oisst.out <- sst.detrend(sst.oisst.anom)
sst.oisst.coef <- temp.oisst.out$coefs
sst.oisst.resid <- temp.oisst.out$resid

temp.soda.out <- sst.detrend(sst.soda.anom)
sst.soda.coef <- temp.soda.out$coefs
sst.soda.resid <- temp.soda.out$resid

rm(temp.godas.out, temp.oras.out, temp.oisst.out, temp.soda.out)
```


### Visualization - SST Anoms (De-Trended)

```{r temp_viz}
imagePlot(list(x = GODAS.lon, y = rev(GODAS.lat), z = out.resid[,,11]),
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: SST Anom November 1982", adj = 0)
world(add = TRUE)
```


## Seasonal Averages

### SON Averages

```{r son_avg}

#get son averages for residual data
son.godas <- son.avg(sst.godas.resid)
son.oras <- son.avg(sst.oras.resid)
son.oisst <- son.avg(sst.oisst.resid)
son.soda <- son.avg(sst.soda.resid)

```

## Alternate SST Anomalies

```{r alt_sst_anoms}
#using sst.anoms() function
```



# Multi-Product Average

```{r functions}
sst.interp <- function(sst, sst.lon, sst.lat, grid.list){
  
  #get dime
  dim.sst <- dim(sst)
  
  nx <- dim.sst[1]
  ny <- dim.sst[2]
  nt <- dim.sst[3]
  
  #interpolate 
  sst.interp <- NULL
  for (j in seq_len(nt)) {
    sst.obj <-  list(x = sst.lon, y = sst.lat, z = sst[,,j])
  
    temp.interp <- interp.surface.grid(sst.obj, grid.list)
    sst.interp <- abind(sst.interp, temp.interp$z, along = 3)
  }
  
  return(sst.interp)
}
```

## Interpolat to Grid

```{r interpolation}
son.GODAS.interp <- sst.interp(son.godas, GODAS.lon, GODAS.lat, grid.list)
son.ORAS.interp <- sst.interp(son.oras, oras.lon, oras.lat, grid.list)
son.OISST.interp <- sst.interp(son.oisst, lon.values.base, lat.values.base, grid.list)
son.SODA.interp <- sst.interp(son.soda, lon.values.soda, lat.values.soda, grid.list)

#dim check
dim(son.GODAS.interp)
dim(son.ORAS.interp)
dim(son.OISST.interp)
dim(son.SODA.interp)

son.GODAS.interp <- son.GODAS.interp[,dim(son.GODAS.interp)[2]:1, ]

```

### Visualization - SON SST Anomalies

```{r Visualization}
#TODO: get unified ryb colors and range

imagePlot(list(x = lon.wide, y = lat.wide, z = son.GODAS.interp[,,1]),
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("GODAS: SON SST Anom 1982", adj = 0)
world(add = TRUE)

imagePlot(list(x = lon.wide, y = lat.wide, z = son.ORAS.interp[,,1]),
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("ORAS: SON SST Anom 1982", adj = 0)
world(add = TRUE)

imagePlot(list(x = lon.wide, y = lat.wide, z = son.OISST.interp[,,1]),
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("OISST: SON SST Anom 1982", adj = 0)
world(add = TRUE)

imagePlot(list(x = lon.wide, y = lat.wide, z = son.SODA.interp[,,1]),
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("SODA: SON SST Anom 1982", adj = 0)
world(add = TRUE)

```

## Product Avg

```{r son.sst.avg}
son.sst.anom <- (son.GODAS.interp + son.ORAS.interp + 
                   son.OISST.interp+ son.SODA.interp)/4
```

### Visualization

```{r col_range}
abs.max <- max(abs(son.sst.anom), na.rm = TRUE)
sst.range <- c(-abs.max, abs.max)
cols.ryb <- rev(colorRampPalette(brewer.pal(11, "RdYlBu"))(12))
breaks.sst <- c(sst.range[1], seq(-1,1, by = 0.2), sst.range[2])
```


```{r moderate}
imagePlot(list(x = lon.wide, y = lat.wide, z = son.sst.anom[,,1]),
          col = cols.ryb, breaks = breaks.sst, zlim =  sst.range,
          xlim = c(30, 120), ylim = c(-20,20),
          xlab = "Lon", ylab = "Lat")
title("1982: SST Anomalies", adj = 0)
world(add = TRUE)
```


