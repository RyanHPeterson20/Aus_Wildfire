---
title: "refit_test"
author: "Ryan Peterson"
date: "2025-04-17"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
#libraries
suppressMessages( library(hierNet)) 
suppressMessages(library(glmnet)) 
suppressMessages( library( lubridate))
suppressMessages(library(grid))

suppressMessages( library(scales)) #for adjusting opacity
```

```{r dat_functions}
# data and functions
setwd("~/CO_AUS/Aus_CO-main/Interactions")

load( "Data/ne_data.rda")
load( "Data/se_data.rda")
load( "Data/bounded_data.rda")
load( "Data/data_matrix.rda")
load( "Data/lag_list.rda")
load( "Data/data_quantile.rda")

#functions:
source("group_functions.R") #grouping/clustering
source("refit_functions.R") #coef/refit functions

```

File for exploring the different model fits and how they compare wrt 2019/2020 wildfire season.

(Add more notes here as we progress)

## Model Fits

1. Previous strong hierNet with indicator functions in main effects.
2. Strong hierNet without indicator functions (main/primary fit)
3. Strong hierNet without indicator function and 2019/2020 wildfire season.
4. Strong hierNet for main conditions but only 2 groups per region.

5. Elastic net fit from model 2 (main fit) with alpha (delta) at 0.10
6. Elastic net fit from model 2 (main fit) with alpha (delta) at 0.25


```{r model_fits}
setwd("~/CO_AUS/Aus_CO-main/Interactions")

#lasso fits
load( "full_strong.rda") #include indicator functions
output_ind <- output

load( "main_strong.rda") #full strong models #output models
output_main <- output

load( "base_strong.rda") #strong models without 2019/2020
output_base <- output

load( "group_strong.rda") #2 group strong models (only 2 groups per region)
output_group <- output

#elastic net fits
load("enet_strong.rda") #elastic net model with alpha = 0.10
output_enet <- output

load("enet25_strong.rda") #elastic net model with alpha = 0.25
output_enet25 <- output

rm(output)
```


```{r}
#season years/weeks
season_weeks <- c(35:52, 1:14)
season_years <- unique(bounded_resp_df$year)

seasons <- c()
for (i in 1:(length(season_years)-1)) {
  temp_season <- paste0(season_years[i], "-", season_years[i+1])
  #print(temp_season)  
  seasons <- c(seasons, temp_season)
}
rm(i, temp_season)

#center response data
NEbase_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEbase_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)

#group response matrices
#NEAus
NEAus_1 <- NEbase_matrix[ ,1:12] #early season
NEAus_2 <- NEbase_matrix[ ,13:17] #primary NE fire season
NEAus_3 <- NEbase_matrix[ ,18:21] #feedback from SE
NEAus_4 <- NEbase_matrix[ ,22:32] #late season

#SEAus
SEAus_1 <- SEbase_matrix[ ,1:7] #early season
SEAus_2 <- SEbase_matrix[ ,8:16] #feedback from NE
SEAus_3 <- SEbase_matrix[ ,17:20] #primary SE fire season
SEAus_4 <- SEbase_matrix[ ,21:32] #late season

NEAus_mat <- list(NEAus_1, NEAus_2, NEAus_3, NEAus_4)
SEAus_mat <- list(SEAus_1, SEAus_2, SEAus_3, SEAus_4)

rm(NEAus_1, NEAus_2, NEAus_3, NEAus_4, SEAus_1, SEAus_2, SEAus_3, SEAus_4)
```

```{r}
#full model data set-up
NE_preds <- NElag_grouping(NE_laglist = NE_laglist_std, j = 1:19)
NE_resp <- NEresp_grouping(NEAus_mat = NEAus_mat, j = 1:19)

SE_preds <- SElag_grouping(SE_laglist = SE_laglist_std, j = 1:19)
SE_resp <- SEresp_grouping(SEAus_mat = SEAus_mat, j = 1:19)

#quantile 75 indicator (if needed)
NE_preds_q75 <- NElag_grouping(NE_laglist = NE_laglist_q75, j = 1:19)
SE_preds_q75 <- SElag_grouping(SE_laglist = SE_laglist_q75, j = 1:19)
```


# Fit Analysis

## (Older Fits)

Main effect indicator function fit


## Main/Primary Fit

Strong hierNet as `baseline' for other models 

### Model Fits including 2019/2020

```{r NEAus}
#full model data set-up
NE_preds <- NElag_grouping(NE_laglist = NE_laglist_std, j = 1:19)
NE_resp <- NEresp_grouping(NEAus_mat = NEAus_mat, j = 1:19)
NE_preds_q75 <- NElag_grouping(NE_laglist = NE_laglist_q75, j = 1:19)

#NE Aus Group 1
NEAus1 <- output_main[[1]]

NEcoefs1 <- get_coefs(NEAus1$hierpath, max_index = 50, 
                      resp = NE_resp[[1]], preds = NE_preds[[1]], preds_quant = NE_preds_q75[[1]])

plot(NEAus1$hiercv)

NEcv1 <- NEAus1$hiercv
which(NEcv1$lamlist == NEcv1$lamhat.1se)
which(NEcv1$lamlist == NEcv1$lamhat)
NEcv1$lamhat.1se
1-NEcv1$cv.err/var( NE_resp[[1]])

#length(NEcoefs1[[3]][[1]]$Main_Effect)
#length(NEcoefs1[[3]][[2]]$Interact_Effect)

NErefit1 <- refit_bic(NEAus1$hierpath, max_index = 50, ebic.gamma = 0.25,
                      lambda.min = FALSE, AIC.c = FALSE,
                      resp = NE_resp[[1]], preds = NE_preds[[1]], 
                      preds_quant = NE_preds_q75[[1]])

NErefit1[[5]]

which.min(NErefit1[[5]][1:21, 2])
which.min(NErefit1[[5]][ , 6])

i <- 3
ridge_coef <- NErefit1[[4]][[i]][-1]
NEridge1_main <- ridge_coef
ridge_coef
length(ridge_coef)



#NE Aus Group 2
NEAus2 <- output_main[[2]]

NEcoefs2 <- get_coefs(NEAus2$hierpath, max_index = 50, 
                      resp = NE_resp[[2]], preds = NE_preds[[2]], preds_quant = NE_preds_q75[[2]])

plot(NEAus2$hiercv)

NEcv1 <- NEAus2$hiercv
which(NEcv1$lamlist == NEcv1$lamhat.1se)
which(NEcv1$lamlist == NEcv1$lamhat)
NEcv1$lamhat.1se
1-NEcv1$cv.err/var( NE_resp[[2]])


NErefit2 <- refit_bic(NEAus2$hierpath, max_index = 50, ebic.gamma = 0.25,
                      lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = NE_resp[[2]], preds = NE_preds[[2]], 
                      preds_quant = NE_preds_q75[[2]])

NErefit2[[5]]

which.min(NErefit2[[5]][ , 2])
which.min(NErefit2[[5]][ , 6])

i <- 18
ridge_coef <- NErefit2[[4]][[i]]
NEridge2_main <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(NErefit2[[1]][[i]]) #glm fit summary

NEcoefs2[[i]][[1]]$Main_Effect
NEcoefs2[[i]][[1]]$Coef

NEcoefs2[[i]][[2]]$Interact_Effect
NEcoefs2[[i]][[2]]$Coef


#NE Aus Group 3
NEAus3 <- output_main[[3]]

NEcoefs3 <- get_coefs(NEAus3$hierpath, max_index = 50, 
                      resp = NE_resp[[3]], preds = NE_preds[[3]], preds_quant = NE_preds_q75[[3]])

plot(NEAus3$hiercv)

NEcv1 <- NEAus3$hiercv
which(NEcv1$lamlist == NEcv1$lamhat.1se)
which(NEcv1$lamlist == NEcv1$lamhat)
NEcv1$lamhat.1se
1-NEcv1$cv.err/var( NE_resp[[3]])


NErefit3 <- refit_bic(NEAus3$hierpath, max_index = 50, ebic.gamma = 0.25,
                      lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = NE_resp[[3]], preds = NE_preds[[3]], 
                      preds_quant = NE_preds_q75[[3]])

NErefit3[[5]]

which.min(NErefit3[[5]][ , 2])
which.min(NErefit3[[5]][ , 6])

i <- 15
ridge_coef <- NErefit3[[4]][[i]]
NEridge3_main <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(NErefit3[[1]][[i]]) #glm fit summary

NEcoefs3[[i]][[1]]$Main_Effect
NEcoefs3[[i]][[1]]$Coef

NEcoefs3[[i]][[2]]$Interact_Effect
NEcoefs3[[i]][[2]]$Coef


#NE Aus Group 4
NEAus4 <- output_main[[4]]

NEcoefs4 <- get_coefs(NEAus4$hierpath, max_index = 50, 
                      resp = NE_resp[[4]], preds = NE_preds[[4]], preds_quant = NE_preds_q75[[4]])

plot(NEAus4$hiercv)

NEcv1 <- NEAus4$hiercv
which(NEcv1$lamlist == NEcv1$lamhat.1se)
which(NEcv1$lamlist == NEcv1$lamhat)
NEcv1$lamhat.1se
1-NEcv1$cv.err/var( NE_resp[[4]])


NErefit4 <- refit_bic(NEAus4$hierpath, max_index = 50, ebic.gamma = 0.25,
                      lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = NE_resp[[4]], preds = NE_preds[[4]], 
                      preds_quant = NE_preds_q75[[4]])

NErefit4[[5]]

which.min(NErefit4[[5]][ , 2])
which.min(NErefit4[[5]][ , 6])

i <- 12
ridge_coef <- NErefit4[[4]][[i]]
NEridge4_main <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(NErefit4[[1]][[i]]) #glm fit summary

NEcoefs4[[i]][[1]]$Main_Effect
NEcoefs4[[i]][[1]]$Coef

NEcoefs4[[i]][[2]]$Interact_Effect
NEcoefs4[[i]][[2]]$Coef


```


```{r SEAus}

SE_preds <- SElag_grouping(SE_laglist = SE_laglist_std, j = 1:19)
SE_resp <- SEresp_grouping(SEAus_mat = SEAus_mat, j = 1:19)
SE_preds_q75 <- SElag_grouping(SE_laglist = SE_laglist_q75, j = 1:19)

#SE Aus Group 1
SEAus1 <- output_main[[5]]

SEcoefs1 <- get_coefs(SEAus1$hierpath, max_index = 50, 
                      resp = SE_resp[[1]], preds = SE_preds[[1]], preds_quant = SE_preds_q75[[1]])

plot(SEAus1$hiercv)

SEcv1 <- SEAus1$hiercv
which(SEcv1$lamlist == SEcv1$lamhat.1se)
which(SEcv1$lamlist == SEcv1$lamhat)
SEcv1$lamhat.1se
1-SEcv1$cv.err/var( SE_resp[[1]])


SErefit1 <- refit_bic(SEAus1$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = SE_resp[[1]], preds = SE_preds[[1]], preds_quant = SE_preds_q75[[1]])

SErefit1[[5]]

which.min(SErefit1[[5]][,2])
which.min(SErefit1[[5]][,6])

i <- 7
#ridge_coef <- SErefit1[[4]][[i]][-1]
ridge_coef <- SErefit1[[4]][[i]]
SEridge1_main <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(SErefit1[[1]][[i]]) #glm fit summary

SEcoefs1[[i]][[1]]$Main_Effect
SEcoefs1[[i]][[1]]$Coef

SEcoefs1[[i]][[2]]$Interact_Effect
SEcoefs1[[i]][[2]]$Coef


#SE Aus Group 2
SEAus2 <- output_main[[6]]

SEcoefs2 <- get_coefs(SEAus2$hierpath, max_index = 50, 
                      resp = SE_resp[[2]], preds = SE_preds[[2]], preds_quant = SE_preds_q75[[2]])

plot(SEAus2$hiercv)

SEcv2 <- SEAus2$hiercv
which(SEcv2$lamlist == SEcv2$lamhat.1se)
which(SEcv2$lamlist == SEcv2$lamhat)
SEcv2$lamhat.1se
1-SEcv2$cv.err/var( SE_resp[[2]])


SErefit2 <- refit_bic(SEAus2$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = SE_resp[[2]], preds = SE_preds[[2]], preds_quant = SE_preds_q75[[2]])

SErefit2[[5]]

which.min(SErefit2[[5]][,2]) #AIC
which.min(SErefit2[[5]][,6]) #BIC

i <- 7
#ridge coefs
#ridge_coef <- SErefit2[[4]][[i]][-1]
ridge_coef <- SErefit2[[4]][[i]]
SEridge2_main <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(SErefit2[[1]][[i]])

SEcoefs2[[i]][[1]]$Main_Effect
SEcoefs2[[i]][[1]]$Coef

SEcoefs2[[i]][[2]]$Interact_Effect
SEcoefs2[[i]][[2]]$Coef


#SE Aus Group 3
SEAus3 <- output_main[[7]]

SEcoefs3 <- get_coefs(SEAus3$hierpath, max_index = 50, 
                      resp = SE_resp[[3]], preds = SE_preds[[3]], 
                      preds_quant = SE_preds_q75[[3]])

plot(SEAus3$hiercv)

SEcv2 <- SEAus3$hiercv
which(SEcv2$lamlist == SEcv2$lamhat.1se)
which(SEcv2$lamlist == SEcv2$lamhat)
SEcv2$lamhat.1se
1-SEcv2$cv.err/var( SE_resp[[2]])


SErefit3 <- refit_bic(SEAus3$hierpath, max_index = 50, ebic.gamma = 0.25, 
                      lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = SE_resp[[3]], preds = SE_preds[[3]], 
                      preds_quant = SE_preds_q75[[3]])

SErefit3[[5]]

which.min(SErefit3[[5]][,2]) #AIC
which.min(SErefit3[[5]][,6]) #BIC

i <- 17
#ridge coefs
#ridge_coef <- SErefit2[[4]][[i]][-1]
ridge_coef <- SErefit3[[4]][[i]]
SEridge3_main <- ridge_coef
ridge_coef
length(ridge_coef)


#glm coefs
summary(SErefit3[[1]][[i]])

SEcoefs3[[i]][[1]]$Main_Effect
SEcoefs3[[i]][[1]]$Coef

SEcoefs3[[i]][[2]]$Interact_Effect
SEcoefs3[[i]][[2]]$Coef

```

### Model Fits excluding 2019/2020

```{r NEAus}
NE_preds <- NElag_grouping(NE_laglist = NE_laglist_std, j = -c(19))
NE_resp <- NEresp_grouping(NEAus_mat = NEAus_mat, j = -c(19))
NE_preds_q75 <- NElag_grouping(NE_laglist = NE_laglist_q75, j = -c(19))

#NE Aus Group 2
NEAus2 <- output_main[[2]]

NEcoefs2 <- get_coefs(NEAus2$hierpath, max_index = 50, 
                      resp = NE_resp[[2]], preds = NE_preds[[2]], preds_quant = NE_preds_q75[[2]])

plot(NEAus2$hiercv)

NEcv1 <- NEAus2$hiercv
which(NEcv1$lamlist == NEcv1$lamhat.1se)
which(NEcv1$lamlist == NEcv1$lamhat)
NEcv1$lamhat.1se
1-NEcv1$cv.err/var( NE_resp[[2]])


NErefit2 <- refit_bic(NEAus2$hierpath, max_index = 50, ebic.gamma = 0.25,
                      lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = NE_resp[[2]], preds = NE_preds[[2]], 
                      preds_quant = NE_preds_q75[[2]])

NErefit2[[5]]

which.min(NErefit2[[5]][ , 2])
which.min(NErefit2[[5]][ , 6])

i <- 18
ridge_coef <- NErefit2[[4]][[i]]
NEridge2_main1 <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(NErefit2[[1]][[i]]) #glm fit summary

NEcoefs2[[i]][[1]]$Main_Effect
NEcoefs2[[i]][[1]]$Coef

NEcoefs2[[i]][[2]]$Interact_Effect
NEcoefs2[[i]][[2]]$Coef


#NE Aus Group 3
NEAus3 <- output_main[[3]]

NEcoefs3 <- get_coefs(NEAus3$hierpath, max_index = 50, 
                      resp = NE_resp[[3]], preds = NE_preds[[3]], preds_quant = NE_preds_q75[[3]])

plot(NEAus3$hiercv)

NEcv1 <- NEAus3$hiercv
which(NEcv1$lamlist == NEcv1$lamhat.1se)
which(NEcv1$lamlist == NEcv1$lamhat)
NEcv1$lamhat.1se
1-NEcv1$cv.err/var( NE_resp[[3]])


NErefit3 <- refit_bic(NEAus3$hierpath, max_index = 50, ebic.gamma = 0.25,
                      lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = NE_resp[[3]], preds = NE_preds[[3]], 
                      preds_quant = NE_preds_q75[[3]])

NErefit3[[5]]

which.min(NErefit3[[5]][ , 2])
which.min(NErefit3[[5]][ , 6])

i <- 15
ridge_coef <- NErefit3[[4]][[i]]
NEridge3_main1 <- ridge_coef
ridge_coef
length(ridge_coef)

```



```{r SEAus}

SE_preds <- SElag_grouping(SE_laglist = SE_laglist_std, j = -c(19))
SE_resp <- SEresp_grouping(SEAus_mat = SEAus_mat, j = -c(19))
SE_preds_q75 <- SElag_grouping(SE_laglist = SE_laglist_q75, j = -c(19))


#SE Aus Group 1
SEAus1 <- output_main[[5]]

SEcoefs1 <- get_coefs(SEAus1$hierpath, max_index = 50, 
                      resp = SE_resp[[1]], preds = SE_preds[[1]], preds_quant = SE_preds_q75[[1]])

plot(SEAus1$hiercv)

SEcv1 <- SEAus1$hiercv
which(SEcv1$lamlist == SEcv1$lamhat.1se)
which(SEcv1$lamlist == SEcv1$lamhat)
SEcv1$lamhat.1se
1-SEcv1$cv.err/var( SE_resp[[1]])


SErefit1 <- refit_bic(SEAus1$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = SE_resp[[1]], preds = SE_preds[[1]], preds_quant = SE_preds_q75[[1]])

SErefit1[[5]]

which.min(SErefit1[[5]][,2])
which.min(SErefit1[[5]][,6])

i <- 7
#ridge_coef <- SErefit1[[4]][[i]][-1]
ridge_coef <- SErefit1[[4]][[i]]
SEridge1_main1 <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(SErefit1[[1]][[i]]) #glm fit summary



#SE Aus Group 2
SEAus2 <- output_main[[6]]

SEcoefs2 <- get_coefs(SEAus2$hierpath, max_index = 50, 
                      resp = SE_resp[[2]], preds = SE_preds[[2]], preds_quant = SE_preds_q75[[2]])

plot(SEAus2$hiercv)

SEcv2 <- SEAus2$hiercv
which(SEcv2$lamlist == SEcv2$lamhat.1se)
which(SEcv2$lamlist == SEcv2$lamhat)
SEcv2$lamhat.1se
1-SEcv2$cv.err/var( SE_resp[[2]])


SErefit2 <- refit_bic(SEAus2$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = SE_resp[[2]], preds = SE_preds[[2]], preds_quant = SE_preds_q75[[2]])

SErefit2[[5]]

which.min(SErefit2[[5]][,2]) #AIC
which.min(SErefit2[[5]][,6]) #BIC

i <- 7
#ridge coefs
#ridge_coef <- SErefit2[[4]][[i]][-1]
ridge_coef <- SErefit2[[4]][[i]]
SEridge2_main1 <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(SErefit2[[1]][[i]])


#SE Aus Group 3
SEAus3 <- output_main[[7]]

SEcoefs3 <- get_coefs(SEAus3$hierpath, max_index = 50, 
                      resp = SE_resp[[3]], preds = SE_preds[[3]], 
                      preds_quant = SE_preds_q75[[3]])

plot(SEAus3$hiercv)

SEcv2 <- SEAus3$hiercv
which(SEcv2$lamlist == SEcv2$lamhat.1se)
which(SEcv2$lamlist == SEcv2$lamhat)
SEcv2$lamhat.1se
1-SEcv2$cv.err/var( SE_resp[[2]])


SErefit3 <- refit_bic(SEAus3$hierpath, max_index = 50, ebic.gamma = 0.25, 
                      lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = SE_resp[[3]], preds = SE_preds[[3]], 
                      preds_quant = SE_preds_q75[[3]])

SErefit3[[5]]

which.min(SErefit3[[5]][,2]) #AIC
which.min(SErefit3[[5]][,6]) #BIC

i <- 17
#ridge coefs
#ridge_coef <- SErefit2[[4]][[i]][-1]
ridge_coef <- SErefit3[[4]][[i]]
SEridge3_main1 <- ridge_coef
ridge_coef
length(ridge_coef)


#glm coefs
summary(SErefit3[[1]][[i]])

SEcoefs3[[i]][[1]]$Main_Effect
SEcoefs3[[i]][[1]]$Coef

SEcoefs3[[i]][[2]]$Interact_Effect
SEcoefs3[[i]][[2]]$Coef
```



## Baseline Wildfire (w/o 2019/2020 Season)


```{r NEAus}
NE_preds <- NElag_grouping(NE_laglist = NE_laglist_std, j = -c(19))
NE_resp <- NEresp_grouping(NEAus_mat = NEAus_mat, j = -c(19))
NE_preds_q75 <- NElag_grouping(NE_laglist = NE_laglist_q75, j = -c(19))

#NE Aus Group 2
NEAus2 <- output_base[[2]]

NEcoefs2 <- get_coefs(NEAus2$hierpath, max_index = 50, 
                      resp = NE_resp[[2]], preds = NE_preds[[2]], preds_quant = NE_preds_q75[[2]])

plot(NEAus2$hiercv)

NEcv1 <- NEAus2$hiercv
which(NEcv1$lamlist == NEcv1$lamhat.1se)
which(NEcv1$lamlist == NEcv1$lamhat)
NEcv1$lamhat.1se
1-NEcv1$cv.err/var( NE_resp[[2]])


NErefit2 <- refit_bic(NEAus2$hierpath, max_index = 50, ebic.gamma = 0.25,
                      lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = NE_resp[[2]], preds = NE_preds[[2]], 
                      preds_quant = NE_preds_q75[[2]])

NErefit2[[5]]

which.min(NErefit2[[5]][ , 2])
which.min(NErefit2[[5]][ , 6])

i <- 8
ridge_coef <- NErefit2[[4]][[i]]
NEridge2_base <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(NErefit2[[1]][[i]]) #glm fit summary

NEcoefs2[[i]][[1]]$Main_Effect
NEcoefs2[[i]][[1]]$Coef

NEcoefs2[[i]][[2]]$Interact_Effect
NEcoefs2[[i]][[2]]$Coef


#NE Aus Group 3
NEAus3 <- output_base[[3]]

NEcoefs3 <- get_coefs(NEAus3$hierpath, max_index = 50, 
                      resp = NE_resp[[3]], preds = NE_preds[[3]], preds_quant = NE_preds_q75[[3]])

plot(NEAus3$hiercv)

NEcv1 <- NEAus3$hiercv
which(NEcv1$lamlist == NEcv1$lamhat.1se)
which(NEcv1$lamlist == NEcv1$lamhat)
NEcv1$lamhat.1se
1-NEcv1$cv.err/var( NE_resp[[3]])


NErefit3 <- refit_bic(NEAus3$hierpath, max_index = 50, ebic.gamma = 0.25,
                      lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = NE_resp[[3]], preds = NE_preds[[3]], 
                      preds_quant = NE_preds_q75[[3]])

NErefit3[[5]]

which.min(NErefit3[[5]][1:14 , 2])
which.min(NErefit3[[5]][ , 6])

i <- 4
ridge_coef <- NErefit3[[4]][[i]]
NEridge3_base <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(NErefit3[[1]][[i]])

NEcoefs3[[i]][[1]]$Main_Effect
NEcoefs3[[i]][[1]]$Coef

```


```{r SEAus}
SE_preds <- SElag_grouping(SE_laglist = SE_laglist_std, j = -c(19))
SE_resp <- SEresp_grouping(SEAus_mat = SEAus_mat, j = -c(19))
SE_preds_q75 <- SElag_grouping(SE_laglist = SE_laglist_q75, j = -c(19))


#SE Aus Group 1
SEAus1 <- output_base[[5]]

SEcoefs1 <- get_coefs(SEAus1$hierpath, max_index = 50, 
                      resp = SE_resp[[1]], preds = SE_preds[[1]], preds_quant = SE_preds_q75[[1]])

plot(SEAus1$hiercv)

SEcv1 <- SEAus1$hiercv
which(SEcv1$lamlist == SEcv1$lamhat.1se)
which(SEcv1$lamlist == SEcv1$lamhat)
SEcv1$lamhat.1se
1-SEcv1$cv.err/var( SE_resp[[1]])


SErefit1 <- refit_bic(SEAus1$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = SE_resp[[1]], preds = SE_preds[[1]], preds_quant = SE_preds_q75[[1]])

SErefit1[[5]]

which.min(SErefit1[[5]][,2])
which.min(SErefit1[[5]][,6])

i <- 7
#ridge_coef <- SErefit1[[4]][[i]][-1]
ridge_coef <- SErefit1[[4]][[i]]
SEridge1_base <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(SErefit1[[1]][[i]]) #glm fit summary



#SE Aus Group 2
SEAus2 <- output_base[[6]]

SEcoefs2 <- get_coefs(SEAus2$hierpath, max_index = 50, 
                      resp = SE_resp[[2]], preds = SE_preds[[2]], preds_quant = SE_preds_q75[[2]])

plot(SEAus2$hiercv)

SEcv2 <- SEAus2$hiercv
which(SEcv2$lamlist == SEcv2$lamhat.1se)
which(SEcv2$lamlist == SEcv2$lamhat)
SEcv2$lamhat.1se
1-SEcv2$cv.err/var( SE_resp[[2]])


SErefit2 <- refit_bic(SEAus2$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = SE_resp[[2]], preds = SE_preds[[2]], preds_quant = SE_preds_q75[[2]])

SErefit2[[5]]

which.min(SErefit2[[5]][,2]) #AIC
which.min(SErefit2[[5]][,6]) #BIC

i <- 8
#ridge coefs
#ridge_coef <- SErefit2[[4]][[i]][-1]
ridge_coef <- SErefit2[[4]][[i]]
SEridge2_base <- ridge_coef
ridge_coef
length(ridge_coef)

#glm coefs
summary(SErefit2[[1]][[i]])


#

#SE Aus Group 3
SEAus3 <- output_base[[7]]

SEcoefs3 <- get_coefs(SEAus3$hierpath, max_index = 50, 
                      resp = SE_resp[[3]], preds = SE_preds[[3]], 
                      preds_quant = SE_preds_q75[[3]])

plot(SEAus3$hiercv)

SEcv2 <- SEAus3$hiercv
which(SEcv2$lamlist == SEcv2$lamhat.1se)
which(SEcv2$lamlist == SEcv2$lamhat)
SEcv2$lamhat.1se
1-SEcv2$cv.err/var( SE_resp[[2]])


SErefit3 <- refit_bic(SEAus3$hierpath, max_index = 50, ebic.gamma = 0.25, 
                      lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = SE_resp[[3]], preds = SE_preds[[3]], 
                      preds_quant = SE_preds_q75[[3]])

SErefit3[[5]]

which.min(SErefit3[[5]][,2]) #AIC
which.min(SErefit3[[5]][,6]) #BIC

i <- 4
#ridge coefs
#ridge_coef <- SErefit2[[4]][[i]][-1]
ridge_coef <- SErefit3[[4]][[i]]
SEridge3_base <- ridge_coef
ridge_coef
length(ridge_coef)


#glm coefs
summary(SErefit3[[1]][[i]])

SEcoefs3[[i]][[1]]$Main_Effect
SEcoefs3[[i]][[1]]$Coef

SEcoefs3[[i]][[2]]$Interact_Effect
SEcoefs3[[i]][[2]]$Coef
```


## Reduced Groups

Looking at only 2 groups per region:
(Add info on new groups.)

```{r new_setup}
#full model data set-up
NE_preds <- NElag_grouping(NE_laglist = NE_laglist_std, j = 1:19)
NE_resp <- NEresp_grouping(NEAus_mat = NEAus_mat, j = 1:19)
NE_preds_q75 <- NElag_grouping(NE_laglist = NE_laglist_q75, j = 1:19)

##predictors
NE_group1 <- NE_preds[[1]]
NE_group2 <- rbind(NE_preds[[2]], NE_preds[[3]], NE_preds[[4]])
NE_preds1 <- list(NE_group1, NE_group2)

SE_group1 <- rbind(SE_preds[[1]], SE_preds[[2]])
SE_group2 <- rbind(SE_preds[[3]], SE_preds[[4]])
SE_preds1 <- list(SE_group1, SE_group2)

##response
NEresp1 <- NE_resp[[1]]
NEresp2 <- c(NE_resp[[2]], NE_resp[[3]], NE_resp[[4]])
NE_resp1 <- list(NEresp1, NEresp2)

SEresp1 <- c(SE_resp[[1]], SE_resp[[2]])
SEresp2 <- c(SE_resp[[3]], SE_resp[[4]])
SE_resp1 <- list(SEresp1, SEresp2)

##indicator preds (q75)

NEq75_pred1 <- NE_preds_q75[[1]]
NEq75_pred2 <- rbind(NE_preds_q75[[2]], NE_preds_q75[[3]], NE_preds_q75[[4]])
NE_preds1_q75 <- list(NEq75_pred1, NEq75_pred2)

SEq75_pred1 <- rbind(SE_preds_q75[[1]], SE_preds_q75[[2]])
SEq75_pred2 <- rbind(SE_preds_q75[[3]], SE_preds_q75[[4]])
SE_preds1_q75 <- list(SEq75_pred1, SEq75_pred2)
```


```{r NEAus}

```


```{r SEAus}
#SE Aus Group 1 
SEAus1 <- output_group[[3]]

SEcoefs1 <- get_coefs(SEAus1$hierpath, max_index = 50, 
                      resp = SE_resp1[[1]], preds = SE_preds1[[1]], preds_quant = SE_preds1_q75[[1]])

plot(SEAus1$hiercv)

SEcv1 <- SEAus1$hiercv
which(SEcv1$lamlist == SEcv1$lamhat.1se)
which(SEcv1$lamlist == SEcv1$lamhat)
SEcv1$lamhat.1se
1-SEcv1$cv.err/var( SE_resp[[1]])


SErefit1 <- refit_bic(SEAus1$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = FALSE, AIC.c = FALSE,
                      intercept = FALSE,
                      resp = SE_resp1[[1]], preds = SE_preds1[[1]], preds_quant = SE_preds1_q75[[1]])

SErefit1[[5]]

which.min(SErefit1[[5]][,2])
which.min(SErefit1[[5]][,6])

i <- 7
#ridge_coef <- SErefit1[[4]][[i]][-1]
ridge_coef <- SErefit1[[4]][[i]]
SEridge1_main <- ridge_coef
ridge_coef
length(ridge_coef)

#SE Aug Group 2



```


## Elastic Nets

### Alpha 0.10

```{r NEAus}
NE_preds <- NElag_grouping(NE_laglist = NE_laglist_std, j = 1:19)
NE_resp <- NEresp_grouping(NEAus_mat = NEAus_mat, j = 1:19)
NE_preds_q75 <- NElag_grouping(NE_laglist = NE_laglist_q75, j = 1:19)

NEAus1 <- output_enet[[1]]

NEcoefs1 <- get_coefs(NEAus1$hierpath, max_index = 50, 
                      resp = NE_resp[[1]], preds = NE_preds[[1]], 
                      preds_quant = NE_preds_q75[[1]])

plot(NEAus1$hiercv)

NEcv1 <- NEAus1$hiercv
which(NEcv1$lamlist == NEcv1$lamhat.1se)
which(NEcv1$lamlist == NEcv1$lamhat)

NErefit1 <- refit_bic(NEAus1$hierpath, max_index = 50, ebic.gamma = 0.25,
                      lambda.min = FALSE, AIC.c = FALSE,
                      resp = NE_resp[[1]], preds = NE_preds[[1]], 
                      preds_quant = NE_preds_q75[[1]])

#NErefit1[[5]]

which.min(NErefit1[[5]][ , 2])
which.min(NErefit1[[5]][ , 6])

i <- 1
ridge_coef <- NErefit1[[4]][[i]][-1]
NEridge1_ent <- ridge_coef
ridge_coef
length(ridge_coef)

NEcoefs1[[i]][[1]]$Main_Effect
NEcoefs1[[i]][[1]]$Coef
```

### Alpha 0.25

```{r NEAus}
NE_preds <- NElag_grouping(NE_laglist = NE_laglist_std, j = 1:19)
NE_resp <- NEresp_grouping(NEAus_mat = NEAus_mat, j = 1:19)
NE_preds_q75 <- NElag_grouping(NE_laglist = NE_laglist_q75, j = 1:19)

NEAus1 <- output_enet25[[1]]

NEcoefs1 <- get_coefs(NEAus1$hierpath, max_index = 50, 
                      resp = NE_resp[[1]], preds = NE_preds[[1]], 
                      preds_quant = NE_preds_q75[[1]])

plot(NEAus1$hiercv)

NEcv1 <- NEAus1$hiercv
which(NEcv1$lamlist == NEcv1$lamhat.1se)
which(NEcv1$lamlist == NEcv1$lamhat)

NErefit1 <- refit_bic(NEAus1$hierpath, max_index = 50, ebic.gamma = 0.25,
                      lambda.min = FALSE, AIC.c = FALSE,
                      resp = NE_resp[[1]], preds = NE_preds[[1]], 
                      preds_quant = NE_preds_q75[[1]])

#NErefit1[[5]]

which.min(NErefit1[[5]][ , 2])
which.min(NErefit1[[5]][ , 6])

i <- 1
ridge_coef <- NErefit1[[4]][[i]][-1]
NEridge1_ent25 <- ridge_coef
ridge_coef
length(ridge_coef)

NEcoefs1[[i]][[1]]$Main_Effect
NEcoefs1[[i]][[1]]$Coef

NEcoefs1[[i]][[2]]$Interact_Effect
NEcoefs1[[i]][[2]]$Coef
```


# Coefficient Visualizations

## Comparisons (by Region/Group)

### NE Aus

```{r}

```


### SE Aus 

```{r SEAus_group1}

```


```{r SEAus_group2}
setwd("~/CO_AUS/Aus_CO-main/Interactions/Figures")

png(filename = "SE2_coeff.png", width = 3000, height = 3000, res = 300)
# Set layout
layout(matrix(c(1, 6,
                2, 6,
                3, 6,
                4, 6,
                5, 6), ncol = 2, byrow = TRUE),
       widths = c(1.5, 1), heights = c(1, 1, 1, 1, 1))

par(oma = c(1, 1, 3, 9))

# Store info for linking
links <- list()

# --- Data Set-up --- 
## Nino
SE2_ninolag <- c(11,17)
SE2_ninocoef <- SEridge2_main[1:2]
SE21_ninolag <- c(11,17)
SE21_ninocoef <- SEridge2_main1[1:2]
SE22_ninolag <- c(11:13,17)
SE22_ninocoef <- SEridge2_base[1:4]
##DMI
SE2_dmilag <- c(6)
SE2_dmicoef <- SEridge2_main[3]
SE21_dmilag <- c(6)
SE21_dmicoef <- SEridge2_main1[3]
SE22_dmilag <- c(5)
SE22_dmicoef <- SEridge2_base[5]
##TSA
SE22_tsalag <- c(8,16,19)
SE22_tsacoef <- SEridge2_base[6:8]
##AAO
SE2_aaolag <- c(24)
SE2_aaocoef <- SEridge2_main[4]
SE21_aaolag <- c(24)
SE21_aaocoef <- SEridge2_main1[4]
SE22_aaolag <- c(24)
SE22_aaocoef <- SEridge2_base[9]

# --- Range ---
SEAus2_range <- range(SE2_ninocoef, SE21_ninocoef, SE22_ninocoef, 
                      SE2_dmicoef, SE21_dmicoef, SE22_dmicoef,
                      SE22_tsacoef,
                      SE2_aaocoef, SE21_aaocoef, SE22_aaocoef)

# --- Plot 1: Nino ---
par(mar = c(4, 4, 2, 1))

plot(SE2_ninolag, SE2_ninocoef, pch = 22, 
     col = "grey4", bg =  alpha("green4",.95), cex = 1.5,
     xlim = c(1,52), 
     ylim = SEAus2_range,
     xlab = "", ylab = "Coefficients")
points(SE21_ninolag, SE21_ninocoef, pch = 22, col = "black",
       bg =  alpha("chartreuse3",.65) , cex = 1.5)
points(SE22_ninolag, SE22_ninocoef, pch = 24, col = "black",
       bg =  alpha("chartreuse3",.95), cex = 1.4)
abline(h = 0, lty = 2)
title("Nino", adj = 0)

#TODO: change the interaction code to be more compact
## Nino Interactions
# I(nino_lag11^2):
## main
links[[1]] <- list(
  y_val = SE2_ninocoef[1],
  from_x = grconvertX(SE2_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE2_ninocoef[1], from = "user", to = "ndc")
)
## main sans
links[[2]] <- list(
  y_val = SE21_ninocoef[1],
  from_x = grconvertX(SE21_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE21_ninocoef[1], from = "user", to = "ndc")
)
## base sans
links[[3]] <- list(
  y_val = SE22_ninocoef[1],
  from_x = grconvertX(SE22_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE22_ninocoef[1], from = "user", to = "ndc")
)

# I(nino_lag12^2):
## base sans
links[[4]] <- list(
  y_val = SE22_ninocoef[2],
  from_x = grconvertX(SE22_ninolag[2], from = "user", to = "ndc"),
  from_y = grconvertY(SE22_ninocoef[2], from = "user", to = "ndc")
)



# --- Plot 2: DMI ---
par(mar = c(4, 4, 2, 1))
plot(SE2_dmilag, SE2_dmicoef, pch = 22,
     col = "grey4",
     bg =  alpha("magenta4",.95), cex = 1.5,
     xlim = c(1,52), 
     ylim = SEAus2_range,
     xlab = "", ylab = "Coefficients")
points(SE21_dmilag, SE21_dmicoef, pch = 22, col = "black",
       bg =  alpha("darkorchid2",.65) , cex = 1.5)
points(SE22_dmilag, SE22_dmicoef, pch = 24, col = "black",
       bg =  alpha("darkorchid2",.95), cex = 1.4)
abline(h = 0, lty = 2)
title("DMI", adj = 0)

# --- Plot 3: TSA ---
par(mar = c(4, 4, 2, 1))
plot(SE22_tsalag, SE22_tsacoef, pch = 24, col = "black",
       bg =  alpha("darkgoldenrod3", 0.95), xlim = c(1,52), cex = 1.4,
     ylim = SEAus2_range,
     xlab = "", ylab = "Coefficients")
abline(h = 0, lty = 2)
title("TSA", adj = 0)

# --- Plot 4: SAM/AAO ---
par(mar = c(4, 4, 2, 1))
plot(SE2_aaolag, SE2_aaocoef, pch = 22,
     col = "grey4",
     bg =  alpha("red3",.95), cex = 1.5,
     xlim = c(1,52), 
     ylim = SEAus2_range,
     xlab = "", ylab = "Coefficients")
points(SE21_aaolag, SE21_aaocoef, pch = 22, col = "black",
       bg =  alpha("coral2",.65) , cex = 1.5)
points(SE22_aaolag, SE22_aaocoef, pch = 24, col = "black",
       bg =  alpha("coral2",.95), cex = 1.4)
abline(h = 0, lty = 2)
title("SAM (AAO)", adj = 0)

## AAO Interactions
# I(aao_lag24^2):
links[[5]] <- list(
  y_val = SE2_aaocoef[1],
  from_x = grconvertX(SE2_aaolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE2_aaocoef[1], from = "user", to = "ndc")
)
## main sans
links[[6]] <- list(
  y_val = SE21_aaocoef[1],
  from_x = grconvertX(SE21_aaolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE21_aaocoef[1], from = "user", to = "ndc")
)
## base sans
links[[7]] <- list(
  y_val = SE22_aaocoef[1],
  from_x = grconvertX(SE22_aaolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE22_aaocoef[1], from = "user", to = "ndc")
)


# --- Plot 5: OLR ---
par(mar = c(4, 4, 2, 1))
plot(SE2_aaolag, SE2_aaocoef, type = "n", xlim = c(1,52), 
     ylim = SEAus2_range,
     xlab = "Lag", ylab = "Coefficients")
abline(h = 0, lty = 2)
title("OLR", adj = 0)

# --- Plot 6: Interaction Effects ---
par(mar = c(4, 4, 2, 2))

int_range <- range(SEridge2_main[5:6], SEridge2_main1[5:6], SEridge2_base[10:12])

plot(SEridge2_main[5], 1.5, type = "n", main = "Interactions", 
     ylim = c(0,1), xlim = int_range,
     xlab = "Coefficients",
     yaxt = "n",  ylab = "")
#for correct points set-up empty plot then assign points after (maybe? test this out)
#TODO: turn this into a single call, format $from_y with unlist()
int_1 <- grconvertY(links[[1]]$from_y, from = "ndc", to = "user")
int_2 <- grconvertY(links[[2]]$from_y, from = "ndc", to = "user")
int_3 <- grconvertY(links[[3]]$from_y, from = "ndc", to = "user")
int_4 <- grconvertY(links[[4]]$from_y, from = "ndc", to = "user")
int_5 <- grconvertY(links[[5]]$from_y, from = "ndc", to = "user")
int_6 <- grconvertY(links[[6]]$from_y, from = "ndc", to = "user")
int_7 <- grconvertY(links[[7]]$from_y, from = "ndc", to = "user")

points(SEridge2_main[5], int_1,  pch = 22, col = "grey4", 
       bg =  alpha("green4",.95), cex = 1.5) 
points(SEridge2_main1[5], int_2, pch = 22, col = "black",
       bg =  alpha("chartreuse3",.65) , cex = 1.5) 
points(SEridge2_base[10:11], c(int_3, int_4), pch = 24, col = "black",
       bg =  alpha("chartreuse3",.95), cex = 1.4) 
points(SEridge2_main[6], int_5, pch = 22, col = "grey4",
        bg =  alpha("red3",.95), cex = 1.5)
points(SEridge2_main1[6], int_6, pch = 22, col = "black",
       bg =  alpha("coral2",.65) , cex = 1.5)
points(SEridge2_base[12], int_7, pch = 24, col = "black",
       bg =  alpha("coral2",.95), cex = 1.4)

#link to x 
links[[1]]$to_x <- grconvertX(SEridge2_main[5], from = "user", to = "ndc")
links[[2]]$to_x <- grconvertX(SEridge2_main1[5], from = "user", to = "ndc")
links[[3]]$to_x <- grconvertX(SEridge2_base[10], from = "user", to = "ndc")
links[[4]]$to_x <- grconvertX(SEridge2_base[11], from = "user", to = "ndc")
links[[5]]$to_x <- grconvertX(SEridge2_main[6], from = "user", to = "ndc")
links[[6]]$to_x <- grconvertX(SEridge2_main1[6], from = "user", to = "ndc")
links[[7]]$to_x <- grconvertX(SEridge2_base[12], from = "user", to = "ndc")

for (i in 1:length(links)) {
  links[[i]]$to_y <- links[[i]]$from_y  # same y to keep it horizontal
}

# --- Draw horizontal linking lines ---
par(xpd = NA)  # allow drawing outside plot regions
colors <- c("green4", rep("chartreuse3", 3), "red3", rep("coral2",2))
linetypes <- c(rep(2,7))

for (i in 1:length(links)) {
  grid.lines(
    x = unit(c(links[[i]]$from_x, links[[i]]$to_x), "npc"),
    y = unit(c(links[[i]]$from_y, links[[i]]$to_y), "npc"),
    gp = gpar(col = colors[i], lwd = 1, lty = linetypes[i])
  )
}

#outer text and legends
par(xpd = NA)
legend("topright", inset = c(-0.52, 0.00),
       title = "Nino",
       legend = c("Coef w/ 2019/2020", "Coef w/o 2019/2020", "Variable w/o 2019/2020"),
       pch = c(22, 22, 24),
       col = c("grey4", "black", "grey4"),
       pt.bg = c("green4", "chartreuse3", "chartreuse3"),
       pt.cex = c(1.5, 1.5, 1.4))
legend("bottomright", inset = c(-0.52, 0.27),
       title = "SAM (AAO)",
       legend = c("Coef w/ 2019/2020", "Coef w/o 2019/2020", "Variable w/o 2019/2020"),
       pch = c(22, 22, 24),
       col = c("grey4", "black", "grey4"),
       pt.bg = c("red3", "coral2", "coral2"),
       pt.cex = c(1.5, 1.5, 1.4))

mtext("SE Aus Group 2 (Mid-October to Mid-December)", outer = TRUE, cex = 1.5, font = 1)

dev.off()
```


```{r SEAus_group3}
SEridge3_main
SEridge3_main1
SEridge3_base

setwd("~/CO_AUS/Aus_CO-main/Interactions/Figures")

png(filename = "SE3_coeff.png", width = 3000, height = 3000, res = 300)

# Set layout
layout(matrix(c(1, 6,
                2, 6,
                3, 6,
                4, 6,
                5, 6), ncol = 2, byrow = TRUE),
       widths = c(1.5, 1), heights = c(1, 1, 1, 1, 1))

par(oma = c(1, 1, 3, 9))

# Store info for linking
links <- list()

# --- Data Set-up --- 
#nino
SE32_ninolag <- c(12,27)
SE32_ninocoef <- SEridge3_base[1:2]
#dmi
SE3_dmilag <- c(7,8)
SE3_dmicoef <- SEridge3_main[1:2]
SE31_dmilag <- c(7,8)
SE31_dmicoef <- SEridge3_main1[1:2]
SE32_dmilag <- c(8,47)
SE32_dmicoef <- SEridge3_base[3:4]
#tsa
SE3_tsalag <- c(6,17,27,28)
SE3_tsacoef <- SEridge3_main[3:6]
SE31_tsalag <- c(6,17,27,28)
SE31_tsacoef <- SEridge3_main1[3:6]
SE32_tsalag <- c(17,28)
SE32_tsacoef <- SEridge3_base[5:6]
#aao
SE3_aaolag <- c(9)
SE3_aaocoef <- SEridge3_main[7]
SE31_aaolag <- c(9)
SE31_aaocoef <- SEridge3_main1[7]
SE32_aaolag <- c(42)
SE32_aaocoef <- SEridge3_base[7]

# --- Range ---
SEAus3_range <- range(SE32_ninocoef, 
                      SE3_dmicoef, SE31_dmicoef, SE32_dmicoef,
                      SE3_tsacoef, SE31_tsacoef, SE32_tsacoef,
                      SE3_aaocoef, SE31_aaocoef, SE32_aaocoef)

# --- Plot 1: Nino ---
par(mar = c(4, 4, 2, 1))

plot(SE32_ninolag, SE32_ninocoef, pch = 24, col = "black",
       bg =  alpha("chartreuse3",.65), cex = 1.4,
     xlim = c(1,52), 
     ylim = SEAus3_range,
     xlab = "", ylab = "Coefficients")
abline(h = 0, lty = 2)
title("Nino", adj = 0)

#interactions
#nino_lag27:dmi_lag47
## base sans
links[[1]] <- list(
  y_val = SE32_ninocoef[2],
  from_x = grconvertX(SE32_ninolag[2], from = "user", to = "ndc"),
  from_y = grconvertY(SE32_ninocoef[2], from = "user", to = "ndc")
)

# --- Plot 2: DMI ---
par(mar = c(4, 4, 2, 1))

plot(SE3_dmilag, SE3_dmicoef, pch = 22,
     col = "grey4",
     bg =  alpha("magenta4",.95), cex = 1.5,
     xlim = c(1,52), 
     ylim = SEAus3_range,
     xlab = "", ylab = "Coefficients")
points(SE31_dmilag, SE31_dmicoef, pch = 22, col = "black",
       bg =  alpha("darkorchid2",.65) , cex = 1.5)
points(SE32_dmilag, SE32_dmicoef, pch = 24, col = "black",
       bg =  alpha("darkorchid2",.65), cex = 1.4)
abline(h = 0, lty = 2)
title("DMI", adj = 0)

#interactions
#I(dmi_lag7^2)
#main
links[[2]] <- list(
  y_val = SE3_dmicoef[1],
  from_x = grconvertX(SE3_dmilag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE3_dmicoef[1], from = "user", to = "ndc")
)
#main sans
links[[3]] <- list(
  y_val = SE31_dmicoef[1],
  from_x = grconvertX(SE31_dmilag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE31_dmicoef[1], from = "user", to = "ndc")
)

#I(dmi_lag8^2) 
#main
links[[4]] <- list(
  y_val = SE3_dmicoef[2],
  from_x = grconvertX(SE3_dmilag[2], from = "user", to = "ndc"),
  from_y = grconvertY(SE3_dmicoef[2], from = "user", to = "ndc")
)
#main sans
links[[5]] <- list(
  y_val = SE31_dmicoef[2],
  from_x = grconvertX(SE31_dmilag[2], from = "user", to = "ndc"),
  from_y = grconvertY(SE31_dmicoef[2], from = "user", to = "ndc")
)
#base sans
links[[6]] <- list(
  y_val = SE32_dmicoef[1],
  from_x = grconvertX(SE32_dmilag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE32_dmicoef[1], from = "user", to = "ndc")
)

#interactions
#dmi_lag47:nino_lag27
#base sans
links[[7]] <- list(
  y_val = SE32_dmicoef[2],
  from_x = grconvertX(SE32_dmilag[2], from = "user", to = "ndc"),
  from_y = grconvertY(SE32_dmicoef[2], from = "user", to = "ndc")
)



# --- Plot 3: TSA ---
par(mar = c(4, 4, 2, 1))
plot(SE3_tsalag, SE3_tsacoef, pch = 22, col = "black",
       bg =  alpha("darkorange2", 0.95), xlim = c(1,52), cex = 1.4,
     ylim = SEAus3_range,
     xlab = "", ylab = "Coefficients")
points(SE31_tsalag, SE31_tsacoef, pch = 22, col = "black",
       bg =  alpha("darkgoldenrod3",.65) , cex = 1.5)
points(SE32_tsalag, SE32_tsacoef, pch = 24, col = "black",
       bg =  alpha("darkgoldenrod3",.65), cex = 1.4)
abline(h = 0, lty = 2)
title("TSA", adj = 0)

#Interactions
#I(tsa_lag6^2)
#main
links[[8]] <- list(
  y_val = SE3_tsacoef[1],
  from_x = grconvertX(SE3_tsalag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE3_tsacoef[1], from = "user", to = "ndc")
)
#main sans
links[[9]] <- list(
  y_val = SE31_tsacoef[1],
  from_x = grconvertX(SE31_tsalag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE31_tsacoef[1], from = "user", to = "ndc")
)

#I(tsa_lag17^2)
#main
links[[10]] <- list(
  y_val = SE3_tsacoef[2],
  from_x = grconvertX(SE3_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(SE3_tsacoef[2], from = "user", to = "ndc")
)
#main sans
links[[11]] <- list(
  y_val = SE31_tsacoef[2],
  from_x = grconvertX(SE31_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(SE31_tsacoef[2], from = "user", to = "ndc")
)
#base sans
links[[12]] <- list(
  y_val = SE32_tsacoef[1],
  from_x = grconvertX(SE32_tsalag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE32_tsacoef[1], from = "user", to = "ndc")
)

# --- Plot 4: SAM/AAO ---
par(mar = c(4, 4, 2, 1))

plot(SE3_aaolag, SE3_aaocoef, pch = 22,
     col = "grey4",
     bg =  alpha("red3",.95), cex = 1.5,
     xlim = c(1,52), 
     ylim = SEAus3_range,
     xlab = "", ylab = "Coefficients")
points(SE31_aaolag, SE31_aaocoef, pch = 22, col = "black",
       bg =  alpha("coral2",.65) , cex = 1.5)
points(SE32_aaolag, SE32_aaocoef, pch = 24, col = "black",
       bg =  alpha("coral2",.65), cex = 1.4)
abline(h = 0, lty = 2)
title("SAM (AAO)", adj = 0)

# --- Plot 5: OLR ---
par(mar = c(4, 4, 2, 1))

plot(SE3_aaolag, SE3_aaocoef, type = "n", xlim = c(1,52), 
     ylim = SEAus2_range,
     xlab = "Lag", ylab = "Coefficients")
abline(h = 0, lty = 2)
title("OLR", adj = 0)

# --- Plot 6: Interaction Effects ---
par(mar = c(4, 4, 2, 2))

int_range <- range(SEridge3_main[8:11], SEridge3_main1[8:11], SEridge3_base[8:10])

plot(SEridge3_main[8], 1.5, type = "n", main = "Interactions", 
     ylim = c(0,1), xlim = int_range,
     xlab = "Coefficients",
     yaxt = "n",  ylab = "")
abline(v= 0, lty = 2)

#dmi squared
int_2 <- grconvertY(links[[2]]$from_y, from = "ndc", to = "user")
int_3 <- grconvertY(links[[3]]$from_y, from = "ndc", to = "user")
int_4 <- grconvertY(links[[4]]$from_y, from = "ndc", to = "user")
int_5 <- grconvertY(links[[5]]$from_y, from = "ndc", to = "user")
int_6 <- grconvertY(links[[6]]$from_y, from = "ndc", to = "user")
#tsa squared
int_8 <- grconvertY(links[[8]]$from_y, from = "ndc", to = "user")
int_9 <- grconvertY(links[[9]]$from_y, from = "ndc", to = "user")
int_10 <- grconvertY(links[[10]]$from_y, from = "ndc", to = "user")
int_11 <- grconvertY(links[[11]]$from_y, from = "ndc", to = "user")
int_12 <- grconvertY(links[[12]]$from_y, from = "ndc", to = "user")
#interactions
int_1 <- grconvertY(links[[1]]$from_y, from = "ndc", to = "user")
int_7 <- grconvertY(links[[7]]$from_y, from = "ndc", to = "user")

int_point <- (int_1 + int_7)/2

#segments
segments(SEridge3_base[10], int_1, SEridge3_base[10], int_point, col = "chartreuse4", lty = 3, lwd = 1.5)
segments(SEridge3_base[10], int_7, SEridge3_base[10], int_point, col = "darkorchid2", lty = 3, lwd = 1.5)

points(SEridge3_main[8:9], c(int_2,int_4),  pch = 22, col = "grey4", 
       bg =  alpha("magenta4",.95), cex = 1.5) 
points(SEridge3_main1[8:9], c(int_3, int_5), pch = 22, col = "black",
       bg =  alpha("darkorchid2",.65) , cex = 1.5) 
points(SEridge3_base[8], int_6, pch = 24, col = "black",
       bg =  alpha("darkorchid2",.65), cex = 1.4) 
points(SEridge3_main[10:11], c(int_8,int_10),  pch = 22, col = "grey4", 
       bg =  alpha("darkorange2",.95), cex = 1.5) 
points(SEridge3_main1[10:11], c(int_9, int_11), pch = 22, col = "black",
       bg =  alpha("darkgoldenrod3",.65) , cex = 1.5) 
points(SEridge3_base[9], int_12, pch = 24, col = "black",
       bg =  alpha("darkgoldenrod3",.65), cex = 1.4) 
points(SEridge3_base[10], int_point, pch = 17, col = "black", cex = 1.4) 

#link to x
#from nino
links[[1]]$to_x <- grconvertX(SEridge3_base[10], from = "user", to = "ndc") #int
#from dmi
links[[2]]$to_x <- grconvertX(SEridge3_main[8], from = "user", to = "ndc")
links[[3]]$to_x <- grconvertX(SEridge3_main1[8], from = "user", to = "ndc")
links[[4]]$to_x <- grconvertX(SEridge3_main[9], from = "user", to = "ndc")
links[[5]]$to_x <- grconvertX(SEridge3_main1[9], from = "user", to = "ndc")
links[[6]]$to_x <- grconvertX(SEridge3_base[8], from = "user", to = "ndc")
links[[7]]$to_x <- grconvertX(SEridge3_base[10], from = "user", to = "ndc") #int
#from tsa
links[[8]]$to_x <- grconvertX(SEridge3_main[10], from = "user", to = "ndc")
links[[9]]$to_x <- grconvertX(SEridge3_main1[10], from = "user", to = "ndc")
links[[10]]$to_x <- grconvertX(SEridge3_main[11], from = "user", to = "ndc")
links[[11]]$to_x <- grconvertX(SEridge3_main1[11], from = "user", to = "ndc")
links[[12]]$to_x <- grconvertX(SEridge3_base[9], from = "user", to = "ndc")


for (i in 1:length(links)) {
  links[[i]]$to_y <- links[[i]]$from_y  # same y to keep it horizontal
}

# --- Draw horizontal linking lines ---
par(xpd = NA)  # allow drawing outside plot regions
colors <- c("chartreuse4", "magenta4", "darkorchid2",
            "magenta4", rep("darkorchid2",3),
            "darkorange2", "darkgoldenrod3","darkorange2", rep("darkgoldenrod3",2))
linetypes <- c(3, rep(2,5), 3, rep(2,5) )
linewidths <- c(1.5, rep(1,5), 1.5, rep(1,5) )

for (i in 1:length(links)) {
  grid.lines(
    x = unit(c(links[[i]]$from_x, links[[i]]$to_x), "npc"),
    y = unit(c(links[[i]]$from_y, links[[i]]$to_y), "npc"),
    gp = gpar(col = colors[i], lwd = linewidths[i], lty = linetypes[i])
  )
}

#outer text and legends
par(xpd = NA)
legend("topright", inset = c(-0.52, 0.00),
       title = "Nino",
       legend = c("Coef w/ 2019/2020", "Coef w/o 2019/2020", "Variable w/o 2019/2020"),
       pch = c(22, 22, 24),
       col = c("grey4", "black", "grey4"),
       pt.bg = c("green4", "chartreuse3", "chartreuse3"),
       pt.cex = c(1.5, 1.5, 1.4))

legend("topright", inset = c(-0.52, 0.23),
       title = "DMI",
       legend = c("Coef w/ 2019/2020", "Coef w/o 2019/2020", "Variable w/o 2019/2020"),
       pch = c(22, 22, 24),
       col = c("grey4", "black", "grey4"),
       pt.bg = c("magenta4", "darkorchid2", "darkorchid2"),
       pt.cex = c(1.5, 1.5, 1.4))

legend("right", inset = c(-0.52, -0.02),
       title = "TSA",
       legend = c("Coef w/ 2019/2020", "Coef w/o 2019/2020", "Variable w/o 2019/2020"),
       pch = c(22, 22, 24),
       col = c("grey4", "black", "grey4"),
       pt.bg = c("darkorange2", "darkgoldenrod3", "darkgoldenrod3"),
       pt.cex = c(1.5, 1.5, 1.4))

legend("bottomright", inset = c(-0.52, 0.27),
       title = "SAM (AAO)",
       legend = c("Coef w/ 2019/2020", "Coef w/o 2019/2020", "Variable w/o 2019/2020"),
       pch = c(22, 22, 24),
       col = c("grey4", "black", "grey4"),
       pt.bg = c("red3", "coral2", "coral2"),
       pt.cex = c(1.5, 1.5, 1.4))


mtext("SE Aus Group 3 (Mid-December to ...)", outer = TRUE, cex = 1.5, font = 1)

dev.off()
```


## Coef Differences

Finalize these plots (with correct index colors)

$\frac{1}{n}\sum(\beta_j - \beta_j^*)$

```{r}
#SE Aus Group 2
SEridge2_main
SEridge2_main1
SEridge2_base
#Nino differences
#coef main/main
coef_dif <- SEridge2_main - SEridge2_main1
nino_avg <- mean(coef_dif[1:2])
dmi_avg <- coef_dif[3]
tsa_avg <- 0
aao_avg <- coef_dif[4]
olr_avg <- 0

var_dif <- SEridge2_main[c(1,2,4)] - SEridge2_base[c(1,4,9)]
var_nino <- rep(0,2) - SEridge2_base[c(2,3)]
nino_avg1 <- mean(c(var_dif[c(1,2)], var_nino)) #nino
dmi_avg1 <- mean(c(SEridge2_main[3], -SEridge2_base[5])) #dmi
tsa_avg1 <- mean(-SEridge2_base[6:8]) #tsa
aao_avg1 <- var_dif[3] #aao
olr_avg1 <- 0

coef_avg <- c(nino_avg, dmi_avg, tsa_avg, aao_avg, olr_avg)
var_avg <- c(nino_avg1, dmi_avg1, tsa_avg1, aao_avg1, olr_avg1)


#TODO: finalize this plot
coef_range <- range(coef_avg, var_avg)

par(mar = c(4, 4, 4, 6) + 0.2)
plot(1:5, coef_avg, pch = 22, ylim = coef_range, 
     ylab= "Avg. Coef Diff", xlab = "Climate Index", main = "Main Effect Differences (w/ 2019/2020 minus w/o 2019/2020)",
     axes = FALSE)
box()
axis(2)
axis(1, at = 1:5, labels = c("Nino", "DMI", "TSA", "SAM", "OLR"),
     las = 1, cex.axis = 1)
points(1:5, var_avg, pch = 24)
abline(h = 0, lty = 2)

legend("topright", inset = c(-0.12, 0.00),
       legend = c("Coef. Refit", "Var. Select Refit"),
       pch = c(22, 24), xpd = NA)
```


