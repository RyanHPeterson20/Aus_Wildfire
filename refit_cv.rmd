---
title: "refit_cv"
author: "Ryan Peterson"
date: "2025-09-25"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r library}
suppressMessages( library(hierNet)) #yes
suppressMessages( library(glmnet)) #test ridge regression for coefs
suppressMessages( library(RAMP)) #maybe
suppressMessages( library(MASS)) #for lm.ridge

suppressMessages( library(foreach)) #parallelization setup
suppressMessages( library(parallel))
suppressMessages( library(doParallel))

suppressMessages( library( lubridate)) #you know why
suppressMessages( library( colorspace)) #for some color alternatives
suppressMessages(library(RColorBrewer)) #colorRampPalette
suppressMessages( library( fields)) #for set.panel() and others 
suppressMessages( library(ggpubr)) #nice tables for dfs (uses ggplot)

suppressMessages( library( Metrics)) #measurement metrics
suppressMessages( library( caret)) #for confusion matrix
suppressMessages( library( jtools)) #lm model summaries

suppressMessages( library( tictoc)) #some timing
```

```{r data_load}
#and functions
# Data Set-Up
setwd("~/CO_AUS/Aus_CO-main/Interactions")

load( "Data/ne_data.rda")
load( "Data/se_data.rda")
load( "Data/bounded_data.rda")
load( "Data/data_matrix.rda")
load( "Data/lag_list.rda")
load( "Data/data_quantile.rda")

#functions:
setwd("~/CO_AUS/Aus_CO-main/Interactions")
#source("group_functions.R") #grouping/clustering
source("group_functionsNew.R") #new groupings
source("refit_functions.R") #coef/refit functions

setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
load("IOD_lag.rda") #data
source("predictionTest_functions.R") #predtest functions 
```

# Data Setup

```{r data_setup_new}
#season years/weeks
season_weeks <- c(35:52, 1:14)
season_years <- unique(bounded_resp_df$year)

seasons <- c()
for (i in 1:(length(season_years)-1)) {
  temp_season <- paste0(season_years[i], "-", season_years[i+1])
  #print(temp_season)  
  seasons <- c(seasons, temp_season)
}
rm(i, temp_season)

#center response data
NEbase_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEbase_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)

#Below includes removal of weeks 35-37 (adjust grouping functions if we need to change this.)
#NEAus
NEAus_1 <- NEbase_matrix[ ,4:12] 
NEAus_2 <- NEbase_matrix[ ,13:17]
NEAus_3 <- NEbase_matrix[ ,18:32]

#NEAus
SEAus_1 <- SEbase_matrix[ ,4:16] 
SEAus_2 <- SEbase_matrix[ ,17:20] 
SEAus_3 <- SEbase_matrix[ ,21:32]

NEAus_mat <- list(NEAus_1, NEAus_2, NEAus_3)
SEAus_mat <- list(SEAus_1, SEAus_2, SEAus_3)

rm(NEAus_1, NEAus_2, NEAus_3, SEAus_1, SEAus_2, SEAus_3)

#full model
NEpreds_new <- NElag_3group(NE_laglist = NE_iodlag, j = 1:19)
NEresp_new <- NEresp_3group(NEAus_mat = NEAus_mat, j = 1:19)

SEpreds_new <- SElag_3group(SE_laglist = SE_iodlag, j = 1:19)
SEresp_new <- SEresp_3group(SEAus_mat = SEAus_mat, j = 1:19)

#partial model
NEpreds_newpart <- NElag_3group(NE_laglist = NE_iodlag, j = -c(19))
NEresp_newpart <- NEresp_3group(NEAus_mat = NEAus_mat, j = -c(19))

SEpreds_newpart <- SElag_3group(SE_laglist = SE_iodlag, j = -c(19))
SEresp_newpart <- SEresp_3group(SEAus_mat = SEAus_mat, j = -c(19))


```


```{r partial_LOO}
#leaving out a single year
NEpartial_preds <- list()
NEpartial_resp <- list()
SEpartial_preds <- list()
SEpartial_resp <- list()
for (j in 1:length(seasons)) {
  #NE Aus
  NEpartial_preds[[seasons[j]]] <- NElag_3group(NE_laglist = NE_iodlag, j = -c(j))
  NEpartial_resp[[seasons[j]]] <- NEresp_3group(NEAus_mat = NEAus_mat, j = -c(j))
  
  #SE Aus
  SEpartial_preds[[seasons[j]]] <- SElag_3group(SE_laglist = SE_iodlag, j = -c(j))
  SEpartial_resp[[seasons[j]]] <- SEresp_3group(SEAus_mat = SEAus_mat, j = -c(j))
}

#extracting a single year (validation data)
NEvalid_preds <- list()
NEvalid_resp <- list()
SEvalid_preds <- list()
SEvalid_resp <- list()
for (k in 1:length(seasons)) {
  #NE Aus
  NEvalid_preds[[seasons[k]]] <- NElag_3group(NE_laglist = NE_iodlag, j = c(k))
  NEvalid_resp[[seasons[k]]] <- NEresp_3group(NEAus_mat = NEAus_mat, j = c(k))
  
  #SE Aus
  SEvalid_preds[[seasons[k]]] <- SElag_3group(SE_laglist = SE_iodlag, j = c(k))
  SEvalid_resp[[seasons[k]]] <- SEresp_3group(SEAus_mat = SEAus_mat, j = c(k))
}

```


# Functions (RAMP)

```{r refit_functions}
refit_ramp <- function(test.ramp, X_1){
  
  main.terms <- test.ramp$mainInd
  main.terms <- colnames(X_1)[main.terms]
  
  interactions <- test.ramp$interInd
      if (!is.null(interactions)){
        for (i in 1:length(interactions)){
          
          this.term <- interactions[i]
          these.subterms <- as.integer(strsplit(this.term, "X")[[1]][2:3])
          these.subterms <- colnames(X_1)[these.subterms]
          
          if (these.subterms[1] != these.subterms[2]){
            this.term <- paste(these.subterms, collapse = ":")
          } else {
            this.term <- paste0("I(", these.subterms[1], "^2)")
          }
          
          interactions[i] <- this.term
        }
      }
  
  #refit with lm
  if (!is.null(interactions)){
    model.string <- paste( paste(main.terms, collapse = " + "),
                           paste(interactions, collapse = " + "),
                           sep = " + ")
  } else {
    model.string <- paste(main.terms, collapse = " + ")
  }
  
  model.string <- paste0("co ~ ", model.string)
  
  return(model.string)
}



terms_only <- function(test.ramp, X_1){
  main.terms <- test.ramp$mainInd
  main.terms <- colnames(X_1)[main.terms]
  
  interactions <- test.ramp$interInd
      if (!is.null(interactions)){
        for (i in 1:length(interactions)){
          
          this.term <- interactions[i]
          these.subterms <- as.integer(strsplit(this.term, "X")[[1]][2:3])
          these.subterms <- colnames(X_1)[these.subterms]
          
          if (these.subterms[1] != these.subterms[2]){
            this.term <- paste(these.subterms, collapse = ":")
          } else {
            this.term <- paste0("I(", these.subterms[1], "^2)")
          }
          
          interactions[i] <- this.term
        }
      }
  return(c(main.terms, interactions))
}

```



# Refit Terms

```{r NEAus_base}
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))
#without OLR
#X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

negroup1 <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE1.terms <- terms_only(negroup1, X_1)
NE1.refit <- refit_ramp(negroup1, X_1)

#NE Aus Group 2
y_2 <- as.numeric(NEresp_new[[2]])

#with OLR
X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:312]))
#without OLR
#X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:260]))

negroup2 <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE2.terms <- terms_only(negroup2, X_2)
NE2.refit <- refit_ramp(negroup2, X_2) 
                        
#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])

#with OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:312]))
#without OLR
#X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:260]))

negroup3 <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE3.terms <- terms_only(negroup3, X_3)                      
NE3.refit <- refit_ramp(negroup3, X_3)  

NEmodels <- list(negroup1, negroup2, negroup3)
NErefits <- list(NE1.refit, NE2.refit, NE3.refit)
              
```

```{r SEAus_base}
#SE Aus Group 1
y_1 <- as.numeric(SEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:312]))
#without OLR
#X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:260]))

segroup1 <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE1.terms <- terms_only(segroup1, X_1)
SE1.refit <- refit_ramp(segroup1, X_1)

#SE Aus Group 2
y_2 <- as.numeric(SEresp_new[[2]])

#with OLR
X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:312]))
#without OLR
#X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:260]))

segroup2 <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE2.terms <- terms_only(segroup2, X_2)
SE2.refit <- refit_ramp(segroup2, X_2)

#SE Aus Group 3
y_3 <- as.numeric(SEresp_new[[3]])

#with OLR
X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:312]))
#without OLR
#X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:260]))

segroup3 <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE3.terms <- terms_only(segroup3, X_3)
SE3.refit <- refit_ramp(segroup3, X_3)

SEmodels <- list(segroup1, segroup2, segroup3)
SErefits <- list(SE1.refit, SE2.refit, SE3.refit)

```

## Refit - Base w/o OLR

```{r NEAus_noOLR}
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])

#without OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

negroup1.noOLR <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE1.terms.noOLR <- terms_only(negroup1.noOLR, X_1)
NE1.refit.noOLR <- refit_ramp(negroup1.noOLR, X_1)

#TODO: refit 
lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm.noOLR <- lm(formula(NE1.refit.noOLR), lm.data_1)
summary(NE1.lm.noOLR)

#NE Aus Group 2
y_2 <- as.numeric(NEresp_new[[2]])

#without OLR
X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:260]))

negroup2.noOLR <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE2.terms.noOLR <- terms_only(negroup2.noOLR, X_2)
NE2.refit.noOLR <- refit_ramp(negroup2.noOLR, X_2)

#refit 
lm.data_2 <- as.data.frame(cbind(y_2, X_2))
names(lm.data_2)[1] <- "co"

NE2.lm.noOLR <- lm(formula(NE2.refit.noOLR), lm.data_2)
summary(NE2.lm.noOLR)


#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])

#without OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:260]))

negroup3.noOLR <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE3.terms.noOLR <- terms_only(negroup3.noOLR, X_3)
NE3.refit.noOLR <- refit_ramp(negroup3.noOLR, X_3)

#refit 
lm.data_3 <- as.data.frame(cbind(y_3, X_3))
names(lm.data_3)[1] <- "co"

NE3.lm.noOLR <- lm(formula(NE3.refit.noOLR), lm.data_3)
summary(NE3.lm.noOLR)

NErefit.noOLR <- list(NE1.refit.noOLR, NE2.refit.noOLR, NE3.refit.noOLR)
NE.lm.noOLR <- list(NE1.lm.noOLR, NE2.lm.noOLR, NE3.lm.noOLR)

```

```{r SEAus_noOLR}
#SE Aus Group 1
y_1 <- as.numeric(SEresp_new[[1]])

#without OLR
X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:260]))

segroup1.noOLR <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE1.terms.noOLR <- terms_only(segroup1.noOLR, X_1)
SE1.refit.noOLR <- refit_ramp(segroup1.noOLR, X_1)

#TODO: refit 
lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

SE1.lm.noOLR <- lm(formula(SE1.refit.noOLR), lm.data_1)
summary(SE1.lm.noOLR)

#SE Aus Group 2
y_2 <- as.numeric(SEresp_new[[2]])

#without OLR
X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:260]))

segroup2.noOLR <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE2.terms.noOLR <- terms_only(segroup2.noOLR, X_2)
SE2.refit.noOLR <- refit_ramp(segroup2.noOLR, X_2)

#refit 
lm.data_2 <- as.data.frame(cbind(y_2, X_2))
names(lm.data_2)[1] <- "co"

SE2.lm.noOLR <- lm(formula(SE2.refit.noOLR), lm.data_2)
summary(SE2.lm.noOLR)


#SE Aus Group 3
y_3 <- as.numeric(SEresp_new[[3]])

#without OLR
X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:260]))

segroup3.noOLR <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE3.terms.noOLR <- terms_only(segroup3.noOLR, X_3)
SE3.refit.noOLR <- refit_ramp(segroup3.noOLR, X_3)

#refit 
lm.data_3 <- as.data.frame(cbind(y_3, X_3))
names(lm.data_3)[1] <- "co"

SE3.lm.noOLR <- lm(formula(SE3.refit.noOLR), lm.data_3)
summary(SE3.lm.noOLR)

SErefit.noOLR <- list(SE1.refit.noOLR, SE2.refit.noOLR, SE3.refit.noOLR)
SE.lm.noOLR <- list(SE1.lm.noOLR, SE2.lm.noOLR, SE3.lm.noOLR)

```

```{r save_noOLR}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(NE.lm.noOLR, SE.lm.noOLR, 
     NErefit.noOLR, SErefit.noOLR, file = "models_noOLR.rda")
```



# Refit w/ eBIC

```{r NEaus_ebic}
#gamma
gamma_seq <- seq(0, 1, length.out = 12)


#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])
#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))

NEAus1.eBIC <- list()
for (j in 2:length(gamma_seq)) {
  negroup1.temp <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE1.refit.temp <- refit_ramp(negroup1.temp, X_1)
  
    #refit 
  lm.data_1 <- as.data.frame(cbind(y_1, X_1))
  names(lm.data_1)[1] <- "co"
  
  NE1.lm.eBIC <- lm(formula(NE1.refit.temp), lm.data_1)
  #summary(NE1.lm.eBIC)
  NEAus1.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- NE1.lm.eBIC
}


#NE Aus Group 2
y_2 <- as.numeric(NEresp_new[[2]])
#with OLR
X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:312]))

NEAus2.eBIC <- list()
for (j in 2:length(gamma_seq)) {
  negroup2.temp <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE2.refit.temp <- refit_ramp(negroup2.temp, X_2)
  
  #refit 
  lm.data_2 <- as.data.frame(cbind(y_2, X_2))
  names(lm.data_2)[1] <- "co"
  
  NE2.lm.eBIC <- lm(formula(NE2.refit.temp), lm.data_2)
  #summary(NE1.lm.eBIC)
  NEAus2.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- NE2.lm.eBIC
}


#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])
#with OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:312]))

NEAus3.eBIC <- list()
for (j in 2:length(gamma_seq)) {
  negroup3.temp <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE3.refit.temp <- refit_ramp(negroup3.temp, X_3)
  
  #refit 
  lm.data_3 <- as.data.frame(cbind(y_3, X_3))
  names(lm.data_3)[1] <- "co"
  
  NE3.lm.eBIC <- lm(formula(NE3.refit.temp), lm.data_3)
  #summary(NE1.lm.eBIC)
  NEAus3.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- NE3.lm.eBIC
}



```

```{r SEaus_ebic}


#NE Aus Group 1
y_1 <- as.numeric(SEresp_new[[1]])
#with OLR
X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:312]))

SEAus1.eBIC <- list()
for (j in 2:length(gamma_seq)) {
  segroup1.temp <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  SE1.refit.temp <- refit_ramp(segroup1.temp, X_1)
  
    #refit 
  lm.data_1 <- as.data.frame(cbind(y_1, X_1))
  names(lm.data_1)[1] <- "co"
  
  SE1.lm.eBIC <- lm(formula(SE1.refit.temp), lm.data_1)
  #summary(NE1.lm.eBIC)
  SEAus1.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- SE1.lm.eBIC
}


#NE Aus Group 2
y_2 <- as.numeric(SEresp_new[[2]])
#with OLR
X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:312]))

SEAus2.eBIC <- list()
for (j in 2:length(gamma_seq)) {
  segroup2.temp <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  SE2.refit.temp <- refit_ramp(segroup2.temp, X_2)
  
  #refit 
  lm.data_2 <- as.data.frame(cbind(y_2, X_2))
  names(lm.data_2)[1] <- "co"
  
  SE2.lm.eBIC <- lm(formula(SE2.refit.temp), lm.data_2)
  #summary(NE1.lm.eBIC)
  SEAus2.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- SE2.lm.eBIC
}


#NE Aus Group 3
y_3 <- as.numeric(SEresp_new[[3]])
#with OLR
X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:312]))

SEAus3.eBIC <- list()
for (j in 2:length(gamma_seq)) {
  segroup3.temp <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  SE3.refit.temp <- refit_ramp(segroup3.temp, X_3)
  
  #refit 
  lm.data_3 <- as.data.frame(cbind(y_3, X_3))
  names(lm.data_3)[1] <- "co"
  
  SE3.lm.eBIC <- lm(formula(SE3.refit.temp), lm.data_3)
  #summary(NE1.lm.eBIC)
  SEAus3.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- SE3.lm.eBIC
}


```

```{r save_ebic}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(NEAus1.eBIC, NEAus2.eBIC, NEAus3.eBIC,
      SEAus1.eBIC, SEAus2.eBIC, SEAus3.eBIC, file = "models_ebic.rda")
```

# Refit w/ eBIC no OLR

```{r NEaus_ebic_noOLR}
#gamma
gamma_seq <- seq(0, 1, length.out = 10)

#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])
#without OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

NEAus1.eBIC.noOLR <- list()
for (j in 2:length(gamma_seq)) {
  negroup1.temp <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE1.refit.temp <- refit_ramp(negroup1.temp, X_1)
  
    #refit 
  lm.data_1 <- as.data.frame(cbind(y_1, X_1))
  names(lm.data_1)[1] <- "co"
  
  NE1.lm.eBIC <- lm(formula(NE1.refit.temp), lm.data_1)
  #summary(NE1.lm.eBIC)
  NEAus1.eBIC.noOLR[[paste0("Gamma:", gamma_seq[[j]])]] <- NE1.lm.eBIC
}


#NE Aus Group 2
y_2 <- as.numeric(NEresp_new[[2]])
#without OLR
X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:260]))

NEAus2.eBIC.noOLR <- list()
for (j in 2:length(gamma_seq)) {
  negroup2.temp <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE2.refit.temp <- refit_ramp(negroup2.temp, X_2)
  
  #refit 
  lm.data_2 <- as.data.frame(cbind(y_2, X_2))
  names(lm.data_2)[1] <- "co"
  
  NE2.lm.eBIC <- lm(formula(NE2.refit.temp), lm.data_2)
  #summary(NE1.lm.eBIC)
  NEAus2.eBIC.noOLR[[paste0("Gamma:", gamma_seq[[j]])]] <- NE2.lm.eBIC
}


#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])
#without OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:260]))

NEAus3.eBIC.noOLR <- list()
for (j in 2:length(gamma_seq)) {
  negroup3.temp <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE3.refit.temp <- refit_ramp(negroup3.temp, X_3)
  
  #refit 
  lm.data_3 <- as.data.frame(cbind(y_3, X_3))
  names(lm.data_3)[1] <- "co"
  
  NE3.lm.eBIC <- lm(formula(NE3.refit.temp), lm.data_3)
  #summary(NE1.lm.eBIC)
  NEAus3.eBIC.noOLR[[paste0("Gamma:", gamma_seq[[j]])]] <- NE3.lm.eBIC
}

```

```{r save}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(NEAus1.eBIC.noOLR, NEAus2.eBIC.noOLR, NEAus3.eBIC.noOLR, file = "models_ebic_noOLR.rda")
```



### Direct Comparison

base, noOLR, and eBIC models

```{r model_summ_NEAus}
#get eBIC gamma val 
##gamma_seq[2] #0.091

#NE Aus Group 1
NE1 <- NE.lms[[1]]
NE1.noOLR <- NE.lm.noOLR[[1]]
NE1.eBIC.1 <- NEAus1.eBIC[[1]] #gamma = 0.091
NE1.eBIC.2 <- NEAus1.eBIC[[2]] #gamma = 0.182
NE1.eBIC.3 <- NEAus1.eBIC[[3]] #gamma = 0.273

summ(NE1, confint = TRUE, digits = 3, vifs = TRUE)
summ(NE1.noOLR, confint = TRUE, digits = 3, vifs = TRUE)
#summ(NE1.eBIC.1, confint = TRUE, digits = 3)
summ(NE1.eBIC.3, confint = TRUE, digits = 3)

#export_summs(NE1, NE1.noOLR, scale = FALSE, 
#             error_format = "[{conf.low}, {conf.high}]", 
#             model.names = c("NE Group 1","NE Group 1 (w/o OLR)"))

export_summs(NE1, NE1.eBIC.3, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")

#NE Aus Group 2
NE2 <- NE.lms[[2]]
NE2.noOLR <- NE.lm.noOLR[[2]]

export_summs(NE2, NE2.noOLR, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")


#NE Aus Group 3
NE3 <- NE.lms[[3]]
NE3.noOLR <- NE.lm.noOLR[[3]]

export_summs(NE3, NE3.noOLR, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")
```

```{r model_summ_SEAus}
#SE Aus Group 1
SE1 <- SE.lms[[1]]
SE1.noOLR <- SE.lm.noOLR[[1]]

export_summs(SE1, SE1.noOLR, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")


#SE Aus Group 2
SE2 <- SE.lms[[2]]
SE2.noOLR <- SE.lm.noOLR[[2]]

export_summs(SE2, SE2.noOLR, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")

#SE Aus Group 3
SE3 <- SE.lms[[3]]
SE3.noOLR <- SE.lm.noOLR[[3]]

export_summs(SE3, SE3.noOLR, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")
```



## Refit - LOO

```{r NEAus_refit}

#NE Aus 
NE.term.list <- NULL
NE.model.list <- NULL
NE.refit.list <- NULL #refit with base model
for (j in 1:length(seasons)) {
  temp.resp <- NEpartial_resp[[j]]
  temp.preds <- NEpartial_preds[[j]]
  
  temp.list <- NULL
  temp.model <- NULL
  temp.refit <- NULL
  for (k in 1:length(temp.preds)) {
    temp.y <- as.numeric(temp.resp[[k]])
    #with OLR
    temp.X <- cbind(as.matrix(temp.preds[[k]][ ,1:312]))
    
    temp.fit <- RAMP(X = temp.X, y = temp.y,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)
    #terms only
    temp.list[[k]] <- terms_only(temp.fit, temp.X)
    temp.model[[k]] <- refit_ramp(temp.fit, temp.X)
    temp.refit[[k]] <- refit_ramp(NEmodels[[k]], temp.X)
  }
  NE.term.list[[seasons[j]]] <- temp.list
  NE.model.list[[seasons[j]]] <- temp.model
  NE.refit.list[[seasons[j]]] <- temp.refit
}

```

```{r sEAus_refit}

#sE Aus 
SE.term.list <- NULL
SE.model.list <- NULL
SE.refit.list <- NULL #refit with base model
for (j in 1:length(seasons)) {
  temp.resp <- SEpartial_resp[[j]]
  temp.preds <- SEpartial_preds[[j]]
  
  temp.list <- NULL
  temp.model <- NULL
  temp.refit <- NULL
  for (k in 1:length(temp.preds)) {
    temp.y <- as.numeric(temp.resp[[k]])
    #with OLR
    temp.X <- cbind(as.matrix(temp.preds[[k]][ ,1:312]))
    
    temp.fit <- RAMP(X = temp.X, y = temp.y,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)
    #terms only
    temp.list[[k]] <- terms_only(temp.fit, temp.X)
    temp.model[[k]] <- refit_ramp(temp.fit, temp.X)
    temp.refit[[k]] <- refit_ramp(SEmodels[[k]], temp.X)
  }
  SE.term.list[[seasons[j]]] <- temp.list
  SE.model.list[[seasons[j]]] <- temp.model
  SE.refit.list[[seasons[j]]] <- temp.refit
}

```

```{r save}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(SE.term.list, SE.model.list, SE.refit.list, 
     NE.term.list, NE.model.list, NE.refit.list, file = "model_refits.rda")
```

```{r load_backin}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
load( "model_refits.rda")
```

### Refit - LOO no OLR

```{r NErefit_sansOLR}
#Test work, finalize with loop when done.
#TODO: finalize this for all years

j <- 19
seasons[j]
temp.resp <- NEpartial_resp[[j]]
temp.preds <- NEpartial_preds[[j]]

#for (k in 1:length(temp.preds)) {
k <- 2
temp.y <- as.numeric(temp.resp[[k]])
#without OLR
temp.X <- cbind(as.matrix(temp.preds[[k]][ ,1:260]))

    temp.fit <- RAMP(X = temp.X, y = temp.y,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)
    #terms only
terms_only(temp.fit, temp.X)
refit_ramp(temp.fit, temp.X)
#refit_ramp(NEmodels[[k]], temp.X)
```

### Refit - eBIC

```{r NErefit_eBIC}

```


## Comparison to Base

```{r NeAus_compare}
#NE Aus Group 1

#get frequency of each term 
baseNE1 <- NE1.terms
#refitNE1 <- NE.term.list[[2]][[1]]

refitNE1 <- unlist(lapply(NE.term.list, function(x) x[[1]]))
baseNE1.count <- sapply(baseNE1, function(x) sum(x == refitNE1))



#unique(refitNE1)
NErefit1.unique <- table(refitNE1)
NErefit1.unique <- NErefit1.unique[!names(NErefit1.unique) %in% baseNE1]
refitNE1.count <- sort(NErefit1.unique, decreasing = TRUE)

#group 2
baseNE2 <- NE2.terms
#refitNE2 <- NE.term.list[[2]][[2]]

refitNE2 <- unlist(lapply(NE.term.list, function(x) x[[2]]))
baseNE2.count <- sapply(baseNE2, function(x) sum(x == refitNE2))
#unique(refitNE2)
NErefit2.unique <- table(refitNE2)
NErefit2.unique <- NErefit2.unique[!names(NErefit2.unique) %in% baseNE2]
refitNE2.count <- sort(NErefit2.unique, decreasing = TRUE)


#group 3
baseNE3 <- NE3.terms
#refitNE3 <- NE.term.list[[2]][[3]]

refitNE3 <- unlist(lapply(NE.term.list, function(x) x[[3]]))
baseNE3.count <- sapply(baseNE3, function(x) sum(x == refitNE3))
#unique(refitNE3)
NErefit3.unique <- table(refitNE3)
NErefit3.unique <- NErefit3.unique[!names(NErefit3.unique) %in% baseNE3]
refitNE3.count <- sort(NErefit3.unique, decreasing = TRUE)

```

```{r seAus_compare}
#sE Aus Group 1

#get frequency of each term 
baseSE1 <- SE1.terms
#refitSE1 <- SE.term.list[[2]][[1]]

refitSE1 <- unlist(lapply(SE.term.list, function(x) x[[1]]))
baseSE1.count <- sapply(baseSE1, function(x) sum(x == refitSE1))
#unique(refitSE1)
SErefit1.unique <- table(refitSE1)
SErefit1.unique <- SErefit1.unique[!names(SErefit1.unique) %in% baseSE1]
refitSE1.count <- sort(SErefit1.unique, decreasing = TRUE)


#group 2
baseSE2 <- SE2.terms
#refitSE2 <- SE.term.list[[2]][[2]]

refitSE2 <- unlist(lapply(SE.term.list, function(x) x[[2]]))
baseSE2.count <- sapply(baseSE2, function(x) sum(x == refitSE2))
#unique(refitSE2)
SErefit2.unique <- table(refitSE2)
SErefit2.unique <- SErefit2.unique[!names(SErefit2.unique) %in% baseSE2]
refitSE2.count <- sort(SErefit2.unique, decreasing = TRUE)

#group 3
baseSE3 <- SE3.terms
#refitSE3 <- SE.term.list[[2]][[3]]

refitSE3 <- unlist(lapply(SE.term.list, function(x) x[[3]]))
baseSE3.count <- sapply(baseSE3, function(x) sum(x == refitSE3))
#unique(refitSE3)
SErefit3.unique <- table(refitSE3)
SErefit3.unique <- SErefit3.unique[!names(SErefit3.unique) %in% baseSE3]
refitSE3.count <- sort(SErefit3.unique, decreasing = TRUE)

```


### Proportion/Count Figures

```{r setup}
rateNE1.const <- sort(baseNE1.count, decreasing = FALSE)/19
rateNE2.const <- sort(baseNE2.count, decreasing = FALSE)/19
rateNE3.const <- sort(baseNE3.count, decreasing = FALSE)/19

rateSE1.const <- sort(baseSE1.count, decreasing = FALSE)/19
rateSE2.const <- sort(baseSE2.count, decreasing = FALSE)/19
rateSE3.const <- sort(baseSE3.count, decreasing = FALSE)/19

cols.ryg19 <- colorRampPalette(brewer.pal(11, "RdYlGn"))(19)
col.seq <- 1:19/19

col.NE1 <- cols.ryg19[match(rateNE1.const, col.seq)]
col.NE2 <- cols.ryg19[match(rateNE2.const, col.seq)]
col.NE3 <- cols.ryg19[match(rateNE3.const, col.seq)]

col.SE1 <- cols.ryg19[match(rateSE1.const, col.seq)]
col.SE2 <- cols.ryg19[match(rateSE2.const, col.seq)]
col.SE3 <- cols.ryg19[match(rateSE3.const, col.seq)]

#other terms
temp.refitNE1 <- refitNE1.count[refitNE1.count > 1]
NE1x_vals <- rep(seq_along(temp.refitNE1), times = temp.refitNE1)
NE1y_vals <- unlist(lapply(temp.refitNE1, function(n) seq_len(n)))

dumb.expansion <- factor(rep(names(temp.refitNE1), times = temp.refitNE1))
is.factor(dumb.expansion)
```

```{r base.fits}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "NE1.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateNE1.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.NE1, xlab = "Proportion")
title("NE Aus Group 1", adj = 0)
dev.off()

png(filename = "NE2.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateNE2.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.NE2, xlab = "Proportion")
title("NE Aus Group 2", adj = 0)
dev.off()

png(filename = "NE3.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateNE3.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.NE3, xlab = "Proportion")
title("NE Aus Group 3", adj = 0)
dev.off()

png(filename = "SE1.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateSE1.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.SE1, xlab = "Proportion")
title("SE Aus Group 1", adj = 0)
dev.off()

png(filename = "SE2.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateSE2.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.SE2, xlab = "Proportion")
title("SE Aus Group 2", adj = 0)
dev.off()

png(filename = "SE3.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateSE3.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.SE3, xlab = "Proportion")
title("SE Aus Group 3", adj = 0)
dev.off()

```

```{r term_count}
#NE 1
temp.refitNE1 <- refitNE1.count[refitNE1.count > 1]

NE1.expansion <- factor(rep(names(temp.refitNE1), times = temp.refitNE1)) #change to numbers than overwrite the labels
NE1.levels <- levels(NE1.expansion)
NE1.exp <- as.numeric(NE1.expansion)

#NE 2
temp.refitNE2 <- refitNE2.count[refitNE2.count > 1]

NE2.expansion <- factor(rep(names(temp.refitNE2), times = temp.refitNE2)) #change to numbers than overwrite the labels
NE2.levels <- levels(NE2.expansion)
NE2.exp <- as.numeric(NE2.expansion)

#NE 3
temp.refitNE3 <- refitNE3.count[refitNE3.count > 1]

NE3.expansion <- factor(rep(names(temp.refitNE3), times = temp.refitNE3)) #change to numbers than overwrite the labels
NE3.levels <- levels(NE3.expansion)
NE3.exp <- as.numeric(NE3.expansion)


#SE 1
temp.refitSE1 <- refitSE1.count[refitSE1.count > 1]

SE1.expansion <- factor(rep(names(temp.refitSE1), times = temp.refitSE1)) #change to numbers than overwrite the labels
SE1.levels <- levels(SE1.expansion)
SE1.exp <- as.numeric(SE1.expansion)

#SE 2
temp.refitSE2 <- refitSE2.count[refitSE2.count > 1]

SE2.expansion <- factor(rep(names(temp.refitSE2), times = temp.refitSE2)) #change to numbers than overwrite the labels
SE2.levels <- levels(SE2.expansion)
SE2.exp <- as.numeric(SE2.expansion)

#SE 3
temp.refitSE3 <- refitSE3.count[refitSE3.count > 1]

SE3.expansion <- factor(rep(names(temp.refitSE3), times = temp.refitSE3)) #change to numbers than overwrite the labels
SE3.levels <- levels(SE3.expansion)
SE3.exp <- as.numeric(SE3.expansion)


```

```{r refits}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "NE1varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(NE1.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(NE1.levels), labels = NE1.levels, las = 1, cex = 0.75)
title("NE Aus Group 1  ", adj = 0)
dev.off()


png(filename = "NE2varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(NE2.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(NE2.levels), labels = NE2.levels, las = 1, cex = 0.75)
title("NE Aus Group 2  ", adj = 0)
dev.off()


png(filename = "NE3varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(NE3.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(NE3.levels), labels = NE3.levels, las = 1, cex = 0.75)
title("NE Aus Group 3  ", adj = 0)
dev.off()


png(filename = "SE1varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(SE1.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(SE1.levels), labels = SE1.levels, las = 1, cex = 0.75)
title("SE Aus Group 1  ", adj = 0)
dev.off()

png(filename = "SE2varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(SE2.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(SE2.levels), labels = SE2.levels, las = 1, cex = 0.75)
title("SE Aus Group 2  ", adj = 0)
dev.off()

png(filename = "SE3varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(SE3.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(SE3.levels), labels = SE3.levels, las = 1, cex = 0.75)
title("SE Aus Group 3  ", adj = 0)
dev.off()
```

# Model Validation


```{r test_model_fits}
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))


lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm <- lm(formula(NE1.refit), lm.data_1)
summary(NE1.lm)


NEvalid_preds[[1]][[1]]
y.true <- NEvalid_resp[[1]][[1]]

y.pred <- predict(NE1.lm, NEvalid_preds[[1]][[1]], se.fit = TRUE)

y.pred$fit
y.pred$se.fit

CPRS(list(mean = y.pred$fit, sd = y.pred$se.fit), y.true)
intscore(list(mean = y.pred$fit, sd = y.pred$se.fit), y.true)

y.true
y.pred
y.true - y.pred

#without OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm.noOLR <- lm(formula(NE1.refit.noOLR), lm.data_1)
summary(NE1.lm.noOLR)

test.X <- NEvalid_preds[[1]][[1]][ ,1:260]
y.pred.noOLR <- predict(NE1.lm.noOLR, test.X)

y.true
y.pred.noOLR
y.true - y.pred.noOLR
```

```{r base_NElm}
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))

lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm <- lm(formula(NE1.refit), lm.data_1)
summary(NE1.lm)

#NE Aus Group 2
y_2 <- as.numeric(NEresp_new[[2]])

#with OLR
X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:312]))

lm.data_2 <- as.data.frame(cbind(y_2, X_2))
names(lm.data_2)[1] <- "co"

NE2.lm <- lm(formula(NE2.refit), lm.data_2)
summary(NE2.lm)

#without OLR
#X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:260]))

#lm.data_2 <- as.data.frame(cbind(y_2, X_2))
#names(lm.data_2)[1] <- "co"

#NE2.lm.noOLR <- lm(formula(NE2.refit.noOLR), lm.data_2)
#summary(NE2.lm.noOLR)


#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])

#with OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:312]))

lm.data_3 <- as.data.frame(cbind(y_3, X_3))
names(lm.data_3)[1] <- "co"

NE3.lm <- lm(formula(NE3.refit), lm.data_3)
summary(NE3.lm)


NE.lms <- list(NE1.lm, NE2.lm, NE3.lm)

```

```{r base_SElm}
#SE Aus Group 1
y_1 <- as.numeric(SEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:312]))

lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

SE1.lm <- lm(formula(SE1.refit), lm.data_1)
summary(SE1.lm)

#SE Aus Group 2
y_2 <- as.numeric(SEresp_new[[2]])

#with OLR
X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:312]))

lm.data_2 <- as.data.frame(cbind(y_2, X_2))
names(lm.data_2)[1] <- "co"

SE2.lm <- lm(formula(SE2.refit), lm.data_2)
summary(SE2.lm)

#SE Aus Group 3
y_3 <- as.numeric(SEresp_new[[3]])

#with OLR
X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:312]))

lm.data_3 <- as.data.frame(cbind(y_3, X_3))
names(lm.data_3)[1] <- "co"

SE3.lm <- lm(formula(SE3.refit), lm.data_3)
summary(SE3.lm)


SE.lms <- list(SE1.lm, SE2.lm, SE3.lm)
```


## LOO Validation

Includes:
rmse, crps, Int score
TODO: add in OOS adj. R^2

```{r model_fits_validation}

#lists
## full model fit: NErefits
## LOO model w/ constant terms: NE.refit.list
## LOO model w/ varying terms: NE.model.list

#rmse 
#TODO: functionalize this so I can repeat for other setups
NE.rmse <- NULL
NE.cprs <- NULL
NE.ints <- NULL
NE.const.LM <- NULL #linear models
for (i in 1:length(seasons)) {
  fit.resp <- NEpartial_resp[[i]]
  fit.preds <- NEpartial_preds[[i]]
  
  valid.resp <- NEvalid_resp[[i]]
  valid.preds <- NEvalid_preds[[i]]
  
  #get terms/model for year/season 
  year.constant <- NE.refit.list[[i]]
  year.varying <- NE.model.list[[i]]
  
  #add in lists/matrices
  NE.loo <- NULL #
  NErmse.yearly <- matrix(NA, ncol = 3)
  colnames(NErmse.yearly) <- c("base.pred", "const.pred", "vary.pred")
  NEcprs.yearly <- matrix(NA, ncol = 3)
  colnames(NEcprs.yearly) <- c("base.pred", "const.pred", "vary.pred")
  NEis.yearly <- matrix(NA, ncol = 3)
  colnames(NEis.yearly) <- c("base.pred", "const.pred", "vary.pred")
  #groups/clusters below
  for (j in 1:3) {
    #lm fit data setup
    y.fit <- as.numeric(fit.resp[[j]])
    #with OLR
    X.fit <- cbind(as.matrix(fit.preds[[j]][ ,1:312]))
    
    lm.data.fit <- as.data.frame(cbind(y.fit, X.fit))
    names(lm.data.fit)[1] <- "co"

    #fit lm models (w/o year/season)
    temp.lm.constant <- lm(formula(year.constant[[j]]), lm.data.fit)
    temp.lm.varying <- lm(formula(year.varying[[j]]), lm.data.fit)
    
    #predict/rmse
    X.valid <- valid.preds[[j]][ ,1:312]
    y.valid <- valid.resp[[j]]
    
    #prediction
    pred.base <- predict(NE.lms[[j]], X.valid, se.fit = TRUE)
    pred.const <- predict(temp.lm.constant, X.valid, se.fit = TRUE)
    pred.vary <- predict(temp.lm.varying, X.valid, se.fit = TRUE)
    
    #predict( ,se.fit = TRUE)
    y.pred.base <- pred.base$fit 
    y.pred.const <- pred.const$fit
    y.pred.vary <- pred.vary$fit
    
    #rmse test
    rmse.base <-  rmse(y.valid, y.pred.base)
    rmse.const <- rmse(y.valid, y.pred.const)
    rmse.vary <- rmse(y.valid, y.pred.vary)
    
    #cprs
    cprs.base <- mean(CPRS(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    cprs.const <- mean(CPRS(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    cprs.vary <- mean(CPRS(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    #IS95
    is.base <- mean(intscore(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    is.const <- mean(intscore(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    is.vary <- mean(intscore(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    #assign data
    RMSE.temp.mat <- cbind(rmse.base, rmse.const, rmse.vary)
    NErmse.yearly <- rbind(NErmse.yearly, RMSE.temp.mat) 
    CPRS.temp.mat <- cbind(cprs.base, cprs.const, cprs.vary)
    NEcprs.yearly <- rbind(NEcprs.yearly, CPRS.temp.mat)
    IS.temp.mat <- cbind(is.base, is.const, is.vary)
    NEis.yearly <- rbind(NEis.yearly, IS.temp.mat)
    
    NE.loo[[j]] <- temp.lm.constant
  }
  #NErmse.yearly <- as.data.frame(NErmse.yearly[-1, ])
  NE.rmse[[seasons[i]]] <- as.data.frame(NErmse.yearly[-1, ])
  NE.cprs[[seasons[i]]] <- as.data.frame(NEcprs.yearly[-1, ])
  NE.ints[[seasons[i]]] <- as.data.frame(NEis.yearly[-1, ])
  NE.const.LM[[seasons[i]]] <- NE.loo
  
}


#TODO: add more validation
#rmse 
SE.rmse <- NULL
SE.cprs <- NULL
SE.ints <- NULL
SE.const.LM <- NULL #linear models
SE.vary.LM <- NULL
for (i in 1:length(seasons)) {
  fit.resp <- SEpartial_resp[[i]]
  fit.preds <- SEpartial_preds[[i]]
  
  valid.resp <- SEvalid_resp[[i]]
  valid.preds <- SEvalid_preds[[i]]
  
  #get terms/model for year/season 
  year.constant <- SE.refit.list[[i]]
  year.varying <- SE.model.list[[i]]
  
  #add in lists/matrices
  SE.loo <- NULL #
  SE.var <- NULL 
  SErmse.yearly <- matrix(NA, ncol = 3)
  colnames(SErmse.yearly) <- c("base.pred", "const.pred", "vary.pred")
  SEcprs.yearly <- matrix(NA, ncol = 3)
  colnames(SEcprs.yearly) <- c("base.pred", "const.pred", "vary.pred")
  SEis.yearly <- matrix(NA, ncol = 3)
  colnames(SEis.yearly) <- c("base.pred", "const.pred", "vary.pred")
  #groups/clusters below
  for (j in 1:3) {
    #lm fit data setup
    y.fit <- as.numeric(fit.resp[[j]])
    #with OLR
    X.fit <- cbind(as.matrix(fit.preds[[j]][ ,1:312]))
    
    lm.data.fit <- as.data.frame(cbind(y.fit, X.fit))
    names(lm.data.fit)[1] <- "co"

    #fit lm models (w/o year/season)
    temp.lm.constant <- lm(formula(year.constant[[j]]), lm.data.fit)
    temp.lm.varying <- lm(formula(year.varying[[j]]), lm.data.fit)
    
    #predict/rmse
    X.valid <- valid.preds[[j]][ ,1:312]
    y.valid <- valid.resp[[j]]
    
    #prediction
    pred.base <- predict(SE.lms[[j]], X.valid, se.fit = TRUE)
    pred.const <- predict(temp.lm.constant, X.valid, se.fit = TRUE)
    pred.vary <- predict(temp.lm.varying, X.valid, se.fit = TRUE)
    
    y.pred.base <- pred.base$fit 
    y.pred.const <- pred.const$fit
    y.pred.vary <- pred.vary$fit
    
    #rmse test
    rmse.base <-  rmse(y.valid, y.pred.base)
    rmse.const <- rmse(y.valid, y.pred.const)
    rmse.vary <- rmse(y.valid, y.pred.vary)
    
    #cprs
    cprs.base <- mean(CPRS(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    cprs.const <- mean(CPRS(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    cprs.vary <- mean(CPRS(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    #IS95
    is.base <- mean(intscore(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    is.const <- mean(intscore(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    is.vary <- mean(intscore(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    temp.mat <- cbind(rmse.base, rmse.const, rmse.vary)
    SErmse.yearly <- rbind(SErmse.yearly, temp.mat) 
    CPRS.temp.mat <- cbind(cprs.base, cprs.const, cprs.vary)
    SEcprs.yearly <- rbind(SEcprs.yearly, CPRS.temp.mat)
    IS.temp.mat <- cbind(is.base, is.const, is.vary)
    SEis.yearly <- rbind(SEis.yearly, IS.temp.mat)
    
    SE.loo[[j]] <- temp.lm.constant
    SE.var[[j]] <- temp.lm.varying
  }
  #NErmse.yearly <- as.data.frame(NErmse.yearly[-1, ])
  SE.rmse[[seasons[i]]] <- as.data.frame(SErmse.yearly[-1, ])
  SE.cprs[[seasons[i]]] <- as.data.frame(SEcprs.yearly[-1, ])
  SE.ints[[seasons[i]]] <- as.data.frame(SEis.yearly[-1, ])
  SE.const.LM[[seasons[i]]] <- SE.loo
  SE.vary.LM[[seasons[i]]] <- SE.var
}

```

```{r test_oosR2}
#TODO: get out of sample R2 working then merge it into previous block validation code.

```


### Model Summaries

```{r summ_outputs}
summ(SE.vary.LM$`2019-2020`[[2]], confint = TRUE, digits = 3)

library( officer)
library( flextable)

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

NE1 <- NE.lms[[1]]
NE1.wo2019 <- NE.const.LM$`2019-2020`[[1]]

export_summs(NE1, NE1.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("NE Group 1","NE Group 1 (w/o 2019)"),
             to.file = "docx", file.name = "NE1models.docx")

NE2 <- NE.lms[[2]]
NE2.wo2019 <- NE.const.LM$`2019-2020`[[2]]

export_summs(NE2, NE2.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("NE Group 2","NE Group 2 (w/o 2019)"),
             to.file = "docx", file.name = "NE2models.docx", longtable = TRUE)

NE3 <- NE.lms[[3]]
NE3.wo2019 <- NE.const.LM$`2019-2020`[[3]]

export_summs(NE3, NE3.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("NE Group 3","NE Group 3 (w/o 2019)"),
             to.file = "docx", file.name = "NE3models.docx", longtable = TRUE)


SE1 <- SE.lms[[1]]
SE1.wo2019 <- SE.const.LM$`2019-2020`[[1]]

export_summs(SE1, SE1.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("SE Group 1","SE Group 1 (w/o 2019)"),
             to.file = "docx", file.name = "SE1models.docx", longtable = TRUE)

SE2 <- SE.lms[[2]]
SE2.wo2019 <- SE.const.LM$`2019-2020`[[2]]

export_summs(SE2, SE2.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("SE Group 2","SE Group 2 (w/o 2019)"),
             to.file = "docx", file.name = "SE2models.docx", longtable = TRUE)

SE3 <- SE.lms[[3]]
SE3.wo2019 <- SE.const.LM$`2019-2020`[[3]]

export_summs(SE3, SE3.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("SE Group 3","SE Group 3 (w/o 2019)"),
             to.file = "docx", file.name = "SE3models.docx", longtable = TRUE)

```


```{r basic_sumaries}
summ(NE.lms[[1]], confint = TRUE, digits = 3)
summ(NE.lms[[2]], confint = TRUE, digits = 3)
summ(NE.lms[[3]], confint = TRUE, digits = 3)

summ(SE.lms[[1]], confint = TRUE, digits = 3)
summ(SE.lms[[2]], confint = TRUE, digits = 3)
summ(SE.lms[[3]], confint = TRUE, digits = 3)

```


### Seasonal Overlap

Known WTIO/ETIO Lags:
NE Aus Group 1: etio_lag42
NE Aus Group 2: wtio_lag30, etio_lag4
NE Aus Group 3: etio_lag19

SE Aus Group 1: wtio_lag4, wtio_lag5, wtio_lag13, etio_lag31
SE Aus Group 2: wtio_lag14, wtio_lag46, etio_lag7, etio_lag33
SE Aus Group 3: wtio_lag1, etio_lag15

```{r overlaps}
#setup
NEAus1_weeks <- season_weeks[4:12]
NEAus2_weeks <- season_weeks[13:17]
NEAus3_weeks <- season_weeks[18:32]

SEAus1_weeks <- season_weeks[4:16]
SEAus2_weeks <- season_weeks[17:20]
SEAus3_weeks <- season_weeks[21:32]

#TODO: make this more flexible

# NE Aus 1
#etio_lag42
NEAus1_lag42 <- NEAus1_weeks - 42
NEAus1_lag42 <- sapply(NEAus1_lag42, function(x) ifelse(x <=0, x + 52, x)) 
NEAus1_lag42

#NE Aus 2
#wtio_lag30
NEAus2_lag30 <- NEAus2_weeks - 30
NEAus2_lag30

#etio_lag4
NEAus2_lag4 <- NEAus2_weeks - 4
NEAus2_lag4

#NE Aus 3
#etio_lag19
NEAus3_lag19 <- NEAus3_weeks - 19
NEAus3_lag19 <- sapply(NEAus3_lag19, function(x) ifelse(x <=0, x + 52, x)) 
NEAus3_lag19  

#SE Aus 1
#wtio_lag4
SEAus1_lag4 <- SEAus1_weeks - 4
SEAus1_lag4

#wtio_lag5
SEAus1_lag5 <- SEAus1_weeks - 5
SEAus1_lag5

#wtio_lag13
SEAus1_lag13 <- SEAus1_weeks - 13
SEAus1_lag13

#etio_lag31
SEAus1_lag31 <- SEAus1_weeks - 31
SEAus1_lag31

#SE Aus 2
#wtio_lag14
SEAus2_lag14 <-  SEAus2_weeks - 14
SEAus2_lag14 <- sapply(SEAus2_lag14, function(x) ifelse(x <=0, x + 52, x)) 
SEAus2_lag14 

#wtio_lag46
SEAus2_lag46 <-  SEAus2_weeks - 46
SEAus2_lag46 <- sapply(SEAus2_lag46, function(x) ifelse(x <=0, x + 52, x)) 
SEAus2_lag46 

#etio_lag7
SEAus2_lag7 <-  SEAus2_weeks - 7
SEAus2_lag7 <- sapply(SEAus2_lag7, function(x) ifelse(x <=0, x + 52, x)) 
SEAus2_lag7 

#etio_lag33
SEAus2_lag33 <-  SEAus2_weeks - 33
SEAus2_lag33 <- sapply(SEAus2_lag33, function(x) ifelse(x <=0, x + 52, x)) 
SEAus2_lag33

#SE Aus 3
#wtio_lag1
SEAus3_lag1 <- SEAus3_weeks -1 
SEAus3_lag1

#etio_lag15
SEAus3_lag15 <- SEAus3_weeks - 15
SEAus3_lag15 <- sapply(SEAus3_lag15, function(x) ifelse(x <=0, x + 52, x)) 
SEAus3_lag15

#organize data

#wtio first
wtio.names <- c("NEAus2:wtiolag30", "SEAus1:wtiolag4",  "SEAus1:wtiolag5", "SEAus1:wtiolag13",
               "SEAus2:wtiolag14", "SEAus2:wtiolag46", "SEAus3:wtiolag1")
wtio.start <- c(NEAus2_lag30[1], min(SEAus1_lag4),  min(SEAus1_lag5),  min(SEAus1_lag13), 
                min(SEAus2_lag14), min(SEAus2_lag46), min(SEAus3_lag1))
wtio.end <- c(NEAus2_lag30[length(NEAus2_lag30)], max(SEAus1_lag4),  max(SEAus1_lag5),  max(SEAus1_lag13), 
              max(SEAus2_lag14), max(SEAus2_lag46), max(SEAus3_lag1))
wtio.lag.df <- data.frame(lag = wtio.names, start = wtio.start, end = wtio.end)
wtio.lag.df <- wtio.lag.df[nrow(wtio.lag.df):1, ]

#etio lags
etio.names <- c("NEAus1:etiolag42",  "NEAus2:etiolag4", "NEAus3:etiolag19", "SEAus1:etiolag31",
                "SEAus2:etiolag7", "SEAus2:etiolag33", "SEAus3:etiolag15")
etio.start <- c(NEAus1_lag42[1],  min(NEAus2_lag4), min(NEAus3_lag19), min(SEAus1_lag31),
                min(SEAus2_lag7), min(SEAus2_lag33), min(SEAus3_lag15))
etio.end <- c(max(NEAus1_lag42), max(NEAus2_lag4), max(NEAus3_lag19), max(SEAus1_lag31),
              max(SEAus2_lag7), max(SEAus2_lag33), max(SEAus3_lag15))
etio.lag.df <- data.frame(lag = etio.names, start = etio.start, end = etio.end)
etio.lag.df <- etio.lag.df[nrow(etio.lag.df):1, ]

etio.overlap <- c(length(etio.names), min(NEAus1_lag42), NEAus1_lag42[length(NEAus1_lag42)])


```

```{r coef_setup}
coef.etio <- NULL
coef.etio <- NULL

NE1 <- NE.lms[[1]]
coef.etio <- NE1$coefficients[3] #etio_lag42 

NE2 <- NE.lms[[2]]
coef.wtio <- NE2$coefficients[5] #wtio_lag30 
coef.etio <- c(coef.etio, NE2$coefficients[6] ) #etio_lag4 

NE3 <- NE.lms[[3]]
coef.etio <- c(coef.etio, NE3$coefficients[3] ) #etio_lag19 

SE1 <- SE.lms[[1]]
#SE1$coefficients
coef.wtio <- c(coef.wtio, SE1$coefficients[4]) #wtio_lag4
coef.wtio <- c(coef.wtio, SE1$coefficients[5]) #wtio_lag5 
coef.wtio <- c(coef.wtio, SE1$coefficients[6]) #wtio_lag13            
coef.etio <- c(coef.etio, SE1$coefficients[7]) #etio_lag31 

SE2 <- SE.lms[[2]]
#SE2$coefficients
coef.wtio <- c(coef.wtio, SE2$coefficients[3]) #wtio_lag14
coef.wtio <- c(coef.wtio, SE2$coefficients[4]) #wtio_lag46
coef.etio <- c(coef.etio, SE2$coefficients[5]) #etio_lag7 
coef.etio <- c(coef.etio, SE2$coefficients[6]) #etio_lag33 

SE3 <- SE.lms[[3]]
#SE3$coefficients
coef.wtio <- c(coef.wtio, SE3$coefficients[5]) #wtio_lag1
coef.etio <- c(coef.etio, SE3$coefficients[6]) #etio_lag15 

#get colors
coef.range <- range(coef.wtio, coef.etio)
abs.max.coef <- max(abs(coef.range))
#try PiYG
cols.PiG48 <- rev(colorRampPalette(brewer.pal(11, "Spectral"))(36))
col.seq.PiG48 <- c(-abs.max.coef, seq(-2.5,2.5, length.out =length(cols.PiG48) - 1), abs.max.coef )
col.brks <- c(-2.5-0.1470588, seq(-2.5,2.5, length.out =length(cols.PiG48) - 1), 2.5+0.1470588)

col.coef.etio <- cols.PiG48[findInterval(coef.etio, col.seq.PiG48)]
col.coef.wtio <- cols.PiG48[findInterval(coef.wtio, col.seq.PiG48)]

```


```{r overlap_figures}
#TODO: test case, update later

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "wtio_lag.png", width = 2000, height = 1200, res = 250)
par(mar = c(4, 9, 3, 6))
plot(NULL, xlim = c(1,52), ylim = c(0.5, length(wtio.names)),
     yaxt = "n", xlab = "Week", ylab = "", main = "")
image.plot(zlim = c(-2.75, 2.75), legend.only = TRUE, col = cols.PiG48,
           breaks = col.brks, horizontal = FALSE,  legend.args = list( text = "Coef", side = 1),
           axis.args = list(at = seq(-2.5, 2.5, 0.5)))
           #smallplot = c(0.1, 0.9, 0.08, 0.10))
axis(2, at = 1:length(wtio.lag.df$lag), labels = wtio.lag.df$lag, las = 1)
segments(x0 = wtio.lag.df$start, y0 = 1:length(wtio.lag.df$start),
         x1 = wtio.lag.df$end,  y1 = 1:length(wtio.lag.df$end),
         lwd = 5, col = rev(col.coef.wtio))
abline(h = 1:length(wtio.lag.df$start), lty = 3, col = "gray70")
abline(v = c(9.5, 22.5, 35.5, 48.9), lty = 2, col = "gray48")
text(x =c(4.75, 16, 29, 42 ), y = 0.5,  labels = c("DJF", "MAM", "JJA", "SON" ))
title("WTIO Lags", adj = 0)
dev.off()

png(filename = "etio_lag.png", width = 2000, height = 1200, res = 250)
par(mar = c(4, 9, 3, 6))
plot(NULL, xlim = c(1,52), ylim = c(0.5, length(etio.names)),
     yaxt = "n", xlab = "Week", ylab = "", main = "")
image.plot(zlim = c(-2.75, 2.75), legend.only = TRUE, col = cols.PiG48,
           breaks = col.brks, horizontal = FALSE, legend.args = list( text = "Coef", side = 1),
           axis.args = list(at = seq(-2.5, 2.5, 0.5)))
axis(2, at = 1:length(etio.lag.df$lag), labels = etio.lag.df$lag, las = 1)
segments(x0 = etio.lag.df$start, y0 = 1:length(etio.lag.df$start),
         x1 = etio.lag.df$end,  y1 = 1:length(etio.lag.df$end),
         lwd = 5, col =rev(col.coef.etio))
segments(x0 = etio.overlap[2], y0 = etio.overlap[1],
         x1 = etio.overlap[3],  y1 = etio.overlap[1],
         lwd = 5, col = col.coef.etio[1])
abline(h = 1:length(etio.lag.df$start), lty = 3, col = "gray70")
abline(v = c(9.5, 22.5, 35.5, 48.9), lty = 2, col = "gray48")
text(x =c(4.75, 16, 29, 42 ), y = 0.5,  labels = c("DJF", "MAM", "JJA", "SON" ))
title("ETIO Lags", adj = 0)
dev.off()
```



## K-Fold

```{r kfold}
k <- 10

#NE aus
NE.kcv <- NULL
for(j in 1:3){ 
  temp.pred <- NEpreds_new[[j]]
  temp.resp <- NEresp_new[[j]]
  
  
  nrow(temp.pred)
  length(temp.resp)
  
  n <- nrow(temp.pred)
  set.seed(156)
  folds <- sample(rep(1:k, length.out = n))
  # Store errors
  mse <- numeric(k)
  for (i in 1:k) {
    # Split into training and test sets
    test.id <- which(folds == i)
    train.preds <- temp.pred[-test.id, ]
    train.resp <- temp.resp[-test.id]
    test.preds <- temp.pred[test.id, ]
    test.resp <- temp.resp[test.id]
    
    # Fit model
    train.data.fit <- as.data.frame(cbind(train.resp, train.preds))
    names(train.data.fit)[1] <- "co"
  
    temp.model <- lm(formula(NErefits[[j]]), train.data.fit)
    
    # Predict
    preds <- predict(temp.model, newdata = test.preds)
    
    # Compute Mean Squared Error
    mse[i] <- mean((test.resp - preds)^2)
  }
  NE.kcv[[j]] <- mean(mse)
}




#SE aus
SE.kcv <- NULL
for(j in 1:3){ 
  temp.pred <- SEpreds_new[[j]]
  temp.resp <- SEresp_new[[j]]
  
  
  nrow(temp.pred)
  length(temp.resp)
  
  n <- nrow(temp.pred)
  set.seed(157)
  folds <- sample(rep(1:k, length.out = n))
  # Store errors
  mse <- numeric(k)
  for (i in 1:k) {
    # Split into training and test sets
    test.id <- which(folds == i)
    train.preds <- temp.pred[-test.id, ]
    train.resp <- temp.resp[-test.id]
    test.preds <- temp.pred[test.id, ]
    test.resp <- temp.resp[test.id]
    
    # Fit model
    train.data.fit <- as.data.frame(cbind(train.resp, train.preds))
    names(train.data.fit)[1] <- "co"
  
    temp.model <- lm(formula(SErefits[[j]]), train.data.fit)
    
    # Predict
    preds <- predict(temp.model, newdata = test.preds)
    
    # Compute Mean Squared Error
    mse[i] <- mean((test.resp - preds)^2)
  }
  SE.kcv[[j]] <- mean(mse)
}

NE.kcv
SE.kcv
```

```{r kfold_noOLR}
k <- 10

#NE aus
NE.kcv.noOLR <- NULL
for(j in 1:3){ 
  temp.pred <- NEpreds_new[[j]][ ,1:260]
  temp.resp <- NEresp_new[[j]]
  
  
  nrow(temp.pred)
  length(temp.resp)
  
  n <- nrow(temp.pred)
  set.seed(156)
  folds <- sample(rep(1:k, length.out = n))
  # Store errors
  mse <- numeric(k)
  for (i in 1:k) {
    # Split into training and test sets
    test.id <- which(folds == i)
    train.preds <- temp.pred[-test.id, ]
    train.resp <- temp.resp[-test.id]
    test.preds <- temp.pred[test.id, ]
    test.resp <- temp.resp[test.id]
    
    # Fit model
    train.data.fit <- as.data.frame(cbind(train.resp, train.preds))
    names(train.data.fit)[1] <- "co"
  
    temp.model <- lm(formula(NErefit.noOLR[[j]]), train.data.fit)
    
    # Predict
    preds <- predict(temp.model, newdata = test.preds)
    
    # Compute Mean Squared Error
    mse[i] <- mean((test.resp - preds)^2)
  }
  NE.kcv.noOLR[[j]] <- mean(mse)
}




#SE aus
SE.kcv.noOLR <- NULL
for(j in 1:3){ 
  temp.pred <- SEpreds_new[[j]][ ,1:260]
  temp.resp <- SEresp_new[[j]]
  
  
  nrow(temp.pred)
  length(temp.resp)
  
  n <- nrow(temp.pred)
  set.seed(157)
  folds <- sample(rep(1:k, length.out = n))
  # Store errors
  mse <- numeric(k)
  for (i in 1:k) {
    # Split into training and test sets
    test.id <- which(folds == i)
    train.preds <- temp.pred[-test.id, ]
    train.resp <- temp.resp[-test.id]
    test.preds <- temp.pred[test.id, ]
    test.resp <- temp.resp[test.id]
    
    # Fit model
    train.data.fit <- as.data.frame(cbind(train.resp, train.preds))
    names(train.data.fit)[1] <- "co"
  
    temp.model <- lm(formula(SErefit.noOLR[[j]]), train.data.fit)
    
    # Predict
    preds <- predict(temp.model, newdata = test.preds)
    
    # Compute Mean Squared Error
    mse[i] <- mean((test.resp - preds)^2)
  }
  SE.kcv.noOLR[[j]] <- mean(mse)
}

NE.kcv.noOLR
SE.kcv.noOLR

```


```{r validation_extract}
#rmse
NEbase.rmse <- unlist(lapply(NE.rmse, function(x) x[[1]]))
NEconst.rmse <- unlist(lapply(NE.rmse, function(x) x[[2]]))
NEvary.rmse <- unlist(lapply(NE.rmse, function(x) x[[3]]))

SEbase.rmse <- unlist(lapply(SE.rmse, function(x) x[[1]]))
SEconst.rmse <- unlist(lapply(SE.rmse, function(x) x[[2]]))
SEvary.rmse <- unlist(lapply(SE.rmse, function(x) x[[3]]))

#cprs
NEbase.cprs <- unlist(lapply(NE.cprs, function(x) x[[1]]))
NEconst.cprs <- unlist(lapply(NE.cprs, function(x) x[[2]]))
NEvary.cprs <- unlist(lapply(NE.cprs, function(x) x[[3]]))

SEbase.cprs <- unlist(lapply(SE.cprs, function(x) x[[1]]))
SEconst.cprs <- unlist(lapply(SE.cprs, function(x) x[[2]]))
SEvary.cprs <- unlist(lapply(SE.cprs, function(x) x[[3]]))

#int score
NEbase.int <- unlist(lapply(NE.ints, function(x) x[[1]]))
NEconst.int <- unlist(lapply(NE.ints, function(x) x[[2]]))
NEvary.int <- unlist(lapply(NE.ints, function(x) x[[3]]))

SEbase.int <- unlist(lapply(SE.ints, function(x) x[[1]]))
SEconst.int <- unlist(lapply(SE.ints, function(x) x[[2]]))
SEvary.int <- unlist(lapply(SE.ints, function(x) x[[3]]))


```


```{r extract_byGroup}
##RMSE
#base terms (no splot)
NEgroup1.base.rmse <- unlist(lapply(NE.rmse, function(x) x[[1]][1]))
NEgroup2.base.rmse <- unlist(lapply(NE.rmse, function(x) x[[1]][2]))
NEgroup3.base.rmse <- unlist(lapply(NE.rmse, function(x) x[[1]][3]))

SEgroup1.base.rmse <- unlist(lapply(SE.rmse, function(x) x[[1]][1]))
SEgroup2.base.rmse <- unlist(lapply(SE.rmse, function(x) x[[1]][2]))
SEgroup3.base.rmse <- unlist(lapply(SE.rmse, function(x) x[[1]][3]))

#constant terms (test/train split)
NEgroup1.rmse <- unlist(lapply(NE.rmse, function(x) x[[2]][1]))
NEgroup2.rmse <- unlist(lapply(NE.rmse, function(x) x[[2]][2]))
NEgroup3.rmse <- unlist(lapply(NE.rmse, function(x) x[[2]][3]))

SEgroup1.rmse <- unlist(lapply(SE.rmse, function(x) x[[2]][1]))
SEgroup2.rmse <- unlist(lapply(SE.rmse, function(x) x[[2]][2]))
SEgroup3.rmse <- unlist(lapply(SE.rmse, function(x) x[[2]][3]))


##CPRS
#base terms (no splot)
NEgroup1.base.cprs <- unlist(lapply(NE.cprs, function(x) x[[1]][1]))
NEgroup2.base.cprs <- unlist(lapply(NE.cprs, function(x) x[[1]][2]))
NEgroup3.base.cprs <- unlist(lapply(NE.cprs, function(x) x[[1]][3]))

SEgroup1.base.cprs <- unlist(lapply(SE.cprs, function(x) x[[1]][1]))
SEgroup2.base.cprs <- unlist(lapply(SE.cprs, function(x) x[[1]][2]))
SEgroup3.base.cprs <- unlist(lapply(SE.cprs, function(x) x[[1]][3]))

#constant terms (test/train split)
NEgroup1.cprs <- unlist(lapply(NE.cprs, function(x) x[[2]][1]))
NEgroup2.cprs <- unlist(lapply(NE.cprs, function(x) x[[2]][2]))
NEgroup3.cprs <- unlist(lapply(NE.cprs, function(x) x[[2]][3]))

SEgroup1.cprs <- unlist(lapply(SE.cprs, function(x) x[[2]][1]))
SEgroup2.cprs <- unlist(lapply(SE.cprs, function(x) x[[2]][2]))
SEgroup3.cprs <- unlist(lapply(SE.cprs, function(x) x[[2]][3]))



##Int Score
#base terms (no split)
NEgroup1.base.ints <- unlist(lapply(NE.ints, function(x) x[[1]][1]))
NEgroup2.base.ints <- unlist(lapply(NE.ints, function(x) x[[1]][2]))
NEgroup3.base.ints <- unlist(lapply(NE.ints, function(x) x[[1]][3]))

SEgroup1.base.ints <- unlist(lapply(SE.ints, function(x) x[[1]][1]))
SEgroup2.base.ints <- unlist(lapply(SE.ints, function(x) x[[1]][2]))
SEgroup3.base.ints <- unlist(lapply(SE.ints, function(x) x[[1]][3]))

#constant terms (test/train split)
NEgroup1.ints <- unlist(lapply(NE.ints, function(x) x[[2]][1]))
NEgroup2.ints <- unlist(lapply(NE.ints, function(x) x[[2]][2]))
NEgroup3.ints <- unlist(lapply(NE.ints, function(x) x[[2]][3]))

SEgroup1.ints <- unlist(lapply(SE.ints, function(x) x[[2]][1]))
SEgroup2.ints <- unlist(lapply(SE.ints, function(x) x[[2]][2]))
SEgroup3.ints <- unlist(lapply(SE.ints, function(x) x[[2]][3]))

```


# ANOVAs

Use to show the effect of including or excluding OLR

```{r }
anova(NE1.lm.noOLR, NE1.lm )
anova(NE2.lm.noOLR, NE2.lm )
anova(NE3.lm.noOLR, NE3.lm )



anova(SE1.lm.noOLR, SE1.lm )
anova(SE2.lm.noOLR, SE2.lm )
anova(SE3.lm.noOLR, SE3.lm )
```




# Figures


## RMSE Plots

```{r}
#get yearly lines
year.div <- seq(0.5, 57.5, by = 3)
year.mid <- seq(2, 56, by = 3)

NErmse.range <- range(NE.rmse)
SErmse.range <- range(SE.rmse)

colors.group <- rep(c("firebrick", "forestgreen", "royalblue3"), 19)

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")


png(filename = "NErmse.png", width = 3600, height = 1500, res = 275)
par(mar = c(5, 5, 3, 7))
plot(1:57, NEconst.rmse, pch = 16, col = colors.group, 
     ylab = "RMSE", ylim = c(0, max(NErmse.range)), xlab = "Year", axes = FALSE)
box()
axis(2)
axis(1, at = year.mid, labels = c(season_years[1:19]), tick = FALSE )
#points(1:57, NEconst.rmse, pch = 15, col = colors.group)
points(1:57, NEvary.rmse, pch = 17, col = alpha(colors.group, 0.75) )
abline(v= year.div, lty = 2)
title("NE Aus: RMSE", adj = 0)
legend("topright", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Group 1", "Group 2", "Group 3"), col = colors.group, pch = 16 )
legend("right", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Constant", "Varying"), col = "black", pch = c(16,17) )
dev.off()


png(filename = "SErmse.png", width = 3600, height = 1500, res = 275)
par(mar = c(5, 5, 3, 7))
plot(1:57, SEconst.rmse, pch = 16, col = colors.group,
     ylab = "RMSE", ylim = c(0, max(SErmse.range)), xlab = "Year", axes = FALSE)
box()
axis(2)
axis(1, at = year.mid, labels = c(season_years[1:19]), tick = FALSE )
#points(1:57, SEconst.rmse, pch = 15, col = colors.group,)
points(1:57, SEvary.rmse, pch = 17, col = alpha(colors.group, 0.75),)
abline(v= year.div, lty = 2)
title("SE Aus: RMSE", adj = 0)
legend("topright", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Group 1", "Group 2", "Group 3"), col = colors.group, pch = 16 )
legend("right", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Constant", "Varying"), col = "black", pch = c(16,17) )
dev.off()

```

```{r boxplots}
#TODO: finalize these plots into a single plot (as before)
#boxplot(NEgroup1.rmse, NEgroup2.rmse, NEgroup3.rmse)
#boxplot(SEgroup1.rmse, SEgroup2.rmse, SEgroup3.rmse)

rmse.range <- range(NEbase.rmse, NEconst.rmse, 
                    NEbase.rmse, SEconst.rmse)

model.names <- c("NE Aus 1", "NE Aus 2", "NE Aus 3",
                 "SE Aus 1", "SE Aus 2", "SE Aus 3")


setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "base_rmse.png", width = 2000, height = 1200, res = 250)
par(mar = c(5, 5, 3, 5))
#base (no split)
boxplot(NEgroup1.base.rmse, NEgroup2.base.rmse, NEgroup3.base.rmse,
        SEgroup1.base.rmse, SEgroup2.base.rmse, SEgroup3.base.rmse, pch = 19,
        ylim = rmse.range, ylab = "RMSE", axes = FALSE)
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Full Model : RMSE", adj = 0)
dev.off()


#constant (loo (single year test split))
png(filename = "constant_rmse.png", width = 2000, height = 1200, res = 250)
par(mar = c(5, 5, 3, 5))
boxplot(NEgroup1.rmse, NEgroup2.rmse, NEgroup3.rmse, 
        SEgroup1.rmse, SEgroup2.rmse, SEgroup3.rmse, pch = 19,
         ylim = rmse.range, ylab = "RMSE")
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : RMSE", adj = 0)
dev.off()
```



## CRPS Plots

```{r}
NEcprs.range <- range(NE.cprs)
SEcprs.range <- range(SE.cprs)

plot(1:57, NEconst.cprs, pch = 16,
     ylim = NEcprs.range)
plot(1:57, SEconst.cprs, pch = 16,
     ylim = SEcprs.range)
```

```{r boxplot_cprs}
cprs.range <- range(NEbase.cprs, NEconst.cprs, 
                    NEbase.cprs, SEconst.cprs)

model.names <- c("NE Aus 1", "NE Aus 2", "NE Aus 3",
                 "SE Aus 1", "SE Aus 2", "SE Aus 3")

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "base_cprs.png", width = 2000, height = 1200, res = 250)
par(mar = c(5, 5, 3, 5))
#base (no split)
boxplot(NEgroup1.base.cprs, NEgroup2.base.cprs, NEgroup3.base.cprs,
        SEgroup1.base.cprs, SEgroup2.base.cprs, SEgroup3.base.cprs, pch = 19,
        ylim = cprs.range, ylab = "CRPS", axes = FALSE)
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Full Model : CRPS", adj = 0)
dev.off()

png(filename = "constant_cprs.png", width = 2000, height = 1200, res = 250)
par(mar = c(5, 5, 3, 5))
boxplot(NEgroup1.cprs, NEgroup2.cprs, NEgroup3.cprs, 
        SEgroup1.cprs, SEgroup2.cprs, SEgroup3.cprs, pch = 19,
         ylim = cprs.range, ylab = "CRPS")
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : CRPS", adj = 0)
dev.off()
```



## Interval Score Plots

```{r}
NEints.range <- range(NE.ints)
SEints.range <- range(SE.ints)

plot(1:57, NEconst.int, pch = 16,
     ylim = NEints.range)
plot(1:57, SEconst.int, pch = 16,
     ylim = SEints.range)
```

```{r boxplots_intscore}
ints.range <- range(NEbase.int, NEconst.int, 
                    NEbase.int, SEconst.int)

model.names <- c("NE Aus 1", "NE Aus 2", "NE Aus 3",
                 "SE Aus 1", "SE Aus 2", "SE Aus 3")

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "base_int.png", width = 2000, height = 1200, res = 250)
par(mar = c(5, 5, 3, 5))
#base (no split)
boxplot(NEgroup1.base.ints, NEgroup2.base.ints, NEgroup3.base.ints,
        SEgroup1.base.ints, SEgroup2.base.ints, SEgroup3.base.ints, pch = 19,
        ylim = ints.range, ylab = "Interval Score", axes = FALSE)
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Full Model : 95% Interval Score", adj = 0)
dev.off()


png(filename = "constant_int.png", width = 2000, height = 1200, res = 250)
#constant terms
par(mar = c(5, 5, 3, 5))
boxplot(NEgroup1.ints, NEgroup2.ints, NEgroup3.ints,
        SEgroup1.ints, SEgroup2.ints, SEgroup3.ints, pch = 19,
        ylim = ints.range, ylab = "Interval Score", axes = FALSE)
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : 95% Interval Score", adj = 0)
dev.off()

```




## Model Fits

```{r base_fits}
#NE base fits
plot(NE.lms[[1]])
plot(NE.lms[[2]])
plot(NE.lms[[3]])

#SE base fits
plot(SE.lms[[1]])
plot(SE.lms[[2]])
plot(SE.lms[[3]])
```




# Test Code

```{r}
lm.data.matrix <- as.data.frame(cbind(y_1, X_1))
names(lm.data.matrix)[1] <- "co"

test.lm <- lm(formula(model.ramp), lm.data.matrix)
summary(test.lm)




y_1 <- as.numeric(NEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))
#without OLR
#X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

negroup1 <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE1.terms <- terms_only(negroup1, X_1)


```

```{r woOLR_anovatest}
#check on OLR

#NE Aus 1
NE1.temp <- NE1.terms[-c(7, 9)]
NE1.model.string <- paste0("co ~ ", paste(NE1.temp, collapse = " + "))
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])
#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))
lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm.refit <- lm(formula(NE1.model.string), lm.data_1)
#summary(NE1.lm.refit)

anova(NE1.lm.refit, NE1.lm)
anova(NE1.lm.noOLR, NE1.lm )

#NE Aus 2
NE2.temp <- NE2.terms[-c(9, 10)]


NE3.terms[-c(8, 10, 17)]

SE1.terms[-c(12:15)]
SE2.terms[-c(6:8)]
SE3.terms[-c(8:12)]
```

