---
title: "refit_cv"
author: "Ryan Peterson"
date: "2025-09-25"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r library}
suppressMessages( library(hierNet)) #no
suppressMessages( library(glmnet)) #test ridge regression for coefs
suppressMessages( library(RAMP)) #maybe
suppressMessages( library(MASS)) #for lm.ridge

suppressMessages( library(foreach)) #parallelization setup
suppressMessages( library(parallel))
suppressMessages( library(doParallel))

suppressMessages( library( lubridate)) #you know why
suppressMessages( library( colorspace)) #for some color alternatives
suppressMessages(library(RColorBrewer)) #colorRampPalette
suppressMessages( library( fields)) #for set.panel() and others 
suppressMessages( library(ggpubr)) #nice tables for dfs (uses ggplot)

suppressMessages( library( Metrics)) #measurement metrics
suppressMessages( library( caret)) #for confusion matrix
suppressMessages( library( jtools)) #lm model summaries

suppressMessages( library( tictoc)) #some timing

suppressMessages(library(grid)) #gridlines between plots
suppressMessages( library(scales)) #for adjusting opacity
```

```{r data_load}
#and functions
# Data Set-Up
setwd("~/CO_AUS/Aus_CO-main/Interactions")

load( "Data/ne_data.rda")
load( "Data/se_data.rda")
load( "Data/bounded_data.rda")
load( "Data/data_matrix.rda")
load( "Data/lag_list.rda")
load( "Data/data_quantile.rda")

#functions:
setwd("~/CO_AUS/Aus_CO-main/Interactions")
#source("group_functions.R") #grouping/clustering
source("group_functionsNew.R") #new groupings
source("refit_functions.R") #coef/refit functions

setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
load("IOD_lag.rda") #data
source("predictionTest_functions.R") #predtest functions 
```

# Data Setup

```{r data_setup_new}
#season years/weeks
season_weeks <- c(35:52, 1:14)
season_years <- unique(bounded_resp_df$year)

seasons <- c()
for (i in 1:(length(season_years)-1)) {
  temp_season <- paste0(season_years[i], "-", season_years[i+1])
  #print(temp_season)  
  seasons <- c(seasons, temp_season)
}
rm(i, temp_season)

#center response data
NEbase_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEbase_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)

#Below includes removal of weeks 35-37 (adjust grouping functions if we need to change this.)
#NEAus
NEAus_1 <- NEbase_matrix[ ,4:12] 
NEAus_2 <- NEbase_matrix[ ,13:17]
NEAus_3 <- NEbase_matrix[ ,18:32]

#NEAus
SEAus_1 <- SEbase_matrix[ ,4:16] 
SEAus_2 <- SEbase_matrix[ ,17:20] 
SEAus_3 <- SEbase_matrix[ ,21:32]

NEAus_mat <- list(NEAus_1, NEAus_2, NEAus_3)
SEAus_mat <- list(SEAus_1, SEAus_2, SEAus_3)

rm(NEAus_1, NEAus_2, NEAus_3, SEAus_1, SEAus_2, SEAus_3)

#full model
NEpreds_new <- NElag_3group(NE_laglist = NE_iodlag, j = 1:19)
NEresp_new <- NEresp_3group(NEAus_mat = NEAus_mat, j = 1:19)

SEpreds_new <- SElag_3group(SE_laglist = SE_iodlag, j = 1:19)
SEresp_new <- SEresp_3group(SEAus_mat = SEAus_mat, j = 1:19)

#partial model
NEpreds_newpart <- NElag_3group(NE_laglist = NE_iodlag, j = -c(19))
NEresp_newpart <- NEresp_3group(NEAus_mat = NEAus_mat, j = -c(19))

SEpreds_newpart <- SElag_3group(SE_laglist = SE_iodlag, j = -c(19))
SEresp_newpart <- SEresp_3group(SEAus_mat = SEAus_mat, j = -c(19))


```

```{r partial_LOO}
#leaving out a single year
NEpartial_preds <- list()
NEpartial_resp <- list()
SEpartial_preds <- list()
SEpartial_resp <- list()
for (j in 1:length(seasons)) {
  #NE Aus
  NEpartial_preds[[seasons[j]]] <- NElag_3group(NE_laglist = NE_iodlag, j = -c(j))
  NEpartial_resp[[seasons[j]]] <- NEresp_3group(NEAus_mat = NEAus_mat, j = -c(j))
  
  #SE Aus
  SEpartial_preds[[seasons[j]]] <- SElag_3group(SE_laglist = SE_iodlag, j = -c(j))
  SEpartial_resp[[seasons[j]]] <- SEresp_3group(SEAus_mat = SEAus_mat, j = -c(j))
}

#extracting a single year (validation data)
NEvalid_preds <- list()
NEvalid_resp <- list()
SEvalid_preds <- list()
SEvalid_resp <- list()
for (k in 1:length(seasons)) {
  #NE Aus
  NEvalid_preds[[seasons[k]]] <- NElag_3group(NE_laglist = NE_iodlag, j = c(k))
  NEvalid_resp[[seasons[k]]] <- NEresp_3group(NEAus_mat = NEAus_mat, j = c(k))
  
  #SE Aus
  SEvalid_preds[[seasons[k]]] <- SElag_3group(SE_laglist = SE_iodlag, j = c(k))
  SEvalid_resp[[seasons[k]]] <- SEresp_3group(SEAus_mat = SEAus_mat, j = c(k))
}

```

# Functions (RAMP)

```{r refit_functions}
refit_ramp <- function(test.ramp, X_1){
  
  main.terms <- test.ramp$mainInd
  main.terms <- colnames(X_1)[main.terms]
  
  interactions <- test.ramp$interInd
      if (!is.null(interactions)){
        for (i in 1:length(interactions)){
          
          this.term <- interactions[i]
          these.subterms <- as.integer(strsplit(this.term, "X")[[1]][2:3])
          these.subterms <- colnames(X_1)[these.subterms]
          
          if (these.subterms[1] != these.subterms[2]){
            this.term <- paste(these.subterms, collapse = ":")
          } else {
            this.term <- paste0("I(", these.subterms[1], "^2)")
          }
          
          interactions[i] <- this.term
        }
      }
  
  #refit with lm
  if (!is.null(interactions)){
    model.string <- paste( paste(main.terms, collapse = " + "),
                           paste(interactions, collapse = " + "),
                           sep = " + ")
  } else {
    model.string <- paste(main.terms, collapse = " + ")
  }
  
  model.string <- paste0("co ~ ", model.string)
  
  return(model.string)
}



terms_only <- function(test.ramp, X_1){
  main.terms <- test.ramp$mainInd
  main.terms <- colnames(X_1)[main.terms]
  
  interactions <- test.ramp$interInd
      if (!is.null(interactions)){
        for (i in 1:length(interactions)){
          
          this.term <- interactions[i]
          these.subterms <- as.integer(strsplit(this.term, "X")[[1]][2:3])
          these.subterms <- colnames(X_1)[these.subterms]
          
          if (these.subterms[1] != these.subterms[2]){
            this.term <- paste(these.subterms, collapse = ":")
          } else {
            this.term <- paste0("I(", these.subterms[1], "^2)")
          }
          
          interactions[i] <- this.term
        }
      }
  return(c(main.terms, interactions))
}

```

# Refit Terms

```{r NEAus_base}
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))
#without OLR
#X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

negroup1 <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE1.terms <- terms_only(negroup1, X_1)
NE1.refit <- refit_ramp(negroup1, X_1)

#NE Aus Group 2
y_2 <- as.numeric(NEresp_new[[2]])

#with OLR
X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:312]))
#without OLR
#X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:260]))

negroup2 <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE2.terms <- terms_only(negroup2, X_2)
NE2.refit <- refit_ramp(negroup2, X_2) 
                        
#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])

#with OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:312]))
#without OLR
#X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:260]))

negroup3 <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE3.terms <- terms_only(negroup3, X_3)                      
NE3.refit <- refit_ramp(negroup3, X_3)  

NEmodels <- list(negroup1, negroup2, negroup3)
NErefits <- list(NE1.refit, NE2.refit, NE3.refit)
              
```

```{r SEAus_base}
#SE Aus Group 1
y_1 <- as.numeric(SEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:312]))
#without OLR
#X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:260]))

segroup1 <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE1.terms <- terms_only(segroup1, X_1)
SE1.refit <- refit_ramp(segroup1, X_1)

#SE Aus Group 2
y_2 <- as.numeric(SEresp_new[[2]])

#with OLR
X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:312]))
#without OLR
#X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:260]))

segroup2 <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE2.terms <- terms_only(segroup2, X_2)
SE2.refit <- refit_ramp(segroup2, X_2)

#SE Aus Group 3
y_3 <- as.numeric(SEresp_new[[3]])

#with OLR
X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:312]))
#without OLR
#X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:260]))

segroup3 <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE3.terms <- terms_only(segroup3, X_3)
SE3.refit <- refit_ramp(segroup3, X_3)

SEmodels <- list(segroup1, segroup2, segroup3)
SErefits <- list(SE1.refit, SE2.refit, SE3.refit)

```

## Refit - Base w/o OLR

```{r NEAus_noOLR}
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])

#without OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

negroup1.noOLR <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE1.terms.noOLR <- terms_only(negroup1.noOLR, X_1)
NE1.refit.noOLR <- refit_ramp(negroup1.noOLR, X_1)

#TODO: refit 
lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm.noOLR <- lm(formula(NE1.refit.noOLR), lm.data_1)
summary(NE1.lm.noOLR)

#NE Aus Group 2
y_2 <- as.numeric(NEresp_new[[2]])

#without OLR
X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:260]))

negroup2.noOLR <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE2.terms.noOLR <- terms_only(negroup2.noOLR, X_2)
NE2.refit.noOLR <- refit_ramp(negroup2.noOLR, X_2)

#refit 
lm.data_2 <- as.data.frame(cbind(y_2, X_2))
names(lm.data_2)[1] <- "co"

NE2.lm.noOLR <- lm(formula(NE2.refit.noOLR), lm.data_2)
summary(NE2.lm.noOLR)


#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])

#without OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:260]))

negroup3.noOLR <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE3.terms.noOLR <- terms_only(negroup3.noOLR, X_3)
NE3.refit.noOLR <- refit_ramp(negroup3.noOLR, X_3)

#refit 
lm.data_3 <- as.data.frame(cbind(y_3, X_3))
names(lm.data_3)[1] <- "co"

NE3.lm.noOLR <- lm(formula(NE3.refit.noOLR), lm.data_3)
summary(NE3.lm.noOLR)

NEmodels.noOLR <- list(negroup1.noOLR, negroup2.noOLR, negroup3.noOLR)
NErefit.noOLR <- list(NE1.refit.noOLR, NE2.refit.noOLR, NE3.refit.noOLR)
NE.lm.noOLR <- list(NE1.lm.noOLR, NE2.lm.noOLR, NE3.lm.noOLR)

```

```{r SEAus_noOLR}
#SE Aus Group 1
y_1 <- as.numeric(SEresp_new[[1]])

#without OLR
X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:260]))

segroup1.noOLR <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE1.terms.noOLR <- terms_only(segroup1.noOLR, X_1)
SE1.refit.noOLR <- refit_ramp(segroup1.noOLR, X_1)

#TODO: refit 
lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

SE1.lm.noOLR <- lm(formula(SE1.refit.noOLR), lm.data_1)
summary(SE1.lm.noOLR)

#SE Aus Group 2
y_2 <- as.numeric(SEresp_new[[2]])

#without OLR
X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:260]))

segroup2.noOLR <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE2.terms.noOLR <- terms_only(segroup2.noOLR, X_2)
SE2.refit.noOLR <- refit_ramp(segroup2.noOLR, X_2)

#refit 
lm.data_2 <- as.data.frame(cbind(y_2, X_2))
names(lm.data_2)[1] <- "co"

SE2.lm.noOLR <- lm(formula(SE2.refit.noOLR), lm.data_2)
summary(SE2.lm.noOLR)


#SE Aus Group 3
y_3 <- as.numeric(SEresp_new[[3]])

#without OLR
X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:260]))

segroup3.noOLR <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE3.terms.noOLR <- terms_only(segroup3.noOLR, X_3)
SE3.refit.noOLR <- refit_ramp(segroup3.noOLR, X_3)

#refit 
lm.data_3 <- as.data.frame(cbind(y_3, X_3))
names(lm.data_3)[1] <- "co"

SE3.lm.noOLR <- lm(formula(SE3.refit.noOLR), lm.data_3)
summary(SE3.lm.noOLR)


SEmodels.noOLR <- list(segroup1.noOLR, segroup2.noOLR, segroup3.noOLR)
SErefit.noOLR <- list(SE1.refit.noOLR, SE2.refit.noOLR, SE3.refit.noOLR)
SE.lm.noOLR <- list(SE1.lm.noOLR, SE2.lm.noOLR, SE3.lm.noOLR)

```

```{r save_noOLR}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(NE.lm.noOLR, SE.lm.noOLR, 
     NErefit.noOLR, SErefit.noOLR, file = "models_noOLR.rda")
```

# Refit w/ eBIC

```{r NEaus_ebic}
#gamma
gamma_seq <- seq(0, 1, length.out = 12)
#include gamma = 0 for "sanity" check with previous BIC fit.

#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])
#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))

NEAus1.eBIC <- list()
NE1.eBIC.terms <- list()
for (j in 1:length(gamma_seq)) {
  negroup1.temp <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE1.refit.temp <- refit_ramp(negroup1.temp, X_1)
  
  NE1.eBIC.terms[[paste0("Gamma:", gamma_seq[[j]])]] <- NE1.refit.temp
  
  
    #refit 
  lm.data_1 <- as.data.frame(cbind(y_1, X_1))
  names(lm.data_1)[1] <- "co"
  
  NE1.lm.eBIC <- lm(formula(NE1.refit.temp), lm.data_1)
  #summary(NE1.lm.eBIC)
  NEAus1.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- NE1.lm.eBIC
}


#NE Aus Group 2
y_2 <- as.numeric(NEresp_new[[2]])
#with OLR
X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:312]))

NEAus2.eBIC <- list()
NE2.eBIC.terms <- list()
for (j in 1:length(gamma_seq)) {
  negroup2.temp <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE2.refit.temp <- refit_ramp(negroup2.temp, X_2)
  
  NE2.eBIC.terms[[paste0("Gamma:", gamma_seq[[j]])]] <- NE2.refit.temp
  
  #refit 
  lm.data_2 <- as.data.frame(cbind(y_2, X_2))
  names(lm.data_2)[1] <- "co"
  
  NE2.lm.eBIC <- lm(formula(NE2.refit.temp), lm.data_2)
  #summary(NE1.lm.eBIC)
  NEAus2.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- NE2.lm.eBIC
}


#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])
#with OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:312]))

NEAus3.eBIC <- list()
NE3.eBIC.terms <- list()
for (j in 1:length(gamma_seq)) {
  negroup3.temp <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE3.refit.temp <- refit_ramp(negroup3.temp, X_3)
  
  NE3.eBIC.terms[[paste0("Gamma:", gamma_seq[[j]])]] <- NE3.refit.temp
  
  #refit 
  lm.data_3 <- as.data.frame(cbind(y_3, X_3))
  names(lm.data_3)[1] <- "co"
  
  NE3.lm.eBIC <- lm(formula(NE3.refit.temp), lm.data_3)
  #summary(NE1.lm.eBIC)
  NEAus3.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- NE3.lm.eBIC
}

NE.eBIC.terms <- list(NE2.eBIC.terms, NE2.eBIC.terms, NE3.eBIC.terms)

```

```{r SEaus_ebic}


#NE Aus Group 1
y_1 <- as.numeric(SEresp_new[[1]])
#with OLR
X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:312]))

SEAus1.eBIC <- list()
SE1.eBIC.terms <- list() ##TODO: finalize this in the below loop
for (j in 2:length(gamma_seq)) {
  segroup1.temp <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  SE1.refit.temp <- refit_ramp(segroup1.temp, X_1)
  
    #refit 
  lm.data_1 <- as.data.frame(cbind(y_1, X_1))
  names(lm.data_1)[1] <- "co"
  
  SE1.lm.eBIC <- lm(formula(SE1.refit.temp), lm.data_1)
  #summary(NE1.lm.eBIC)
  SEAus1.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- SE1.lm.eBIC
}


#NE Aus Group 2
y_2 <- as.numeric(SEresp_new[[2]])
#with OLR
X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:312]))

SEAus2.eBIC <- list()
SE2.eBIC.terms <- list() ##TODO: finalize this in the below loop
for (j in 2:length(gamma_seq)) {
  segroup2.temp <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  SE2.refit.temp <- refit_ramp(segroup2.temp, X_2)
  
  #refit 
  lm.data_2 <- as.data.frame(cbind(y_2, X_2))
  names(lm.data_2)[1] <- "co"
  
  SE2.lm.eBIC <- lm(formula(SE2.refit.temp), lm.data_2)
  #summary(NE1.lm.eBIC)
  SEAus2.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- SE2.lm.eBIC
}


#NE Aus Group 3
y_3 <- as.numeric(SEresp_new[[3]])
#with OLR
X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:312]))

SEAus3.eBIC <- list()
SE3.eBIC.terms <- list() ##TODO: finalize this in the below loop
for (j in 2:length(gamma_seq)) {
  segroup3.temp <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  SE3.refit.temp <- refit_ramp(segroup3.temp, X_3)
  
  #refit 
  lm.data_3 <- as.data.frame(cbind(y_3, X_3))
  names(lm.data_3)[1] <- "co"
  
  SE3.lm.eBIC <- lm(formula(SE3.refit.temp), lm.data_3)
  #summary(NE1.lm.eBIC)
  SEAus3.eBIC[[paste0("Gamma:", gamma_seq[[j]])]] <- SE3.lm.eBIC
}


```

```{r save_ebic}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(NEAus1.eBIC, NEAus2.eBIC, NEAus3.eBIC,
      SEAus1.eBIC, SEAus2.eBIC, SEAus3.eBIC, file = "models_ebic.rda")
```

## Refine Gamma, eBIC

```{r get_termDiff}

#gamma
gamma_seq <- seq(0, 1, length.out = 12)
gamma_seq

#ne aus 1
ne1.count <- unlist(lapply(NEAus1.eBIC, function(x) length(coef(x))))
diff(ne1.count)
min.loc <- which.min(diff(sne1.count))+1
start.gamma1 <- gamma_seq[min.loc]
end.gamma1 <- gamma_seq[min.loc+1]

new.gamma1 <- seq(start.gamma1, end.gamma1, length.out = 8)

unique(ne1.count)


#ne aus 2
ne2.count <- unlist(lapply(NEAus2.eBIC, function(x) length(coef(x))))
diff(ne2.count)
min.loc <- which.min(diff(ne2.count))+1
start.gamma2 <- gamma_seq[min.loc]
end.gamma2 <- gamma_seq[min.loc+1]

new.gamma2 <- seq(start.gamma2, end.gamma2, length.out = 8)



#ne aus 3
ne3.count <- unlist(lapply(NEAus3.eBIC, function(x) length(coef(x))))
diff(ne3.count)
min.loc <- which.min(diff(ne3.count))+1
start.gamma3 <- gamma_seq[min.loc]
end.gamma3 <- gamma_seq[min.loc+1]

new.gamma3 <- seq(start.gamma3, end.gamma3, length.out = 8)


#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])
#with OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:312]))

NEAus3.eBIC.new <- list()
for (j in 1:length(new.gamma3)) {
  negroup3.temp <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = new.gamma3[j],
                             n.lambda = 500)
  
  #terms only
  NE3.refit.temp <- refit_ramp(negroup3.temp, X_3)
  
  #refit 
  lm.data_3 <- as.data.frame(cbind(y_3, X_3))
  names(lm.data_3)[1] <- "co"
  
  NE3.lm.eBIC <- lm(formula(NE3.refit.temp), lm.data_3)
  #summary(NE1.lm.eBIC)
  NEAus3.eBIC.new[[paste0("Gamma:", new.gamma3[[j]])]] <- NE3.lm.eBIC
}

unlist(lapply(NEAus3.eBIC.new, function(x) length(coef(x))))

#se aus 1
se1.count <- unlist(lapply(SEAus1.eBIC, function(x) length(coef(x))))
diff(se1.count)
min.loc <- which.min(diff(se1.count))+1
start.gamma1 <- gamma_seq[min.loc]
end.gamma1 <- gamma_seq[min.loc+1]

new.gamma1 <- seq(start.gamma1, end.gamma1, length.out = 8)


#SE Aus Group 1
y_1 <- as.numeric(SEresp_new[[1]])
#with OLR
X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:312]))

SEAus1.eBIC.new <- list()
for (j in 1:length(new.gamma1)) {
  segroup1.temp <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = new.gamma1[j],
                             n.lambda = 500)
  
  #terms only
  SE1.refit.temp <- refit_ramp(segroup1.temp, X_1)
  
    #refit 
  lm.data_1 <- as.data.frame(cbind(y_1, X_1))
  names(lm.data_1)[1] <- "co"
  
  SE1.lm.eBIC <- lm(formula(SE1.refit.temp), lm.data_1)
  #summary(NE1.lm.eBIC)
  SEAus1.eBIC.new[[paste0("Gamma:", new.gamma1[[j]])]] <- SE1.lm.eBIC
}

unlist(lapply(SEAus1.eBIC.new, function(x) length(coef(x))))


#se aus 2
se2.count <- unlist(lapply(SEAus2.eBIC, function(x) length(coef(x))))
diff(se2.count)
#min.loc <- which.min(diff(se2.count))+1
#start.gamma2 <- gamma_seq[min.loc]
#end.gamma2 <- gamma_seq[min.loc+1]

#new.gamma2 <- seq(start.gamma2, end.gamma2, length.out = 8)

# se aus 3
se3.count <- unlist(lapply(SEAus3.eBIC, function(x) length(coef(x))))
diff(se3.count)
min.loc <- which.min(diff(se3.count))+1
start.gamma3 <- gamma_seq[min.loc]
end.gamma3 <- gamma_seq[min.loc+1]

new.gamma3 <- seq(start.gamma3, end.gamma3, length.out = 12)

#NE Aus Group 3
y_3 <- as.numeric(SEresp_new[[3]])
#with OLR
X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:312]))

SEAus3.eBIC.new <- list()
for (j in 1:length(new.gamma3)) {
  segroup3.temp <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = new.gamma3[j],
                             n.lambda = 500)
  
  #terms only
  SE3.refit.temp <- refit_ramp(segroup3.temp, X_3)
  
  #refit 
  lm.data_3 <- as.data.frame(cbind(y_3, X_3))
  names(lm.data_3)[1] <- "co"
  
  SE3.lm.eBIC <- lm(formula(SE3.refit.temp), lm.data_3)
  #summary(NE1.lm.eBIC)
  SEAus3.eBIC.new[[paste0("Gamma:", new.gamma3[[j]])]] <- SE3.lm.eBIC
}


unlist(lapply(SEAus3.eBIC.new, function(x) length(coef(x))))

```



# Refit w/ eBIC no OLR

```{r NEaus_ebic_noOLR}
#gamma
gamma_seq <- seq(0, 1, length.out = 10)

#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])
#without OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

NEAus1.eBIC.noOLR <- list()
for (j in 2:length(gamma_seq)) {
  negroup1.temp <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE1.refit.temp <- refit_ramp(negroup1.temp, X_1)
  
    #refit 
  lm.data_1 <- as.data.frame(cbind(y_1, X_1))
  names(lm.data_1)[1] <- "co"
  
  NE1.lm.eBIC <- lm(formula(NE1.refit.temp), lm.data_1)
  #summary(NE1.lm.eBIC)
  NEAus1.eBIC.noOLR[[paste0("Gamma:", gamma_seq[[j]])]] <- NE1.lm.eBIC
}


#NE Aus Group 2
y_2 <- as.numeric(NEresp_new[[2]])
#without OLR
X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:260]))

NEAus2.eBIC.noOLR <- list()
for (j in 2:length(gamma_seq)) {
  negroup2.temp <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE2.refit.temp <- refit_ramp(negroup2.temp, X_2)
  
  #refit 
  lm.data_2 <- as.data.frame(cbind(y_2, X_2))
  names(lm.data_2)[1] <- "co"
  
  NE2.lm.eBIC <- lm(formula(NE2.refit.temp), lm.data_2)
  #summary(NE1.lm.eBIC)
  NEAus2.eBIC.noOLR[[paste0("Gamma:", gamma_seq[[j]])]] <- NE2.lm.eBIC
}


#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])
#without OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:260]))

NEAus3.eBIC.noOLR <- list()
for (j in 2:length(gamma_seq)) {
  negroup3.temp <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "EBIC",
                             ebic.gamma = gamma_seq[j],
                             n.lambda = 500)
  
  #terms only
  NE3.refit.temp <- refit_ramp(negroup3.temp, X_3)
  
  #refit 
  lm.data_3 <- as.data.frame(cbind(y_3, X_3))
  names(lm.data_3)[1] <- "co"
  
  NE3.lm.eBIC <- lm(formula(NE3.refit.temp), lm.data_3)
  #summary(NE1.lm.eBIC)
  NEAus3.eBIC.noOLR[[paste0("Gamma:", gamma_seq[[j]])]] <- NE3.lm.eBIC
}

```

```{r save}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(NEAus1.eBIC.noOLR, NEAus2.eBIC.noOLR, NEAus3.eBIC.noOLR, file = "models_ebic_noOLR.rda")
```



### Direct Comparison

base, noOLR, and eBIC models

```{r model_summ_NEAus}
#get eBIC gamma val 
##gamma_seq[2] #0.091

#NE Aus Group 1
NE1 <- NE.lms[[1]]
NE1.noOLR <- NE.lm.noOLR[[1]]
NE1.eBIC.1 <- NEAus1.eBIC[[1]] #gamma = 0.091
NE1.eBIC.2 <- NEAus1.eBIC[[2]] #gamma = 0.182
NE1.eBIC.3 <- NEAus1.eBIC[[3]] #gamma = 0.273

summ(NE1, confint = TRUE, digits = 3, vifs = TRUE)
summ(NE1.noOLR, confint = TRUE, digits = 3, vifs = TRUE)
#summ(NE1.eBIC.1, confint = TRUE, digits = 3)
summ(NE1.eBIC.3, confint = TRUE, digits = 3)

#export_summs(NE1, NE1.noOLR, scale = FALSE, 
#             error_format = "[{conf.low}, {conf.high}]", 
#             model.names = c("NE Group 1","NE Group 1 (w/o OLR)"))

export_summs(NE1, NE1.eBIC.3, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")

#NE Aus Group 2
NE2 <- NE.lms[[2]]
NE2.noOLR <- NE.lm.noOLR[[2]]

export_summs(NE2, NE2.noOLR, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")


#NE Aus Group 3
NE3 <- NE.lms[[3]]
NE3.noOLR <- NE.lm.noOLR[[3]]

export_summs(NE3, NE3.noOLR, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")
```

```{r model_summ_SEAus}
#SE Aus Group 1
SE1 <- SE.lms[[1]]
SE1.noOLR <- SE.lm.noOLR[[1]]

export_summs(SE1, SE1.noOLR, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")


#SE Aus Group 2
SE2 <- SE.lms[[2]]
SE2.noOLR <- SE.lm.noOLR[[2]]

export_summs(SE2, SE2.noOLR, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")

#SE Aus Group 3
SE3 <- SE.lms[[3]]
SE3.noOLR <- SE.lm.noOLR[[3]]

export_summs(SE3, SE3.noOLR, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]")
```


## Refit - LOO

```{r NEAus_refit}

#NE Aus 
NE.term.list <- NULL
NE.model.list <- NULL
NE.refit.list <- NULL #refit with base model
for (j in 1:length(seasons)) {
  temp.resp <- NEpartial_resp[[j]]
  temp.preds <- NEpartial_preds[[j]]
  
  temp.list <- NULL
  temp.model <- NULL
  temp.refit <- NULL
  for (k in 1:length(temp.preds)) {
    temp.y <- as.numeric(temp.resp[[k]])
    #with OLR
    temp.X <- cbind(as.matrix(temp.preds[[k]][ ,1:312]))
    
    temp.fit <- RAMP(X = temp.X, y = temp.y,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)
    #terms only
    temp.list[[k]] <- terms_only(temp.fit, temp.X)
    temp.model[[k]] <- refit_ramp(temp.fit, temp.X)
    temp.refit[[k]] <- refit_ramp(NEmodels[[k]], temp.X)
  }
  NE.term.list[[seasons[j]]] <- temp.list
  NE.model.list[[seasons[j]]] <- temp.model
  NE.refit.list[[seasons[j]]] <- temp.refit
}

```

```{r sEAus_refit}

#sE Aus 
SE.term.list <- NULL
SE.model.list <- NULL
SE.refit.list <- NULL #refit with base model
for (j in 1:length(seasons)) {
  temp.resp <- SEpartial_resp[[j]]
  temp.preds <- SEpartial_preds[[j]]
  
  temp.list <- NULL
  temp.model <- NULL
  temp.refit <- NULL
  for (k in 1:length(temp.preds)) {
    temp.y <- as.numeric(temp.resp[[k]])
    #with OLR
    temp.X <- cbind(as.matrix(temp.preds[[k]][ ,1:312]))
    
    temp.fit <- RAMP(X = temp.X, y = temp.y,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)
    #terms only
    temp.list[[k]] <- terms_only(temp.fit, temp.X)
    temp.model[[k]] <- refit_ramp(temp.fit, temp.X)
    temp.refit[[k]] <- refit_ramp(SEmodels[[k]], temp.X)
  }
  SE.term.list[[seasons[j]]] <- temp.list
  SE.model.list[[seasons[j]]] <- temp.model
  SE.refit.list[[seasons[j]]] <- temp.refit
}

```

```{r save}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(SE.term.list, SE.model.list, SE.refit.list, 
     NE.term.list, NE.model.list, NE.refit.list, file = "model_refits.rda")
```

```{r load_backin}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
load( "model_refits.rda")
```


### Refit - LOO eBIC

```{r eBIC_loo}
#combined refit and model validations

#gamma
gamma_seq <- seq(0, 1, length.out = 12)
#NE Aus

#season
NEebic.refit.years <- NULL
for (j in 1:length(seasons)) {
  
  fit.resp <- NEpartial_resp[[j]]
  fit.preds <- NEpartial_preds[[j]]
  
  valid.resp <- NEvalid_resp[[j]]
  valid.preds <- NEvalid_preds[[j]]
  
  #group
  NEebic.refit <- NULL
  for (k in 1:3) {

    fit.y <- as.numeric(fit.resp[[k]])
    #with OLR
    fit.X <- cbind(as.matrix(fit.preds[[k]][ ,1:312]))

    lm.data.fit <- as.data.frame(cbind(fit.y, fit.X))
    names(lm.data.fit)[1] <- "co"
    
    #predict/rmse
    valid.y <- valid.resp[[k]]
    valid.X <- valid.preds[[k]][ ,1:312]
    
    #ebic model terms
    NE.eBIC <- NE.eBIC.terms[[k]]
    
    NEebic.valid <- matrix(NA, ncol = 7)
    colnames(NEebic.valid) <- c("gamma", "const.rmse", "vary.rmse", "const.cprs", "vary.cprs",
                                "const.is95", "vary.is95")

    #ebic loop
    for (i in 1:length(gamma_seq)) {
        vary.fit <- RAMP(X = fit.X, y = fit.y,
                       penalty = "LASSO",
                       tune = "EBIC",
                       ebic.gamma = gamma_seq[i],
                       n.lambda = 250)
        
        #refit varying terms
        vary.terms <- refit_ramp(vary.fit, fit.X)
        
        const.terms <- NE.eBIC[[i]] #terms for constant fit
        
        #fit lm models (w/o year/season)
        temp.lm.constant <- lm(formula(const.terms), lm.data.fit)
        temp.lm.varying <- lm(formula(vary.terms), lm.data.fit)
        
        #prediction
        pred.const <- predict(temp.lm.constant, valid.X, se.fit = TRUE)
        pred.vary <- predict(temp.lm.varying, valid.X, se.fit = TRUE)        
        
        #rmse
        rmse.const <- rmse(valid.y, pred.const$fit)
        rmse.vary <- rmse(valid.y, pred.vary$fit)
        
        #cprs    
        cprs.const <- mean(CPRS(list(mean = pred.const$fit, sd = pred.const$se.fit), valid.y))
        cprs.vary <- mean(CPRS(list(mean = pred.vary$fit, sd = pred.vary$se.fit), valid.y))
    
        #IS95
        is.const <- mean(intscore(list(mean = pred.const$fit, sd = pred.const$se.fit), valid.y))
        is.vary <- mean(intscore(list(mean = pred.vary$fit, sd = pred.vary$se.fit), valid.y))
        
        NEebic.valid <- rbind(NEebic.valid, c(gamma_seq[i], rmse.const, rmse.vary, cprs.const, cprs.vary,
                                              is.const, is.vary))
        
    }
    NEebic.refit[[k]] <- NEebic.valid[-1, ]
  }
  NEebic.refit.years[[seasons[j]]] <- NEebic.refit
}  

setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(NEebic.refit.years,
     file = "model_eBICrefits.rda")
```


```{r save_ebicrefit}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(NEebic.refit.years,
     file = "model_eBICrefits.rda")
```


### Refit - LOO no OLR

```{r refit_sansOLR}


#NE Aus 
NE.terms.noOLR <- NULL
NE.model.noOLR <- NULL
#NE.refit.noOLR <- NULL #refit with base model
for (j in 1:length(seasons)) {
  temp.resp <- NEpartial_resp[[j]]
  temp.preds <- NEpartial_preds[[j]]
  
  temp.list <- NULL
  temp.model <- NULL
  temp.refit <- NULL
  for (k in 1:length(temp.preds)) {
    temp.y <- as.numeric(temp.resp[[k]])
    #with OLR
    temp.X <- cbind(as.matrix(temp.preds[[k]][ ,1:260]))
    
    temp.fit <- RAMP(X = temp.X, y = temp.y,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)
    #terms only
    temp.list[[k]] <- terms_only(temp.fit, temp.X)
    temp.model[[k]] <- refit_ramp(temp.fit, temp.X)
    #temp.refit[[k]] <- refit_ramp(NEmodels[[k]], temp.X)
  }
  NE.terms.noOLR[[seasons[j]]] <- temp.list
  NE.model.noOLR[[seasons[j]]] <- temp.model
  #NE.refit.noOLR[[seasons[j]]] <- temp.refit
}


#sE Aus 
SE.terms.noOLR <- NULL
SE.model.noOLR <- NULL
#SE.refit.noOLR <- NULL #refit with base model
for (j in 1:length(seasons)) {
  temp.resp <- SEpartial_resp[[j]]
  temp.preds <- SEpartial_preds[[j]]
  
  temp.list <- NULL
  temp.model <- NULL
  temp.refit <- NULL
  for (k in 1:length(temp.preds)) {
    temp.y <- as.numeric(temp.resp[[k]])
    #with OLR
    temp.X <- cbind(as.matrix(temp.preds[[k]][ ,1:260]))
    
    temp.fit <- RAMP(X = temp.X, y = temp.y,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)
    #terms only
    temp.list[[k]] <- terms_only(temp.fit, temp.X)
    temp.model[[k]] <- refit_ramp(temp.fit, temp.X)
    #temp.refit[[k]] <- refit_ramp(SEmodels[[k]], temp.X)
  }
  SE.terms.noOLR[[seasons[j]]] <- temp.list
  SE.model.noOLR[[seasons[j]]] <- temp.model
  #SE.refit.noOLR[[seasons[j]]] <- temp.refit
}

```

```{r save}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(SE.terms.noOLR, SE.model.noOLR, 
     NE.terms.noOLR, NE.model.noOLR, file = "modelrefits_noOLR.rda")
```

```{r noOLR_constant}
NE.refit.noOLR <- NULL #refit with base model
for (j in 1:length(seasons)) {
  temp.resp <- NEpartial_resp[[j]]
  temp.preds <- NEpartial_preds[[j]]
  
  temp.refit <- NULL
  for (k in 1:length(temp.preds)) {
    temp.y <- as.numeric(temp.resp[[k]])
    #with OLR
    temp.X <- cbind(as.matrix(temp.preds[[k]][ ,1:260]))

    temp.refit[[k]] <- refit_ramp(NEmodels.noOLR[[k]], temp.X)
  }
  NE.refit.noOLR[[seasons[j]]] <- temp.refit
}


SE.refit.noOLR <- NULL #refit with base model
for (j in 1:length(seasons)) {
  temp.resp <- SEpartial_resp[[j]]
  temp.preds <- SEpartial_preds[[j]]
  
  temp.refit <- NULL
  for (k in 1:length(temp.preds)) {
    temp.y <- as.numeric(temp.resp[[k]])
    #with OLR
    temp.X <- cbind(as.matrix(temp.preds[[k]][ ,1:260]))
    
    temp.refit[[k]] <- refit_ramp(SEmodels.noOLR[[k]], temp.X)
  }
  SE.refit.noOLR[[seasons[j]]] <- temp.refit
}
```


### Refit - eBIC

```{r NErefit_eBIC}

```


## Comparison to Base

```{r NeAus_compare}
#NE Aus Group 1

#get frequency of each term 
baseNE1 <- NE1.terms
#refitNE1 <- NE.term.list[[2]][[1]]

refitNE1 <- unlist(lapply(NE.term.list, function(x) x[[1]]))
baseNE1.count <- sapply(baseNE1, function(x) sum(x == refitNE1))



#unique(refitNE1)
NErefit1.unique <- table(refitNE1)
NErefit1.unique <- NErefit1.unique[!names(NErefit1.unique) %in% baseNE1]
refitNE1.count <- sort(NErefit1.unique, decreasing = TRUE)

#group 2
baseNE2 <- NE2.terms
#refitNE2 <- NE.term.list[[2]][[2]]

refitNE2 <- unlist(lapply(NE.term.list, function(x) x[[2]]))
baseNE2.count <- sapply(baseNE2, function(x) sum(x == refitNE2))
#unique(refitNE2)
NErefit2.unique <- table(refitNE2)
NErefit2.unique <- NErefit2.unique[!names(NErefit2.unique) %in% baseNE2]
refitNE2.count <- sort(NErefit2.unique, decreasing = TRUE)


#group 3
baseNE3 <- NE3.terms
#refitNE3 <- NE.term.list[[2]][[3]]

refitNE3 <- unlist(lapply(NE.term.list, function(x) x[[3]]))
baseNE3.count <- sapply(baseNE3, function(x) sum(x == refitNE3))
#unique(refitNE3)
NErefit3.unique <- table(refitNE3)
NErefit3.unique <- NErefit3.unique[!names(NErefit3.unique) %in% baseNE3]
refitNE3.count <- sort(NErefit3.unique, decreasing = TRUE)

```

```{r seAus_compare}
#sE Aus Group 1

#get frequency of each term 
baseSE1 <- SE1.terms
#refitSE1 <- SE.term.list[[2]][[1]]

refitSE1 <- unlist(lapply(SE.term.list, function(x) x[[1]]))
baseSE1.count <- sapply(baseSE1, function(x) sum(x == refitSE1))
#unique(refitSE1)
SErefit1.unique <- table(refitSE1)
SErefit1.unique <- SErefit1.unique[!names(SErefit1.unique) %in% baseSE1]
refitSE1.count <- sort(SErefit1.unique, decreasing = TRUE)


#group 2
baseSE2 <- SE2.terms
#refitSE2 <- SE.term.list[[2]][[2]]

refitSE2 <- unlist(lapply(SE.term.list, function(x) x[[2]]))
baseSE2.count <- sapply(baseSE2, function(x) sum(x == refitSE2))
#unique(refitSE2)
SErefit2.unique <- table(refitSE2)
SErefit2.unique <- SErefit2.unique[!names(SErefit2.unique) %in% baseSE2]
refitSE2.count <- sort(SErefit2.unique, decreasing = TRUE)

#group 3
baseSE3 <- SE3.terms
#refitSE3 <- SE.term.list[[2]][[3]]

refitSE3 <- unlist(lapply(SE.term.list, function(x) x[[3]]))
baseSE3.count <- sapply(baseSE3, function(x) sum(x == refitSE3))
#unique(refitSE3)
SErefit3.unique <- table(refitSE3)
SErefit3.unique <- SErefit3.unique[!names(SErefit3.unique) %in% baseSE3]
refitSE3.count <- sort(SErefit3.unique, decreasing = TRUE)

```


### Proportion/Count Figures

```{r setup}
rateNE1.const <- sort(baseNE1.count, decreasing = FALSE)/19
rateNE2.const <- sort(baseNE2.count, decreasing = FALSE)/19
rateNE3.const <- sort(baseNE3.count, decreasing = FALSE)/19

rateSE1.const <- sort(baseSE1.count, decreasing = FALSE)/19
rateSE2.const <- sort(baseSE2.count, decreasing = FALSE)/19
rateSE3.const <- sort(baseSE3.count, decreasing = FALSE)/19

cols.ryg19 <- colorRampPalette(brewer.pal(11, "RdYlGn"))(19)
col.seq <- 1:19/19

col.NE1 <- cols.ryg19[match(rateNE1.const, col.seq)]
col.NE2 <- cols.ryg19[match(rateNE2.const, col.seq)]
col.NE3 <- cols.ryg19[match(rateNE3.const, col.seq)]

col.SE1 <- cols.ryg19[match(rateSE1.const, col.seq)]
col.SE2 <- cols.ryg19[match(rateSE2.const, col.seq)]
col.SE3 <- cols.ryg19[match(rateSE3.const, col.seq)]

#other terms
temp.refitNE1 <- refitNE1.count[refitNE1.count > 1]
NE1x_vals <- rep(seq_along(temp.refitNE1), times = temp.refitNE1)
NE1y_vals <- unlist(lapply(temp.refitNE1, function(n) seq_len(n)))

dumb.expansion <- factor(rep(names(temp.refitNE1), times = temp.refitNE1))
is.factor(dumb.expansion)
```

```{r base.fits}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "NE1.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateNE1.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.NE1, xlab = "Proportion")
title("NE Aus Group 1", adj = 0)
dev.off()

png(filename = "NE2.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateNE2.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.NE2, xlab = "Proportion")
title("NE Aus Group 2", adj = 0)
dev.off()

png(filename = "NE3.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateNE3.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.NE3, xlab = "Proportion")
title("NE Aus Group 3", adj = 0)
dev.off()

png(filename = "SE1.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateSE1.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.SE1, xlab = "Proportion")
title("SE Aus Group 1", adj = 0)
dev.off()

png(filename = "SE2.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateSE2.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.SE2, xlab = "Proportion")
title("SE Aus Group 2", adj = 0)
dev.off()

png(filename = "SE3.const.png", width = 2400, height = 1600, res = 250)
par(mar = c(5, 10, 3, 3))
barplot(height = rateSE3.const, xlim = c(0,1),
        horiz=T, las = 1, col = col.SE3, xlab = "Proportion")
title("SE Aus Group 3", adj = 0)
dev.off()

```

```{r term_count}
#NE 1
temp.refitNE1 <- refitNE1.count[refitNE1.count > 1]

NE1.expansion <- factor(rep(names(temp.refitNE1), times = temp.refitNE1)) #change to numbers than overwrite the labels
NE1.levels <- levels(NE1.expansion)
NE1.exp <- as.numeric(NE1.expansion)

#NE 2
temp.refitNE2 <- refitNE2.count[refitNE2.count > 1]

NE2.expansion <- factor(rep(names(temp.refitNE2), times = temp.refitNE2)) #change to numbers than overwrite the labels
NE2.levels <- levels(NE2.expansion)
NE2.exp <- as.numeric(NE2.expansion)

#NE 3
temp.refitNE3 <- refitNE3.count[refitNE3.count > 1]

NE3.expansion <- factor(rep(names(temp.refitNE3), times = temp.refitNE3)) #change to numbers than overwrite the labels
NE3.levels <- levels(NE3.expansion)
NE3.exp <- as.numeric(NE3.expansion)


#SE 1
temp.refitSE1 <- refitSE1.count[refitSE1.count > 1]

SE1.expansion <- factor(rep(names(temp.refitSE1), times = temp.refitSE1)) #change to numbers than overwrite the labels
SE1.levels <- levels(SE1.expansion)
SE1.exp <- as.numeric(SE1.expansion)

#SE 2
temp.refitSE2 <- refitSE2.count[refitSE2.count > 1]

SE2.expansion <- factor(rep(names(temp.refitSE2), times = temp.refitSE2)) #change to numbers than overwrite the labels
SE2.levels <- levels(SE2.expansion)
SE2.exp <- as.numeric(SE2.expansion)

#SE 3
temp.refitSE3 <- refitSE3.count[refitSE3.count > 1]

SE3.expansion <- factor(rep(names(temp.refitSE3), times = temp.refitSE3)) #change to numbers than overwrite the labels
SE3.levels <- levels(SE3.expansion)
SE3.exp <- as.numeric(SE3.expansion)


```

```{r refits}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "NE1varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(NE1.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(NE1.levels), labels = NE1.levels, las = 1, cex = 0.75)
title("NE Aus Group 1  ", adj = 0)
dev.off()


png(filename = "NE2varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(NE2.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(NE2.levels), labels = NE2.levels, las = 1, cex = 0.75)
title("NE Aus Group 2  ", adj = 0)
dev.off()


png(filename = "NE3varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(NE3.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(NE3.levels), labels = NE3.levels, las = 1, cex = 0.75)
title("NE Aus Group 3  ", adj = 0)
dev.off()


png(filename = "SE1varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(SE1.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(SE1.levels), labels = SE1.levels, las = 1, cex = 0.75)
title("SE Aus Group 1  ", adj = 0)
dev.off()

png(filename = "SE2varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(SE2.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(SE2.levels), labels = SE2.levels, las = 1, cex = 0.75)
title("SE Aus Group 2  ", adj = 0)
dev.off()

png(filename = "SE3varyterms.png", width = 2400, height = 2000, res = 250)
par(mar = c(5, 10.65, 3, 3))
stripchart(SE3.exp, method = "stack", offset = 1.65, at = 0,
           pch = 19, col = "steelblue", vertical = TRUE, xlab = "Count", yaxt = "n", xlim = c(0,0.5))
axis(2, at = 1:length(SE3.levels), labels = SE3.levels, las = 1, cex = 0.75)
title("SE Aus Group 3  ", adj = 0)
dev.off()
```

# Model Validation

(Note: the model validation for eBIC is done above in the LOO work)

```{r test_model_fits}
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))


lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm <- lm(formula(NE1.refit), lm.data_1)
summary(NE1.lm)


NEvalid_preds[[1]][[1]]
y.true <- NEvalid_resp[[1]][[1]]

y.pred <- predict(NE1.lm, NEvalid_preds[[1]][[1]], se.fit = TRUE)

y.pred$fit
y.pred$se.fit

CPRS(list(mean = y.pred$fit, sd = y.pred$se.fit), y.true)
intscore(list(mean = y.pred$fit, sd = y.pred$se.fit), y.true)

y.true
y.pred
y.true - y.pred

#without OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm.noOLR <- lm(formula(NE1.refit.noOLR), lm.data_1)
summary(NE1.lm.noOLR)

test.X <- NEvalid_preds[[1]][[1]][ ,1:260]
y.pred.noOLR <- predict(NE1.lm.noOLR, test.X)

y.true
y.pred.noOLR
y.true - y.pred.noOLR
```

```{r base_NElm}
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))

lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm <- lm(formula(NE1.refit), lm.data_1)
summary(NE1.lm)

#NE Aus Group 2
y_2 <- as.numeric(NEresp_new[[2]])

#with OLR
X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:312]))

lm.data_2 <- as.data.frame(cbind(y_2, X_2))
names(lm.data_2)[1] <- "co"

NE2.lm <- lm(formula(NE2.refit), lm.data_2)
summary(NE2.lm)

#without OLR
#X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:260]))

#lm.data_2 <- as.data.frame(cbind(y_2, X_2))
#names(lm.data_2)[1] <- "co"

#NE2.lm.noOLR <- lm(formula(NE2.refit.noOLR), lm.data_2)
#summary(NE2.lm.noOLR)


#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])

#with OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:312]))

lm.data_3 <- as.data.frame(cbind(y_3, X_3))
names(lm.data_3)[1] <- "co"

NE3.lm <- lm(formula(NE3.refit), lm.data_3)
summary(NE3.lm)


NE.lms <- list(NE1.lm, NE2.lm, NE3.lm)

```

```{r base_SElm}
#SE Aus Group 1
y_1 <- as.numeric(SEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:312]))

lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

SE1.lm <- lm(formula(SE1.refit), lm.data_1)
summary(SE1.lm)

#SE Aus Group 2
y_2 <- as.numeric(SEresp_new[[2]])

#with OLR
X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:312]))

lm.data_2 <- as.data.frame(cbind(y_2, X_2))
names(lm.data_2)[1] <- "co"

SE2.lm <- lm(formula(SE2.refit), lm.data_2)
summary(SE2.lm)

#SE Aus Group 3
y_3 <- as.numeric(SEresp_new[[3]])

#with OLR
X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:312]))

lm.data_3 <- as.data.frame(cbind(y_3, X_3))
names(lm.data_3)[1] <- "co"

SE3.lm <- lm(formula(SE3.refit), lm.data_3)
summary(SE3.lm)


SE.lms <- list(SE1.lm, SE2.lm, SE3.lm)
```


## LOO Validation

Includes:
rmse, crps, Int score
TODO: add in OOS adj. R^2

```{r model_fits_validation}

#lists
## full model fit: NErefits
## LOO model w/ constant terms: NE.refit.list
## LOO model w/ varying terms: NE.model.list

#rmse 
NE.rmse <- NULL
NE.cprs <- NULL
NE.ints <- NULL
NE.const.LM <- NULL #linear models
NE.vary.LM <- NULL
NE.pred.int <- NULL
for (i in 1:length(seasons)) {
  fit.resp <- NEpartial_resp[[i]]
  fit.preds <- NEpartial_preds[[i]]
  
  valid.resp <- NEvalid_resp[[i]]
  valid.preds <- NEvalid_preds[[i]]
  
  #get terms/model for year/season 
  year.constant <- NE.refit.list[[i]]
  year.varying <- NE.model.list[[i]]
  
  #add in lists/matrices
  NE.loo <- NULL #constant linear models
  NE.var <- NULL #varying linear models
  NErmse.yearly <- matrix(NA, ncol = 3)
  colnames(NErmse.yearly) <- c("base.pred", "const.pred", "vary.pred")
  NEcprs.yearly <- matrix(NA, ncol = 3)
  colnames(NEcprs.yearly) <- c("base.pred", "const.pred", "vary.pred")
  NEis.yearly <- matrix(NA, ncol = 3)
  colnames(NEis.yearly) <- c("base.pred", "const.pred", "vary.pred")
  NE.intervals <- matrix(NA, ncol = 12)
  colnames(NE.intervals) <- c("true", "base.fit", "base.lwr", "base.upr",  
                              "const.fit", "const.lwr", "const.upr",
                              "vary.fit", "vary.lwr", "vary.upr", 
                              "const.lwr99", "const.upr99")
  
  #groups/clusters below
  for (j in 1:3) {
    #lm fit data setup
    y.fit <- as.numeric(fit.resp[[j]])
    #with OLR
    X.fit <- cbind(as.matrix(fit.preds[[j]][ ,1:312]))
    
    lm.data.fit <- as.data.frame(cbind(y.fit, X.fit))
    names(lm.data.fit)[1] <- "co"

    #fit lm models (w/o year/season)
    temp.lm.constant <- lm(formula(year.constant[[j]]), lm.data.fit)
    temp.lm.varying <- lm(formula(year.varying[[j]]), lm.data.fit)
    
    #predict/rmse
    X.valid <- valid.preds[[j]][ ,1:312]
    y.valid <- valid.resp[[j]]
    
    #prediction
    pred.base <- predict(NE.lms[[j]], X.valid, se.fit = TRUE)
    pred.const <- predict(temp.lm.constant, X.valid, se.fit = TRUE)
    pred.vary <- predict(temp.lm.varying, X.valid, se.fit = TRUE)
    
    #prediction interval
    pred.base.interval <- predict(NE.lms[[j]], X.valid, interval = "prediction")
    pred.const.interval <- predict(temp.lm.constant, X.valid, interval = "prediction", level = 0.95, se.fit = TRUE)
    pred.vary.interval <- predict(temp.lm.varying, X.valid, interval = "prediction")
    
    #pred interval 90%
    pred.const.interval.90 <- predict(temp.lm.constant, X.valid, interval = "prediction", level = 0.99, se.fit = TRUE)
    
    #predict( ,se.fit = TRUE)
    y.pred.base <- pred.base$fit 
    y.pred.const <- pred.const$fit
    y.pred.vary <- pred.vary$fit
    
    #rmse test
    rmse.base <-  rmse(y.valid, y.pred.base)
    rmse.const <- rmse(y.valid, y.pred.const)
    rmse.vary <- rmse(y.valid, y.pred.vary)
    
    #cprs
    cprs.base <- mean(CPRS(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    cprs.const <- mean(CPRS(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    cprs.vary <- mean(CPRS(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    #IS95
    is.base <- mean(intscore(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    is.const <- mean(intscore(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    is.vary <- mean(intscore(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    #assign data
    RMSE.temp.mat <- cbind(rmse.base, rmse.const, rmse.vary)
    NErmse.yearly <- rbind(NErmse.yearly, RMSE.temp.mat) 
    CPRS.temp.mat <- cbind(cprs.base, cprs.const, cprs.vary)
    NEcprs.yearly <- rbind(NEcprs.yearly, CPRS.temp.mat)
    IS.temp.mat <- cbind(is.base, is.const, is.vary)
    NEis.yearly <- rbind(NEis.yearly, IS.temp.mat)
    
    #assign models
    NE.loo[[j]] <- temp.lm.constant
    NE.var[[j]] <- temp.lm.varying
    
    #assign predictions
    NE.intervals <- rbind(NE.intervals, cbind(y.valid, pred.base.interval, pred.const.interval$fit, pred.vary.interval,
                                              pred.const.interval.90$fit[,c(2,3)]))
  }
  #NErmse.yearly <- as.data.frame(NErmse.yearly[-1, ])
  NE.rmse[[seasons[i]]] <- as.data.frame(NErmse.yearly[-1, ])
  NE.cprs[[seasons[i]]] <- as.data.frame(NEcprs.yearly[-1, ])
  NE.ints[[seasons[i]]] <- as.data.frame(NEis.yearly[-1, ])
  NE.const.LM[[seasons[i]]] <- NE.loo
  NE.vary.LM[[seasons[i]]] <- NE.var
  NE.pred.int[[seasons[i]]] <- as.data.frame(NE.intervals[-1, ])
}


#TODO: add more validation
#rmse 
SE.rmse <- NULL
SE.cprs <- NULL
SE.ints <- NULL
SE.const.LM <- NULL #linear models
SE.vary.LM <- NULL
SE.pred.int <- NULL
for (i in 1:length(seasons)) {
  fit.resp <- SEpartial_resp[[i]]
  fit.preds <- SEpartial_preds[[i]]
  
  valid.resp <- SEvalid_resp[[i]]
  valid.preds <- SEvalid_preds[[i]]
  
  #get terms/model for year/season 
  year.constant <- SE.refit.list[[i]]
  year.varying <- SE.model.list[[i]]
  
  #add in lists/matrices
  SE.loo <- NULL #constant linear models
  SE.var <- NULL #varying linear models
  SErmse.yearly <- matrix(NA, ncol = 3)
  colnames(SErmse.yearly) <- c("base.pred", "const.pred", "vary.pred")
  SEcprs.yearly <- matrix(NA, ncol = 3)
  colnames(SEcprs.yearly) <- c("base.pred", "const.pred", "vary.pred")
  SEis.yearly <- matrix(NA, ncol = 3)
  colnames(SEis.yearly) <- c("base.pred", "const.pred", "vary.pred")
  SE.intervals <- matrix(NA, ncol = 12)
  colnames(SE.intervals) <- c("true", "base.fit", "base.lwr", "base.upr",  
                              "const.fit", "const.lwr", "const.upr",
                              "vary.fit", "vary.lwr", "vary.upr", 
                              "const.lwr99", "const.upr99")
  
  #groups/clusters below
  for (j in 1:3) {
    #lm fit data setup
    y.fit <- as.numeric(fit.resp[[j]])
    #with OLR
    X.fit <- cbind(as.matrix(fit.preds[[j]][ ,1:312]))
    
    lm.data.fit <- as.data.frame(cbind(y.fit, X.fit))
    names(lm.data.fit)[1] <- "co"

    #fit lm models (w/o year/season)
    temp.lm.constant <- lm(formula(year.constant[[j]]), lm.data.fit)
    temp.lm.varying <- lm(formula(year.varying[[j]]), lm.data.fit)
    
    #predict/rmse
    X.valid <- valid.preds[[j]][ ,1:312]
    y.valid <- valid.resp[[j]]
    
    #prediction
    pred.base <- predict(SE.lms[[j]], X.valid, se.fit = TRUE)
    pred.const <- predict(temp.lm.constant, X.valid, se.fit = TRUE)
    pred.vary <- predict(temp.lm.varying, X.valid, se.fit = TRUE)
    
    #prediction interval
    pred.base.interval <- predict(SE.lms[[j]], X.valid, interval = "prediction")
    pred.const.interval <- predict(temp.lm.constant, X.valid, interval = "prediction", level = 0.95)
    pred.vary.interval <- predict(temp.lm.varying, X.valid, interval = "prediction")    
    
    #pred interval 90%
    pred.const.interval.90 <- predict(temp.lm.constant, X.valid, interval = "prediction", level = 0.99, se.fit = TRUE)
    
    y.pred.base <- pred.base$fit 
    y.pred.const <- pred.const$fit
    y.pred.vary <- pred.vary$fit
    
    #rmse test
    rmse.base <-  rmse(y.valid, y.pred.base)
    rmse.const <- rmse(y.valid, y.pred.const)
    rmse.vary <- rmse(y.valid, y.pred.vary)
    
    #cprs
    cprs.base <- mean(CPRS(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    cprs.const <- mean(CPRS(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    cprs.vary <- mean(CPRS(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    #IS95
    is.base <- mean(intscore(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    is.const <- mean(intscore(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    is.vary <- mean(intscore(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    temp.mat <- cbind(rmse.base, rmse.const, rmse.vary)
    SErmse.yearly <- rbind(SErmse.yearly, temp.mat) 
    CPRS.temp.mat <- cbind(cprs.base, cprs.const, cprs.vary)
    SEcprs.yearly <- rbind(SEcprs.yearly, CPRS.temp.mat)
    IS.temp.mat <- cbind(is.base, is.const, is.vary)
    SEis.yearly <- rbind(SEis.yearly, IS.temp.mat)
    
    SE.loo[[j]] <- temp.lm.constant
    SE.var[[j]] <- temp.lm.varying
    
    #assign predictions
    SE.intervals <- rbind(SE.intervals, cbind(y.valid, pred.base.interval, pred.const.interval, pred.vary.interval,
                                              pred.const.interval.90$fit[,c(2,3)]))   
  }
  #NErmse.yearly <- as.data.frame(NErmse.yearly[-1, ])
  SE.rmse[[seasons[i]]] <- as.data.frame(SErmse.yearly[-1, ])
  SE.cprs[[seasons[i]]] <- as.data.frame(SEcprs.yearly[-1, ])
  SE.ints[[seasons[i]]] <- as.data.frame(SEis.yearly[-1, ])
  SE.const.LM[[seasons[i]]] <- SE.loo
  SE.vary.LM[[seasons[i]]] <- SE.var
  SE.pred.int[[seasons[i]]] <- as.data.frame(SE.intervals[-1, ])
}

```

```{r test_oosR2}
#TODO: get out of sample R2 working then merge it into previous block validation code.

```

### LOO - Models w/o OLR

```{r}
NE.rmse.noOLR <- NULL
NE.cprs.noOLR <- NULL
NE.ints.noOLR <- NULL
NE.const.noOLR <- NULL #linear models
NE.vary.noOLR <- NULL
NE.predint.noOLR <- NULL
for (i in 1:length(seasons)) {
  fit.resp <- NEpartial_resp[[i]]
  fit.preds <- NEpartial_preds[[i]]
  
  valid.resp <- NEvalid_resp[[i]]
  valid.preds <- NEvalid_preds[[i]]
  
  #get terms/model for year/season 
  year.constant <- NE.refit.noOLR[[i]]
  year.varying <- NE.model.noOLR[[i]] 
  
  #add in lists/matrices
  NE.loo <- NULL #
  NErmse.yearly <- matrix(NA, ncol = 3)
  colnames(NErmse.yearly) <- c("base.pred", "const.pred", "vary.pred")
  NEcprs.yearly <- matrix(NA, ncol = 3)
  colnames(NEcprs.yearly) <- c("base.pred", "const.pred", "vary.pred")
  NEis.yearly <- matrix(NA, ncol = 3)
  colnames(NEis.yearly) <- c("base.pred", "const.pred", "vary.pred")
  for (j in 1:3) {
    #lm fit data setup
    y.fit <- as.numeric(fit.resp[[j]])
    #with OLR
    X.fit <- cbind(as.matrix(fit.preds[[j]][ ,1:260]))
    
    lm.data.fit <- as.data.frame(cbind(y.fit, X.fit))
    names(lm.data.fit)[1] <- "co"

    #fit lm models (w/o year/season)
    temp.lm.constant <- lm(formula(year.constant[[j]]), lm.data.fit)
    temp.lm.varying <- lm(formula(year.varying[[j]]), lm.data.fit)
  
    #predict/rmse
    X.valid <- valid.preds[[j]][ ,1:260]
    y.valid <- valid.resp[[j]]
    
    #prediction
    pred.base <- predict(NE.lm.noOLR[[j]], X.valid, se.fit = TRUE)
    pred.const <- predict(temp.lm.constant, X.valid, se.fit = TRUE)
    pred.vary <- predict(temp.lm.varying, X.valid, se.fit = TRUE)
    
    
    
    
    #predict( ,se.fit = TRUE)
    y.pred.base <- pred.base$fit 
    y.pred.const <- pred.const$fit
    y.pred.vary <- pred.vary$fit
    
    #rmse test
    rmse.base <-  rmse(y.valid, y.pred.base)
    rmse.const <- rmse(y.valid, y.pred.const)
    rmse.vary <- rmse(y.valid, y.pred.vary)
    
    #cprs
    cprs.base <- mean(CPRS(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    cprs.const <- mean(CPRS(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    cprs.vary <- mean(CPRS(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    #IS95
    is.base <- mean(intscore(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    is.const <- mean(intscore(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    is.vary <- mean(intscore(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    #assign data
    RMSE.temp.mat <- cbind(rmse.base, rmse.const, rmse.vary)
    NErmse.yearly <- rbind(NErmse.yearly, RMSE.temp.mat) 
    CPRS.temp.mat <- cbind(cprs.base, cprs.const, cprs.vary)
    NEcprs.yearly <- rbind(NEcprs.yearly, CPRS.temp.mat)
    IS.temp.mat <- cbind(is.base, is.const, is.vary)
    NEis.yearly <- rbind(NEis.yearly, IS.temp.mat)
    
    NE.loo[[j]] <- temp.lm.constant
  }
  #NErmse.yearly <- as.data.frame(NErmse.yearly[-1, ])
  NE.rmse.noOLR[[seasons[i]]] <- as.data.frame(NErmse.yearly[-1, ])
  NE.cprs.noOLR[[seasons[i]]] <- as.data.frame(NEcprs.yearly[-1, ])
  NE.ints.noOLR[[seasons[i]]] <- as.data.frame(NEis.yearly[-1, ])
  NE.const.noOLR[[seasons[i]]] <- NE.loo
}  


SE.rmse.noOLR <- NULL
SE.cprs.noOLR <- NULL
SE.ints.noOLR <- NULL
SE.const.noOLR <- NULL #linear models
SE.vary.noOLR <- NULL
for (i in 1:length(seasons)) {
  fit.resp <- SEpartial_resp[[i]]
  fit.preds <- SEpartial_preds[[i]]
  
  valid.resp <- SEvalid_resp[[i]]
  valid.preds <- SEvalid_preds[[i]]
  
  #get terms/model for year/season 
  year.constant <- SE.refit.noOLR[[i]]
  year.varying <- SE.model.noOLR[[i]]
  
  #add in lists/matrices
  SE.loo <- NULL #
  SE.var <- NULL 
  SErmse.yearly <- matrix(NA, ncol = 3)
  colnames(SErmse.yearly) <- c("base.pred", "const.pred", "vary.pred")
  SEcprs.yearly <- matrix(NA, ncol = 3)
  colnames(SEcprs.yearly) <- c("base.pred", "const.pred", "vary.pred")
  SEis.yearly <- matrix(NA, ncol = 3)
  colnames(SEis.yearly) <- c("base.pred", "const.pred", "vary.pred")
  #groups/clusters below
  for (j in 1:3) {
    #lm fit data setup
    y.fit <- as.numeric(fit.resp[[j]])
    #with OLR
    X.fit <- cbind(as.matrix(fit.preds[[j]][ ,1:260]))
    
    lm.data.fit <- as.data.frame(cbind(y.fit, X.fit))
    names(lm.data.fit)[1] <- "co"

    #fit lm models (w/o year/season)
    temp.lm.constant <- lm(formula(year.constant[[j]]), lm.data.fit)
    temp.lm.varying <- lm(formula(year.varying[[j]]), lm.data.fit)
    
    #predict/rmse
    X.valid <- valid.preds[[j]][ ,1:260]
    y.valid <- valid.resp[[j]]
    
    #prediction
    pred.base <- predict(SE.lm.noOLR[[j]], X.valid, se.fit = TRUE)
    pred.const <- predict(temp.lm.constant, X.valid, se.fit = TRUE)
    pred.vary <- predict(temp.lm.varying, X.valid, se.fit = TRUE)
    
    y.pred.base <- pred.base$fit 
    y.pred.const <- pred.const$fit
    y.pred.vary <- pred.vary$fit
    
    #rmse test
    rmse.base <-  rmse(y.valid, y.pred.base)
    rmse.const <- rmse(y.valid, y.pred.const)
    rmse.vary <- rmse(y.valid, y.pred.vary)
    
    #cprs
    cprs.base <- mean(CPRS(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    cprs.const <- mean(CPRS(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    cprs.vary <- mean(CPRS(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    #IS95
    is.base <- mean(intscore(list(mean = pred.base$fit, sd = pred.base$se.fit), y.valid))
    is.const <- mean(intscore(list(mean = pred.const$fit, sd = pred.const$se.fit), y.valid))
    is.vary <- mean(intscore(list(mean = pred.vary$fit, sd = pred.vary$se.fit), y.valid))
    
    temp.mat <- cbind(rmse.base, rmse.const, rmse.vary)
    SErmse.yearly <- rbind(SErmse.yearly, temp.mat) 
    CPRS.temp.mat <- cbind(cprs.base, cprs.const, cprs.vary)
    SEcprs.yearly <- rbind(SEcprs.yearly, CPRS.temp.mat)
    IS.temp.mat <- cbind(is.base, is.const, is.vary)
    SEis.yearly <- rbind(SEis.yearly, IS.temp.mat)
    
    SE.loo[[j]] <- temp.lm.constant
    SE.var[[j]] <- temp.lm.varying
  }
  #NErmse.yearly <- as.data.frame(NErmse.yearly[-1, ])
  SE.rmse.noOLR[[seasons[i]]] <- as.data.frame(SErmse.yearly[-1, ])
  SE.cprs.noOLR[[seasons[i]]] <- as.data.frame(SEcprs.yearly[-1, ])
  SE.ints.noOLR[[seasons[i]]] <- as.data.frame(SEis.yearly[-1, ])
  SE.const.noOLR[[seasons[i]]] <- SE.loo
  SE.vary.noOLR[[seasons[i]]] <- SE.var
}



```



### Model Summaries

```{r summ_outputs}
summ(SE.vary.LM$`2019-2020`[[2]], confint = TRUE, digits = 3)

library( officer)
library( flextable)

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

NE1 <- NE.lms[[1]]
NE1.wo2019 <- NE.const.LM$`2019-2020`[[1]]

export_summs(NE1, NE1.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("NE Group 1","NE Group 1 (w/o 2019)"),
             to.file = "docx", file.name = "NE1models.docx")

NE2 <- NE.lms[[2]]
NE2.wo2019 <- NE.const.LM$`2019-2020`[[2]]

export_summs(NE2, NE2.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("NE Group 2","NE Group 2 (w/o 2019)"),
             to.file = "docx", file.name = "NE2models.docx", longtable = TRUE)

NE3 <- NE.lms[[3]]
NE3.wo2019 <- NE.const.LM$`2019-2020`[[3]]

export_summs(NE3, NE3.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("NE Group 3","NE Group 3 (w/o 2019)"),
             to.file = "docx", file.name = "NE3models.docx", longtable = TRUE)


SE1 <- SE.lms[[1]]
SE1.wo2019 <- SE.const.LM$`2019-2020`[[1]]

export_summs(SE1, SE1.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("SE Group 1","SE Group 1 (w/o 2019)"),
             to.file = "docx", file.name = "SE1models.docx", longtable = TRUE)

SE2 <- SE.lms[[2]]
SE2.wo2019 <- SE.const.LM$`2019-2020`[[2]]

export_summs(SE2, SE2.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("SE Group 2","SE Group 2 (w/o 2019)"),
             to.file = "docx", file.name = "SE2models.docx", longtable = TRUE)

SE3 <- SE.lms[[3]]
SE3.wo2019 <- SE.const.LM$`2019-2020`[[3]]

export_summs(SE3, SE3.wo2019, scale = FALSE, 
             error_format = "[{conf.low}, {conf.high}]", model.names = c("SE Group 3","SE Group 3 (w/o 2019)"),
             to.file = "docx", file.name = "SE3models.docx", longtable = TRUE)

```


```{r basic_sumaries}
summ(NE.lms[[1]], confint = TRUE, digits = 3)
summ(NE.lms[[2]], confint = TRUE, digits = 3)
summ(NE.lms[[3]], confint = TRUE, digits = 3)

summ(SE.lms[[1]], confint = TRUE, digits = 3)
summ(SE.lms[[2]], confint = TRUE, digits = 3)
summ(SE.lms[[3]], confint = TRUE, digits = 3)

```


### Seasonal Overlap

Known WTIO/ETIO Lags:
NE Aus Group 1: etio_lag42
NE Aus Group 2: wtio_lag30, etio_lag4
NE Aus Group 3: etio_lag19

SE Aus Group 1: wtio_lag4, wtio_lag5, wtio_lag13, etio_lag31
SE Aus Group 2: wtio_lag14, wtio_lag46, etio_lag7, etio_lag33
SE Aus Group 3: wtio_lag1, etio_lag15

```{r overlaps}
#setup
NEAus1_weeks <- season_weeks[4:12]
NEAus2_weeks <- season_weeks[13:17]
NEAus3_weeks <- season_weeks[18:32]

SEAus1_weeks <- season_weeks[4:16]
SEAus2_weeks <- season_weeks[17:20]
SEAus3_weeks <- season_weeks[21:32]

#TODO: make this more flexible

# NE Aus 1
#etio_lag42
NEAus1_lag42 <- NEAus1_weeks - 42
NEAus1_lag42 <- sapply(NEAus1_lag42, function(x) ifelse(x <=0, x + 52, x)) 
NEAus1_lag42

#NE Aus 2
#wtio_lag30
NEAus2_lag30 <- NEAus2_weeks - 30
NEAus2_lag30

#etio_lag4
NEAus2_lag4 <- NEAus2_weeks - 4
NEAus2_lag4

#NE Aus 3
#etio_lag19
NEAus3_lag19 <- NEAus3_weeks - 19
NEAus3_lag19 <- sapply(NEAus3_lag19, function(x) ifelse(x <=0, x + 52, x)) 
NEAus3_lag19  

#SE Aus 1
#wtio_lag4
SEAus1_lag4 <- SEAus1_weeks - 4
SEAus1_lag4

#wtio_lag5
SEAus1_lag5 <- SEAus1_weeks - 5
SEAus1_lag5

#wtio_lag13
SEAus1_lag13 <- SEAus1_weeks - 13
SEAus1_lag13

#etio_lag31
SEAus1_lag31 <- SEAus1_weeks - 31
SEAus1_lag31

#SE Aus 2
#wtio_lag14
SEAus2_lag14 <-  SEAus2_weeks - 14
SEAus2_lag14 <- sapply(SEAus2_lag14, function(x) ifelse(x <=0, x + 52, x)) 
SEAus2_lag14 

#wtio_lag46
SEAus2_lag46 <-  SEAus2_weeks - 46
SEAus2_lag46 <- sapply(SEAus2_lag46, function(x) ifelse(x <=0, x + 52, x)) 
SEAus2_lag46 

#etio_lag7
SEAus2_lag7 <-  SEAus2_weeks - 7
SEAus2_lag7 <- sapply(SEAus2_lag7, function(x) ifelse(x <=0, x + 52, x)) 
SEAus2_lag7 

#etio_lag33
SEAus2_lag33 <-  SEAus2_weeks - 33
SEAus2_lag33 <- sapply(SEAus2_lag33, function(x) ifelse(x <=0, x + 52, x)) 
SEAus2_lag33

#SE Aus 3
#wtio_lag1
SEAus3_lag1 <- SEAus3_weeks -1 
SEAus3_lag1

#etio_lag15
SEAus3_lag15 <- SEAus3_weeks - 15
SEAus3_lag15 <- sapply(SEAus3_lag15, function(x) ifelse(x <=0, x + 52, x)) 
SEAus3_lag15

#organize data

#wtio first
wtio.names <- c("NEAus2:wtiolag30", "SEAus1:wtiolag4",  "SEAus1:wtiolag5", "SEAus1:wtiolag13",
               "SEAus2:wtiolag14", "SEAus2:wtiolag46", "SEAus3:wtiolag1")
wtio.start <- c(NEAus2_lag30[1], min(SEAus1_lag4),  min(SEAus1_lag5),  min(SEAus1_lag13), 
                min(SEAus2_lag14), min(SEAus2_lag46), (min(SEAus3_lag1)+52))
wtio.end <- c(NEAus2_lag30[length(NEAus2_lag30)], max(SEAus1_lag4),  max(SEAus1_lag5),  max(SEAus1_lag13), 
              max(SEAus2_lag14), max(SEAus2_lag46), (max(SEAus3_lag1)+52))
wtio.lag.df <- data.frame(lag = wtio.names, start = wtio.start, end = wtio.end)
wtio.lag.df <- wtio.lag.df[nrow(wtio.lag.df):1, ]

#etio lags
etio.names <- c("NEAus1:etiolag42",  "NEAus2:etiolag4", "NEAus3:etiolag19", "SEAus1:etiolag31",
                "SEAus2:etiolag7", "SEAus2:etiolag33", "SEAus3:etiolag15")
etio.start <- c(min(NEAus1_lag42),  min(NEAus2_lag4), min(NEAus3_lag19), min(SEAus1_lag31),
                min(SEAus2_lag7), min(SEAus2_lag33), min(SEAus3_lag15))
#etio.start <- c(NEAus1_lag42[1],  min(NEAus2_lag4), min(NEAus3_lag19), min(SEAus1_lag31),
#                min(SEAus2_lag7), min(SEAus2_lag33), min(SEAus3_lag15))
etio.end <- c(NEAus1_lag42[length(NEAus1_lag42)], max(NEAus2_lag4), max(NEAus3_lag19), max(SEAus1_lag31),
              max(SEAus2_lag7), max(SEAus2_lag33), max(SEAus3_lag15))
#etio.end <- c(max(NEAus1_lag42), max(NEAus2_lag4), max(NEAus3_lag19), max(SEAus1_lag31),
#              max(SEAus2_lag7), max(SEAus2_lag33), max(SEAus3_lag15))
etio.lag.df <- data.frame(lag = etio.names, start = etio.start, end = etio.end)
etio.lag.df <- etio.lag.df[nrow(etio.lag.df):1, ]

etio.overlap <- c(length(etio.names), min(NEAus1_lag42), NEAus1_lag42[length(NEAus1_lag42)])


```

```{r coef_setup}
coef.etio <- NULL
coef.etio <- NULL

NE1 <- NEmodels[[1]]
#NE1 <- NE.lms[[1]]
coef.etio <- NE1$coefficients[3] #etio_lag42 

NE2 <- NEmodels[[2]]
#NE2 <- NE.lms[[2]]
coef.wtio <- NE2$coefficients[5] #wtio_lag30 
coef.etio <- c(coef.etio, NE2$coefficients[6] ) #etio_lag4 

NE3 <- NEmodels[[3]]
#NE3 <- NE.lms[[3]]
coef.etio <- c(coef.etio, NE3$coefficients[3] ) #etio_lag19 

SE1 <- SEmodels[[1]]
#SE1 <- SE.lms[[1]]
#SE1$coefficients
coef.wtio <- c(coef.wtio, SE1$coefficients[4]) #wtio_lag4
coef.wtio <- c(coef.wtio, SE1$coefficients[5]) #wtio_lag5 
coef.wtio <- c(coef.wtio, SE1$coefficients[6]) #wtio_lag13            
coef.etio <- c(coef.etio, SE1$coefficients[7]) #etio_lag31 

SE2 <- SEmodels[[2]]
#SE2 <- SE.lms[[2]]
#SE2$coefficients
coef.wtio <- c(coef.wtio, SE2$coefficients[3]) #wtio_lag14
coef.wtio <- c(coef.wtio, SE2$coefficients[4]) #wtio_lag46
coef.etio <- c(coef.etio, SE2$coefficients[5]) #etio_lag7 
coef.etio <- c(coef.etio, SE2$coefficients[6]) #etio_lag33 

SE3 <- SEmodels[[3]]
#SE3 <- SE.lms[[3]]
#SE3$coefficients
coef.wtio <- c(coef.wtio, SE3$coefficients[5]) #wtio_lag1
coef.etio <- c(coef.etio, SE3$coefficients[6]) #etio_lag15 

#get colors
coef.range <- range(coef.wtio, coef.etio)
abs.max.coef <- max(abs(coef.range))
#try PiYG
cols.PiG48 <- rev(colorRampPalette(brewer.pal(11, "Spectral"))(36))
col.seq.PiG48 <- c(-abs.max.coef, seq(-2.5,2.5, length.out =length(cols.PiG48) - 1), abs.max.coef )
col.brks <- c(-2.5-0.1470588, seq(-2.5,2.5, length.out =length(cols.PiG48) - 1), 2.5+0.1470588)

col.coef.etio <- cols.PiG48[findInterval(coef.etio, col.seq.PiG48)]
col.coef.wtio <- cols.PiG48[findInterval(coef.wtio, col.seq.PiG48)]

#updated axis 2 labels
wtio.lag.df$lag
wtio.lags <- c("lag 1 ", "lag 46", "lag 14", "lag 13", "lag 5 ", "lag 4 ", "lag 30")

etio.lag.df$lag
etio.lags <- c("lag 15", "lag 33", "lag 7 ", "lag 31", "lag 19", "lag 4 ", "lag 42")
```


```{r update_overlapFigs}
#updating the overlap figures to better represent what is happening
setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures/New")

png(filename = "wtiolag_new.png", width = 2400, height = 1200, res = 250)
par(mar = c(4, 6, 3, 6))
plot(NULL, xlim = c(1,66), ylim = c(0.5, length(wtio.names)),
     yaxt = "n", xaxt = "n", xlab = "Week", ylab = "", main = "")
image.plot(zlim = c(-2.75, 2.75), legend.only = TRUE, col = cols.PiG48,
           breaks = col.brks, horizontal = FALSE,  legend.args = list( text = "Coef", side = 1),
           axis.args = list(at = seq(-2.5, 2.5, 0.5)))
axis(2, at = 1:length(wtio.lags), labels = wtio.lags, las = 1)
axis(1, at = 1:66, labels = c(1:52, 1:14), cex.axis = 0.67)
segments(x0 = wtio.lag.df$start, y0 = 1:length(wtio.lag.df$start),
         x1 = wtio.lag.df$end,  y1 = 1:length(wtio.lag.df$end),
         lwd = 5, col = rev(col.coef.wtio))
abline(h = 1:length(wtio.lag.df$start), lty = 3, col = "gray70")
abline(v = c(9.5, 22.5, 35.5, 48.5, 61.5), lty = 2, col = "gray48")
text(x =c(4.75, 16, 29, 42, 55 ), y = 0.5,  labels = c("DJF", "MAM", "JJA", "SON", "DJF" ))
title("WTIO Lags", adj = 0)
dev.off()


png(filename = "etiolag_new.png", width = 2400, height = 1200, res = 250)
par(mar = c(4, 6, 3, 6))
plot(NULL, xlim = c(1, 66), ylim = c(0.5, length(etio.names)),
     yaxt = "n", xaxt = "n",  xlab = "Week", ylab = "", main = "")
image.plot(zlim = c(-2.75, 2.75), legend.only = TRUE, col = cols.PiG48,
           breaks = col.brks, horizontal = FALSE, legend.args = list( text = "Coef", side = 1),
           axis.args = list(at = seq(-2.5, 2.5, 0.5)))
axis(2, at = 1:length(etio.lags), labels = etio.lags, las = 1)
axis(1, at = 1:66, labels = c(1:52, 1:14), cex.axis = 0.67)
segments(x0 = etio.lag.df$start, y0 = 1:length(etio.lag.df$start),
         x1 = etio.lag.df$end,  y1 = 1:length(etio.lag.df$end),
         lwd = 5, col =rev(col.coef.etio))
abline(h = 1:length(etio.lag.df$start), lty = 3, col = "gray70")
abline(v = c(9.5, 22.5, 35.5, 48.5, 61.5), lty = 2, col = "gray48")
text(x =c(4.75, 16, 29, 42, 55 ), y = 0.5,  labels = c("DJF", "MAM", "JJA", "SON", "DJF" ))
title("ETIO Lags", adj = 0)
dev.off()

```


```{r overlap_figures}
#TODO: test case, update later

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "wtio_lag.png", width = 2000, height = 1200, res = 250)
par(mar = c(4, 9, 3, 6))
plot(NULL, xlim = c(1,52), ylim = c(0.5, length(wtio.names)),
     yaxt = "n", xlab = "Week", ylab = "", main = "")
image.plot(zlim = c(-2.75, 2.75), legend.only = TRUE, col = cols.PiG48,
           breaks = col.brks, horizontal = FALSE,  legend.args = list( text = "Coef", side = 1),
           axis.args = list(at = seq(-2.5, 2.5, 0.5)))
           #smallplot = c(0.1, 0.9, 0.08, 0.10))
axis(2, at = 1:length(wtio.lag.df$lag), labels = wtio.lag.df$lag, las = 1)
segments(x0 = wtio.lag.df$start, y0 = 1:length(wtio.lag.df$start),
         x1 = wtio.lag.df$end,  y1 = 1:length(wtio.lag.df$end),
         lwd = 5, col = rev(col.coef.wtio))
abline(h = 1:length(wtio.lag.df$start), lty = 3, col = "gray70")
abline(v = c(9.5, 22.5, 35.5, 48.9), lty = 2, col = "gray48")
text(x =c(4.75, 16, 29, 42 ), y = 0.5,  labels = c("DJF", "MAM", "JJA", "SON" ))
title("WTIO Lags", adj = 0)
dev.off()

png(filename = "etio_lag.png", width = 2000, height = 1200, res = 250)
par(mar = c(4, 9, 3, 6))
plot(NULL, xlim = c(1,52), ylim = c(0.5, length(etio.names)),
     yaxt = "n", xlab = "Week", ylab = "", main = "")
image.plot(zlim = c(-2.75, 2.75), legend.only = TRUE, col = cols.PiG48,
           breaks = col.brks, horizontal = FALSE, legend.args = list( text = "Coef", side = 1),
           axis.args = list(at = seq(-2.5, 2.5, 0.5)))
axis(2, at = 1:length(etio.lag.df$lag), labels = etio.lag.df$lag, las = 1)
segments(x0 = etio.lag.df$start, y0 = 1:length(etio.lag.df$start),
         x1 = etio.lag.df$end,  y1 = 1:length(etio.lag.df$end),
         lwd = 5, col =rev(col.coef.etio))
segments(x0 = etio.overlap[2], y0 = etio.overlap[1],
         x1 = etio.overlap[3],  y1 = etio.overlap[1],
         lwd = 5, col = col.coef.etio[1])
abline(h = 1:length(etio.lag.df$start), lty = 3, col = "gray70")
abline(v = c(9.5, 22.5, 35.5, 48.9), lty = 2, col = "gray48")
text(x =c(4.75, 16, 29, 42 ), y = 0.5,  labels = c("DJF", "MAM", "JJA", "SON" ))
title("ETIO Lags", adj = 0)
dev.off()
```



## K-Fold

```{r kfold}
k <- 10

#NE aus
NE.kcv <- NULL
for(j in 1:3){ 
  temp.pred <- NEpreds_new[[j]]
  temp.resp <- NEresp_new[[j]]
  
  
  nrow(temp.pred)
  length(temp.resp)
  
  n <- nrow(temp.pred)
  set.seed(156)
  folds <- sample(rep(1:k, length.out = n))
  # Store errors
  mse <- numeric(k)
  for (i in 1:k) {
    # Split into training and test sets
    test.id <- which(folds == i)
    train.preds <- temp.pred[-test.id, ]
    train.resp <- temp.resp[-test.id]
    test.preds <- temp.pred[test.id, ]
    test.resp <- temp.resp[test.id]
    
    # Fit model
    train.data.fit <- as.data.frame(cbind(train.resp, train.preds))
    names(train.data.fit)[1] <- "co"
  
    temp.model <- lm(formula(NErefits[[j]]), train.data.fit)
    
    # Predict
    preds <- predict(temp.model, newdata = test.preds)
    
    # Compute Mean Squared Error
    mse[i] <- mean((test.resp - preds)^2)
  }
  NE.kcv[[j]] <- mean(mse)
}




#SE aus
SE.kcv <- NULL
for(j in 1:3){ 
  temp.pred <- SEpreds_new[[j]]
  temp.resp <- SEresp_new[[j]]
  
  
  nrow(temp.pred)
  length(temp.resp)
  
  n <- nrow(temp.pred)
  set.seed(157)
  folds <- sample(rep(1:k, length.out = n))
  # Store errors
  mse <- numeric(k)
  for (i in 1:k) {
    # Split into training and test sets
    test.id <- which(folds == i)
    train.preds <- temp.pred[-test.id, ]
    train.resp <- temp.resp[-test.id]
    test.preds <- temp.pred[test.id, ]
    test.resp <- temp.resp[test.id]
    
    # Fit model
    train.data.fit <- as.data.frame(cbind(train.resp, train.preds))
    names(train.data.fit)[1] <- "co"
  
    temp.model <- lm(formula(SErefits[[j]]), train.data.fit)
    
    # Predict
    preds <- predict(temp.model, newdata = test.preds)
    
    # Compute Mean Squared Error
    mse[i] <- mean((test.resp - preds)^2)
  }
  SE.kcv[[j]] <- mean(mse)
}

NE.kcv
SE.kcv
```

```{r kfold_noOLR}
k <- 10

#NE aus
NE.kcv.noOLR <- NULL
for(j in 1:3){ 
  temp.pred <- NEpreds_new[[j]][ ,1:260]
  temp.resp <- NEresp_new[[j]]
  
  
  nrow(temp.pred)
  length(temp.resp)
  
  n <- nrow(temp.pred)
  set.seed(156)
  folds <- sample(rep(1:k, length.out = n))
  # Store errors
  mse <- numeric(k)
  for (i in 1:k) {
    # Split into training and test sets
    test.id <- which(folds == i)
    train.preds <- temp.pred[-test.id, ]
    train.resp <- temp.resp[-test.id]
    test.preds <- temp.pred[test.id, ]
    test.resp <- temp.resp[test.id]
    
    # Fit model
    train.data.fit <- as.data.frame(cbind(train.resp, train.preds))
    names(train.data.fit)[1] <- "co"
  
    temp.model <- lm(formula(NErefit.noOLR[[j]]), train.data.fit)
    
    # Predict
    preds <- predict(temp.model, newdata = test.preds)
    
    # Compute Mean Squared Error
    mse[i] <- mean((test.resp - preds)^2)
  }
  NE.kcv.noOLR[[j]] <- mean(mse)
}




#SE aus
SE.kcv.noOLR <- NULL
for(j in 1:3){ 
  temp.pred <- SEpreds_new[[j]][ ,1:260]
  temp.resp <- SEresp_new[[j]]
  
  
  nrow(temp.pred)
  length(temp.resp)
  
  n <- nrow(temp.pred)
  set.seed(157)
  folds <- sample(rep(1:k, length.out = n))
  # Store errors
  mse <- numeric(k)
  for (i in 1:k) {
    # Split into training and test sets
    test.id <- which(folds == i)
    train.preds <- temp.pred[-test.id, ]
    train.resp <- temp.resp[-test.id]
    test.preds <- temp.pred[test.id, ]
    test.resp <- temp.resp[test.id]
    
    # Fit model
    train.data.fit <- as.data.frame(cbind(train.resp, train.preds))
    names(train.data.fit)[1] <- "co"
  
    temp.model <- lm(formula(SErefit.noOLR[[j]]), train.data.fit)
    
    # Predict
    preds <- predict(temp.model, newdata = test.preds)
    
    # Compute Mean Squared Error
    mse[i] <- mean((test.resp - preds)^2)
  }
  SE.kcv.noOLR[[j]] <- mean(mse)
}

NE.kcv.noOLR
SE.kcv.noOLR

```

```{r kFold_eBIC}

```


## Validation

```{r validation_extract}
#rmse
NEbase.rmse <- unlist(lapply(NE.rmse, function(x) x[[1]]))
NEconst.rmse <- unlist(lapply(NE.rmse, function(x) x[[2]]))
NEvary.rmse <- unlist(lapply(NE.rmse, function(x) x[[3]]))

SEbase.rmse <- unlist(lapply(SE.rmse, function(x) x[[1]]))
SEconst.rmse <- unlist(lapply(SE.rmse, function(x) x[[2]]))
SEvary.rmse <- unlist(lapply(SE.rmse, function(x) x[[3]]))

#cprs
NEbase.cprs <- unlist(lapply(NE.cprs, function(x) x[[1]]))
NEconst.cprs <- unlist(lapply(NE.cprs, function(x) x[[2]]))
NEvary.cprs <- unlist(lapply(NE.cprs, function(x) x[[3]]))

SEbase.cprs <- unlist(lapply(SE.cprs, function(x) x[[1]]))
SEconst.cprs <- unlist(lapply(SE.cprs, function(x) x[[2]]))
SEvary.cprs <- unlist(lapply(SE.cprs, function(x) x[[3]]))

#int score
NEbase.int <- unlist(lapply(NE.ints, function(x) x[[1]]))
NEconst.int <- unlist(lapply(NE.ints, function(x) x[[2]]))
NEvary.int <- unlist(lapply(NE.ints, function(x) x[[3]]))

SEbase.int <- unlist(lapply(SE.ints, function(x) x[[1]]))
SEconst.int <- unlist(lapply(SE.ints, function(x) x[[2]]))
SEvary.int <- unlist(lapply(SE.ints, function(x) x[[3]]))


```

```{r extract_byGroup}
##RMSE
#base terms (no splot)
NEgroup1.base.rmse <- unlist(lapply(NE.rmse, function(x) x[[1]][1]))
NEgroup2.base.rmse <- unlist(lapply(NE.rmse, function(x) x[[1]][2]))
NEgroup3.base.rmse <- unlist(lapply(NE.rmse, function(x) x[[1]][3]))

SEgroup1.base.rmse <- unlist(lapply(SE.rmse, function(x) x[[1]][1]))
SEgroup2.base.rmse <- unlist(lapply(SE.rmse, function(x) x[[1]][2]))
SEgroup3.base.rmse <- unlist(lapply(SE.rmse, function(x) x[[1]][3]))

#constant terms (test/train split)
NEgroup1.rmse <- unlist(lapply(NE.rmse, function(x) x[[2]][1]))
NEgroup2.rmse <- unlist(lapply(NE.rmse, function(x) x[[2]][2]))
NEgroup3.rmse <- unlist(lapply(NE.rmse, function(x) x[[2]][3]))

SEgroup1.rmse <- unlist(lapply(SE.rmse, function(x) x[[2]][1]))
SEgroup2.rmse <- unlist(lapply(SE.rmse, function(x) x[[2]][2]))
SEgroup3.rmse <- unlist(lapply(SE.rmse, function(x) x[[2]][3]))


##CPRS
#base terms (no splot)
NEgroup1.base.cprs <- unlist(lapply(NE.cprs, function(x) x[[1]][1]))
NEgroup2.base.cprs <- unlist(lapply(NE.cprs, function(x) x[[1]][2]))
NEgroup3.base.cprs <- unlist(lapply(NE.cprs, function(x) x[[1]][3]))

SEgroup1.base.cprs <- unlist(lapply(SE.cprs, function(x) x[[1]][1]))
SEgroup2.base.cprs <- unlist(lapply(SE.cprs, function(x) x[[1]][2]))
SEgroup3.base.cprs <- unlist(lapply(SE.cprs, function(x) x[[1]][3]))

#constant terms (test/train split)
NEgroup1.cprs <- unlist(lapply(NE.cprs, function(x) x[[2]][1]))
NEgroup2.cprs <- unlist(lapply(NE.cprs, function(x) x[[2]][2]))
NEgroup3.cprs <- unlist(lapply(NE.cprs, function(x) x[[2]][3]))

SEgroup1.cprs <- unlist(lapply(SE.cprs, function(x) x[[2]][1]))
SEgroup2.cprs <- unlist(lapply(SE.cprs, function(x) x[[2]][2]))
SEgroup3.cprs <- unlist(lapply(SE.cprs, function(x) x[[2]][3]))



##Int Score
#base terms (no split)
NEgroup1.base.ints <- unlist(lapply(NE.ints, function(x) x[[1]][1]))
NEgroup2.base.ints <- unlist(lapply(NE.ints, function(x) x[[1]][2]))
NEgroup3.base.ints <- unlist(lapply(NE.ints, function(x) x[[1]][3]))

SEgroup1.base.ints <- unlist(lapply(SE.ints, function(x) x[[1]][1]))
SEgroup2.base.ints <- unlist(lapply(SE.ints, function(x) x[[1]][2]))
SEgroup3.base.ints <- unlist(lapply(SE.ints, function(x) x[[1]][3]))

#constant terms (test/train split)
NEgroup1.ints <- unlist(lapply(NE.ints, function(x) x[[2]][1]))
NEgroup2.ints <- unlist(lapply(NE.ints, function(x) x[[2]][2]))
NEgroup3.ints <- unlist(lapply(NE.ints, function(x) x[[2]][3]))

SEgroup1.ints <- unlist(lapply(SE.ints, function(x) x[[2]][1]))
SEgroup2.ints <- unlist(lapply(SE.ints, function(x) x[[2]][2]))
SEgroup3.ints <- unlist(lapply(SE.ints, function(x) x[[2]][3]))

```

```{r rmse_noOLR}
#point rmse 
NEbase.rmse.noOLR <- unlist(lapply(NE.rmse.noOLR, function(x) x[[1]]))
NEconst.rmse.noOLR <- unlist(lapply(NE.rmse.noOLR, function(x) x[[2]]))
NEvary.rmse.noOLR <- unlist(lapply(NE.rmse.noOLR, function(x) x[[3]]))

SEbase.rmse.noOLR <- unlist(lapply(SE.rmse.noOLR, function(x) x[[1]]))
SEconst.rmse.noOLR <- unlist(lapply(SE.rmse.noOLR, function(x) x[[2]]))
SEvary.rmse.noOLR <- unlist(lapply(SE.rmse.noOLR, function(x) x[[3]]))

#boxplot rmse
#base terms (no splot)
NE1.base.noOLR <- unlist(lapply(NE.rmse.noOLR, function(x) x[[1]][1]))
NE2.base.noOLR <- unlist(lapply(NE.rmse.noOLR, function(x) x[[1]][2]))
NE3.base.noOLR <- unlist(lapply(NE.rmse.noOLR, function(x) x[[1]][3]))

SE1.base.noOLR <- unlist(lapply(SE.rmse.noOLR, function(x) x[[1]][1]))
SE2.base.noOLR <- unlist(lapply(SE.rmse.noOLR, function(x) x[[1]][2]))
SE3.base.noOLR <- unlist(lapply(SE.rmse.noOLR, function(x) x[[1]][3]))

#constant terms (test/train split)
NE1.rmse.noOLR <- unlist(lapply(NE.rmse.noOLR, function(x) x[[2]][1]))
NE2.rmse.noOLR <- unlist(lapply(NE.rmse.noOLR, function(x) x[[2]][2]))
NE3.rmse.noOLR <- unlist(lapply(NE.rmse.noOLR, function(x) x[[2]][3]))

SE1.rmse.noOLR <- unlist(lapply(SE.rmse.noOLR, function(x) x[[2]][1]))
SE2.rmse.noOLR <- unlist(lapply(SE.rmse.noOLR, function(x) x[[2]][2]))
SE3.rmse.noOLR <- unlist(lapply(SE.rmse.noOLR, function(x) x[[2]][3]))
```

```{r cprs_noOLR}
#point cprs 
NEbase.cprs.noOLR <- unlist(lapply(NE.cprs.noOLR, function(x) x[[1]]))
NEconst.cprs.noOLR <- unlist(lapply(NE.cprs.noOLR, function(x) x[[2]]))

SEbase.cprs.noOLR <- unlist(lapply(SE.cprs.noOLR, function(x) x[[1]]))
SEconst.cprs.noOLR <- unlist(lapply(SE.cprs.noOLR, function(x) x[[2]]))


##CPRS
#base terms (no splot)
NE1.base.cprs.noOLR <- unlist(lapply(NE.cprs.noOLR, function(x) x[[1]][1]))
NE2.base.cprs.noOLR <- unlist(lapply(NE.cprs.noOLR, function(x) x[[1]][2]))
NE3.base.cprs.noOLR <- unlist(lapply(NE.cprs.noOLR, function(x) x[[1]][3]))

SE1.base.cprs.noOLR <- unlist(lapply(SE.cprs.noOLR, function(x) x[[1]][1]))
SE2.base.cprs.noOLR <- unlist(lapply(SE.cprs.noOLR, function(x) x[[1]][2]))
SE3.base.cprs.noOLR <- unlist(lapply(SE.cprs.noOLR, function(x) x[[1]][3]))

#constant terms (test/train split)
NE1.cprs.noOLR <- unlist(lapply(NE.cprs.noOLR, function(x) x[[2]][1]))
NE2.cprs.noOLR <- unlist(lapply(NE.cprs.noOLR, function(x) x[[2]][2]))
NE3.cprs.noOLR <- unlist(lapply(NE.cprs.noOLR, function(x) x[[2]][3]))

SE1.cprs.noOLR <- unlist(lapply(SE.cprs.noOLR, function(x) x[[2]][1]))
SE2.cprs.noOLR <- unlist(lapply(SE.cprs.noOLR, function(x) x[[2]][2]))
SE3.cprs.noOLR <- unlist(lapply(SE.cprs.noOLR, function(x) x[[2]][3]))

```

```{r intscore_noOLR}
#point cprs 
NEbase.ints.noOLR <- unlist(lapply(NE.ints.noOLR, function(x) x[[1]]))
NEconst.ints.noOLR <- unlist(lapply(NE.ints.noOLR, function(x) x[[2]]))

SEbase.ints.noOLR <- unlist(lapply(SE.ints.noOLR, function(x) x[[1]]))
SEconst.ints.noOLR <- unlist(lapply(SE.ints.noOLR, function(x) x[[2]]))

##Int Score
#base terms (no split)
NE1.base.ints.noOLR <- unlist(lapply(NE.ints.noOLR, function(x) x[[1]][1]))
NE2.base.ints.noOLR <- unlist(lapply(NE.ints.noOLR, function(x) x[[1]][2]))
NE3.base.ints.noOLR <- unlist(lapply(NE.ints.noOLR, function(x) x[[1]][3]))

SE1.base.ints.noOLR <- unlist(lapply(SE.ints.noOLR, function(x) x[[1]][1]))
SE2.base.ints.noOLR <- unlist(lapply(SE.ints.noOLR, function(x) x[[1]][2]))
SE3.base.ints.noOLR <- unlist(lapply(SE.ints.noOLR, function(x) x[[1]][3]))

#constant terms (test/train split)
NE1.ints.noOLR <- unlist(lapply(NE.ints.noOLR, function(x) x[[2]][1]))
NE2.ints.noOLR <- unlist(lapply(NE.ints.noOLR, function(x) x[[2]][2]))
NE3.ints.noOLR <- unlist(lapply(NE.ints.noOLR, function(x) x[[2]][3]))

SE1.ints.noOLR <- unlist(lapply(SE.ints.noOLR, function(x) x[[2]][1]))
SE2.ints.noOLR <- unlist(lapply(SE.ints.noOLR, function(x) x[[2]][2]))
SE3.ints.noOLR <- unlist(lapply(SE.ints.noOLR, function(x) x[[2]][3]))
```

### eBIC Validation

```{r ebic_listextract}
#extract specific elements 
lapply(NEebic.refit.years, function(x) x[[1]])
unlist(lapply(NEebic.refit.years, function(x) x[[1]][1,2]))

```


## ANOVAs

Use to show the effect of including or excluding OLR

```{r }
anova(NE1.lm.noOLR, NE1.lm )
anova(NE2.lm.noOLR, NE2.lm )
anova(NE3.lm.noOLR, NE3.lm )



anova(SE1.lm.noOLR, SE1.lm )
anova(SE2.lm.noOLR, SE2.lm )
anova(SE3.lm.noOLR, SE3.lm )
```




# Figures

## Predictions (and intervals)

```{r prediction_extract}
#for: SE.pred.int, NE.pred.int

unlist(lapply(NE.pred.int, function(x) x[ ,1])) #true values
unlist(lapply(NE.pred.int, function(x) x[ ,5])) #const fit

NEpred.2001 <- NE.pred.int[[1]]
season_weeks[-c(1:3)]
```

```{r NEAus_fits}


plot(1:29, NE.pred.int[[1]]$true, type = "l", ylim = range(NE.pred.int[[1]]))
lines(1:29, NE.pred.int[[1]]$const.fit, lty = 4)
lines(1:29, NE.pred.int[[1]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, NE.pred.int[[1]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)

plot(1:29, NE.pred.int[[2]]$true, type = "l", ylim = range(NE.pred.int[[2]]))
lines(1:29, NE.pred.int[[2]]$const.fit, lty = 4)
lines(1:29, NE.pred.int[[2]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, NE.pred.int[[2]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)

plot(1:29, NE.pred.int[[3]]$true, type = "l", ylim = range(NE.pred.int[[3]]))
lines(1:29, NE.pred.int[[3]]$const.fit, lty = 4)
lines(1:29, NE.pred.int[[3]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, NE.pred.int[[3]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)

plot(1:29, NE.pred.int[[4]]$true, type = "l", ylim = range(NE.pred.int[[4]]))
lines(1:29, NE.pred.int[[4]]$const.fit, lty = 4)
lines(1:29, NE.pred.int[[4]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, NE.pred.int[[4]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("NE Aus ", seasons[4]), adj = 0)

plot(1:29, NE.pred.int[[5]]$true, type = "l", ylim = range(NE.pred.int[[5]]))
lines(1:29, NE.pred.int[[5]]$const.fit, lty = 4)
lines(1:29, NE.pred.int[[5]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, NE.pred.int[[5]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("NE Aus ", seasons[5]), adj = 0)

plot(1:29,  NE.pred.int[[6]]$true, type = "l", ylim = range(NE.pred.int[[6]]))
lines(1:29, NE.pred.int[[6]]$const.fit, lty = 4)
lines(1:29, NE.pred.int[[6]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, NE.pred.int[[6]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("NE Aus ", seasons[6]), adj = 0)

plot(1:29,  NE.pred.int[[7]]$true, type = "l", ylim = range(NE.pred.int[[7]]))
lines(1:29, NE.pred.int[[7]]$const.fit, lty = 4)
lines(1:29, NE.pred.int[[7]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, NE.pred.int[[7]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("NE Aus ", seasons[7]), adj = 0)

plot(1:29,  NE.pred.int[[8]]$true, type = "l", ylim = range(NE.pred.int[[8]]))
lines(1:29, NE.pred.int[[8]]$const.fit, lty = 4)
lines(1:29, NE.pred.int[[8]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, NE.pred.int[[8]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("NE Aus ", seasons[8]), adj = 0)

plot(1:29,  NE.pred.int[[9]]$true, type = "l", ylim = range(NE.pred.int[[9]]))
lines(1:29, NE.pred.int[[9]]$const.fit, lty = 4)
lines(1:29, NE.pred.int[[9]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, NE.pred.int[[9]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("NE Aus ", seasons[9]), adj = 0)

plot(1:29,  NE.pred.int[[10]]$true, type = "l", ylim = range(NE.pred.int[[10]]))
lines(1:29, NE.pred.int[[10]]$const.fit, lty = 4)
lines(1:29, NE.pred.int[[10]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, NE.pred.int[[10]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("NE Aus ", seasons[10]), adj = 0)

plot(1:29,  NE.pred.int[[11]]$true, type = "l", ylim = range(NE.pred.int[[11]]))
lines(1:29, NE.pred.int[[11]]$const.fit, lty = 4)
lines(1:29, NE.pred.int[[11]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, NE.pred.int[[11]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("NE Aus ", seasons[11]), adj = 0)


for (k in 12:19) {
  plot(1:29,  NE.pred.int[[k]]$true, type = "l", ylim = range(NE.pred.int[[k]]))
  lines(1:29, NE.pred.int[[k]]$const.fit, lty = 4)
  lines(1:29, NE.pred.int[[k]]$const.lwr, lty = 4, col = "royalblue3")
  lines(1:29, NE.pred.int[[k]]$const.upr, lty = 4, col = "orangered3")
  abline(h=0, lty = 2)
  title(paste0("NE Aus ", seasons[k]), adj = 0)
}

#plot(1:29, NE.pred.int[[1]]$true, type = "l", ylim = range(NE.pred.int[[1]]))
#lines(1:29, NE.pred.int[[1]]$base.fit, lty = 3)
#lines(1:29, NE.pred.int[[1]]$base.lwr, lty = 3, col = "royalblue3")
#lines(1:29, NE.pred.int[[1]]$base.upr, lty = 3, col = "orangered3")

```


```{r SEAus_preds}
j <- 1
plot(1:29,  SE.pred.int[[j]]$true, type = "l", ylim = range(SE.pred.int[[j]]))
lines(1:29, SE.pred.int[[j]]$const.fit, lty = 4)
lines(1:29, SE.pred.int[[j]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, SE.pred.int[[j]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("SE Aus ", seasons[j]), adj = 0)

j <- 2
plot(1:29,  SE.pred.int[[j]]$true, type = "l", ylim = range(SE.pred.int[[j]]))
lines(1:29, SE.pred.int[[j]]$const.fit, lty = 4)
lines(1:29, SE.pred.int[[j]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, SE.pred.int[[j]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("SE Aus ", seasons[j]), adj = 0)

j <- 3
plot(1:29,  SE.pred.int[[j]]$true, type = "l", ylim = range(SE.pred.int[[j]]))
lines(1:29, SE.pred.int[[j]]$const.fit, lty = 4)
lines(1:29, SE.pred.int[[j]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, SE.pred.int[[j]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("SE Aus ", seasons[j]), adj = 0)

j <- 4
plot(1:29,  SE.pred.int[[j]]$true, type = "l", ylim = range(SE.pred.int[[j]]))
lines(1:29, SE.pred.int[[j]]$const.fit, lty = 4)
lines(1:29, SE.pred.int[[j]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, SE.pred.int[[j]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("SE Aus ", seasons[j]), adj = 0)

j <- 5
plot(1:29,  SE.pred.int[[j]]$true, type = "l", ylim = range(SE.pred.int[[j]]))
lines(1:29, SE.pred.int[[j]]$const.fit, lty = 4)
lines(1:29, SE.pred.int[[j]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, SE.pred.int[[j]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("SE Aus ", seasons[j]), adj = 0)

j <- 6
plot(1:29,  SE.pred.int[[j]]$true, type = "l", ylim = range(SE.pred.int[[j]]))
lines(1:29, SE.pred.int[[j]]$const.fit, lty = 4)
lines(1:29, SE.pred.int[[j]]$const.lwr, lty = 4, col = "royalblue3")
lines(1:29, SE.pred.int[[j]]$const.upr, lty = 4, col = "orangered3")
abline(h=0, lty = 2)
title(paste0("SE Aus ", seasons[j]), adj = 0)


for (k in 7:19) {
  plot(1:29,  SE.pred.int[[k]]$true, type = "l", ylim = range(SE.pred.int[[k]]))
  lines(1:29, SE.pred.int[[k]]$const.fit, lty = 4)
  lines(1:29, SE.pred.int[[k]]$const.lwr, lty = 4, col = "royalblue3")
  lines(1:29, SE.pred.int[[k]]$const.upr, lty = 4, col = "orangered3")
  abline(h=0, lty = 2)
  title(paste0("SE Aus ", seasons[k]), adj = 0)
}

```

```{r residuals}
plot(1:29, NE.pred.int[[1]]$true-NE.pred.int[[1]]$const.fit, type = "l", ylim = range(NE.pred.int[[1]]))

plot(1:29, SE.pred.int[[1]]$true-SE.pred.int[[1]]$const.fit, type = "l", ylim = range(SE.pred.int[[1]]))
```


## RMSE Plots

```{r}
#get yearly lines
year.div <- seq(0.5, 57.5, by = 3)
year.mid <- seq(2, 56, by = 3)

NErmse.range <- range(NE.rmse)
SErmse.range <- range(SE.rmse)

colors.group <- rep(c("firebrick", "forestgreen", "royalblue3"), 19)

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")


png(filename = "NErmse.png", width = 3600, height = 1500, res = 275)
par(mar = c(5, 5, 3, 7))
plot(1:57, NEconst.rmse, pch = 16, col = colors.group, 
     ylab = "RMSE", ylim = c(0, max(NErmse.range)), xlab = "Year", axes = FALSE)
box()
axis(2)
axis(1, at = year.mid, labels = c(season_years[1:19]), tick = FALSE )
#points(1:57, NEconst.rmse, pch = 15, col = colors.group)
points(1:57, NEvary.rmse, pch = 17, col = alpha(colors.group, 0.75) )
abline(v= year.div, lty = 2)
title("NE Aus: RMSE", adj = 0)
legend("topright", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Group 1", "Group 2", "Group 3"), col = colors.group, pch = 16 )
legend("right", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Constant", "Varying"), col = "black", pch = c(16,17) )
dev.off()


png(filename = "SErmse.png", width = 3600, height = 1500, res = 275)
par(mar = c(5, 5, 3, 7))
plot(1:57, SEconst.rmse, pch = 16, col = colors.group,
     ylab = "RMSE", ylim = c(0, max(SErmse.range)), xlab = "Year", axes = FALSE)
box()
axis(2)
axis(1, at = year.mid, labels = c(season_years[1:19]), tick = FALSE )
#points(1:57, SEconst.rmse, pch = 15, col = colors.group,)
points(1:57, SEvary.rmse, pch = 17, col = alpha(colors.group, 0.75),)
abline(v= year.div, lty = 2)
title("SE Aus: RMSE", adj = 0)
legend("topright", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Group 1", "Group 2", "Group 3"), col = colors.group, pch = 16 )
legend("right", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Constant", "Varying"), col = "black", pch = c(16,17) )
dev.off()

```

```{r boxplots}
#TODO: finalize these plots into a single plot (as before)
#boxplot(NEgroup1.rmse, NEgroup2.rmse, NEgroup3.rmse)
#boxplot(SEgroup1.rmse, SEgroup2.rmse, SEgroup3.rmse)

rmse.range <- range(NEbase.rmse, NEconst.rmse, 
                    NEbase.rmse, SEconst.rmse)

model.names <- c("NE Aus 1", "NE Aus 2", "NE Aus 3",
                 "SE Aus 1", "SE Aus 2", "SE Aus 3")


setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "base_rmse.png", width = 2000, height = 1200, res = 250)
par(mar = c(5, 5, 3, 5))
#base (no split)
boxplot(NEgroup1.base.rmse, NEgroup2.base.rmse, NEgroup3.base.rmse,
        SEgroup1.base.rmse, SEgroup2.base.rmse, SEgroup3.base.rmse, pch = 19,
        ylim = rmse.range, ylab = "RMSE", axes = FALSE)
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Full Model : RMSE", adj = 0)
dev.off()


#constant (loo (single year test split))
png(filename = "constant_rmse.png", width = 2000, height = 1200, res = 250)
par(mar = c(5, 5, 3, 5))
boxplot(NEgroup1.rmse, NEgroup2.rmse, NEgroup3.rmse, 
        SEgroup1.rmse, SEgroup2.rmse, SEgroup3.rmse, pch = 19,
         ylim = rmse.range, ylab = "RMSE")
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : RMSE", adj = 0)
dev.off()
```


### RMSE - no OLR

```{r const_rmse}
#get yearly lines
year.div <- seq(0.5, 57.5, by = 3)
year.mid <- seq(2, 56, by = 3)

NErmse.range.noOLR <- range(NEconst.rmse.noOLR, NEconst.rmse)
SErmse.range.noOLR <- range(SEconst.rmse.noOLR, SEconst.rmse)

colors.group <- rep(c("firebrick", "forestgreen", "royalblue3"), 19)


par(mar = c(5, 5, 3, 7))
plot(1:57, NEconst.rmse.noOLR, pch = 19, col = colors.group, 
     ylab = "RMSE", ylim = c(0, max(NErmse.range.noOLR)), xlab = "Year", axes = FALSE)
box()
axis(2)
axis(1, at = year.mid, labels = c(season_years[1:19]), tick = FALSE )
points(1:57, NEconst.rmse, pch = 17, col = colors.group)
abline(v= year.div, lty = 2)
title("NE Aus: RMSE", adj = 0)
legend("topright", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Group 1", "Group 2", "Group 3"), col = colors.group, pch = 16 )
legend("right", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("with OLR", "without OLR"), col = "black", pch = c(17,19) )


par(mar = c(5, 5, 3, 7))
plot(1:57, SEconst.rmse.noOLR, pch = 19, col = colors.group, 
     ylab = "RMSE", ylim = c(0, max(SErmse.range.noOLR)), xlab = "Year", axes = FALSE)
box()
axis(2)
axis(1, at = year.mid, labels = c(season_years[1:19]), tick = FALSE )
points(1:57, SEconst.rmse, pch = 17, col = colors.group)
abline(v= year.div, lty = 2)
title("SE Aus: RMSE", adj = 0)
legend("topright", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Group 1", "Group 2", "Group 3"), col = colors.group, pch = 16 )
legend("right", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("with OLR", "without OLR"), col = "black", pch = c(17,19) )
```

```{r const_boxplot}
rmse.range <- range(NEbase.rmse, NEconst.rmse, NEconst.rmse.noOLR,
                    NEbase.rmse, SEconst.rmse, SEconst.rmse.noOLR)

model.names <- c("NE Aus 1", "NE Aus 2", "NE Aus 3",
                 "SE Aus 1", "SE Aus 2", "SE Aus 3")

NEmodel.names <- c("NE Aus 1", "NE Aus 1 - no OLR", 
                   "NE Aus 2", "NE Aus 2 - no OLR",
                   "NE Aus 3", "NE Aus 3 - no OLR")

SEmodel.names <- c("SE Aus 1", "SE Aus 1 - no OLR", 
                   "SE Aus 2", "SE Aus 2 - no OLR",
                   "SE Aus 3", "SE Aus 3 - no OLR")

par(mar = c(5, 5, 3, 5))
boxplot(NE1.rmse.noOLR, NE2.rmse.noOLR, NE3.rmse.noOLR, 
        SE1.rmse.noOLR, SE2.rmse.noOLR, SE3.rmse.noOLR, pch = 19,
         ylim = rmse.range, ylab = "RMSE")
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : RMSE", adj = 0)


par(mar = c(5, 5, 3, 5))
boxplot(NEgroup1.rmse, NE1.rmse.noOLR, 
        NEgroup2.rmse, NE2.rmse.noOLR, 
        NEgroup3.rmse, NE3.rmse.noOLR, pch = 19,
         ylim = rmse.range, ylab = "RMSE")
axis(1, labels = NEmodel.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : NE Aus RMSE", adj = 0)


par(mar = c(5, 5, 3, 5))
boxplot(SEgroup1.rmse, SE1.rmse.noOLR, 
        SEgroup2.rmse, SE2.rmse.noOLR, 
        SEgroup3.rmse, SE3.rmse.noOLR, pch = 19,
        ylim = rmse.range, ylab = "RMSE")
axis(1, labels = SEmodel.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : SE Aus RMSE", adj = 0)


```

```{r base_rmse}
#get yearly lines
year.div <- seq(0.5, 57.5, by = 3)
year.mid <- seq(2, 56, by = 3)

NErmse.range.noOLR <- range(NEbase.rmse.noOLR, NEbase.rmse)
SErmse.range.noOLR <- range(SEbase.rmse.noOLR, SEbase.rmse)

colors.group <- rep(c("firebrick", "forestgreen", "royalblue3"), 19)


par(mar = c(5, 5, 3, 7))
plot(1:57, NEbase.rmse.noOLR, pch = 19, col = colors.group, 
     ylab = "RMSE", ylim = c(0, max(NErmse.range.noOLR)), xlab = "Year", axes = FALSE)
box()
axis(2)
axis(1, at = year.mid, labels = c(season_years[1:19]), tick = FALSE )
points(1:57, NEbase.rmse, pch = 17, col = colors.group)
abline(v= year.div, lty = 2)
title("NE Aus: RMSE", adj = 0)
legend("topright", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Group 1", "Group 2", "Group 3"), col = colors.group, pch = 16 )
legend("right", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("with OLR", "without OLR"), col = "black", pch = c(17,19) )


par(mar = c(5, 5, 3, 7))
plot(1:57, SEbase.rmse.noOLR, pch = 19, col = colors.group, 
     ylab = "RMSE", ylim = c(0, max(SErmse.range.noOLR)), xlab = "Year", axes = FALSE)
box()
axis(2)
axis(1, at = year.mid, labels = c(season_years[1:19]), tick = FALSE )
points(1:57, SEbase.rmse, pch = 17, col = colors.group)
abline(v= year.div, lty = 2)
title("SE Aus: RMSE", adj = 0)
legend("topright", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("Group 1", "Group 2", "Group 3"), col = colors.group, pch = 16 )
legend("right", inset = c(-0.12, 0), xpd = TRUE,
       legend = c("with OLR", "without OLR"), col = "black", pch = c(17,19) )

```

```{r base_boxplot}
rmse.range <- range(NEbase.rmse, NEbase.rmse.noOLR,
                    NEbase.rmse, SEbase.rmse.noOLR)

model.names <- c("NE Aus 1", "NE Aus 2", "NE Aus 3",
                 "SE Aus 1", "SE Aus 2", "SE Aus 3")

NEmodel.names <- c("NE Aus 1", "NE Aus 1 - no OLR", 
                   "NE Aus 2", "NE Aus 2 - no OLR",
                   "NE Aus 3", "NE Aus 3 - no OLR")

SEmodel.names <- c("SE Aus 1", "SE Aus 1 - no OLR", 
                   "SE Aus 2", "SE Aus 2 - no OLR",
                   "SE Aus 3", "SE Aus 3 - no OLR")

par(mar = c(5, 5, 3, 5))
boxplot(NE1.base.noOLR, NE2.base.noOLR, NE3.base.noOLR, 
        SE1.base.noOLR, SE2.base.noOLR, SE3.base.noOLR, pch = 19,
         ylim = rmse.range, ylab = "RMSE")
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Base (Full) Model : RMSE", adj = 0)


par(mar = c(5, 5, 3, 5))
boxplot(NEgroup1.base.rmse, NE1.base.noOLR, 
        NEgroup2.base.rmse, NE2.base.noOLR, 
        NEgroup3.base.rmse, NE3.base.noOLR, pch = 19,
         ylim = rmse.range, ylab = "RMSE")
axis(1, labels = NEmodel.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Base (Full) Model : NE Aus RMSE", adj = 0)


par(mar = c(5, 5, 3, 5))
boxplot(SEgroup1.base.rmse, SE1.base.noOLR, 
        SEgroup2.base.rmse, SE2.base.noOLR, 
        SEgroup3.base.rmse, SE3.base.noOLR, pch = 19,
        ylim = rmse.range, ylab = "RMSE")
axis(1, labels = SEmodel.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Base (Full)  Model : SE Aus RMSE", adj = 0)
```




## CRPS Plots

```{r}
NEcprs.range <- range(NE.cprs)
SEcprs.range <- range(SE.cprs)

plot(1:57, NEconst.cprs, pch = 16,
     ylim = NEcprs.range)
plot(1:57, SEconst.cprs, pch = 16,
     ylim = SEcprs.range)
```

```{r boxplot_cprs}
cprs.range <- range(NEbase.cprs, NEconst.cprs, 
                    NEbase.cprs, SEconst.cprs) 

model.names <- c("NE Aus 1", "NE Aus 2", "NE Aus 3",
                 "SE Aus 1", "SE Aus 2", "SE Aus 3")

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "base_cprs.png", width = 2000, height = 1200, res = 250)
par(mar = c(5, 5, 3, 5))
#base (no split)
boxplot(NEgroup1.base.cprs, NEgroup2.base.cprs, NEgroup3.base.cprs,
        SEgroup1.base.cprs, SEgroup2.base.cprs, SEgroup3.base.cprs, pch = 19,
        ylim = cprs.range, ylab = "CRPS", axes = FALSE)
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Full Model : CRPS", adj = 0)
dev.off()

png(filename = "constant_cprs.png", width = 2000, height = 1200, res = 250)
par(mar = c(5, 5, 3, 5))
boxplot(NEgroup1.cprs, NEgroup2.cprs, NEgroup3.cprs, 
        SEgroup1.cprs, SEgroup2.cprs, SEgroup3.cprs, pch = 19,
         ylim = cprs.range, ylab = "CRPS")
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : CRPS", adj = 0)
dev.off()
```

### CRPS - no OLR

```{r}
cprs.range <- range(NEbase.cprs, NEconst.cprs,  NEbase.cprs.noOLR, NEconst.cprs.noOLR,
                    NEbase.cprs, SEconst.cprs, SEbase.cprs.noOLR, SEconst.cprs.noOLR)

model.names <- c("NE Aus 1", "NE Aus 2", "NE Aus 3",
                 "SE Aus 1", "SE Aus 2", "SE Aus 3")

NEmodel.names <- c("NE Aus 1", "NE Aus 1 - no OLR", 
                   "NE Aus 2", "NE Aus 2 - no OLR",
                   "NE Aus 3", "NE Aus 3 - no OLR")

SEmodel.names <- c("SE Aus 1", "SE Aus 1 - no OLR", 
                   "SE Aus 2", "SE Aus 2 - no OLR",
                   "SE Aus 3", "SE Aus 3 - no OLR")


par(mar = c(5, 5, 3, 5))
boxplot(NE1.cprs.noOLR, NE2.cprs.noOLR, NE3.cprs.noOLR, 
        SE1.cprs.noOLR, SE2.cprs.noOLR, SE3.cprs.noOLR, pch = 19,
         ylim = cprs.range, ylab = "CRPS")
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : CRPS", adj = 0)

par(mar = c(5, 5, 3, 5))
boxplot(NEgroup1.cprs, NE1.cprs.noOLR, 
        NEgroup2.cprs, NE2.cprs.noOLR, 
        NEgroup3.cprs, NE3.cprs.noOLR, pch = 19,
         ylim = cprs.range, ylab = "CRPS")
axis(1, labels = NEmodel.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : NE Aus CRPS", adj = 0)


par(mar = c(5, 5, 3, 5))
boxplot(SEgroup1.cprs, SE1.cprs.noOLR, 
        SEgroup2.cprs, SE2.cprs.noOLR, 
        SEgroup3.cprs, SE3.cprs.noOLR, pch = 19,
        ylim = cprs.range, ylab = "CRPS")
axis(1, labels = SEmodel.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : SE Aus CRPS", adj = 0)


par(mar = c(5, 5, 3, 5))
boxplot(NEgroup1.base.cprs, NE1.base.cprs.noOLR, 
        NEgroup2.base.cprs, NE2.base.cprs.noOLR, 
        NEgroup3.base.cprs, NE3.base.cprs.noOLR, pch = 19,
         ylim = cprs.range, ylab = "CRPS")
axis(1, labels = NEmodel.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Base Model : NE Aus CRPS", adj = 0)


par(mar = c(5, 5, 3, 5))
boxplot(SEgroup1.base.cprs, SE1.base.cprs.noOLR, 
        SEgroup2.base.cprs, SE2.base.cprs.noOLR, 
        SEgroup3.base.cprs, SE3.base.cprs.noOLR, pch = 19,
        ylim = cprs.range, ylab = "CRPS")
axis(1, labels = SEmodel.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Base Model : SE Aus CRPS", adj = 0)

```


## Interval Score Plots

```{r}
NEints.range <- range(NE.ints)
SEints.range <- range(SE.ints)

plot(1:57, NEconst.int, pch = 16,
     ylim = NEints.range)
plot(1:57, SEconst.int, pch = 16,
     ylim = SEints.range)
```

```{r boxplots_intscore}
ints.range <- range(NEbase.int, NEconst.int, 
                    NEbase.int, SEconst.int)

model.names <- c("NE Aus 1", "NE Aus 2", "NE Aus 3",
                 "SE Aus 1", "SE Aus 2", "SE Aus 3")

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "base_int.png", width = 2000, height = 1200, res = 250)
par(mar = c(5, 5, 3, 5))
#base (no split)
boxplot(NEgroup1.base.ints, NEgroup2.base.ints, NEgroup3.base.ints,
        SEgroup1.base.ints, SEgroup2.base.ints, SEgroup3.base.ints, pch = 19,
        ylim = ints.range, ylab = "Interval Score", axes = FALSE)
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Full Model : 95% Interval Score", adj = 0)
dev.off()


png(filename = "constant_int.png", width = 2000, height = 1200, res = 250)
#constant terms
par(mar = c(5, 5, 3, 5))
boxplot(NEgroup1.ints, NEgroup2.ints, NEgroup3.ints,
        SEgroup1.ints, SEgroup2.ints, SEgroup3.ints, pch = 19,
        ylim = ints.range, ylab = "Interval Score", axes = FALSE)
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : 95% Interval Score", adj = 0)
dev.off()

```


### IS - no OLR

```{r constat_terms}
ints.range <- range(NEbase.int, NEconst.int, NEbase.ints.noOLR, NEconst.ints.noOLR, 
                    NEbase.int, SEconst.int, SEbase.ints.noOLR, SEconst.ints.noOLR)

model.names <- c("NE Aus 1", "NE Aus 2", "NE Aus 3",
                 "SE Aus 1", "SE Aus 2", "SE Aus 3")

NEmodel.names <- c("NE Aus 1", "NE Aus 1 - no OLR", 
                   "NE Aus 2", "NE Aus 2 - no OLR",
                   "NE Aus 3", "NE Aus 3 - no OLR")

SEmodel.names <- c("SE Aus 1", "SE Aus 1 - no OLR", 
                   "SE Aus 2", "SE Aus 2 - no OLR",
                   "SE Aus 3", "SE Aus 3 - no OLR")

par(mar = c(5, 5, 3, 5))
boxplot(NE1.ints.noOLR, NE2.ints.noOLR, NE3.ints.noOLR, 
        SE1.ints.noOLR, SE2.ints.noOLR, SE3.ints.noOLR, pch = 19,
         ylim = ints.range, ylab = "Score")
axis(1, labels = model.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : Interval Score", adj = 0)


par(mar = c(5, 5, 3, 5))
boxplot(NEgroup1.ints, NE1.ints.noOLR, 
        NEgroup2.ints, NE2.ints.noOLR, 
        NEgroup3.ints, NE3.ints.noOLR, pch = 19,
         ylim = ints.range, ylab = "Score")
axis(1, labels = NEmodel.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : NE Aus Interval Score", adj = 0)


par(mar = c(5, 5, 3, 5))
boxplot(SEgroup1.ints, SE1.ints.noOLR, 
        SEgroup2.ints, SE2.ints.noOLR, 
        SEgroup3.ints, SE3.ints.noOLR, pch = 19,
        ylim = ints.range, ylab = "Score")
axis(1, labels = SEmodel.names, at = 1:6, cex.axis = 1)
axis(2)                      
box()
title("Constant Term Model : SE Aus Interval Score", adj = 0)

```


# eBIC models

```{r temp_section}

#NE Aus group 1

NEAus1.eBIC.fig <- matrix(c(0, summary(NE.lms[[1]])$adj.r.squared, length(coef(NE.lms[[1]]))) , ncol = 3) 
colnames(NEAus1.eBIC.fig) <- c("gamma", "adj.R2", "terms")
for (i in 2:length(gamma_seq)) {
  model.temp <- NEAus1.eBIC[[i-1]]
  adj.R2 <- summary(model.temp)$adj.r.squared
  num.terms <- length(coef(model.temp))
  NEAus1.eBIC.fig <- rbind(NEAus1.eBIC.fig, c(gamma_seq[i], adj.R2, num.terms))
}
NEAus1.eBIC.fig <- as.data.frame(NEAus1.eBIC.fig)

#NE Aus group 2
NEAus2.eBIC.fig <- matrix(c(0, summary(NE.lms[[2]])$adj.r.squared, length(coef(NE.lms[[2]]))) , ncol = 3) 
colnames(NEAus2.eBIC.fig) <- c("gamma", "adj.R2", "terms")
for (i in 2:length(gamma_seq)) {
  model.temp <- NEAus2.eBIC[[i-1]]
  adj.R2 <- summary(model.temp)$adj.r.squared
  num.terms <- length(coef(model.temp))
  NEAus2.eBIC.fig <- rbind(NEAus2.eBIC.fig, c(gamma_seq[i], adj.R2, num.terms))
}
NEAus2.eBIC.fig <- as.data.frame(NEAus2.eBIC.fig)



#NE Aus group 3
NEAus3.eBIC.fig <- matrix(c(0, summary(NE.lms[[3]])$adj.r.squared, length(coef(NE.lms[[3]]))) , ncol = 3) 
colnames(NEAus3.eBIC.fig) <- c("gamma", "adj.R2", "terms")
for (i in 2:length(gamma_seq)) {
  model.temp <- NEAus3.eBIC[[i-1]]
  adj.R2 <- summary(model.temp)$adj.r.squared
  num.terms <- length(coef(model.temp))
  NEAus3.eBIC.fig <- rbind(NEAus3.eBIC.fig, c(gamma_seq[i], adj.R2, num.terms))
}
NEAus3.eBIC.fig <- as.data.frame(NEAus3.eBIC.fig)


#SE Aus group 1

SEAus1.eBIC.fig <- matrix(c(0, summary(SE.lms[[1]])$adj.r.squared, length(coef(SE.lms[[1]]))) , ncol = 3) 
colnames(SEAus1.eBIC.fig) <- c("gamma", "adj.R2", "terms")
for (i in 2:length(gamma_seq)) {
  model.temp <- SEAus1.eBIC[[i-1]]
  adj.R2 <- summary(model.temp)$adj.r.squared
  num.terms <- length(coef(model.temp))
  SEAus1.eBIC.fig <- rbind(SEAus1.eBIC.fig, c(gamma_seq[i], adj.R2, num.terms))
}
SEAus1.eBIC.fig <- as.data.frame(SEAus1.eBIC.fig)


#SE Aus group 2

SEAus2.eBIC.fig <- matrix(c(0, summary(SE.lms[[2]])$adj.r.squared, length(coef(SE.lms[[2]]))) , ncol = 3) 
colnames(SEAus2.eBIC.fig) <- c("gamma", "adj.R2", "terms")
for (i in 2:length(gamma_seq)) {
  model.temp <- SEAus2.eBIC[[i-1]]
  adj.R2 <- summary(model.temp)$adj.r.squared
  num.terms <- length(coef(model.temp))
  SEAus2.eBIC.fig <- rbind(SEAus2.eBIC.fig, c(gamma_seq[i], adj.R2, num.terms))
}
SEAus2.eBIC.fig <- as.data.frame(SEAus2.eBIC.fig)


#SE Aus group 3

SEAus3.eBIC.fig <- matrix(c(0, summary(SE.lms[[3]])$adj.r.squared, length(coef(SE.lms[[3]]))) , ncol = 3) 
colnames(SEAus3.eBIC.fig) <- c("gamma", "adj.R2", "terms")
for (i in 2:length(gamma_seq)) {
  model.temp <- SEAus3.eBIC[[i-1]]
  adj.R2 <- summary(model.temp)$adj.r.squared
  num.terms <- length(coef(model.temp))
  SEAus3.eBIC.fig <- rbind(SEAus3.eBIC.fig, c(gamma_seq[i], adj.R2, num.terms))
}
SEAus3.eBIC.fig <- as.data.frame(SEAus3.eBIC.fig)

```

```{r figures}
plot(NEAus1.eBIC.fig$gamma, NEAus1.eBIC.fig$adj.R2, pch = 19, ylim = c(0, 1),
     xlab = "gamma", ylab= "adj R2")
par(new = TRUE)
plot(NEAus1.eBIC.fig$gamma, NEAus1.eBIC.fig$terms, axes = FALSE, 
     xlab = "", ylab = "", ylim = c(0, max(NEAus1.eBIC.fig$terms)))
axis(side = 4)    
#mtext("y2: 20 * log(x)", side = 4, line = 3, col = "red")
title("NE Aus Group 1 : eBIC", adj = 0)


#NE Aus 2 plot
plot(NEAus2.eBIC.fig$gamma, NEAus2.eBIC.fig$adj.R2, pch = 19, ylim = c(0, 1),
     xlab = "gamma", ylab= "adj R2")
par(new = TRUE)
plot(NEAus2.eBIC.fig$gamma, NEAus2.eBIC.fig$terms, axes = FALSE, pch = 17, col = "firebrick",
     xlab = "", ylab = "", ylim = c(0, max(NEAus2.eBIC.fig$terms)))
axis(side = 4)    
title("NE Aus Group 2 : eBIC", adj = 0)

#NE Aus 3 plot
plot(NEAus3.eBIC.fig$gamma, NEAus3.eBIC.fig$adj.R2, pch = 19, ylim = c(0, 1),
     xlab = "gamma", ylab= "adj R2")
par(new = TRUE)
plot(NEAus3.eBIC.fig$gamma, NEAus3.eBIC.fig$terms, axes = FALSE, pch = 17, col = "firebrick",
     xlab = "", ylab = "", ylim = c(0, max(NEAus3.eBIC.fig$terms)))
axis(side = 4)    
#mtext("y2: 20 * log(x)", side = 4, line = 3, col = "red")
title("NE Aus Group 3 : eBIC", adj = 0)


#SE Aus 1 plot
plot(SEAus1.eBIC.fig$gamma, SEAus1.eBIC.fig$adj.R2, pch = 19, ylim = c(0, 1),
     xlab = "gamma", ylab= "adj R2")
par(new = TRUE)
plot(SEAus1.eBIC.fig$gamma, SEAus1.eBIC.fig$terms, axes = FALSE, 
     xlab = "", ylab = "", ylim = c(0, max(SEAus1.eBIC.fig$terms)))
axis(side = 4)    
title("SE Aus Group 1 : eBIC", adj = 0)

#SE Aus 2 plot
plot(SEAus2.eBIC.fig$gamma, SEAus2.eBIC.fig$adj.R2, pch = 19, ylim = c(0, 1),
     xlab = "gamma", ylab= "adj R2")
par(new = TRUE)
plot(SEAus2.eBIC.fig$gamma, SEAus2.eBIC.fig$terms, axes = FALSE, 
     xlab = "", ylab = "", ylim = c(0, max(SEAus2.eBIC.fig$terms)))
axis(side = 4)    
title("SE Aus Group 2 : eBIC", adj = 0)

#SE Aus 3 plot
plot(SEAus3.eBIC.fig$gamma, SEAus3.eBIC.fig$adj.R2, pch = 19, ylim = c(0, 1),
     xlab = "gamma", ylab= "adj R2")
par(new = TRUE)
plot(SEAus3.eBIC.fig$gamma, SEAus3.eBIC.fig$terms, axes = FALSE, 
     xlab = "", ylab = "", ylim = c(0, max(SEAus3.eBIC.fig$terms)))
axis(side = 4)    
title("SE Aus Group 3 : eBIC", adj = 0)




```




# Model Fits

```{r base_fits}
#NE base fits
plot(NE.lms[[1]])
plot(NE.lms[[2]])
plot(NE.lms[[3]])

#SE base fits
plot(SE.lms[[1]])
plot(SE.lms[[2]])
plot(SE.lms[[3]])
```


## Coefficient Models

```{r get_coefs}
#NE Aus group 1 (models wo 2019)
NE1.coef <- coef(NE.lms[[1]])
NE1.constcoef <- coef(NE.const.LM[[19]][[1]])
NE1.varycoef <- coef(NE.vary.LM[[19]][[1]])
length(NE1.constcoef)
length(NE1.varycoef)

#NE Aus group 2 (models wo 2019)
NE2.coef <- coef(NE.lms[[2]])
NE2.constcoef <- coef(NE.const.LM[[19]][[2]])
NE2.varycoef <- coef(NE.vary.LM[[19]][[2]])
length(NE2.constcoef)
length(NE2.varycoef)

#NE Aus group 3 (models wo 2019)
NE3.coef <- coef(NE.lms[[3]])
NE3.constcoef <- coef(NE.const.LM[[19]][[3]])
NE3.varycoef <- coef(NE.vary.LM[[19]][[3]])
length(NE3.constcoef)
length(NE3.varycoef)

#SE Aus group 1 (models wo 2019)
SE1.coef <- coef(SE.lms[[1]])
SE1.constcoef <- coef(SE.const.LM[[19]][[1]])
SE1.varycoef <- coef(SE.vary.LM[[19]][[1]])
length(SE1.constcoef)
length(SE1.varycoef)

#SE Aus group 2 (models wo 2019)
SE2.coef <- coef(SE.lms[[2]])
SE2.constcoef <- coef(SE.const.LM[[19]][[2]])
SE2.varycoef <- coef(SE.vary.LM[[19]][[2]])
length(SE2.constcoef)
length(SE2.varycoef)


#SE Aus group 3 (models wo 2019)
SE3.coef <- coef(SE.lms[[3]])
SE3.constcoef <- coef(SE.const.LM[[19]][[3]])
SE3.varycoef <- coef(SE.vary.LM[[19]][[3]])
length(SE3.constcoef)
length(SE3.varycoef)

```
### NE AUS Models

```{r NEAUS1_ohGOD}
#NE1.coef
#NE1.constcoef
#NE1.varycoef

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "NE1_oct.png", width = 3000, height = 3200, res = 300)

#TODO: add in an extra row of plots if needed
layout(matrix(c(1, 6,
                2, 6,
                3, 6,
                4, 6,
                5, 6), ncol = 2, byrow = TRUE),
       widths = c(1.5, 1), heights = c(1, 1, 1, 1, 1))

par(oma = c(1, 1, 3, 9))

# Store links
links <- list()

# --- Data Set-up --- 
## Nino
NE1_ninolag <- c(9)
NE1_ninocoef <- NE1.coef[2]
NE12_ninolag <- c(9)
NE12_ninocoef <- NE1.constcoef[2]

## WTIO
NE13_wtiolag <- c(3,4,7,50,52)
NE13_wtiocoef <- NE1.varycoef[2:6]

## ETIO
NE1_etiolag <- c(42)
NE1_etiocoef <- NE1.coef[3]
NE12_etiolag <- c(42)
NE12_etiocoef <- NE1.constcoef[3]
NE13_etiolag <- c(2, 42)
NE13_etiocoef <- NE1.varycoef[7:8]

## TSA
NE1_tsalag <- c(19,32)
NE1_tsacoef <- NE1.coef[4:5]
NE12_tsalag <- c(19,32)
NE12_tsacoef <- NE1.constcoef[4:5]
NE13_tsalag <- c(11, 15, 17, 18)
NE13_tsacoef <- NE1.varycoef[9:12]

## SAM (AAO)
NE1_aaolag <- c(2, 4)
NE1_aaocoef <- NE1.coef[6:7]
NE12_aaolag <- c(2, 4)
NE12_aaocoef <- NE1.constcoef[6:7]
NE13_aaolag <- c(2)
NE13_aaocoef <- NE1.varycoef[13]

## OLR
NE1_olrlag <- c(19)
NE1_olrcoef <- NE1.coef[8]
NE12_olrlag <- c(19)
NE12_olrcoef <- NE1.constcoef[8]
NE13_olrlag <- c(19)
NE13_olrcoef <- NE1.varycoef[14]


# --- Range ---
NEAus1_absmax <- max(abs(range(NE1.coef,
                      NE1.constcoef,
                      NE1.varycoef)))
NEAus1_range <- c(-NEAus1_absmax, NEAus1_absmax)

# --- Plot 1: Nino ---
par(mar = c(4, 4, 2, 1))

plot(NE1_ninolag-0.125, NE1_ninocoef, pch = 22, 
     col = "grey4", bg =  alpha("green4",.95), cex = 1.5,
     xlim = c(1,52), 
     ylim = NEAus1_range,
     xlab = "", ylab = "")
points(NE12_ninolag+0.125, NE12_ninocoef, pch = 22, col = "black",
       bg =  alpha("chartreuse2",.65) , cex = 1.5)
abline(h = 0, lty = 2)
title("Nino", adj = 0)

## --- Nino Interaction
## nino_lag9:etio_lag42
## base
links[[1]] <- list(
  y_val = NE1_ninocoef[1],
  from_x = grconvertX(NE1_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_ninocoef[1], from = "user", to = "ndc")
)

## constant
links[[2]] <- list(
  y_val = NE12_ninocoef[1],
  from_x = grconvertX(NE12_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE12_ninocoef[1], from = "user", to = "ndc")
)

## nino_lag9:tsa_lag32 
## base
links[[3]] <- list(
  y_val = NE1_ninocoef[1],
  from_x = grconvertX(NE1_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_ninocoef[1], from = "user", to = "ndc")
)

## constant
links[[4]] <- list(
  y_val = NE12_ninocoef[1],
  from_x = grconvertX(NE12_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE12_ninocoef[1], from = "user", to = "ndc")
)

## nino_lag9:NEolr_lag19 
## base
links[[5]] <- list(
  y_val = NE1_ninocoef[1],
  from_x = grconvertX(NE1_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_ninocoef[1], from = "user", to = "ndc")
)

## constant
links[[6]] <- list(
  y_val = NE12_ninocoef[1],
  from_x = grconvertX(NE12_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE12_ninocoef[1], from = "user", to = "ndc")
)


# --- Plot 2: WTIO & ETIO ---
par(mar = c(4, 4, 2, 1))

plot(NE13_wtiolag, NE13_wtiocoef, pch = 24, col = "black",
     bg =  alpha("palevioletred2",.65) , cex = 1.33, 
     xlim = c(1,52), 
     ylim = NEAus1_range,
     xlab = "", ylab = "")
points(NE1_etiolag, NE1_etiocoef, pch = 22, 
      col = "grey4", bg =  alpha("royalblue4",.95), cex = 1.5)
points(NE12_etiolag, NE12_etiocoef, pch = 22, col = "black",
       bg =  alpha("royalblue2",.65) , cex = 1.5)
abline(h = 0, lty = 2)
title("WTIO & ETIO", adj = 0)


## --- ETIO Interactions
#nino_lag9:etio_lag42
## base
links[[7]] <- list(
  y_val = NE1_etiocoef[1],
  from_x = grconvertX(NE1_etiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_etiocoef[1], from = "user", to = "ndc")
)

## constant
links[[8]] <- list(
  y_val = NE12_etiocoef[1],
  from_x = grconvertX(NE12_etiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE12_etiocoef[1], from = "user", to = "ndc")
)

# --- Plot 3: TSA ---
par(mar = c(4, 4, 2, 1))

plot(NE1_tsalag, NE1_tsacoef, pch = 22, col = "black",
       bg =  alpha("darkorange3", 0.95), xlim = c(1,52), cex = 1.4,
     ylim = NEAus1_range,
     xlab = "", ylab = "Coefficients", cex.lab = 1.33)
points(NE12_tsalag, NE12_tsacoef, pch = 22, col = "black",
       bg =  alpha("darkgoldenrod2",.65) , cex = 1.5)
points(NE13_tsalag, NE13_tsacoef, pch = 24, col = "black",
       bg =  alpha("darkgoldenrod2",.65) , cex = 1.33)
abline(h = 0, lty = 2)
title("TSA", adj = 0)

## --- TSA Interaction
## nino_lag9:tsa_lag32
## base
links[[9]] <- list(
  y_val = NE1_tsacoef[2],
  from_x = grconvertX(NE1_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_tsacoef[2], from = "user", to = "ndc")
)

## constant
links[[10]] <- list(
  y_val = NE12_tsacoef[2],
  from_x = grconvertX(NE12_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE12_tsacoef[2], from = "user", to = "ndc")
)

# --- Plot 4: SAM/AAO ---
par(mar = c(4, 4, 2, 1))
plot(NE1_aaolag-0.125, NE1_aaocoef, pch = 22,
     col = "grey4",
     bg =  alpha("red3",.95), cex = 1.5,
     xlim = c(1,52), 
     ylim = NEAus1_range,
     xlab = "", ylab = "")
points(NE12_aaolag+0.125, NE12_aaocoef, pch = 22, col = "black",
       bg =  alpha("coral2",.65) , cex = 1.5)
points(NE13_aaolag+0.125, NE13_aaocoef, pch = 24, col = "black",
       bg =  alpha("coral2",.65) , cex = 1.33)
abline(h = 0, lty = 2)
title("SAM (AAO)", adj = 0)


# --- Plot 5: OLR ---
par(mar = c(4, 4, 2, 1))
plot(NE1_olrlag, NE1_olrcoef, pch = 22, col = "black",
       bg =  alpha("turquoise4", 0.95), xlim = c(1,52), cex = 1.4,
     ylim = NEAus1_range,
     xlab = "Lag", ylab = "", cex.lab = 1.33)
points(NE12_olrlag-0.125, NE12_olrcoef, pch = 22, col = "black",
       bg =  alpha("paleturquoise3",.65) , cex = 1.5)
points(NE13_olrlag+0.125, NE13_olrcoef, pch = 24, col = "black",
       bg =  alpha("paleturquoise3",.65) , cex = 1.33)
abline(h = 0, lty = 2)
title("OLR", adj = 0)

## --- OLR Interactions
## nino_lag9:NEolr_lag19
## base
links[[11]] <- list(
  y_val = NE1_olrcoef[1],
  from_x = grconvertX(NE1_olrlag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_olrcoef[1], from = "user", to = "ndc")
)

## constant
links[[12]] <- list(
  y_val = NE12_olrcoef[1],
  from_x = grconvertX(NE12_olrlag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE12_olrcoef[1], from = "user", to = "ndc")
)


# --- Plot 6: Interaction Effects ---
par(mar = c(4, 4, 2, 2))

int_range <- range(NE1.coef,
                      NE1.constcoef,
                      NE1.varycoef)


plot(NE1.coef[1], 0, type = "n", main = "", 
     ylim = c(0,1), xlim = NEAus1_range,
     xlab = "Coefficients", cex.lab = 1.33,
     yaxt = "n",  ylab = "")
abline(v= 0, lty = 2)

#interactions
int_1 <- grconvertY(links[[1]]$from_y, from = "ndc", to = "user") # nino_lag9:etio_lag42 #base
int_2 <- grconvertY(links[[2]]$from_y, from = "ndc", to = "user") # nino_lag9:etio_lag42 
int_3 <- grconvertY(links[[3]]$from_y, from = "ndc", to = "user") # nino_lag9:tsa_lag32 #base
int_4 <- grconvertY(links[[4]]$from_y, from = "ndc", to = "user") # nino_lag9:tsa_lag32 
int_5 <- grconvertY(links[[5]]$from_y, from = "ndc", to = "user") # nino_lag9:NEolr_lag19 #base
int_6 <- grconvertY(links[[6]]$from_y, from = "ndc", to = "user") # nino_lag9:NEolr_lag19 

int_7 <- grconvertY(links[[7]]$from_y, from = "ndc", to = "user") # nino_lag9:etio_lag42 #base
int_8 <- grconvertY(links[[8]]$from_y, from = "ndc", to = "user") # nino_lag9:etio_lag42 
int_9 <- grconvertY(links[[9]]$from_y, from = "ndc", to = "user") # nino_lag9:tsa_lag32 #base
int_10 <- grconvertY(links[[10]]$from_y, from = "ndc", to = "user") # nino_lag9:tsa_lag32 
int_11 <- grconvertY(links[[11]]$from_y, from = "ndc", to = "user") # nino_lag9:NEolr_lag19 #base
int_12 <- grconvertY(links[[12]]$from_y, from = "ndc", to = "user") # nino_lag9:NEolr_lag19 

#nino_lag9:etio_lag42 
int_pt1 <- (int_1 + int_7)/2
segments(NE1.coef[11], int_1, NE1.coef[11], int_pt1, col = "green4", lty = 2, lwd = 1.5)
segments(NE1.coef[11], int_7, NE1.coef[11], int_pt1, col = "royalblue4", lty = 2, lwd = 1.5)

int_pt2 <- (int_2 + int_8)/2
segments(NE1.constcoef[11], int_2, NE1.constcoef[11], int_pt2, col = "chartreuse2", lty = 3, lwd = 1.5)
segments(NE1.constcoef[11], int_8, NE1.constcoef[11], int_pt2, col = "royalblue2", lty = 3, lwd = 1.5)

# nino_lag9:tsa_lag32 
int_pt3 <- (int_3 + int_9)/2
segments(NE1.coef[9], int_3, NE1.coef[9], int_pt3, col = "green4", lty = 2, lwd = 1.5)
segments(NE1.coef[9], int_9, NE1.coef[9], int_pt3, col = "darkorange3", lty = 2, lwd = 1.5)

int_pt4 <- (int_4 + int_10)/2
segments(NE1.constcoef[9], int_4, NE1.constcoef[9], int_pt4, col = "chartreuse2", lty = 3, lwd = 1.5)
segments(NE1.constcoef[9], int_10, NE1.constcoef[9], int_pt4, col = "darkgoldenrod2", lty = 3, lwd = 1.5)

int_pt5 <- (int_5 + int_11)/2
segments(NE1.coef[10], int_5, NE1.coef[10], int_pt5, col = "green4", lty = 2, lwd = 1.5)
segments(NE1.coef[10], int_11, NE1.coef[10], int_pt5, col = "turquoise4", lty = 2, lwd = 1.5)

int_pt6 <- (int_6 + int_12)/2
segments(NE1.constcoef[10], int_6, NE1.constcoef[10], int_pt6, col = "chartreuse2", lty = 3, lwd = 1.5)
segments(NE1.constcoef[10], int_12, NE1.constcoef[10], int_pt6, col = "paleturquoise3", lty = 3, lwd = 1.5)

#interaction points
points(NE1.coef[11], int_pt1,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE1.constcoef[11], int_pt2,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE1.coef[9], int_pt3,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE1.constcoef[9], int_pt4,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE1.coef[10], int_pt5,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE1.constcoef[10], int_pt6,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 

#link to x 
links[[1]]$to_x <- grconvertX(NE1.coef[11], from = "user", to = "ndc")
links[[2]]$to_x <- grconvertX(NE1.constcoef[11], from = "user", to = "ndc")
links[[3]]$to_x <- grconvertX(NE1.coef[9], from = "user", to = "ndc")
links[[4]]$to_x <- grconvertX(NE1.constcoef[9], from = "user", to = "ndc")
links[[5]]$to_x <- grconvertX(NE1.coef[10], from = "user", to = "ndc")
links[[6]]$to_x <- grconvertX(NE1.constcoef[10], from = "user", to = "ndc")
links[[7]]$to_x <- grconvertX(NE1.coef[11], from = "user", to = "ndc")
links[[8]]$to_x <- grconvertX(NE1.constcoef[11], from = "user", to = "ndc")
links[[9]]$to_x <- grconvertX(NE1.coef[9], from = "user", to = "ndc")
links[[10]]$to_x <- grconvertX(NE1.constcoef[9], from = "user", to = "ndc")
links[[11]]$to_x <- grconvertX(NE1.coef[10], from = "user", to = "ndc")
links[[12]]$to_x <- grconvertX(NE1.constcoef[10], from = "user", to = "ndc")

for (i in 1:length(links)) {
  links[[i]]$to_y <- links[[i]]$from_y  # same y to keep it horizontal
}

# --- Draw horizontal linking lines ---
par(xpd = NA)  # allow drawing outside plot regions
colors <- c(rep(c("green4", "chartreuse2"), 3), "royalblue4", "royalblue2", 
            "darkorange3",  "darkgoldenrod3",  "turquoise4",  "paleturquoise3")
linetypes <- rep(c(2,3), 6)

for (i in 1:length(links)) {
  grid.lines(
    x = unit(c(links[[i]]$from_x, links[[i]]$to_x), "npc"),
    y = unit(c(links[[i]]$from_y, links[[i]]$to_y), "npc"),
    gp = gpar(col = colors[i], lwd = 1, lty = linetypes[i])
  )
}

#outer text and legends
par(xpd = NA)
legend("topright", inset = c(-0.45, 0.00),
       title = "Nino",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("green4",  "chartreuse2", "chartreuse2"),
       pt.cex = c(1.5, 1.5, 1.33))
legend("topright", inset = c(-0.45, 0.2),
       title = "WTIO",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("magenta4",  "palevioletred2", "palevioletred2"),
       pt.cex = c(1.5, 1.5, 1.33))
legend("topright", inset = c(-0.45, 0.3),
       title = "ETIO",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("royalblue4",  "royalblue2", "royalblue2"),
       pt.cex = c(1.5, 1.5, 1.33))

legend("right", inset = c(-0.45, 0.00),
       title = "TSA",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4","grey4", "grey4"),
       pt.bg = c("darkorange3",  "darkgoldenrod2",  "darkgoldenrod2"),
       pt.cex = c(1.5, 1.5, 1.33))

legend("bottomright", inset = c(-0.45, 0.26),
       title = "SAM (AAO)",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4","grey4","grey4"),
       pt.bg = c("red3",  "coral2",  "coral2"),
       pt.cex = c(1.5, 1.5, 1.33))

legend("bottomright", inset = c(-0.45, 0.05),
       title = "OLR",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("turquoise4",  "paleturquoise3", "paleturquoise3"),
       pt.cex = c(1.5, 1.5, 1.33))

mtext("NE Aus Group 1 (Weeks 38-46)", outer = TRUE, cex = 1.5, font = 1)

dev.off()

```



```{r NEAUS3_killME}
#NE3.coef
#NE3.constcoef
#NE3.varycoef

setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "NE3_oct.png", width = 3000, height = 3200, res = 300)

#TODO: add in an extra row of plots if needed
layout(matrix(c(1, 6,
                2, 6,
                3, 6,
                4, 6,
                5, 6), ncol = 2, byrow = TRUE),
       widths = c(1.5, 1), heights = c(1, 1, 1, 1, 1))

par(oma = c(1, 1, 3, 9))

# Store links
links <- list()

# --- Data Set-up --- 
## Nino
NE3_ninolag <- c(41)
NE3_ninocoef <- NE3.coef[2]
NE32_ninolag <- c(41)
NE32_ninocoef <- NE3.constcoef[2]
NE33_ninolag <- c(25)
NE33_ninocoef <- NE3.varycoef[2]

## WTIO
NE33_wtiolag <- c(31)
NE33_wtiocoef <- NE3.varycoef[3]

## ETIO
NE3_etiolag <- c(19)
NE3_etiocoef <- NE3.coef[3]
NE32_etiolag <- c(19)
NE32_etiocoef <- NE3.constcoef[3]
NE33_etiolag <- c(6, 16, 21)
NE33_etiocoef <- NE3.varycoef[4:6]

## TSA
NE3_tsalag <- c(1, 19, 37, 52)
NE3_tsacoef <- NE3.coef[c(10, 4, 5,6)]
NE32_tsalag <- c(1, 19, 37, 52)
NE32_tsacoef <- NE3.constcoef[c(10, 4, 5,6)]
NE33_tsalag <- c(2, 28, 52)
NE33_tsacoef <- NE3.varycoef[7:9]

## SAM (AAO)
NE3_aaolag <- c(43, 44)
NE3_aaocoef <- NE3.coef[7:8]
NE32_aaolag <- c(43, 44)
NE32_aaocoef <- NE3.constcoef[7:8]
NE33_aaolag <- c(5, 7, 29, 43, 44)
NE33_aaocoef <- NE3.varycoef[10:14]

## OLR
NE3_olrlag <- c(1, 32)
NE3_olrcoef <- NE3.coef[c(9,11)]
NE32_olrlag <- c(1, 32)
NE32_olrcoef <- NE3.constcoef[c(9,11)]

# --- Range ---
NEAus3_absmax <- max(abs(range(NE3.coef,
                      NE3.constcoef,
                      NE3.varycoef)))
NEAus3_range <- c(-NEAus3_absmax, NEAus3_absmax)

# --- Plot 1: Nino ---
par(mar = c(4, 4, 2, 1))

plot(NE3_ninolag, NE3_ninocoef, pch = 22, 
     col = "grey4", bg =  alpha("green4",.95), cex = 1.5,
     xlim = c(1,52), 
     ylim = NEAus3_range,
     xlab = "", ylab = "")
points(NE32_ninolag, NE32_ninocoef, pch = 22, col = "black",
       bg =  alpha("chartreuse2",.65) , cex = 1.5)
points(NE33_ninolag, NE33_ninocoef, pch = 24, col = "black",
       bg =  alpha("chartreuse2",.65) , cex = 1.33)
abline(h = 0, lty = 2)
title("Nino", adj = 0)

## --- Nino Interaction
#nino_lag41:etio_lag19
## base: NE3.coef[14]
links[[1]] <- list(
  y_val = NE3_ninocoef[1],
  from_x = grconvertX(NE3_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_ninocoef[1], from = "user", to = "ndc")
)

## constant: NE3.constcoef[14]
links[[2]] <- list(
  y_val = NE32_ninocoef[1],
  from_x = grconvertX(NE32_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_ninocoef[1], from = "user", to = "ndc")
)

#nino_lag41:tsa_lag19 
## base: NE3.coef[15]
links[[3]] <- list(
  y_val = NE3_ninocoef[1],
  from_x = grconvertX(NE3_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_ninocoef[1], from = "user", to = "ndc")
)

## constant: NE3.constcoef[15]
links[[4]] <- list(
  y_val = NE32_ninocoef[1],
  from_x = grconvertX(NE32_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_ninocoef[1], from = "user", to = "ndc")
)

#nino_lag41:tsa_lag1
## base: NE3.coef[16]
links[[5]] <- list(
  y_val = NE3_ninocoef[1],
  from_x = grconvertX(NE3_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_ninocoef[1], from = "user", to = "ndc")
)

## constant: NE3.constcoef[16]
links[[6]] <- list(
  y_val = NE32_ninocoef[1],
  from_x = grconvertX(NE32_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_ninocoef[1], from = "user", to = "ndc")
)


# --- Plot 2: WTIO & ETIO ---
par(mar = c(4, 4, 2, 1))

plot(NE33_wtiolag, NE33_wtiocoef, pch = 24, col = "black",
     bg =  alpha("palevioletred2",.65) , cex = 1.33, 
     xlim = c(1,52), 
     ylim = NEAus3_range,
     xlab = "", ylab = "")
points(NE3_etiolag, NE3_etiocoef, pch = 22, 
      col = "grey4", bg =  alpha("royalblue4",.95), cex = 1.5)
points(NE32_etiolag, NE32_etiocoef, pch = 22, col = "black",
       bg =  alpha("royalblue2",.65) , cex = 1.5)
points(NE33_etiolag, NE33_etiocoef, pch = 24, col = "black",
       bg =  alpha("royalblue2",.65) , cex = 1.33)
abline(h = 0, lty = 2)
title("WTIO & ETIO", adj = 0)


## --- WTIO Interactions
# wtio_lag31:tsa_lag2
#vary: NE3.varycoef[15]
links[[7]] <- list(
  y_val = NE33_wtiocoef[1],
  from_x = grconvertX(NE33_wtiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE33_wtiocoef[1], from = "user", to = "ndc")
)

#wtio_lag31:tsa_lag52 
# varying: NE3.varycoef[16]
links[[8]] <- list(
  y_val = NE33_wtiocoef[1],
  from_x = grconvertX(NE33_wtiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE33_wtiocoef[1], from = "user", to = "ndc")
)


## --- ETIO Interactions
# nino_lag41:etio_lag19, 
## base: NE3.coef[14]
links[[9]] <- list(
  y_val = NE3_etiocoef[1],
  from_x = grconvertX(NE3_etiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_etiocoef[1], from = "user", to = "ndc")
)

## constant: NE3.constcoef[14]
links[[10]] <- list(
  y_val = NE32_etiocoef[1],
  from_x = grconvertX(NE32_etiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_etiocoef[1], from = "user", to = "ndc")
)


# etio_lag19:tsa_lag37, 
## base: NE3.coef[17]
links[[11]] <- list(
  y_val = NE3_etiocoef[1],
  from_x = grconvertX(NE3_etiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_etiocoef[1], from = "user", to = "ndc")
)

## constant: NE3.constcoef[17]
links[[12]] <- list(
  y_val = NE32_etiocoef[1],
  from_x = grconvertX(NE32_etiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_etiocoef[1], from = "user", to = "ndc")
)


# etio_lag19:tsa_lag52
## base: NE3.coef[13]
links[[13]] <- list(
  y_val = NE3_etiocoef[1],
  from_x = grconvertX(NE3_etiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_etiocoef[1], from = "user", to = "ndc")
)

## constant: NE3.constcoef[13]
links[[14]] <- list(
  y_val = NE32_etiocoef[1],
  from_x = grconvertX(NE32_etiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_etiocoef[1], from = "user", to = "ndc")
)


# --- Plot 3: TSA ---
par(mar = c(4, 4, 2, 1))

plot(NE3_tsalag, NE3_tsacoef, pch = 22, col = "black",
       bg =  alpha("darkorange3", 0.95), xlim = c(1,52), cex = 1.4,
     ylim = NEAus3_range,
     xlab = "", ylab = "Coefficients", cex.lab = 1.33)
points(NE32_tsalag, NE32_tsacoef, pch = 22, col = "black",
       bg =  alpha("darkgoldenrod2",.65) , cex = 1.5)
points(NE33_tsalag, NE33_tsacoef, pch = 24, col = "black",
       bg =  alpha("darkgoldenrod2",.65) , cex = 1.33)
abline(h = 0, lty = 2)
title("TSA", adj = 0)

## --- TSA Interaction
# wtio_lag31:tsa_lag2
# varying NE3.varycoef[15]
links[[15]] <- list(
  y_val = NE33_tsacoef[1],
  from_x = grconvertX(NE33_tsalag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE33_tsacoef[1], from = "user", to = "ndc")
)


#wtio_lag31:tsa_lag52  
# (varying)  NE3.varycoef[16]
links[[16]] <- list(
  y_val = NE33_tsacoef[3],
  from_x = grconvertX(NE33_tsalag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE33_tsacoef[3], from = "user", to = "ndc")
)

##base/constant:
#  I(tsa_lag19^2)
# base: NE3.coef[12]
links[[17]] <- list(
  y_val = NE3_tsacoef[2],
  from_x = grconvertX(NE3_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[2], from = "user", to = "ndc")
)

#constant: NE3.constcoef[12]
links[[18]] <- list(
  y_val = NE32_tsacoef[2],
  from_x = grconvertX(NE32_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[2], from = "user", to = "ndc")
)


#etio_lag19:tsa_lag37,
#base: NE3.coef[17]
links[[19]] <- list(
  y_val = NE3_tsacoef[3],
  from_x = grconvertX(NE3_tsalag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[3], from = "user", to = "ndc")
)

#const: NE3.constcoef[17]
links[[20]] <- list(
  y_val = NE32_tsacoef[3],
  from_x = grconvertX(NE32_tsalag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[3], from = "user", to = "ndc")
)

#etio_lag19:tsa_lag52, 
#base: NE3.coef[13]
links[[21]] <- list(
  y_val = NE3_tsacoef[4],
  from_x = grconvertX(NE3_tsalag[4], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[4], from = "user", to = "ndc")
)

#const: NE3.constcoef[13]
links[[22]] <- list(
  y_val = NE32_tsacoef[4],
  from_x = grconvertX(NE32_tsalag[4], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[4], from = "user", to = "ndc")
)


#nino_lag41:tsa_lag19, 
#base: NE3.coef[15]
links[[23]] <- list(
  y_val = NE3_tsacoef[2],
  from_x = grconvertX(NE3_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[2], from = "user", to = "ndc")
)

#const: NE3.constcoef[15]
links[[24]] <- list(
  y_val = NE32_tsacoef[2],
  from_x = grconvertX(NE32_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[2], from = "user", to = "ndc")
)


#nino_lag41:tsa_lag1, 
#base: NE3.coef[16]
links[[25]] <- list(
  y_val = NE3_tsacoef[1],
  from_x = grconvertX(NE3_tsalag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[1], from = "user", to = "ndc")
)

#const: NE3.constcoef[16]
links[[26]] <- list(
  y_val = NE32_tsacoef[1],
  from_x = grconvertX(NE32_tsalag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[1], from = "user", to = "ndc")
)


#tsa_lag19:tsa_lag1 
#base: NE3.coef[18]
links[[27]] <- list(
  y_val = NE3_tsacoef[2],
  from_x = grconvertX(NE3_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[2], from = "user", to = "ndc")
)

#const: NE3.constcoef[18]
links[[28]] <- list(
  y_val = NE32_tsacoef[2],
  from_x = grconvertX(NE32_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[2], from = "user", to = "ndc")
)

#base: NE3.coef[18]
links[[29]] <- list(
  y_val = NE3_tsacoef[1],
  from_x = grconvertX(NE3_tsalag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[1], from = "user", to = "ndc")
)

#const: NE3.constcoef[18]
links[[30]] <- list(
  y_val = NE32_tsacoef[1],
  from_x = grconvertX(NE32_tsalag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[1], from = "user", to = "ndc")
)

# tsa_lag19:tsa_lag37  
#base: NE3.coef[20]
links[[31]] <- list(
  y_val = NE3_tsacoef[2],
  from_x = grconvertX(NE3_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[2], from = "user", to = "ndc")
)

#const: NE3.constcoef[20]
links[[32]] <- list(
  y_val = NE32_tsacoef[3],
  from_x = grconvertX(NE32_tsalag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[3], from = "user", to = "ndc")
)

#base: NE3.coef[20]
links[[33]] <- list(
  y_val = NE3_tsacoef[3],
  from_x = grconvertX(NE3_tsalag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[3], from = "user", to = "ndc")
)

#const: NE3.constcoef[20]
links[[34]] <- list(
  y_val = NE32_tsacoef[3],
  from_x = grconvertX(NE32_tsalag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[3], from = "user", to = "ndc")
)
 
#tsa_lag37:aao_lag43   
#base: NE3.coef[21]
links[[35]] <- list(
  y_val = NE3_tsacoef[3],
  from_x = grconvertX(NE3_tsalag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[3], from = "user", to = "ndc")
)

#const: NE3.constcoef[21]
links[[36]] <- list(
  y_val = NE32_tsacoef[3],
  from_x = grconvertX(NE32_tsalag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[3], from = "user", to = "ndc")
)

#tsa_lag37:aao_lag44 
#base: NE3.coef[22]
links[[37]] <- list(
  y_val = NE3_tsacoef[3],
  from_x = grconvertX(NE3_tsalag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[3], from = "user", to = "ndc")
)

#const: NE3.constcoef[22]
links[[38]] <- list(
  y_val = NE32_tsacoef[3],
  from_x = grconvertX(NE32_tsalag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[3], from = "user", to = "ndc")
)

## tsa_lag1:NEolr_lag32  
#base: NE3.coef[19]
links[[39]] <- list(
  y_val = NE3_tsacoef[1],
  from_x = grconvertX(NE3_tsalag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[1], from = "user", to = "ndc")
)

#const: NE3.constcoef[19]
links[[40]] <- list(
  y_val = NE32_tsacoef[1],
  from_x = grconvertX(NE32_tsalag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_tsacoef[1], from = "user", to = "ndc")
)


# --- Plot 4: SAM/AAO ---
par(mar = c(4, 4, 2, 1))
plot(NE3_aaolag, NE3_aaocoef, pch = 22,
     col = "grey4",
     bg =  alpha("red3",.95), cex = 1.5,
     xlim = c(1,52), 
     ylim = NEAus3_range,
     xlab = "", ylab = "")
points(NE32_aaolag, NE32_aaocoef, pch = 22, col = "black",
       bg =  alpha("coral2",.65) , cex = 1.5)
points(NE33_aaolag, NE33_aaocoef, pch = 24, col = "black",
       bg =  alpha("coral2",.65) , cex = 1.33)
abline(h = 0, lty = 2)
title("SAM (AAO)", adj = 0)

## --- AAO Interactions
# tsa_lag37:aao_lag43   
#base: NE3.coef[21]
links[[41]] <- list(
  y_val = NE3_aaocoef[1],
  from_x = grconvertX(NE3_aaolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_aaocoef[1], from = "user", to = "ndc")
)

#const: NE3.constcoef[21]
links[[42]] <- list(
  y_val = NE32_aaocoef[1],
  from_x = grconvertX(NE32_aaolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_aaocoef[1], from = "user", to = "ndc")
)

# tsa_lag37:aao_lag44
#base: NE3.coef[22]
links[[43]] <- list(
  y_val = NE3_aaocoef[2],
  from_x = grconvertX(NE3_aaolag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_aaocoef[2], from = "user", to = "ndc")
)

#const: NE3.constcoef[21]
links[[44]] <- list(
  y_val = NE32_aaocoef[2],
  from_x = grconvertX(NE32_aaolag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_aaocoef[2], from = "user", to = "ndc")
)


# --- Plot 5: OLR ---
par(mar = c(4, 4, 2, 1))
plot(NE3_olrlag, NE3_olrcoef, pch = 22, col = "black",
       bg =  alpha("turquoise4", 0.95), xlim = c(1,52), cex = 1.4,
     ylim = NEAus3_range,
     xlab = "Lag", ylab = "", cex.lab = 1.33)
points(NE32_olrlag-0.125, NE32_olrcoef, pch = 22, col = "black",
       bg =  alpha("paleturquoise3",.65) , cex = 1.5)
abline(h = 0, lty = 2)
title("OLR", adj = 0)

## --- OLR Interactions
# tsa_lag1:NEolr_lag32
#base: NE3.coef[19]
links[[45]] <- list(
  y_val = NE3_olrcoef[2],
  from_x = grconvertX(NE3_olrlag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_olrcoef[2], from = "user", to = "ndc")
)

#const: NE3.constcoef[19]
links[[46]] <- list(
  y_val = NE32_olrcoef[2],
  from_x = grconvertX(NE32_olrlag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE32_olrcoef[2], from = "user", to = "ndc")
)


# --- Plot 6: Interaction Effects ---
par(mar = c(4, 4, 2, 2))

plot(NE3.coef[1], 0, type = "n", main = "", 
     ylim = c(0,1), xlim = NEAus3_range,
     xlab = "Coefficients", cex.lab = 1.33,
     yaxt = "n",  ylab = "")
abline(v= 0, lty = 2)

#square terms
int_17 <- grconvertY(links[[17]]$from_y, from = "ndc", to = "user") #
int_18 <- grconvertY(links[[18]]$from_y, from = "ndc", to = "user") #

#interactions
int_1 <- grconvertY(links[[1]]$from_y, from = "ndc", to = "user") # #nino_lag41:etio_lag19 #base
int_2 <- grconvertY(links[[2]]$from_y, from = "ndc", to = "user") # #nino_lag41:etio_lag19 
int_3 <- grconvertY(links[[3]]$from_y, from = "ndc", to = "user") # #nino_lag41:tsa_lag19 #base
int_4 <- grconvertY(links[[4]]$from_y, from = "ndc", to = "user") # #nino_lag41:tsa_lag19  
int_5 <- grconvertY(links[[5]]$from_y, from = "ndc", to = "user") #
int_6 <- grconvertY(links[[6]]$from_y, from = "ndc", to = "user") #
int_7 <- grconvertY(links[[7]]$from_y, from = "ndc", to = "user") #
int_8 <- grconvertY(links[[8]]$from_y, from = "ndc", to = "user") #
int_9 <- grconvertY(links[[9]]$from_y, from = "ndc", to = "user") #  
int_10 <- grconvertY(links[[10]]$from_y, from = "ndc", to = "user") #
int_11 <- grconvertY(links[[11]]$from_y, from = "ndc", to = "user") #
int_12 <- grconvertY(links[[12]]$from_y, from = "ndc", to = "user") #
int_13 <- grconvertY(links[[13]]$from_y, from = "ndc", to = "user") #
int_14 <- grconvertY(links[[14]]$from_y, from = "ndc", to = "user") #
int_15 <- grconvertY(links[[15]]$from_y, from = "ndc", to = "user") #
int_16 <- grconvertY(links[[16]]$from_y, from = "ndc", to = "user") #

int_18 <- grconvertY(links[[18]]$from_y, from = "ndc", to = "user") #
int_19 <- grconvertY(links[[19]]$from_y, from = "ndc", to = "user") #  
int_20 <- grconvertY(links[[20]]$from_y, from = "ndc", to = "user") #
int_21 <- grconvertY(links[[21]]$from_y, from = "ndc", to = "user") #
int_22 <- grconvertY(links[[22]]$from_y, from = "ndc", to = "user") #
int_23 <- grconvertY(links[[23]]$from_y, from = "ndc", to = "user") #
int_24 <- grconvertY(links[[24]]$from_y, from = "ndc", to = "user") #
int_25 <- grconvertY(links[[25]]$from_y, from = "ndc", to = "user") #
int_26 <- grconvertY(links[[26]]$from_y, from = "ndc", to = "user") #
int_27 <- grconvertY(links[[27]]$from_y, from = "ndc", to = "user") #
int_28 <- grconvertY(links[[28]]$from_y, from = "ndc", to = "user") #
int_29 <- grconvertY(links[[29]]$from_y, from = "ndc", to = "user") #  
int_30 <- grconvertY(links[[30]]$from_y, from = "ndc", to = "user") #
int_31 <- grconvertY(links[[31]]$from_y, from = "ndc", to = "user") #
int_32 <- grconvertY(links[[32]]$from_y, from = "ndc", to = "user") #
int_33 <- grconvertY(links[[33]]$from_y, from = "ndc", to = "user") #
int_34 <- grconvertY(links[[34]]$from_y, from = "ndc", to = "user") #
int_35 <- grconvertY(links[[35]]$from_y, from = "ndc", to = "user") #
int_36 <- grconvertY(links[[36]]$from_y, from = "ndc", to = "user") #
int_37 <- grconvertY(links[[37]]$from_y, from = "ndc", to = "user") #
int_38 <- grconvertY(links[[38]]$from_y, from = "ndc", to = "user") #
int_39 <- grconvertY(links[[39]]$from_y, from = "ndc", to = "user") #  
int_40 <- grconvertY(links[[40]]$from_y, from = "ndc", to = "user") #
int_41 <- grconvertY(links[[41]]$from_y, from = "ndc", to = "user") #
int_42 <- grconvertY(links[[42]]$from_y, from = "ndc", to = "user") #
int_43 <- grconvertY(links[[43]]$from_y, from = "ndc", to = "user") #
int_44 <- grconvertY(links[[44]]$from_y, from = "ndc", to = "user") #
int_45 <- grconvertY(links[[45]]$from_y, from = "ndc", to = "user") #
int_46 <- grconvertY(links[[46]]$from_y, from = "ndc", to = "user") #

#interaction points
int_pt1 <- (int_1 + int_9)/2
segments(NE3.coef[14], int_1, NE3.coef[14], int_pt1, col = "green4", lty = 2, lwd = 1.5)
segments(NE3.coef[14], int_9, NE3.coef[14], int_pt1, col = "royalblue4", lty = 2, lwd = 1.5)

int_pt2 <- (int_2 + int_10)/2
segments(NE3.constcoef[14], int_2, NE3.constcoef[14], int_pt2, col = "chartreuse2", lty = 3, lwd = 1.5)
segments(NE3.constcoef[14], int_10, NE3.constcoef[14], int_pt2, col = "royalblue2", lty = 3, lwd = 1.5)

int_pt3 <- (int_3 + int_23)/2
segments(NE3.coef[15], int_3, NE3.coef[15], int_pt3, col = "green4", lty = 2, lwd = 1.5)
segments(NE3.coef[15], int_23, NE3.coef[15], int_pt3, col = "darkorange3", lty = 2, lwd = 1.5)

int_pt4 <- (int_4 + int_24)/2
segments(NE3.constcoef[15], int_4, NE3.constcoef[15], int_pt4, col = "chartreuse2", lty = 3, lwd = 1.5)
segments(NE3.constcoef[15], int_24, NE3.constcoef[15], int_pt4, col = "darkgoldenrod2", lty = 3, lwd = 1.5)

int_pt5 <- (int_5 + int_25)/2
segments(NE3.coef[16], int_5, NE3.coef[16], int_pt5, col = "green4", lty = 2, lwd = 1.5)
segments(NE3.coef[16], int_25, NE3.coef[16], int_pt5, col = "darkorange3", lty = 2, lwd = 1.5)

int_pt6 <- (int_6 + int_26)/2
segments(NE3.constcoef[16], int_6, NE3.constcoef[16], int_pt6, col = "chartreuse2", lty = 3, lwd = 1.5)
segments(NE3.constcoef[16], int_26, NE3.constcoef[16], int_pt6, col = "darkgoldenrod2", lty = 3, lwd = 1.5)

int_pt7 <- (int_7 + int_15)/2
segments(NE3.varycoef[15], int_7, NE3.varycoef[15], int_pt7, col = "palevioletred2", lty = 3, lwd = 1.5)
segments(NE3.varycoef[15], int_15, NE3.varycoef[15], int_pt7, col = "darkgoldenrod2", lty = 3, lwd = 1.5)

int_pt8 <- (int_8 + int_16)/2
segments(NE3.varycoef[16], int_8, NE3.varycoef[16], int_pt8, col = "palevioletred2", lty = 3, lwd = 1.5)
segments(NE3.varycoef[16], int_16, NE3.varycoef[16], int_pt8, col = "darkgoldenrod2", lty = 3, lwd = 1.5)

int_pt9 <- (int_11 + int_19)/2
segments(NE3.coef[17], int_11, NE3.coef[17], int_pt9, col = "royalblue4", lty = 2, lwd = 1.5)
segments(NE3.coef[17], int_19, NE3.coef[17], int_pt9, col = "darkorange3", lty = 2, lwd = 1.5)

int_pt10 <- (int_12 + int_20)/2
segments(NE3.constcoef[17], int_12, NE3.constcoef[17], int_pt10, col = "royalblue2", lty = 3, lwd = 1.5)
segments(NE3.constcoef[17], int_20, NE3.constcoef[17], int_pt10, col = "darkgoldenrod2", lty = 3, lwd = 1.5)

int_pt11 <- (int_13 + int_21)/2
segments(NE3.coef[13], int_13, NE3.coef[13], int_pt11, col = "royalblue4", lty = 2, lwd = 1.5)
segments(NE3.coef[13], int_21, NE3.coef[13], int_pt11, col = "darkorange3", lty = 2, lwd = 1.5)

int_pt12 <- (int_14 + int_22)/2
segments(NE3.constcoef[13], int_14, NE3.constcoef[13], int_pt12, col = "royalblue2", lty = 3, lwd = 1.5)
segments(NE3.constcoef[13], int_22, NE3.constcoef[13], int_pt12, col = "darkgoldenrod2", lty = 3, lwd = 1.5)

int_pt13 <- (int_27 + int_29)/2
segments(NE3.coef[18], int_27, NE3.coef[18], int_pt13, col = "darkorange3", lty = 2, lwd = 1.5)
segments(NE3.coef[18], int_29, NE3.coef[18], int_pt13, col = "darkorange3", lty = 2, lwd = 1.5)

int_pt14 <- (int_28 + int_30)/2
segments(NE3.constcoef[18], int_28, NE3.constcoef[18], int_pt14, col = "darkgoldenrod2", lty = 3, lwd = 1.5)
segments(NE3.constcoef[18], int_30, NE3.constcoef[18], int_pt14, col = "darkgoldenrod2", lty = 3, lwd = 1.5)

int_pt15 <- (int_31 + int_33)/2
segments(NE3.coef[20], int_31, NE3.coef[20], int_pt15, col = "darkorange3", lty = 2, lwd = 1.5)
segments(NE3.coef[20], int_33, NE3.coef[20], int_pt15, col = "darkorange3", lty = 2, lwd = 1.5)

int_pt16 <- (int_32 + int_34)/2
segments(NE3.constcoef[20], int_32, NE3.constcoef[20], int_pt16, col = "darkgoldenrod2", lty = 3, lwd = 1.5)
segments(NE3.constcoef[20], int_34, NE3.constcoef[20], int_pt16, col = "darkgoldenrod2", lty = 3, lwd = 1.5)

int_pt17 <- (int_35 + int_41)/2
segments(NE3.coef[21], int_35, NE3.coef[21], int_pt17, col = "darkorange3", lty = 2, lwd = 1.5)
segments(NE3.coef[21], int_41, NE3.coef[21], int_pt17, col = "red3", lty = 2, lwd = 1.5)

int_pt18 <- (int_36 + int_42)/2
segments(NE3.constcoef[21], int_36, NE3.constcoef[21], int_pt18, col = "darkgoldenrod2", lty = 3, lwd = 1.5)
segments(NE3.constcoef[21], int_42, NE3.constcoef[21], int_pt18, col = "coral2", lty = 3, lwd = 1.5)

int_pt19 <- (int_37 + int_43)/2
segments(NE3.coef[22], int_37, NE3.coef[22], int_pt19, col = "darkorange3", lty = 2, lwd = 1.5)
segments(NE3.coef[22], int_43, NE3.coef[22], int_pt19, col = "red3", lty = 2, lwd = 1.5)

int_pt20 <- (int_38 + int_44)/2
segments(NE3.constcoef[22], int_38, NE3.constcoef[22], int_pt20, col = "darkgoldenrod2", lty = 3, lwd = 1.5)
segments(NE3.constcoef[22], int_44, NE3.constcoef[22], int_pt20, col = "coral2", lty = 3, lwd = 1.5)

int_pt21 <- (int_39 + int_45)/2
segments(NE3.coef[19], int_39, NE3.coef[19], int_pt21, col = "darkorange3", lty = 2, lwd = 1.5)
segments(NE3.coef[19], int_45, NE3.coef[19], int_pt21, col = "turquoise4", lty = 2, lwd = 1.5)

int_pt22 <- (int_40 + int_46)/2
segments(NE3.constcoef[19], int_40, NE3.constcoef[19], int_pt22, col = "darkgoldenrod2", lty = 3, lwd = 1.5)
segments(NE3.constcoef[19], int_46, NE3.constcoef[19], int_pt22, col = "paleturquoise3", lty = 3, lwd = 1.5)

#square points
points(NE3.coef[12], int_17,  pch = 22, col = "grey4",
        bg =  alpha("darkorange3",.95), cex = 1.5,) 
points(NE3.constcoef[12], int_18,  pch = 22, col = "grey4",
        bg =  alpha("darkgoldenrod2",.95), cex = 1.5,) 

#interaction points
points(NE3.coef[14], int_pt1,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.constcoef[14], int_pt2,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.coef[15], int_pt3,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.constcoef[15], int_pt4,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.coef[16], int_pt5,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.constcoef[16], int_pt6,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.varycoef[15], int_pt7,  pch = 24, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.33,) 
points(NE3.varycoef[16], int_pt8,  pch = 24, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.33,) 
points(NE3.coef[17], int_pt9,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.constcoef[17], int_pt10,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.coef[13], int_pt11,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.constcoef[13], int_pt12,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.coef[18], int_pt13,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.constcoef[18], int_pt14,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.coef[20], int_pt15,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.constcoef[20], int_pt16,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.coef[21], int_pt17,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.constcoef[21], int_pt18,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.coef[22], int_pt19,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.constcoef[22], int_pt20,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.coef[19], int_pt21,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(NE3.constcoef[19], int_pt22,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 

#link to x 
links[[1]]$to_x <- grconvertX(NE3.coef[14], from = "user", to = "ndc")
links[[2]]$to_x <- grconvertX(NE3.constcoef[14], from = "user", to = "ndc")
links[[3]]$to_x <- grconvertX(NE3.coef[15], from = "user", to = "ndc")
links[[4]]$to_x <- grconvertX(NE3.constcoef[15], from = "user", to = "ndc")
links[[5]]$to_x <- grconvertX(NE3.coef[16], from = "user", to = "ndc")
links[[6]]$to_x <- grconvertX(NE3.constcoef[16], from = "user", to = "ndc")
links[[7]]$to_x <- grconvertX(NE3.varycoef[15], from = "user", to = "ndc")
links[[8]]$to_x <- grconvertX(NE3.varycoef[16], from = "user", to = "ndc")
links[[9]]$to_x <- grconvertX(NE3.coef[14], from = "user", to = "ndc")
links[[10]]$to_x <- grconvertX(NE3.constcoef[14], from = "user", to = "ndc")
links[[11]]$to_x <- grconvertX(NE3.coef[17], from = "user", to = "ndc")
links[[12]]$to_x <- grconvertX(NE3.constcoef[17], from = "user", to = "ndc")
links[[13]]$to_x <- grconvertX(NE3.coef[13], from = "user", to = "ndc")
links[[14]]$to_x <- grconvertX(NE3.constcoef[13], from = "user", to = "ndc")
links[[15]]$to_x <- grconvertX(NE3.varycoef[15], from = "user", to = "ndc")
links[[16]]$to_x <- grconvertX(NE3.varycoef[16], from = "user", to = "ndc")
links[[17]]$to_x <- grconvertX(NE3.coef[12], from = "user", to = "ndc")
links[[18]]$to_x <- grconvertX(NE3.constcoef[12], from = "user", to = "ndc")
links[[19]]$to_x <- grconvertX(NE3.coef[17], from = "user", to = "ndc")
links[[20]]$to_x <- grconvertX(NE3.constcoef[17], from = "user", to = "ndc")
links[[21]]$to_x <- grconvertX(NE3.coef[13], from = "user", to = "ndc")
links[[22]]$to_x <- grconvertX(NE3.constcoef[13], from = "user", to = "ndc")
links[[23]]$to_x <- grconvertX(NE3.coef[15], from = "user", to = "ndc")
links[[24]]$to_x <- grconvertX(NE3.constcoef[15], from = "user", to = "ndc")
links[[25]]$to_x <- grconvertX(NE3.coef[16], from = "user", to = "ndc")
links[[26]]$to_x <- grconvertX(NE3.constcoef[16], from = "user", to = "ndc")
links[[27]]$to_x <- grconvertX(NE3.coef[18], from = "user", to = "ndc")
links[[28]]$to_x <- grconvertX(NE3.constcoef[18], from = "user", to = "ndc")
links[[29]]$to_x <- grconvertX(NE3.coef[18], from = "user", to = "ndc")
links[[30]]$to_x <- grconvertX(NE3.constcoef[18], from = "user", to = "ndc")
links[[31]]$to_x <- grconvertX(NE3.coef[20], from = "user", to = "ndc")
links[[32]]$to_x <- grconvertX(NE3.constcoef[20], from = "user", to = "ndc")
links[[33]]$to_x <- grconvertX(NE3.coef[20], from = "user", to = "ndc")
links[[34]]$to_x <- grconvertX(NE3.constcoef[20], from = "user", to = "ndc")
links[[35]]$to_x <- grconvertX(NE3.coef[21], from = "user", to = "ndc")
links[[36]]$to_x <- grconvertX(NE3.constcoef[21], from = "user", to = "ndc")
links[[37]]$to_x <- grconvertX(NE3.coef[22], from = "user", to = "ndc")
links[[38]]$to_x <- grconvertX(NE3.constcoef[22], from = "user", to = "ndc")
links[[39]]$to_x <- grconvertX(NE3.coef[19], from = "user", to = "ndc")
links[[40]]$to_x <- grconvertX(NE3.constcoef[19], from = "user", to = "ndc")
links[[41]]$to_x <- grconvertX(NE3.coef[21], from = "user", to = "ndc")
links[[42]]$to_x <- grconvertX(NE3.constcoef[21], from = "user", to = "ndc")
links[[43]]$to_x <- grconvertX(NE3.coef[22], from = "user", to = "ndc")
links[[44]]$to_x <- grconvertX(NE3.constcoef[22], from = "user", to = "ndc")
links[[45]]$to_x <- grconvertX(NE3.coef[19], from = "user", to = "ndc")
links[[46]]$to_x <- grconvertX(NE3.constcoef[19], from = "user", to = "ndc")

for (i in 1:length(links)) {
  links[[i]]$to_y <- links[[i]]$from_y  # same y to keep it horizontal
}

# --- Draw horizontal linking lines ---
par(xpd = NA)  # allow drawing outside plot regions
colors <- c(rep(c("green4", "chartreuse2"), 3),  "palevioletred2", "palevioletred2",
            rep(c("royalblue4", "royalblue2"), 3),  "darkgoldenrod3", "darkgoldenrod3",
            rep(c("darkorange3", "darkgoldenrod3"), 12), 
            rep(c("red3", "coral2"), 2),  "turquoise4",  "paleturquoise3")
linetypes <- c(rep(c(2,3), 3), 3, 3, rep(c(2,3), 3), 3 ,3,  rep(c(2,3), 15))

for (i in 1:length(links)) {
  grid.lines(
    x = unit(c(links[[i]]$from_x, links[[i]]$to_x), "npc"),
    y = unit(c(links[[i]]$from_y, links[[i]]$to_y), "npc"),
    gp = gpar(col = colors[i], lwd = 1, lty = linetypes[i])
  )
}


#outer text and legends
par(xpd = NA)
legend("topright", inset = c(-0.45, 0.00),
       title = "Nino",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("green4",  "chartreuse2", "chartreuse2"),
       pt.cex = c(1.5, 1.5, 1.33))
legend("topright", inset = c(-0.45, 0.2),
       title = "WTIO",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("magenta4",  "palevioletred2", "palevioletred2"),
       pt.cex = c(1.5, 1.5, 1.33))
legend("topright", inset = c(-0.45, 0.3),
       title = "ETIO",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("royalblue4",  "royalblue2", "royalblue2"),
       pt.cex = c(1.5, 1.5, 1.33))

legend("right", inset = c(-0.45, 0.00),
       title = "TSA",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4","grey4", "grey4"),
       pt.bg = c("darkorange3",  "darkgoldenrod2",  "darkgoldenrod2"),
       pt.cex = c(1.5, 1.5, 1.33))

legend("bottomright", inset = c(-0.45, 0.26),
       title = "SAM (AAO)",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4","grey4","grey4"),
       pt.bg = c("red3",  "coral2",  "coral2"),
       pt.cex = c(1.5, 1.5, 1.33))

legend("bottomright", inset = c(-0.45, 0.05),
       title = "OLR",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("turquoise4",  "paleturquoise3", "paleturquoise3"),
       pt.cex = c(1.5, 1.5, 1.33))

mtext("NE Aus Group 3 (Weeks 52, 1-14)", outer = TRUE, cex = 1.5, font = 1)

dev.off()


```


### SE AUS Models

```{r SEAUS2_dearLORD}
#SE2.coef
#SE2.constcoef
#SE2.varycoef


setwd("~/CO_AUS/Aus_CO-main/Interactions_New/Figures")

png(filename = "SE2_oct.png", width = 3000, height = 3200, res = 300)

#TODO: add in an extra row of plots if needed
layout(matrix(c(1, 6,
                2, 6,
                3, 6,
                4, 6,
                5, 6), ncol = 2, byrow = TRUE),
       widths = c(1.5, 1), heights = c(1, 1, 1, 1, 1))

par(oma = c(1, 1, 3, 9))

# Store links
links <- list()

# --- Data Set-up --- 
## Nino
SE2_ninolag <- c(40)
SE2_ninocoef <- SE2.coef[2]
SE22_ninolag <- c(40)
SE22_ninocoef <- SE2.constcoef[2]
SE23_ninolag <- c(28)
SE23_ninocoef <- SE2.varycoef[2]

## WTIO
SE2_wtiolag <- c(14,46)
SE2_wtiocoef <- SE2.coef[c(3:4)]
SE22_wtiolag <- c(14,46)
SE22_wtiocoef <- SE2.constcoef[c(3:4)]
SE23_wtiolag <- c(14, 15)
SE23_wtiocoef <- SE2.varycoef[c(3:4)]

## ETIO
SE2_etiolag <- c(7, 33)
SE2_etiocoef <- SE2.coef[c(5,6)]
SE22_etiolag <- c(7, 33)
SE22_etiocoef <- SE2.constcoef[c(5,6)]
SE23_etiolag  <- c(8)
SE23_etiocoef <- SE2.varycoef[5]

## TSA
SE23_tsalag <- c(28)
SE23_tsacoef <- SE2.varycoef[6]

## AAO
SE23_aaolag <- c(21, 42, 50)
SE23_aaocoef <- SE2.varycoef[c(7:9)]

## OLR
SE2_olrlag <- c(10, 32, 40)
SE2_olrcoef <- SE2.coef[c(7:9)]
SE22_olrlag <- c(10, 32, 40)
SE22_olrcoef <- SE2.constcoef[c(7:9)]
SE23_olrlag <- c(33)
SE23_olrcoef <- SE2.varycoef[10]


# --- Range ---
SEAus2_absmax <- max(abs(range(SE2.coef,
                      SE2.constcoef,
                      SE2.varycoef)))
SEAus2_range <- c(-SEAus2_absmax, SEAus2_absmax)

# --- Plot 1: Nino ---
par(mar = c(4, 4, 2, 1))

plot(SE2_ninolag, SE2_ninocoef, pch = 22, 
     col = "grey4", bg =  alpha("green4",.95), cex = 1.5,
     xlim = c(1,52), 
     ylim = SEAus2_range,
     xlab = "", ylab = "")
points(SE22_ninolag, SE22_ninocoef, pch = 22, col = "black",
       bg =  alpha("chartreuse2",.65) , cex = 1.5)
points(SE23_ninolag, SE23_ninocoef, pch = 24, col = "black",
       bg =  alpha("chartreuse2",.65) , cex = 1.33)
abline(h = 0, lty = 2)
title("Nino", adj = 0)

## --- Nino Interaction
## nino_lag40:etio_lag7
## base
links[[1]] <- list(
  y_val = SE2_ninocoef[1],
  from_x = grconvertX(SE2_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE2_ninocoef[1], from = "user", to = "ndc")
)

## constant
links[[2]] <- list(
  y_val = SE22_ninocoef[1],
  from_x = grconvertX(SE22_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE22_ninocoef[1], from = "user", to = "ndc")
)

# --- Plot 2: WTIO & ETIO ---
par(mar = c(4, 4, 2, 1))

plot(SE2_wtiolag-0.125, SE2_wtiocoef, pch = 22, col = "black",
     bg =  alpha("magenta4",.95) , cex = 1.5, 
     xlim = c(1,52), 
     ylim = SEAus2_range,
     xlab = "", ylab = "")
points(SE22_wtiolag, SE22_wtiocoef, pch = 22, col = "black",
       bg =  alpha("palevioletred2",.65) , cex = 1.5)
points(SE23_wtiolag+0.125, SE23_wtiocoef, pch = 24, col = "black",
       bg =  alpha("palevioletred2",.65) , cex = 1.33)
points(SE2_etiolag, SE2_etiocoef, pch = 22, 
      col = "grey4", bg =  alpha("royalblue4",.95), cex = 1.5)
points(SE22_etiolag, SE22_etiocoef, pch = 22, col = "black",
       bg =  alpha("royalblue2",.65) , cex = 1.5)
points(SE23_etiolag, SE23_etiocoef, pch = 24, col = "black",
       bg =  alpha("royalblue2",.65) , cex = 1.33)
abline(h = 0, lty = 2)
title("WTIO & ETIO", adj = 0)

## --- WTIO Interaction
## I(wtio_lag14^2) (varying terms)
## varying
links[[3]] <- list(
  y_val = SE23_wtiocoef[1],
  from_x = grconvertX(SE23_wtiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE23_wtiocoef[1], from = "user", to = "ndc")
)


## --- ETIO Interaction
## nino_lag40:etio_lag7
## base
links[[4]] <- list(
  y_val = SE2_etiocoef[1],
  from_x = grconvertX(SE2_etiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE2_etiocoef[1], from = "user", to = "ndc")
)

## constant
links[[5]] <- list(
  y_val = SE22_etiocoef[1],
  from_x = grconvertX(SE22_etiolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(SE22_etiocoef[1], from = "user", to = "ndc")
)

# --- Plot 3: TSA ---
par(mar = c(4, 4, 2, 1))

plot(SE23_tsalag, SE23_tsacoef, pch = 24, col = "black",
       bg =  alpha("darkgoldenrod2",.65), xlim = c(1,52), cex = 1.33,
     ylim = SEAus2_range,
     xlab = "", ylab = "Coefficients", cex.lab = 1.33)
abline(h = 0, lty = 2)
title("TSA", adj = 0)


# --- Plot 4: SAM/AAO ---
par(mar = c(4, 4, 2, 1))

plot(SE23_aaolag, SE23_aaocoef, pch = 24,
     col = "grey4",
     bg =  alpha("coral2",.65) , cex = 1.33,
     xlim = c(1,52), 
     ylim = SEAus2_range,
     xlab = "", ylab = "")
abline(h = 0, lty = 2)
title("SAM (AAO)", adj = 0)

# --- Plot 5: OLR ---
par(mar = c(4, 4, 2, 1))

plot(SE2_olrlag+0.125, SE2_olrcoef, pch = 22, col = "black",
       bg =  alpha("turquoise4", 0.95), xlim = c(1,52), cex = 1.4,
     ylim = SEAus2_range,
     xlab = "Lag", ylab = "", cex.lab = 1.33)
points(SE22_olrlag-0.125, SE22_olrcoef, pch = 22, col = "black",
       bg =  alpha("paleturquoise3",.65) , cex = 1.5)
points(SE23_olrlag, SE23_olrcoef, pch = 24, col = "black",
       bg =  alpha("paleturquoise3",.65) , cex = 1.33)
abline(h = 0, lty = 2)
title("OLR", adj = 0)



# --- Plot 6: Interaction Effects ---
par(mar = c(4, 4, 2, 2))

plot(SE2.coef[1], 0, type = "n", main = "", 
     ylim = c(0,1), xlim = SEAus2_range,
     xlab = "Coefficients", cex.lab = 1.33,
     yaxt = "n",  ylab = "")
abline(v= 0, lty = 2)

#square terms
int_1 <- grconvertY(links[[3]]$from_y, from = "ndc", to = "user") # I(wtio_lag14^2) (varying terms)

#interactions
int_2 <- grconvertY(links[[1]]$from_y, from = "ndc", to = "user") # nino_lag40:etio_lag7 #base
int_3 <- grconvertY(links[[2]]$from_y, from = "ndc", to = "user") # nino_lag40:etio_lag7 
int_4 <- grconvertY(links[[4]]$from_y, from = "ndc", to = "user") # nino_lag40:etio_lag7 #base
int_5 <- grconvertY(links[[5]]$from_y, from = "ndc", to = "user") # nino_lag40:etio_lag7

#nino_lag40:etio_lag7
int_pt1 <- (int_2 + int_4)/2
segments(SE2.coef[10], int_2, SE2.coef[10], int_pt1, col = "green4", lty = 2, lwd = 1.5)
segments(SE2.coef[10], int_4, SE2.coef[10], int_pt1, col = "royalblue4", lty = 2, lwd = 1.5)

int_pt2 <- (int_3 + int_5)/2
segments(SE2.constcoef[10], int_3, SE2.constcoef[10], int_pt2, col = "chartreuse2", lty = 3, lwd = 1.5)
segments(SE2.constcoef[10], int_5, SE2.constcoef[10], int_pt2, col = "royalblue2", lty = 3, lwd = 1.5)

#interaction points
points(SE2.varycoef[11], int_1,  pch = 24, col = "grey4",
        bg =  alpha("palevioletred2",.65), cex = 1.33,) 
points(SE2.coef[10], int_pt1,  pch = 22, col = "grey4",
        bg =  alpha("gray",.95), cex = 1.5,) 
points(SE2.constcoef[10], int_pt2,  pch = 22, col = "grey4",
        bg =  alpha("gray",.65), cex = 1.5,) 

#link to x 
links[[1]]$to_x <- grconvertX(SE2.coef[10], from = "user", to = "ndc")
links[[2]]$to_x <- grconvertX(SE2.constcoef[10], from = "user", to = "ndc")
links[[3]]$to_x <- grconvertX(SE2.varycoef[11], from = "user", to = "ndc")
links[[4]]$to_x <- grconvertX(SE2.coef[10], from = "user", to = "ndc")
links[[5]]$to_x <- grconvertX(SE2.constcoef[10], from = "user", to = "ndc")

for (i in 1:length(links)) {
  links[[i]]$to_y <- links[[i]]$from_y  # same y to keep it horizontal
}

# --- Draw horizontal linking lines ---
par(xpd = NA)  # allow drawing outside plot regions
colors <- c("green4", "chartreuse2", "palevioletred3", "royalblue4", "royalblue2")
linetypes <- c(2,3,3,2,3)

for (i in 1:length(links)) {
  grid.lines(
    x = unit(c(links[[i]]$from_x, links[[i]]$to_x), "npc"),
    y = unit(c(links[[i]]$from_y, links[[i]]$to_y), "npc"),
    gp = gpar(col = colors[i], lwd = 1, lty = linetypes[i])
  )
}


#outer text and legends
par(xpd = NA)
legend("topright", inset = c(-0.45, 0.00),
       title = "Nino",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("green4",  "chartreuse2", "chartreuse2"),
       pt.cex = c(1.5, 1.5, 1.33))
legend("topright", inset = c(-0.45, 0.2),
       title = "WTIO",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("magenta4",  "palevioletred2", "palevioletred2"),
       pt.cex = c(1.5, 1.5, 1.33))
legend("topright", inset = c(-0.45, 0.3),
       title = "ETIO",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("royalblue4",  "royalblue2", "royalblue2"),
       pt.cex = c(1.5, 1.5, 1.33))

legend("right", inset = c(-0.45, 0.00),
       title = "TSA",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4","grey4", "grey4"),
       pt.bg = c("darkorange3",  "darkgoldenrod2",  "darkgoldenrod2"),
       pt.cex = c(1.5, 1.5, 1.33))

legend("bottomright", inset = c(-0.45, 0.26),
       title = "SAM (AAO)",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4","grey4","grey4"),
       pt.bg = c("red3",  "coral2",  "coral2"),
       pt.cex = c(1.5, 1.5, 1.33))

legend("bottomright", inset = c(-0.45, 0.05),
       title = "OLR",
       legend = c("Base", "Constant", "Varying"),
       pch = c(22, 22, 24),
       col = c("grey4", "grey4", "grey4"),
       pt.bg = c("turquoise4",  "paleturquoise3", "paleturquoise3"),
       pt.cex = c(1.5, 1.5, 1.33))

mtext("SE Aus Group 2 (Weeks 51, 52, 1, & 2)", outer = TRUE, cex = 1.5, font = 1)

dev.off()


```



# Test Code

```{r}
lm.data.matrix <- as.data.frame(cbind(y_1, X_1))
names(lm.data.matrix)[1] <- "co"

test.lm <- lm(formula(model.ramp), lm.data.matrix)
summary(test.lm)




y_1 <- as.numeric(NEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))
#without OLR
#X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

negroup1 <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE1.terms <- terms_only(negroup1, X_1)


```

```{r woOLR_anovatest}
#check on OLR

#NE Aus 1
NE1.temp <- NE1.terms[-c(7, 9)]
NE1.model.string <- paste0("co ~ ", paste(NE1.temp, collapse = " + "))
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])
#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))
lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm.refit <- lm(formula(NE1.model.string), lm.data_1)
#summary(NE1.lm.refit)

anova(NE1.lm.refit, NE1.lm)
anova(NE1.lm.noOLR, NE1.lm )

#NE Aus 2
NE2.temp <- NE2.terms[-c(9, 10)]


NE3.terms[-c(8, 10, 17)]

SE1.terms[-c(12:15)]
SE2.terms[-c(6:8)]
SE3.terms[-c(8:12)]
```

