---
title: "refit_cv"
author: "Ryan Peterson"
date: "2025-09-25"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r library}
suppressMessages( library(hierNet)) #yes
suppressMessages( library(glmnet)) #test ridge regression for coefs
suppressMessages( library(RAMP)) #maybe
suppressMessages( library(MASS)) #for lm.ridge

suppressMessages( library(foreach)) #parallelization setup
suppressMessages( library(parallel))
suppressMessages( library(doParallel))

suppressMessages( library( lubridate)) #you know why
suppressMessages( library( colorspace)) #for some color alternatives
suppressMessages( library( fields)) #for set.panel() and others 
suppressMessages( library(ggpubr)) #nice tables for dfs (uses ggplot)

suppressMessages( library( caret)) #for confusion matrix

suppressMessages( library( tictoc)) #some timing
```

```{r data_load}
#and functions
# Data Set-Up
setwd("~/CO_AUS/Aus_CO-main/Interactions")

load( "Data/ne_data.rda")
load( "Data/se_data.rda")
load( "Data/bounded_data.rda")
load( "Data/data_matrix.rda")
load( "Data/lag_list.rda")
load( "Data/data_quantile.rda")

#functions:
setwd("~/CO_AUS/Aus_CO-main/Interactions")
#source("group_functions.R") #grouping/clustering
source("group_functionsNew.R") #new groupings
source("refit_functions.R") #coef/refit functions

setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
load("IOD_lag.rda")
```

# Data Setup

```{r data_setup_new}
#season years/weeks
season_weeks <- c(35:52, 1:14)
season_years <- unique(bounded_resp_df$year)

seasons <- c()
for (i in 1:(length(season_years)-1)) {
  temp_season <- paste0(season_years[i], "-", season_years[i+1])
  #print(temp_season)  
  seasons <- c(seasons, temp_season)
}
rm(i, temp_season)

#center response data
NEbase_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEbase_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)

#Below includes removal of weeks 35-37 (adjust grouping functions if we need to change this.)
#NEAus
NEAus_1 <- NEbase_matrix[ ,4:12] 
NEAus_2 <- NEbase_matrix[ ,13:17]
NEAus_3 <- NEbase_matrix[ ,18:32]

#NEAus
SEAus_1 <- SEbase_matrix[ ,4:16] 
SEAus_2 <- SEbase_matrix[ ,17:20] 
SEAus_3 <- SEbase_matrix[ ,21:32]

NEAus_mat <- list(NEAus_1, NEAus_2, NEAus_3)
SEAus_mat <- list(SEAus_1, SEAus_2, SEAus_3)

rm(NEAus_1, NEAus_2, NEAus_3, SEAus_1, SEAus_2, SEAus_3)

#full model
NEpreds_new <- NElag_3group(NE_laglist = NE_iodlag, j = 1:19)
NEresp_new <- NEresp_3group(NEAus_mat = NEAus_mat, j = 1:19)

SEpreds_new <- SElag_3group(SE_laglist = SE_iodlag, j = 1:19)
SEresp_new <- SEresp_3group(SEAus_mat = SEAus_mat, j = 1:19)

#partial model
NEpreds_newpart <- NElag_3group(NE_laglist = NE_iodlag, j = -c(19))
NEresp_newpart <- NEresp_3group(NEAus_mat = NEAus_mat, j = -c(19))

SEpreds_newpart <- SElag_3group(SE_laglist = SE_iodlag, j = -c(19))
SEresp_newpart <- SEresp_3group(SEAus_mat = SEAus_mat, j = -c(19))


```


```{r partial_LOO}
#leaving out a single year
NEpartial_preds <- list()
NEpartial_resp <- list()
SEpartial_preds <- list()
SEpartial_resp <- list()
for (j in 1:length(seasons)) {
  #NE Aus
  NEpartial_preds[[seasons[j]]] <- NElag_3group(NE_laglist = NE_iodlag, j = -c(j))
  NEpartial_resp[[seasons[j]]] <- NEresp_3group(NEAus_mat = NEAus_mat, j = -c(j))
  
  #SE Aus
  SEpartial_preds[[seasons[j]]] <- SElag_3group(SE_laglist = SE_iodlag, j = -c(j))
  SEpartial_resp[[seasons[j]]] <- SEresp_3group(SEAus_mat = SEAus_mat, j = -c(j))
}

#extracting a single year (validation data)
NEvalid_preds <- list()
NEvalid_resp <- list()
SEvalid_preds <- list()
SEvalid_resp <- list()
for (k in 1:length(seasons)) {
  #NE Aus
  NEvalid_preds[[seasons[k]]] <- NElag_3group(NE_laglist = NE_iodlag, j = c(k))
  NEvalid_resp[[seasons[k]]] <- NEresp_3group(NEAus_mat = NEAus_mat, j = c(k))
  
  #SE Aus
  SEvalid_preds[[seasons[k]]] <- SElag_3group(SE_laglist = SE_iodlag, j = c(k))
  SEvalid_resp[[seasons[k]]] <- SEresp_3group(SEAus_mat = SEAus_mat, j = c(k))
}

```


# Functions (RAMP)

```{r refit_functions}
refit_ramp <- function(test.ramp, X_1){
  
  main.terms <- test.ramp$mainInd
  main.terms <- colnames(X_1)[main.terms]
  
  interactions <- test.ramp$interInd
      if (!is.null(interactions)){
        for (i in 1:length(interactions)){
          
          this.term <- interactions[i]
          these.subterms <- as.integer(strsplit(this.term, "X")[[1]][2:3])
          these.subterms <- colnames(X_1)[these.subterms]
          
          if (these.subterms[1] != these.subterms[2]){
            this.term <- paste(these.subterms, collapse = ":")
          } else {
            this.term <- paste0("I(", these.subterms[1], "^2)")
          }
          
          interactions[i] <- this.term
        }
      }
  
  #refit with lm
  if (!is.null(interactions)){
    model.string <- paste( paste(main.terms, collapse = " + "),
                           paste(interactions, collapse = " + "),
                           sep = " + ")
  } else {
    model.string <- paste(main.terms, collapse = " + ")
  }
  
  model.string <- paste0("co ~ ", model.string)
  
  return(model.string)
}



terms_only <- function(test.ramp, X_1){
  main.terms <- test.ramp$mainInd
  main.terms <- colnames(X_1)[main.terms]
  
  interactions <- test.ramp$interInd
      if (!is.null(interactions)){
        for (i in 1:length(interactions)){
          
          this.term <- interactions[i]
          these.subterms <- as.integer(strsplit(this.term, "X")[[1]][2:3])
          these.subterms <- colnames(X_1)[these.subterms]
          
          if (these.subterms[1] != these.subterms[2]){
            this.term <- paste(these.subterms, collapse = ":")
          } else {
            this.term <- paste0("I(", these.subterms[1], "^2)")
          }
          
          interactions[i] <- this.term
        }
      }
  return(c(main.terms, interactions))
}

```



# Refit Terms

```{r NEAus_base}
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))
#without OLR
#X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

negroup1 <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE1.terms <- terms_only(negroup1, X_1)
NE1.refit <- refit_ramp(negroup1, X_1)

#NE Aus Group 2
y_2 <- as.numeric(NEresp_new[[2]])

#with OLR
X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:312]))
#without OLR
#X_2 <- cbind(as.matrix(NEpreds_new[[2]][ ,1:260]))

negroup2 <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE2.terms <- terms_only(negroup2, X_2)
NE2.refit <- refit_ramp(negroup2, X_2) 
                        
#NE Aus Group 3
y_3 <- as.numeric(NEresp_new[[3]])

#with OLR
X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:312]))
#without OLR
#X_3 <- cbind(as.matrix(NEpreds_new[[3]][ ,1:260]))

negroup3 <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE3.terms <- terms_only(negroup3, X_3)                      
NE3.refit <- refit_ramp(negroup3, X_3)  

NEmodels <- list(negroup1, negroup2, negroup3)

              
```

```{r SEAus_base}
#SE Aus Group 1
y_1 <- as.numeric(SEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:312]))
#without OLR
#X_1 <- cbind(as.matrix(SEpreds_new[[1]][ ,1:260]))

segroup1 <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE1.terms <- terms_only(segroup1, X_1)
SE1.refit <- refit_ramp(segroup1, X_1)

#SE Aus Group 2
y_2 <- as.numeric(SEresp_new[[2]])

#with OLR
X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:312]))
#without OLR
#X_2 <- cbind(as.matrix(SEpreds_new[[2]][ ,1:260]))

segroup2 <- RAMP(X = X_2, y = y_2,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE2.terms <- terms_only(segroup2, X_2)
SE2.refit <- refit_ramp(segroup2, X_2)

#SE Aus Group 3
y_3 <- as.numeric(SEresp_new[[3]])

#with OLR
X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:312]))
#without OLR
#X_3 <- cbind(as.matrix(SEpreds_new[[3]][ ,1:260]))

segroup3 <- RAMP(X = X_3, y = y_3,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
SE3.terms <- terms_only(segroup3, X_3)
SE3.refit <- refit_ramp(segroup3, X_3)

SEmodels <- list(segroup1, segroup2, segroup3)

```

## Refit - Base w/o OLR

```{r NEAus_noOLR}
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])

#without OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

negroup1.noOLR <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE1.terms.noOLR <- terms_only(negroup1.noOLR, X_1)
NE1.refit.noOLR <- refit_ramp(negroup1.noOLR, X_1)


```



## Refit - LOO

```{r NEAus_refit}

#NE Aus 
NE.term.list <- NULL
NE.model.list <- NULL
NE.refit.list <- NULL #refit with base model
for (j in 1:length(seasons)) {
  temp.resp <- NEpartial_resp[[j]]
  temp.preds <- NEpartial_preds[[j]]
  
  temp.list <- NULL
  temp.model <- NULL
  temp.refit <- NULL
  for (k in 1:length(temp.preds)) {
    temp.y <- as.numeric(temp.resp[[k]])
    #with OLR
    temp.X <- cbind(as.matrix(temp.preds[[k]][ ,1:312]))
    
    temp.fit <- RAMP(X = temp.X, y = temp.y,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)
    #terms only
    temp.list[[k]] <- terms_only(temp.fit, temp.X)
    temp.model[[k]] <- refit_ramp(temp.fit, temp.X)
    temp.refit[[k]] <- refit_ramp(NEmodels[[k]], temp.X)
  }
  NE.term.list[[seasons[j]]] <- temp.list
  NE.model.list[[seasons[j]]] <- temp.model
  NE.refit.list[[seasons[j]]] <- temp.refit
}

```

```{r sEAus_refit}

#sE Aus 
SE.term.list <- NULL
SE.model.list <- NULL
SE.refit.list <- NULL #refit with base model
for (j in 1:length(seasons)) {
  temp.resp <- SEpartial_resp[[j]]
  temp.preds <- SEpartial_preds[[j]]
  
  temp.list <- NULL
  temp.model <- NULL
  temp.refit <- NULL
  for (k in 1:length(temp.preds)) {
    temp.y <- as.numeric(temp.resp[[k]])
    #with OLR
    temp.X <- cbind(as.matrix(temp.preds[[k]][ ,1:312]))
    
    temp.fit <- RAMP(X = temp.X, y = temp.y,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)
    #terms only
    temp.list[[k]] <- terms_only(temp.fit, temp.X)
    temp.model[[k]] <- refit_ramp(temp.fit, temp.X)
    temp.refit[[k]] <- refit_ramp(SEmodels[[k]], temp.X)
  }
  SE.term.list[[seasons[j]]] <- temp.list
  SE.model.list[[seasons[j]]] <- temp.model
  SE.refit.list[[seasons[j]]] <- temp.refit
}

```

```{r save}
setwd("~/CO_AUS/Aus_CO-main/Interactions_New")
save(SE.term.list, SE.model.list, SE.refit.list, 
     NE.term.list, NE.model.list, NE.refit.list, file = "model_refits.rda")
```


## Comparison to Base

```{r NeAus_compare}
#NE Aus Group 1

#get frequency of each term 
baseNE1 <- NE1.terms
#refitNE1 <- NE.term.list[[2]][[1]]

refitNE1 <- unlist(lapply(NE.term.list, function(x) x[[1]]))
sapply(baseNE1, function(x) sum(x == refitNE1))
#unique(refitNE1)
NErefit1.unique <- table(refitNE1)
NErefit1.unique <- NErefit1.unique[!names(NErefit1.unique) %in% baseNE1]
sort(NErefit1.unique, decreasing = TRUE)


#group 2
baseNE2 <- NE2.terms
#refitNE2 <- NE.term.list[[2]][[2]]

refitNE2 <- unlist(lapply(NE.term.list, function(x) x[[2]]))
sapply(baseNE2, function(x) sum(x == refitNE2))
#unique(refitNE2)
NErefit2.unique <- table(refitNE2)
NErefit2.unique <- NErefit2.unique[!names(NErefit2.unique) %in% baseNE2]
sort(NErefit2.unique, decreasing = TRUE)


#group 3
baseNE3 <- NE3.terms
#refitNE3 <- NE.term.list[[2]][[3]]

refitNE3 <- unlist(lapply(NE.term.list, function(x) x[[3]]))
sapply(baseNE3, function(x) sum(x == refitNE3))
#unique(refitNE3)
NErefit3.unique <- table(refitNE3)
NErefit3.unique <- NErefit3.unique[!names(NErefit3.unique) %in% baseNE3]
sort(NErefit3.unique, decreasing = TRUE)

```

```{r seAus_compare}
#sE Aus Group 1

#get frequency of each term 
baseSE1 <- SE1.terms
#refitSE1 <- SE.term.list[[2]][[1]]

refitSE1 <- unlist(lapply(SE.term.list, function(x) x[[1]]))
sapply(baseSE1, function(x) sum(x == refitSE1))
#unique(refitSE1)
SErefit1.unique <- table(refitSE1)
SErefit1.unique <- SErefit1.unique[!names(SErefit1.unique) %in% baseSE1]
sort(SErefit1.unique, decreasing = TRUE)


#group 2
baseSE2 <- SE2.terms
#refitSE2 <- SE.term.list[[2]][[2]]

refitSE2 <- unlist(lapply(SE.term.list, function(x) x[[2]]))
sapply(baseSE2, function(x) sum(x == refitSE2))
#unique(refitSE2)
SErefit2.unique <- table(refitSE2)
SErefit2.unique <- SErefit2.unique[!names(SErefit2.unique) %in% baseSE2]
sort(SErefit2.unique, decreasing = TRUE)

#group 3
baseSE3 <- SE3.terms
#refitSE3 <- SE.term.list[[2]][[3]]

refitSE3 <- unlist(lapply(SE.term.list, function(x) x[[3]]))
sapply(baseSE3, function(x) sum(x == refitSE3))
#unique(refitSE3)
SErefit3.unique <- table(refitSE3)
SErefit3.unique <- SErefit3.unique[!names(SErefit3.unique) %in% baseSE3]
sort(SErefit3.unique, decreasing = TRUE)

```


# Model Validation

RMSE, ....

```{r test_model_fits}
#NE Aus Group 1
y_1 <- as.numeric(NEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))


lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm <- lm(formula(NE1.refit), lm.data_1)
summary(NE1.lm)

NEvalid_preds[[1]][[1]]
y.true <- NEvalid_resp[[1]][[1]]

y.pred <- predict(NE1.lm, NEvalid_preds[[1]][[1]])

y.true
y.true - y.pred

#without OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

lm.data_1 <- as.data.frame(cbind(y_1, X_1))
names(lm.data_1)[1] <- "co"

NE1.lm.noOLR <- lm(formula(NE1.refit.noOLR), lm.data_1)
summary(NE1.lm.noOLR)

test.X <- NEvalid_preds[[1]][[1]][ ,1:260]
y.pred.noOLR <- predict(NE1.lm.noOLR, test.X)

y.true - y.pred.noOLR
```




```{r loo_fits}


for (i in 1:length(seasons)) {
  fit.resp <- NEpartial_resp[[i]]
  fit.preds <- NEpartial_preds[[i]]
  
  valid.resp <- NEvalid_resp[[i]]
  valid.preds <- NEvalid_preds[[i]]
  
}
```


```{r }
predict()
```



# Figures


## Constant Structure


# Test Code

```{r}
lm.data.matrix <- as.data.frame(cbind(y_1, X_1))
names(lm.data.matrix)[1] <- "co"

test.lm <- lm(formula(model.ramp), lm.data.matrix)
summary(test.lm)




y_1 <- as.numeric(NEresp_new[[1]])

#with OLR
X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:312]))
#without OLR
#X_1 <- cbind(as.matrix(NEpreds_new[[1]][ ,1:260]))

negroup1 <- RAMP(X = X_1, y = y_1,
                             penalty = "LASSO",
                             tune = "BIC",
                             n.lambda = 500)

#terms only
NE1.terms <- terms_only(negroup1, X_1)


```


