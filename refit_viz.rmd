---
title: "refit_viz"
author: "Ryan Peterson"
date: "2025-04-07"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
suppressMessages( library(hierNet)) #yes

suppressMessages( library(RAMP)) #maybe
suppressMessages(library(glmnet)) #test ridge regression for coefs

suppressMessages( library( lubridate)) #you know why

library(grid)
```


```{r data_functions}
load( "Data/ne_data.rda")
load( "Data/se_data.rda")
load( "Data/bounded_data.rda")
load( "Data/data_matrix.rda")
load( "Data/lag_list.rda")
load( "Data/data_quantile.rda")

#functions:
source("group_functions.R") #grouping/clustering

#fit models
load( "hiernet1_group.rda") #weak/4group

load( "SEAus_hiernet_temp2.rda") #strong/se/4group
load( "SEAus_hiernet_temp.rda") #strong/se/4group
load( "NEAus_hiernet_strong.rda") #strong/ne/4group

load( "full_strong.rda") #full strong models #output models

```


```{r setup}
#set up 

#season years/weeks
season_weeks <- c(35:52, 1:14)
season_years <- unique(bounded_resp_df$year)

seasons <- c()
for (i in 1:(length(season_years)-1)) {
  temp_season <- paste0(season_years[i], "-", season_years[i+1])
  #print(temp_season)  
  seasons <- c(seasons, temp_season)
}
rm(i, temp_season)

#center response data
NEbase_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEbase_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)

#group response matrices
#NEAus
NEAus_1 <- NEbase_matrix[ ,1:12] #early season
NEAus_2 <- NEbase_matrix[ ,13:17] #primary NE fire season
NEAus_3 <- NEbase_matrix[ ,18:21] #feedback from SE
NEAus_4 <- NEbase_matrix[ ,22:32] #late season

#SEAus
SEAus_1 <- SEbase_matrix[ ,1:7] #early season
SEAus_2 <- SEbase_matrix[ ,8:16] #feedback from NE
SEAus_3 <- SEbase_matrix[ ,17:20] #primary SE fire season
SEAus_4 <- SEbase_matrix[ ,21:32] #late season

NEAus_mat <- list(NEAus_1, NEAus_2, NEAus_3, NEAus_4)
SEAus_mat <- list(SEAus_1, SEAus_2, SEAus_3, SEAus_4)

rm(NEAus_1, NEAus_2, NEAus_3, NEAus_4, SEAus_1, SEAus_2, SEAus_3, SEAus_4)
```


```{r model_data}
#full model
NE_preds <- NElag_grouping(NE_laglist = NE_laglist_std, j = 1:19)
NE_resp <- NEresp_grouping(NEAus_mat = NEAus_mat, j = 1:19)

SE_preds <- SElag_grouping(SE_laglist = SE_laglist_std, j = 1:19)
SE_resp <- SEresp_grouping(SEAus_mat = SEAus_mat, j = 1:19)

#quantile 75 indicator
NE_preds_q75 <- NElag_grouping(NE_laglist = NE_laglist_q75, j = 1:19)
SE_preds_q75 <- SElag_grouping(SE_laglist = SE_laglist_q75, j = 1:19)

full_resp <- c(NE_resp, SE_resp)
full_preds <- c(NE_preds, SE_preds)
full_preds_q75 <- c(NE_preds_q75, SE_preds_q75)
```


# NE Aus - Refits

## Group 1

```{r refits}
NEAus1 <- output[[1]]

#NEpath_new$Group_1
  
NEcoefs1 <- get_coefs(NEAus1$hierpath, max_index = 50, 
                      resp = NE_resp[[1]], preds = NE_preds[[1]], preds_quant = NE_preds_q75[[1]])
plot(NEAus1$hiercv)
#plot(NEcv_new$Group_1)

NEcv1 <- NEAus1$hiercv
which(NEcv1$lamlist == NEcv1$lamhat.1se)
which(NEcv1$lamlist == NEcv1$lamhat)
NEcv1$lamhat.1se
1-NEcv1$cv.err/var( NE_resp[[1]])

length(NEcoefs1[[9]][[1]]$Main_Effect)
length(NEcoefs1[[9]][[2]]$Interact_Effect)

NErefit1 <- refit_bic(NEAus1$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = TRUE,
                      resp = NE_resp[[1]], preds = NE_preds[[1]], preds_quant = NE_preds_q75[[1]])
NErefit1[[5]]

#use either 9 or 12 (ebic: 0.15 for 9, 0.25 for 12)
i <- 9
ridge_coef <- NErefit1[[4]][[i]][-1]
NEridge_1 <- ridge_coef
ridge_coef
length(ridge_coef)

NEridge_cv <- NErefit1[[6]]
lm1se <- which( NEridge_cv[[i]]$lambda == NEridge_cv[[i]]$lambda.1se)
lmhat <- which( NEridge_cv[[i]]$lambda == NEridge_cv[[i]]$lambda.min)
NEr2 <- 1-NEridge_cv[[i]]$cvm/var( NE_resp[[1]])
NEr2[lm1se]
NEr2[lmhat]

sqrt(NEridge_cv[[i]]$cvm[lmhat])
NEAus1_r2 <- NEr2[lmhat]


#fit model
lm_coef <- coef(NErefit1[[1]][[i]])[-1]
```

```{r temp_coeftest}
#NEridge_1min <- NEridge_1
nino_coefs <- NEridge_1[c(1:6, 29:32)]
nino_coefsmin <- NEridge_1min[c(1:6, 29:32)]
nino_coeflasso <- c(NEcoefs1[[9]][[1]][c(1:6, 29:31),2], NEcoefs1[[9]][[2]][4,2])

coef_lim <- range(nino_coefs, nino_coefsmin, nino_coeflasso, lm_coef[c(1:6, 29:32)])

plot(1:length(nino_coefs), nino_coefs, pch =15, ylim = coef_lim)
points(1:length(nino_coefs), nino_coefsmin, pch =17, col = "magenta3")
points(1:length(nino_coefs), nino_coeflasso, pch =18, col = "green4")
points(1:length(nino_coefs), lm_coef[c(1:6, 29:32)], pch =16, col = "blue3")
```


## Group 2

```{r refits}
NEAus2 <- output[[2]]

#NEpath_new$Group_2 #(strong w/ indicator interactions)
  
NEcoefs2 <- get_coefs(NEAus2$hierpath, max_index = 50, 
                      resp = NE_resp[[2]], preds = NE_preds[[2]], preds_quant = NE_preds_q75[[2]])

plot(NEAus2$hiercv)

NEcv2 <- NEAus2$hiercv
which(NEcv2$lamlist == NEcv2$lamhat.1se)
which(NEcv2$lamlist == NEcv2$lamhat)
NEcv2$lamhat.1se
1-NEcv2$cv.err/var( NE_resp[[2]])

length(NEcoefs2[[14]][[1]]$Main_Effect)
length(NEcoefs2[[14]][[2]]$Interact_Effect)

NErefit2 <- refit_bic(NEAus2$hierpath, max_index = 50, ebic.gamma = 0.15, lambda.min = TRUE,
                      resp = NE_resp[[2]], preds = NE_preds[[2]], preds_quant = NE_preds_q75[[2]])
NErefit2[[5]]

# i = 14 seems to be optimal wrt BIC (15,16 ok)
i <- 14
ridge_coef <- NErefit2[[4]][[i]][-1]
NEridge_2 <- ridge_coef
ridge_coef

NEridge_cv <- NErefit2[[6]]
lm1se <- which( NEridge_cv[[i]]$lambda == NEridge_cv[[i]]$lambda.1se)
lmhat <- which( NEridge_cv[[i]]$lambda == NEridge_cv[[i]]$lambda.min)
NEr2 <- 1-NEridge_cv[[i]]$cvm/var( NE_resp[[2]])
NEr2[lm1se]
NEr2[lmhat]

length(ridge_coef)

```

## Group 3

```{r refits}
NEAus3 <- output[[3]]

#NEpath_new$Group_3 #(strong w/ indicator interactions)
  
NEcoefs3 <- get_coefs(NEAus3$hierpath, max_index = 50, 
                      resp = NE_resp[[3]], preds = NE_preds[[3]], preds_quant = NE_preds_q75[[3]])

plot(NEAus3$hiercv)

NEcv3 <- NEAus3$hiercv
which(NEcv3$lamlist == NEcv3$lamhat.1se)
which(NEcv3$lamlist == NEcv3$lamhat)
NEcv3$lamhat.1se
1-NEcv3$cv.err/var( NE_resp[[3]])


NErefit3 <- refit_bic(NEAus3$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = TRUE,
                      resp = NE_resp[[3]], preds = NE_preds[[3]], preds_quant = NE_preds_q75[[3]])
NErefit3[[5]]

# ebic = 0.25: 12-14 work the same, ebic = 0.5: 5-7
i <- 14
ridge_coef <- NErefit3[[4]][[i]][-1]
NEridge_3 <- ridge_coef
ridge_coef
length(ridge_coef)

NEridge_cv <- NErefit3[[6]]
lm1se <- which( NEridge_cv[[i]]$lambda == NEridge_cv[[i]]$lambda.1se)
lmhat <- which( NEridge_cv[[i]]$lambda == NEridge_cv[[i]]$lambda.min)
NEr2 <- 1-NEridge_cv[[i]]$cvm/var( NE_resp[[3]])
NEr2[lm1se]
NEr2[lmhat]

```

## Group 4

```{r refit}
NEAus4 <- output[[4]]

#NEpath_new$Group_4 #(strong w/ indicator interactions)
  
NEcoefs4 <- get_coefs(NEAus4$hierpath, max_index = 50, 
                      resp = NE_resp[[4]], preds = NE_preds[[4]], preds_quant = NE_preds_q75[[4]])

plot(NEAus4$hiercv)

NEcv4 <- NEAus4$hiercv
which(NEcv4$lamlist == NEcv4$lamhat.1se)
which(NEcv4$lamlist == NEcv4$lamhat)
NEcv4$lamhat.1se
1-NEcv4$cv.err/var( NE_resp[[4]])


NErefit4 <- refit_bic(NEAus4$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = TRUE,
                      resp = NE_resp[[4]], preds = NE_preds[[4]], preds_quant = NE_preds_q75[[4]])
NErefit4[[5]]

#plot(1:26, NErefit4[[5]][1:26,3], pch = 16)


#from bic, 5,6,14 seem good (maybe 17, use this one since BIC 17 < BIC 14)
i <- 17
ridge_coef <- NErefit4[[4]][[i]][-1]
NEridge_4 <- ridge_coef
ridge_coef
length(ridge_coef)

NEridge_cv <- NErefit4[[6]]
lm1se <- which( NEridge_cv[[i]]$lambda == NEridge_cv[[i]]$lambda.1se)
lmhat <- which( NEridge_cv[[i]]$lambda == NEridge_cv[[i]]$lambda.min)
NEr2 <- 1-NEridge_cv[[i]]$cvm/var( NE_resp[[4]])
NEr2[lm1se]
NEr2[lmhat]


```

# SE Aus - Refits

## Group 1

```{r refits}
SEAus1 <- output[[5]]

#SEpath_new$Group_1 #(strong w/ indicator interactions)
  
SEcoefs1 <- get_coefs(SEAus1$hierpath, max_index = 50, 
                      resp = SE_resp[[1]], preds = SE_preds[[1]], preds_quant = SE_preds_q75[[1]])

plot(SEAus1$hiercv)

SEcv1 <- SEAus1$hiercv
which(SEcv1$lamlist == SEcv1$lamhat.1se)
which(SEcv1$lamlist == SEcv1$lamhat)
SEcv1$lamhat.1se
1-SEcv1$cv.err/var( SE_resp[[1]])

SEAus1$hierpath$bp[1,1] <- 0.1 #dummy coef

SErefit1 <- refit_bic(SEAus1$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = TRUE,
                      resp = SE_resp[[1]], preds = SE_preds[[1]], preds_quant = SE_preds_q75[[1]])

#ignore row 1
SErefit1[[5]]

#from bic, 5 is optimal (6,7,8,10 good) 
i <- 10
ridge_coef <- SErefit1[[4]][[i]][-1]
SEridge_1 <- ridge_coef
ridge_coef
length(ridge_coef)

SEridge_cv <- SErefit1[[6]]
lm1se <- which( SEridge_cv[[i]]$lambda == SEridge_cv[[i]]$lambda.1se)
lmhat <- which( SEridge_cv[[i]]$lambda == SEridge_cv[[i]]$lambda.min)
SEr2 <- 1-SEridge_cv[[i]]$cvm/var( SE_resp[[1]])
SEr2[lm1se]
SEr2[lmhat]

```

## Group 2

```{r refits}
SEAus2 <- output[[6]]

#SEpath_new$Group_2 #(strong w/ indicator interactions)
  
SEcoefs2 <- get_coefs(SEAus2$hierpath, max_index = 50, 
                      resp = SE_resp[[2]], preds = SE_preds[[2]], preds_quant = SE_preds_q75[[2]])

plot(SEAus2$hiercv)

SEcv2 <- SEAus2$hiercv
which(SEcv2$lamlist == SEcv2$lamhat.1se)
which(SEcv2$lamlist == SEcv2$lamhat)
SEcv2$lamhat.1se
1-SEcv2$cv.err/var( SE_resp[[2]])


SErefit2 <- refit_bic(SEAus2$hierpath, max_index = 50, ebic.gamma = 0.50, lambda.min = TRUE,
                      resp = SE_resp[[2]], preds = SE_preds[[2]], preds_quant = SE_preds_q75[[2]])

SErefit2[[5]]

#bic min 8 (5-10, 14 good, 15 ok), ebic 0.25/0.5 min 5
i <- 14
ridge_coef <- SErefit2[[4]][[i]][-1]
SEridge_2 <- ridge_coef
ridge_coef
length(ridge_coef)

SEridge_cv <- SErefit2[[6]]
lm1se <- which( SEridge_cv[[i]]$lambda == SEridge_cv[[i]]$lambda.1se)
lmhat <- which( SEridge_cv[[i]]$lambda == SEridge_cv[[i]]$lambda.min)
SEr2 <- 1-SEridge_cv[[i]]$cvm/var( SE_resp[[2]])
SEr2[lm1se]
SEr2[lmhat]

#summary(SErefit2[[1]][[i]])
```

## Group 3

```{r refits}
SEAus3 <- output[[7]]

#SEpath_new2$Group_3 #(strong w/ indicator interactions)
  
SEcoefs3 <- get_coefs(SEAus3$hierpath, max_index = 50, 
                      resp = SE_resp[[3]], preds = SE_preds[[3]], preds_quant = SE_preds_q75[[3]])

plot(SEAus3$hiercv)

SEcv3 <- SEAus3$hiercv
which(SEcv3$lamlist == SEcv3$lamhat.1se)
which(SEcv3$lamlist == SEcv3$lamhat)
SEcv3$lamhat.1se
1-SEcv3$cv.err/var( SE_resp[[3]])

SErefit3 <- refit_bic(SEAus3$hierpath, max_index = 50, ebic.gamma = 0.50, lambda.min = TRUE,
                      resp = SE_resp[[3]], preds = SE_preds[[3]], preds_quant = SE_preds_q75[[3]])

SErefit3[[5]]

#bic min 15, ebic 0.25 min 15,ebic 0.50: 14,15
i <- 15
ridge_coef <- SErefit3[[4]][[i]][-1]
SEridge_3 <- ridge_coef
ridge_coef
length(ridge_coef)

SEridge_cv <- SErefit1[[6]]
lm1se <- which( SEridge_cv[[i]]$lambda == SEridge_cv[[i]]$lambda.1se)
lmhat <- which( SEridge_cv[[i]]$lambda == SEridge_cv[[i]]$lambda.min)
SEr2 <- 1-SEridge_cv[[i]]$cvm/var( SE_resp[[3]])
SEr2[lm1se]
SEr2[lmhat]
```

## Group 4

```{r refits}
SEAus4 <- output[[8]]

#SEpath_new2$Group_4 #(strong w/ indicator interactions)
  
SEcoefs4 <- get_coefs(SEAus4$hierpath, max_index = 50, 
                      resp = SE_resp[[4]], preds = SE_preds[[4]], preds_quant = SE_preds_q75[[4]])

plot(SEAus4$hiercv)

SEcv4 <- SEAus4$hiercv
which(SEcv4$lamlist == SEcv4$lamhat.1se)
which(SEcv4$lamlist == SEcv4$lamhat)
SEcv4$lamhat.1se
1-SEcv4$cv.err/var( SE_resp[[4]])


SErefit4 <- refit_bic(SEAus4$hierpath, max_index = 50, ebic.gamma = 0.25, lambda.min = TRUE,
                      resp = SE_resp[[4]], preds = SE_preds[[4]], preds_quant = SE_preds_q75[[4]])

SErefit4[[5]]

#bic best 3 ( very good: 14 (3rd best bic)), ebic = 0.25: 3
i <- 14
ridge_coef <- SErefit4[[4]][[i]][-1]
SEridge_4 <- ridge_coef
ridge_coef
length(ridge_coef)

SEridge_cv <- SErefit4[[6]]
lm1se <- which( SEridge_cv[[i]]$lambda == SEridge_cv[[i]]$lambda.1se)
lmhat <- which( SEridge_cv[[i]]$lambda == SEridge_cv[[i]]$lambda.min)
SEr2 <- 1-SEridge_cv[[i]]$cvm/var( SE_resp[[4]])
SEr2[lm1se]
SEr2[lmhat]

#lm bic min i=14 (not even close to other indices)
#summary(SErefit4[[1]][[i]])

```


# Coefficient Plot

## NE Aus
Create plot for coefficients of each model (plotted climate mode)
(currently mostly manual)

TODO: update NE Aus gorup 4

See if we can do this all in R (use the stacked TS plots as a guide)

```{r nino}
#NEridge_1
NE1_ninolag <- c(9,10,12,13,28,33)
NE1_ninocoef <- NEridge_1[1:6]

NE1_ninoind <- c(5,8,12)
NE1_ninocoefind <- NEridge_1[29:31]

#NEridge_2
NE2_ninolag <- c(25)
NE2_ninocoef <- NEridge_2[1]

NE2_ninoind <- c(11, 12)
NE2_ninocoefind <- NEridge_2[14:15]

#NEridge_3 #not included

#NEridge_4
NE4_ninolag <- c(4, 13, 25, 26)
NE4_ninocoef <- NEridge_4[1:4]

NE4_ninoind <- c(20)
NE4_ninocoefind <- NEridge_4[27]

coef_range <- range(NE1_ninocoef, NE1_ninocoefind, NE2_ninocoef, NE2_ninocoefind, NE4_ninocoef, NE4_ninocoefind)

plot(NE1_ninolag, NE1_ninocoef, pch = 15, col = "blue2", xlim = c(1,52), ylim = coef_range,
     xlab = "lag", ylab = "Coefficients")
points(NE1_ninoind, NE1_ninocoefind, pch = 0, col = "blue2")
points(NE2_ninolag, NE2_ninocoef, pch = 16, col = "green3")
points(NE2_ninoind, NE2_ninocoefind, pch = 1, col = "green4", cex = 1.52)
points(NE4_ninolag, NE4_ninocoef, pch = 18, col = "red3", cex = 1.5)
points(NE4_ninoind, NE4_ninocoefind, pch = 5, col = "red3")
abline(h=0, lty = 2)
```

```{r dmi}
#TODO update for dmi
#NEridge_1
NE1_dmilag <- c(52)
NE1_dmicoef <- NEridge_1[7]

#NEridge_2
NE2_dmilag <- c(7,12,41)
NE2_dmicoef <- NEridge_2[2:4]

NE2_dmiind <- c(6)
NE2_dmicoefind <- NEridge_2[16]

#NEridge_3
NE3_dmilag <- c(8,26)
NE3_dmicoef <- NEridge_3[1:2]

NEridge_4
NE4_dmilag <- c(15,16,19:21,29:31,52)
NE4_dmicoef <- NEridge_4[5:13]

dmi_range <- range(NE1_dmicoef, NE2_dmicoef, NE2_dmicoefind, NE3_dmicoef, NE4_dmicoef)

plot(NE1_dmilag, NE1_dmicoef, pch = 15, col = "blue2", xlim = c(1,52), ylim = dmi_range,
     xlab = "lag", ylab = "Coefficients")
points(NE2_dmilag, NE2_dmicoef, pch = 16, col = "green3")
points(NE2_dmiind, NE2_dmicoefind, pch = 1, col = "green4", cex = 1.52)
points(NE3_dmilag, NE3_dmicoef, pch = 17, col = "orange3")
points(NE4_dmilag, NE4_dmicoef, pch = 18, col = "red3", cex = 1.5)
abline(h=0, lty = 2)

```

```{r tsa}
#NEridge_1
NE1_tsalag <- c(1,14,15,18,19,31,32,34:39)
NE1_tsacoef <- NEridge_1[8:20]

#NEridge_2
NE2_tsalag <- c(31,47,48,49)
NE2_tsacoef <- NEridge_2[5:8]

#NEridge_3
NE3_tsalag <- c(2,17,29)
NE3_tsacoef <- NEridge_3[3:5]

NEridge_4
NE4_tsalag <- c(22,28,29,49, 52)
NE4_tsacoef <- NEridge_4[14:18]

tsa_range <- range(NE1_tsacoef, NE2_tsacoef, NE3_tsacoef, NE4_tsacoef)

plot(NE1_tsalag, NE1_tsacoef, pch = 15, col = "blue2", xlim = c(1,52), ylim = tsa_range,
     xlab = "lag", ylab = "Coefficients")
points(NE2_tsalag, NE2_tsacoef, pch = 16, col = "green3")
points(NE3_tsalag, NE3_tsacoef, pch = 17, col = "orange3")
points(NE4_tsalag, NE4_tsacoef, pch = 18, col = "red3", cex = 1.5)
abline(h=0, lty = 2)
```

```{r aao}
NE1_aaolag <- c(2,7,15,24,27,35)
NE1_aaocoef <- NEridge_1[21:26]

NE3_aaolag <- c(43,44)
NE3_aaocoef <- NEridge_3[6:7]

NEridge_4
NE4_aaolag <- c(5,18,20,34,44)
NE4_aaocoef <- NEridge_4[19:23]

aao_range <- range(NE1_aaocoef, NE3_aaocoef, NE4_aaocoef)

plot(NE1_aaolag, NE1_aaocoef, pch = 15, col = "blue2", xlim = c(1,52), ylim = aao_range,
     xlab = "lag", ylab = "Coefficients")
points(NE3_aaolag, NE3_aaocoef, pch = 17, col = "orange3")
points(NE4_aaolag, NE4_aaocoef, pch = 18, col = "red3", cex = 1.5)
abline(h=0, lty = 2)
```

```{r olr}

NE1_olrlag <- c(47, 51)
NE1_olrcoef <- NEridge_1[27:28]

NE2_olrlag <- c(1,2,30,32,52)
NE2_olrcoef <- NEridge_2[9:13]

NE3_olrlag <- c(1)
NE3_olrcoef <- NEridge_3[8]

NE4_olrlag <- c(10,19,20)
NE4_olrcoef <- NEridge_4[24:26]

olr_range <- range(NE1_olrcoef, NE2_olrcoef, NE3_olrcoef, NE4_olrcoef)

plot(NE1_olrlag, NE1_olrcoef, pch = 15, col = "blue2", xlim = c(1,52), ylim = olr_range,
     xlab = "lag", ylab = "Coefficients")
points(NE2_olrlag, NE2_olrcoef, pch = 16, col = "green3")
points(NE3_olrlag, NE3_olrcoef, pch = 17, col = "orange3")
points(NE4_olrlag, NE4_olrcoef, pch = 18, col = "red3", cex = 1.5)
abline(h=0, lty = 2)
```

## SE Aus

```{r nino}
#SEridge_2
SE2_ninolag <- c(11)
SE2_ninocoef <- SEridge_2[1]

SE2_ninoind <- c(10:12)
SE2_ninocoefind <- SEridge_2[18:20]

#SEridge_4
SE4_ninolag <- c(25,34,47)
SE4_ninocoef <- SEridge_4[1:3]

SE4_ninoind <- c(13)
SE4_ninocoefind <- SEridge_4[21]


nino_range <- range(SE2_ninocoef, SE2_ninocoefind, SE4_ninocoef, SE4_ninocoefind)

plot(SE2_ninolag, SE2_ninocoef, pch = 16, col = "green3", xlim = c(1,52), ylim = nino_range,
     xlab = "lag", ylab = "Coefficients")
points(SE2_ninoind, SE2_ninocoefind, pch = 1, col = "green4", cex = 1.25)
points(SE4_ninolag, SE4_ninocoef, pch = 18, col = "red3", cex = 1.5)
points(SE4_ninoind, SE4_ninocoefind, pch = 5, col = "red3")
abline(h=0, lty = 2)

```

```{r dmi}
#SEridge_1
SE1_dmilag <- c(31,37,42:44)
SE1_dmicoef <- SEridge_1[1:5]

SE1_dmiind <- c(43)
SE1_dmicoefind <- SEridge_1[16]

SE2_dmilag <- c(6,34)
SE2_dmicoef <- SEridge_2[2:3]

SE2_dmiind <- c(5,6)
SE2_dmicoefind <- SEridge_2[21:22]

#SEridge_3
SE3_dmilag <- c(7,8)
SE3_dmicoef <- SEridge_3[1:2]

SE4_dmilag <- c(12,14:16,24,40)
SE4_dmicoef <- SEridge_4[4:9]

SE4_dmiind <- c(14)
SE4_dmicoefind <- SEridge_4[22]

dmi_range <- range(SE1_dmicoef, SE1_dmicoefind, SE2_dmicoef, SE2_dmicoefind, SE3_dmicoef, SE4_dmicoef, SE4_dmicoefind)

plot(SE1_dmilag, SE1_dmicoef, pch = 15, col = "blue2", xlim = c(1,52), ylim = dmi_range,
     xlab = "lag", ylab = "Coefficients")
points(SE1_dmiind, SE1_dmicoefind, pch = 0, col = "blue2")
points(SE2_dmilag, SE2_dmicoef, pch = 16, col = "green3")
points(SE2_dmiind, SE2_dmicoefind, pch = 1, col = "green4", cex = 1.25)
points(SE3_dmilag, SE3_dmicoef, pch = 17, col = "orange3")
points(SE4_dmilag, SE4_dmicoef, pch = 18, col = "red3", cex = 1.5)
points(SE4_dmiind, SE4_dmicoefind, pch = 5, col = "red3")
abline(h=0, lty = 2)


```

```{r tsa}
SE1_tsalag <- c(12:15)
SE1_tsacoef <- SEridge_1[6:9]

SE2_tsalag <- c(14,15,17,44)
SE2_tsacoef <- SEridge_2[4:7]

SE3_tsalag <- c(27)
SE3_tsacoef <- SEridge_3[3]

SE4_tsalag <- c(21,22,52)
SE4_tsacoef <- SEridge_4[10:12]

tsa_range <- range(SE1_tsacoef, SE2_tsacoef, SE3_tsacoef, SE4_tsacoef)

plot(SE1_tsalag, SE1_tsacoef, pch = 15, col = "blue2", xlim = c(1,52), ylim = tsa_range,
     xlab = "lag", ylab = "Coefficients")
points(SE2_tsalag, SE2_tsacoef, pch = 16, col = "green3")
points(SE3_tsalag, SE3_tsacoef, pch = 17, col = "orange3")
points(SE4_tsalag, SE4_tsacoef, pch = 18, col = "red3", cex = 1.5)
abline(h=0, lty = 2)

```

```{r aao}
SE1_aaolag <- c(17,18,23,27,29,35)
SE1_aaocoef <- SEridge_1[10:15]

SE2_aaolag <- c(7,15,24,25,39,51)
SE2_aaocoef <- SEridge_2[8:13]

SE3_aaolag <- c(9)
SE3_aaocoef <- SEridge_3[4]

SE4_aaolag <- c(36,37,47)
SE4_aaocoef <- SEridge_4[13:15]

aao_range <- range(SE1_aaocoef, SE2_aaocoef, SE3_aaocoef, SE4_aaocoef)

plot(SE1_aaolag, SE1_aaocoef, pch = 15, col = "blue2", xlim = c(1,52), ylim = aao_range,
     xlab = "lag", ylab = "Coefficients")
points(SE2_aaolag, SE2_aaocoef, pch = 16, col = "green3")
points(SE3_aaolag, SE3_aaocoef, pch = 17, col = "orange3")
points(SE4_aaolag, SE4_aaocoef, pch = 18, col = "red3", cex = 1.5)
abline(h=0, lty = 2)


```

```{r olr}
SE2_olrlag <- c(1,15,23,28)
SE2_olrcoef <- SEridge_2[14:17] 

SE4_olrlag <- c(1,28,35,38,49)
SE4_olrcoef <- SEridge_4[16:20] 

olr_range <- range(SE2_olrcoef, SE4_olrcoef)

plot(SE2_olrlag, SE2_olrcoef, pch = 16, col = "green3", xlim = c(1,52), ylim = olr_range,
     xlab = "lag", ylab = "Coefficients")
points(SE4_olrlag, SE4_olrcoef, pch = 18, col = "red3", cex = 1.5)
abline(h=0, lty = 2)
```


## Big Plots


```{r test_plot}

NEridge_1
NE1_quad <- NEridge_1[32:39]
NE1_quad

NEridge_2
NE2_quad <- NEridge_2[17:25]
NE2_quad

NEridge_3
NE3_quad <- NEridge_3[9:11]
NE3_quad

NEridge_4
NE4_quad <- NEridge_4[28:40]
NE4_quad


```


```{r test_plots}

# Define the layout matrix
layout_matrix <- matrix(c(1, 4,
                          2, 4,
                          3, 4), ncol = 2, byrow = TRUE)

# Set the layout
layout(layout_matrix, widths = c(2, 1), heights = c(1, 1, 1))

# Optional: Add some margin control
par(mar = c(4, 4, 2, 1))  # Bottom, left, top, right

# Plot 1 (top left)
plot(1:10, main = "Top Left")

# Plot 2 (middle left)
plot(rnorm(10), main = "Middle Left")

# Plot 3 (bottom left)
plot(runif(10), main = "Bottom Left")

# Plot 4 (right column, tall plot)
par(mar = c(4, 2, 2, 2))  # Adjust margins for the tall plot
plot(1:100, sin(1:100/10), type = "l", main = "Tall Right Plot")

```


```{r}


# Define the layout
layout(matrix(c(1,4,
                2,4,
                3,4), ncol = 2, byrow = TRUE),
       widths = c(1, 1), heights = c(1,1,1))

# Set up a list to store coordinates
coords <- list()

# --- Plot 1: Top Left ---
par(mar = c(4, 4, 2, 1))
plot(1:10, main = "Top Left")

# --- Plot 2: Middle Left ---
par(mar = c(4, 4, 2, 1))
y_vals <- rnorm(10)
plot(y_vals, main = "Middle Left")

# Choose a point to connect FROM (e.g., 5th point)
coords$from_x <- grconvertX(5,         from = "user", to = "ndc")
coords$from_y <- grconvertY(y_vals[5], from = "user", to = "ndc")

# --- Plot 3: Bottom Left ---
par(mar = c(4, 4, 2, 1))
plot(runif(10), main = "Bottom Left")

# --- Plot 4: Tall Right ---
par(mar = c(4, 4, 2, 2))
x_vals <- 1:100
y_vals_right <- sin(x_vals / 10)
plot(x_vals, y_vals_right, type = "l", main = "Tall Right Plot")

# Choose a point to connect TO (e.g., x = 50)
coords$to_x <- grconvertX(50,       from = "user", to = "ndc")
coords$to_y <- grconvertY(sin(5),   from = "user", to = "ndc")

# --- Draw a line between the two points (on the same device) ---
# VERY IMPORTANT: Enable drawing outside the plot regions
par(xpd = NA)

# Now use grid to draw the line *on top of the plots*, without clearing
grid.lines(
  x = unit(c(coords$from_x, coords$to_x), "npc"),
  y = unit(c(coords$from_y, coords$to_y), "npc"),
  gp = gpar(col = "red", lwd = 2)
)

```



```{r}
#TODO: begin by developing with NE Aus (group 3, ....,group 4 )

setwd("~/CO_AUS/Aus_CO-main/Interactions")
  
png(filename = "test_coeff.png", width = 3000, height = 3000, res = 300)
# Set layout
layout(matrix(c(1, 6,
                2, 6,
                3, 6,
                4, 6,
                5, 6), ncol = 2, byrow = TRUE),
       widths = c(1.5, 1), heights = c(1, 1, 1, 1, 1))

# Store info for linking
links <- list()

# --- Plot 1: Nino ---
par(mar = c(4, 4, 2, 1))
#NE 1
NE1_ninolag <- c(9,10,12,13,28,33)
NE1_ninocoef <- NEridge_1[1:6]
NE1_ninoind <- c(5,8,12)
NE1_ninocoefind <- NEridge_1[29:31]
#NE Aus group 2
NE2_ninolag <- c(25)
NE2_ninocoef <- NEridge_2[1]
NE2_ninoind <- c(11, 12)
NE2_ninocoefind <- NEridge_2[14:15]
#NE 4
NE4_ninolag <- c(4, 13, 25, 26)
NE4_ninocoef <- NEridge_4[1:4]
NE4_ninoind <- c(20)
NE4_ninocoefind <- NEridge_4[27]

nino_range <- range(NE1_ninocoef, NE1_ninocoefind, NE2_ninocoef, NE2_ninocoefind, NE4_ninocoef, NE4_ninocoefind)

plot(NE2_ninolag, NE2_ninocoef, pch = 16, col = "green4", xlim = c(1,52), cex = 1.4,
     ylim = nino_range,
     xlab = "Lag", ylab = "Coefficients")
title("Nino", adj = 0)
points(NE2_ninoind, NE2_ninocoefind, pch = 1, col = "green4", cex = 1.52)
points(NE1_ninolag, NE1_ninocoef, pch = 15, col = "blue2", cex = 1)
points(NE1_ninoind, NE1_ninocoefind, pch = 0, col = "blue2", cex = 1.5)
points(NE4_ninolag, NE4_ninocoef, pch = 18, col = "red3", cex = 1.5)
points(NE4_ninoind, NE4_ninocoefind, pch = 5, col = "red3", cex = 1.5)
abline(h = 0, lty = 2)


#NE Aus group 1:
#I(nino_lag33^2)  
links[[15]] <- list(
  y_val = NE1_ninocoef[6],
  from_x = grconvertX(NE1_ninolag[6], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_ninocoef[6], from = "user", to = "ndc")
)
#nino_lag9:nino_lag28
links[[19]] <- list(
  y_val = NE1_ninocoef[1],
  from_x = grconvertX(NE1_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_ninocoef[1], from = "user", to = "ndc")
)
#nino_lag9:nino_lag28
links[[20]] <- list(
  y_val = NE1_ninocoef[5],
  from_x = grconvertX(NE1_ninolag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_ninocoef[5], from = "user", to = "ndc")
)
#nino_lag10:aao_lag15
links[[21]] <- list(
  y_val = NE1_ninocoef[2],
  from_x = grconvertX(NE1_ninolag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_ninocoef[2], from = "user", to = "ndc")
)

#NE Aus group 4
# nino_lag4:aao_lag5 
links[[32]] <- list(
  y_val = NE4_ninocoef[1],
  from_x = grconvertX(NE4_ninolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_ninocoef[1], from = "user", to = "ndc")
)
#nino_lag13:dmi_lag52
links[[34]] <- list(
  y_val = NE4_ninocoef[2],
  from_x = grconvertX(NE4_ninolag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_ninocoef[2], from = "user", to = "ndc")
)


# --- Plot 2: DMI ---
par(mar = c(4, 4, 2, 1))
#NE 1
NE1_dmilag <- c(52)
NE1_dmicoef <- NEridge_1[7]
#NEridge_2
NE2_dmilag <- c(7,12,41)
NE2_dmicoef <- NEridge_2[2:4]
NE2_dmiind <- c(6)
NE2_dmicoefind <- NEridge_2[16]
#NE 3
NE3_dmilag <- c(8,26)
NE3_dmicoef <- NEridge_3[1:2]
#NE 4
NE4_dmilag <- c(15,16,19:21,29:31,52)
NE4_dmicoef <- NEridge_4[5:13]

dmi_range <- range(NE1_dmicoef, NE2_dmicoef, NE2_dmicoefind, NE3_dmicoef, NE4_dmicoef)

plot(NE3_dmilag, NE3_dmicoef, pch = 17, col = "orange3", cex = 1.5, 
     xlim = c(1,52), ylim = dmi_range,
     xlab = "Lag", ylab = "Coefficients")
title("DMI", adj = 0)
points(NE1_dmilag, NE1_dmicoef, pch = 15, col = "blue2", cex = 1)
points(NE2_dmilag, NE2_dmicoef, pch = 16, col = "green4", cex = 1.5)
points(NE2_dmiind, NE2_dmicoefind, pch = 1, col = "green4", cex = 1.52)
points(NE4_dmilag, NE4_dmicoef, pch = 18, col = "red3", cex = 1.5)
abline(h = 0, lty = 2)


#NE AUS group 3
links[[1]] <- list(
  y_val = NE3_dmicoef[1],
  from_x = grconvertX(NE3_dmilag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_dmicoef[1], from = "user", to = "ndc")
)

#NE AUS group 2 I(dmi_lag7^2) 
links[[4]] <- list(
  y_val = NE2_dmicoef[1],
  from_x = grconvertX(NE2_dmilag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE2_dmicoef[1], from = "user", to = "ndc")
)
#I(dmi_lag41^2)
links[[5]] <- list(
  y_val = NE2_dmicoef[3],
  from_x = grconvertX(NE2_dmilag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE2_dmicoef[3], from = "user", to = "ndc")
)
#dmi_lag12:NEolr_lag1 
links[[11]] <- list(
  y_val = NE2_dmicoef[2],
  from_x = grconvertX(NE2_dmilag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE2_dmicoef[2], from = "user", to = "ndc")
)
#dmi_lag41:NEolr_lag1 
links[[12]] <- list(
  y_val = NE2_dmicoef[3],
  from_x = grconvertX(NE2_dmilag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE2_dmicoef[3], from = "user", to = "ndc")
)

#NE group 4
#I(dmi_lag15^2) 
links[[27]] <- list(
  y_val = NE4_dmicoef[1],
  from_x = grconvertX(NE4_dmilag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_dmicoef[1], from = "user", to = "ndc")
)
#I(dmi_lag16^2) 
links[[28]] <- list(
  y_val = NE4_dmicoef[2],
  from_x = grconvertX(NE4_dmilag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_dmicoef[2], from = "user", to = "ndc")
)
#nino_lag13:dmi_lag52 
links[[35]] <- list(
  y_val = NE4_dmicoef[9],
  from_x = grconvertX(NE4_dmilag[9], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_dmicoef[9], from = "user", to = "ndc")
)
#dmi_lag19:tsa_lag52 
links[[36]] <- list(
  y_val = NE4_dmicoef[3],
  from_x = grconvertX(NE4_dmilag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_dmicoef[3], from = "user", to = "ndc")
)
#dmi_lag20:tsa_lag49 
links[[38]] <- list(
  y_val = NE4_dmicoef[4],
  from_x = grconvertX(NE4_dmilag[4], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_dmicoef[4], from = "user", to = "ndc")
)
#dmi_lag21:tsa_lag52
links[[40]] <- list(
  y_val = NE4_dmicoef[5],
  from_x = grconvertX(NE4_dmilag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_dmicoef[5], from = "user", to = "ndc")
)
#dmi_lag29:tsa_lag52  
links[[42]] <- list(
  y_val = NE4_dmicoef[6],
  from_x = grconvertX(NE4_dmilag[6], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_dmicoef[6], from = "user", to = "ndc")
)
#dmi_lag30:tsa_lag52
links[[44]] <- list(
  y_val = NE4_dmicoef[7],
  from_x = grconvertX(NE4_dmilag[7], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_dmicoef[7], from = "user", to = "ndc")
)
#dmi_lag31:tsa_lag52
links[[46]] <- list(
  y_val = NE4_dmicoef[8],
  from_x = grconvertX(NE4_dmilag[8], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_dmicoef[8], from = "user", to = "ndc")
)

# --- Plot 3: TSA ---
par(mar = c(4, 4, 2, 1))

#NE 1
NE1_tsalag <- c(1,14,15,18,19,31,32,34:39)
NE1_tsacoef <- NEridge_1[8:20]
#NE 2
NE2_tsalag <- c(31,47,48,49)
NE2_tsacoef <- NEridge_2[5:8]
#NE 3
NE3_tsalag <- c(2,17,29)
NE3_tsacoef <- NEridge_3[3:5]
#NE 4
NE4_tsalag <- c(22,28,29,49, 52)
NE4_tsacoef <- NEridge_4[14:18]

tsa_range <- range(NE1_tsacoef, NE2_tsacoef, NE3_tsacoef, NE4_tsacoef)

plot(NE3_tsalag, NE3_tsacoef, pch = 17, col = "orange3", cex = 1.5, 
     xlim = c(1,52), ylim = tsa_range,
     xlab = "Lag", ylab = "Coefficients")
title("TSA", adj = 0)
points(NE1_tsalag, NE1_tsacoef, pch = 15, col = "blue2", cex = 1)
points(NE2_tsalag, NE2_tsacoef, pch = 16, col = "green4", cex = 1.5)
points(NE4_tsalag, NE4_tsacoef, pch = 18, col = "red3", cex = 1.5)
abline(h = 0, lty = 2)


#NE AUS group 3
links[[2]] <- list(
  y_val = NE3_tsacoef[1],
  from_x = grconvertX(NE3_tsalag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[1], from = "user", to = "ndc")
)

links[[3]] <- list(
  y_val = NE3_tsacoef[2],
  from_x = grconvertX(NE3_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE3_tsacoef[2], from = "user", to = "ndc")
)

#NE AUS group 2
#I(tsa_lag47^2)       
links[[6]] <- list(
  y_val = NE2_tsacoef[2],
  from_x = grconvertX(NE2_tsalag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE2_tsacoef[2], from = "user", to = "ndc")
)
#I(tsa_lag49^2) 
links[[7]] <- list(
  y_val = NE2_tsacoef[4],
  from_x = grconvertX(NE2_tsalag[4], from = "user", to = "ndc"),
  from_y = grconvertY(NE2_tsacoef[4], from = "user", to = "ndc")
)

#NE Aus group 1 
#I(tsa_lag19^2)
links[[16]] <- list(
  y_val = NE1_tsacoef[5],
  from_x = grconvertX(NE1_tsalag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_tsacoef[5], from = "user", to = "ndc")
)

#NE group 4
#dmi_lag19:tsa_lag52 
links[[37]] <- list(
  y_val = NE4_tsacoef[5],
  from_x = grconvertX(NE4_tsalag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_tsacoef[5], from = "user", to = "ndc")
)
#dmi_lag20:tsa_lag49 
links[[39]] <- list(
  y_val = NE4_tsacoef[4],
  from_x = grconvertX(NE4_tsalag[4], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_tsacoef[4], from = "user", to = "ndc")
)
#dmi_lag21:tsa_lag52 
links[[41]] <- list(
  y_val = NE4_tsacoef[5],
  from_x = grconvertX(NE4_tsalag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_tsacoef[5], from = "user", to = "ndc")
)
#dmi_lag29:tsa_lag52  
links[[43]] <- list(
  y_val = NE4_tsacoef[5],
  from_x = grconvertX(NE4_tsalag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_tsacoef[5], from = "user", to = "ndc")
)
#dmi_lag30:tsa_lag52
links[[45]] <- list(
  y_val = NE4_tsacoef[5],
  from_x = grconvertX(NE4_tsalag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_tsacoef[5], from = "user", to = "ndc")
)
#dmi_lag31:tsa_lag52 
links[[47]] <- list(
  y_val = NE4_tsacoef[5],
  from_x = grconvertX(NE4_tsalag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_tsacoef[5], from = "user", to = "ndc")
)


# --- Plot 4 AAO :
par(mar = c(4, 4, 2, 1))

#NE 1
NE1_aaolag <- c(2,7,15,24,27,35)
NE1_aaocoef <- NEridge_1[21:26]
#NE 3
NE3_aaolag <- c(43,44)
NE3_aaocoef <- NEridge_3[6:7]
#NE 4
NE4_aaolag <- c(5,18,20,34,44)
NE4_aaocoef <- NEridge_4[19:23]

aao_range <- range(NE1_aaocoef, NE3_aaocoef, NE4_aaocoef)

plot(NE3_aaolag, NE3_aaocoef, pch = 17, col = "orange3", cex = 1.5, 
     xlim = c(1,52), ylim = aao_range,
     xlab = "Lag", ylab = "Coefficients")
title("SAM (AAO)", adj = 0)
points(NE1_aaolag, NE1_aaocoef, pch = 15, col = "blue2", cex = 1)
points(NE4_aaolag, NE4_aaocoef, pch = 18, col = "red3", cex = 1.5)
abline(h = 0, lty = 2)

#NE Aus group 1 
#I(aao_lag24^2)
links[[17]] <- list(
  y_val = NE1_aaocoef[4],
  from_x = grconvertX(NE1_aaolag[4], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_aaocoef[4], from = "user", to = "ndc")
)
#nino_lag10:aao_lag15
links[[22]] <- list(
  y_val = NE1_aaocoef[3],
  from_x = grconvertX(NE1_aaolag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_aaocoef[3], from = "user", to = "ndc")
)
#aao_lag24:aao_lag35
links[[23]] <- list(
  y_val = NE1_aaocoef[5],
  from_x = grconvertX(NE1_aaolag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_aaocoef[5], from = "user", to = "ndc")
)
#aao_lag24:aao_lag35
links[[24]] <- list(
  y_val = NE1_aaocoef[5],
  from_x = grconvertX(NE1_aaolag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_aaocoef[5], from = "user", to = "ndc")
)

#NE group 4
#I(aao_lag34^2)
links[[29]] <- list(
  y_val = NE4_aaocoef[4],
  from_x = grconvertX(NE4_aaolag[4], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_aaocoef[4], from = "user", to = "ndc")
)
#I(aao_lag44^2) 
links[[30]] <- list(
  y_val = NE4_aaocoef[5],
  from_x = grconvertX(NE4_aaolag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_aaocoef[5], from = "user", to = "ndc")
)
#nino_lag4:aao_lag5
links[[33]] <- list(
  y_val = NE4_aaocoef[1],
  from_x = grconvertX(NE4_aaolag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_aaocoef[1], from = "user", to = "ndc")
)



# --- Plot 5 OLR:
par(mar = c(4, 4, 2, 1))

#NE 1
NE1_olrlag <- c(47, 51)
NE1_olrcoef <- NEridge_1[27:28]
#NE 2
NE2_olrlag <- c(1,2,30,32,52)
NE2_olrcoef <- NEridge_2[9:13]
#NE 3
NE3_olrlag <- c(1)
NE3_olrcoef <- NEridge_3[8]
#NE 4
NE4_olrlag <- c(10,19,20)
NE4_olrcoef <- NEridge_4[24:26]

olr_range <- range(NE1_olrcoef, NE2_olrcoef, NE3_olrcoef, NE4_olrcoef)

plot(NE3_olrlag, NE3_olrcoef, pch = 17, col = "orange3", cex = 1.5, 
     xlim = c(1,52), ylim = olr_range,
     xlab = "Lag", ylab = "Coefficients")
title("OLR", adj = 0)
points(NE1_olrlag, NE1_olrcoef, pch = 15, col = "blue2", cex = 1)
points(NE2_olrlag, NE2_olrcoef, pch = 16, col = "green4", cex = 1.5)
points(NE4_olrlag, NE4_olrcoef, pch = 18, col = "red3", cex = 1.5)
abline(h = 0, lty = 2)

#NE AUS group 2
#I(NEolr_lag30^2)        
links[[8]] <- list(
  y_val = NE2_olrcoef[3],
  from_x = grconvertX(NE2_olrlag[3], from = "user", to = "ndc"),
  from_y = grconvertY(NE2_olrcoef[3], from = "user", to = "ndc")
)
#I(NEolr_lag32^2) 
links[[9]] <- list(
  y_val = NE2_olrcoef[4],
  from_x = grconvertX(NE2_olrlag[4], from = "user", to = "ndc"),
  from_y = grconvertY(NE2_olrcoef[4], from = "user", to = "ndc")
)
#I(NEolr_lag52^2) 
links[[10]] <- list(
  y_val = NE2_olrcoef[5],
  from_x = grconvertX(NE2_olrlag[5], from = "user", to = "ndc"),
  from_y = grconvertY(NE2_olrcoef[5], from = "user", to = "ndc")
)
#dmi_lag12:NEolr_lag1 
links[[13]] <- list(
  y_val = NE2_olrcoef[1],
  from_x = grconvertX(NE2_olrlag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE2_olrcoef[1], from = "user", to = "ndc")
)
#dmi_lag41:NEolr_lag1 
links[[14]] <- list(
  y_val = NE2_olrcoef[1],
  from_x = grconvertX(NE2_olrlag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE2_olrcoef[1], from = "user", to = "ndc")
)

#NE Aus group 1 
#I(NEolr_lag47^2) 
links[[18]] <- list(
  y_val = NE1_olrcoef[1],
  from_x = grconvertX(NE1_olrlag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_olrcoef[1], from = "user", to = "ndc")
)
#NEolr_lag47:NEolr_lag51 
links[[25]] <- list(
  y_val = NE1_olrcoef[1],
  from_x = grconvertX(NE1_olrlag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_olrcoef[1], from = "user", to = "ndc")
)
#NEolr_lag47:NEolr_lag51 
links[[26]] <- list(
  y_val = NE1_olrcoef[1],
  from_x = grconvertX(NE1_olrlag[1], from = "user", to = "ndc"),
  from_y = grconvertY(NE1_olrcoef[1], from = "user", to = "ndc")
)

#NE Group 4
#I(NEolr_lag19^2) 
links[[31]] <- list(
  y_val = NE4_olrcoef[2],
  from_x = grconvertX(NE4_olrlag[2], from = "user", to = "ndc"),
  from_y = grconvertY(NE4_olrcoef[2], from = "user", to = "ndc")
)


# --- Plot 6: Interaction Effects ---

y_range <- c(0,1)

#TODO: finalize y locations at the end
#approx locations

NE2_loc <- c(0.728, 0.72, 0.448, 0.505, 0.002, -0.002, -0.05)
NE3_loc <- c(0.778, 0.485, 0.438) #NE Aus 3

int_range <- range(NE1_quad, NE2_quad, NE3_quad, NE4_quad)

par(mar = c(4, 4, 2, 2))
plot(NE3_quad, NE3_loc, pch = 17, col = "orange3", cex = 1.5, main = "Interactions", 
     ylim = y_range, xlim = int_range,
     xlab = "Coefficients")
     #yaxt = "n",  ylab = "")
points(NE2_quad[1:7], NE2_loc, pch = 16, col = "green4", cex = 1.5)
abline(v=0, lty = 2)


# For each link, match the left-side y-value with fixed x on right
#manual x locations
#NE group 3
links[[1]]$to_x <- grconvertX(NE3_quad[1], from = "user", to = "ndc")
links[[2]]$to_x <- grconvertX(NE3_quad[2], from = "user", to = "ndc")
links[[3]]$to_x <- grconvertX(NE3_quad[3], from = "user", to = "ndc")

#NE group 2
links[[4]]$to_x <- grconvertX(NE2_quad[1], from = "user", to = "ndc")
links[[5]]$to_x <- grconvertX(NE2_quad[2], from = "user", to = "ndc")
links[[6]]$to_x <- grconvertX(NE2_quad[3], from = "user", to = "ndc")
links[[7]]$to_x <- grconvertX(NE2_quad[4], from = "user", to = "ndc")
links[[8]]$to_x <- grconvertX(NE2_quad[5], from = "user", to = "ndc")
links[[9]]$to_x <- grconvertX(NE2_quad[6], from = "user", to = "ndc")
links[[10]]$to_x <- grconvertX(NE2_quad[7], from = "user", to = "ndc")

links[[11]]$to_x <- grconvertX(NE2_quad[8], from = "user", to = "ndc")
links[[13]]$to_x <- grconvertX(NE2_quad[8], from = "user", to = "ndc")
segments(NE2_quad[8], 0.1, NE2_quad[8], 0.77, col = "green4", lwd = 2, lty = 3)
links[[12]]$to_x <- grconvertX(NE2_quad[9], from = "user", to = "ndc")
links[[14]]$to_x <- grconvertX(NE2_quad[9], from = "user", to = "ndc")

#NE group 1
links[[15]]$to_x <- grconvertX(NE1_quad[1], from = "user", to = "ndc")
links[[16]]$to_x <- grconvertX(NE1_quad[2], from = "user", to = "ndc")
links[[17]]$to_x <- grconvertX(NE1_quad[3], from = "user", to = "ndc")
links[[18]]$to_x <- grconvertX(NE1_quad[4], from = "user", to = "ndc")

links[[19]]$to_x <- grconvertX(NE1_quad[5], from = "user", to = "ndc")
links[[20]]$to_x <- grconvertX(NE1_quad[5], from = "user", to = "ndc")
links[[21]]$to_x <- grconvertX(NE1_quad[6], from = "user", to = "ndc")
links[[22]]$to_x <- grconvertX(NE1_quad[6], from = "user", to = "ndc")
links[[23]]$to_x <- grconvertX(NE1_quad[7], from = "user", to = "ndc")
links[[24]]$to_x <- grconvertX(NE1_quad[7], from = "user", to = "ndc")
links[[25]]$to_x <- grconvertX(NE1_quad[8], from = "user", to = "ndc")
links[[26]]$to_x <- grconvertX(NE1_quad[8], from = "user", to = "ndc")

#NE group 4
links[[27]]$to_x <- grconvertX(NE1_quad[1], from = "user", to = "ndc")
links[[28]]$to_x <- grconvertX(NE1_quad[2], from = "user", to = "ndc")
links[[29]]$to_x <- grconvertX(NE1_quad[3], from = "user", to = "ndc")
links[[30]]$to_x <- grconvertX(NE1_quad[4], from = "user", to = "ndc")
links[[31]]$to_x <- grconvertX(NE1_quad[5], from = "user", to = "ndc")

links[[32]]$to_x <- grconvertX(NE1_quad[6], from = "user", to = "ndc")
links[[33]]$to_x <- grconvertX(NE1_quad[6], from = "user", to = "ndc")
links[[34]]$to_x <- grconvertX(NE1_quad[7], from = "user", to = "ndc")
links[[35]]$to_x <- grconvertX(NE1_quad[7], from = "user", to = "ndc")
links[[36]]$to_x <- grconvertX(NE1_quad[8], from = "user", to = "ndc")
links[[37]]$to_x <- grconvertX(NE1_quad[8], from = "user", to = "ndc")
links[[38]]$to_x <- grconvertX(NE1_quad[9], from = "user", to = "ndc")
links[[39]]$to_x <- grconvertX(NE1_quad[9], from = "user", to = "ndc")
links[[40]]$to_x <- grconvertX(NE1_quad[10], from = "user", to = "ndc")
links[[41]]$to_x <- grconvertX(NE1_quad[10], from = "user", to = "ndc")
links[[42]]$to_x <- grconvertX(NE1_quad[11], from = "user", to = "ndc")
links[[43]]$to_x <- grconvertX(NE1_quad[11], from = "user", to = "ndc")
links[[44]]$to_x <- grconvertX(NE1_quad[12], from = "user", to = "ndc")
links[[45]]$to_x <- grconvertX(NE1_quad[12], from = "user", to = "ndc")
links[[46]]$to_x <- grconvertX(NE1_quad[13], from = "user", to = "ndc")
links[[47]]$to_x <- grconvertX(NE1_quad[13], from = "user", to = "ndc")

for (i in 1:length(links)) {
  links[[i]]$to_y <- links[[i]]$from_y  # same y to keep it horizontal
}

# --- Draw horizontal linking lines ---
par(xpd = NA)  # allow drawing outside plot regions
colors <- c(rep("orange3", 3), rep("green4", 11), rep("blue2", 12), rep("red3", 21))
linetypes <- c(rep(2, 10), rep(3,4), rep(2, 4), rep(3, 8), rep(2, 5), rep(3, 16))

for (i in 1:length(links)) {
  grid.lines(
    x = unit(c(links[[i]]$from_x, links[[i]]$to_x), "npc"),
    y = unit(c(links[[i]]$from_y, links[[i]]$to_y), "npc"),
    gp = gpar(col = colors[i], lwd = 1, lty = linetypes[i])
  )
}

dev.off()

```


# Predictions

## NE Aus

```{r NEAus1_pred}
i <- 9 #lambda choice

NEaus_main <- NEcoefs1[[i]][[1]] #main effects
NEaus_int <- NEcoefs1[[i]][[2]] #interaction effects

model_string <- paste( paste(NEaus_main$Main_Effect, collapse = " + "),
                       paste(NEaus_int$Interact_Effect, collapse = " + "),
                       sep = " + ")

model_string <- paste0("y ~ ", model_string)

#testing for each year:
#TODO: delete later after everything is working
k <- 1:19
NE_preds <- NElag_grouping(NE_laglist = NE_laglist_std, j = k)
NE_resp <- NEresp_grouping(NEAus_mat = NEAus_mat, j = k)
NE_preds_q75 <- NElag_grouping(NE_laglist = NE_laglist_q75, j = k)

y = as.numeric(NE_resp[[1]])
X = cbind(as.matrix(NE_preds[[1]][ ,1:260]),
          as.matrix(NE_preds_q75[[1]][ ,1:104])  )

coef_names <- c(colnames(NE_preds[[1]]), paste0( "IND_", colnames(NE_preds_q75[[1]][ ,1:104]) ) )
colnames(X) <- coef_names

#ridge model
X_df <- as.data.frame(X)
f <- as.formula(model_string)
X_new <- model.matrix(f, X_df)

#from refits
ridge_refit <- NErefit1[[3]][[i]] #ridge fit
refit_cv <- NErefit1[[6]][[i]] #ridge cv

refit_cv$lambda.1se
refit_cv$lambda.min

set.seed(300)
#ridge_cv <- cv.glmnet(X_new, y, alpha = 0.00, nfolds = 5)
#ridge_fit <- glmnet(X_new, y, alpha = 0.00)

#save this for later
plot(refit_cv)
plot(ridge_refit, xvar = "dev")

#TODO: also test predictions with: refit_cv$lambda.min
NEAus1_pred <- predict(ridge_refit, X_new, s = refit_cv$lambda.min, type = "response")

#sort by year
NE1_yhat <- c()
for (j in 1:19) {
  NE1_yhat <- c(NE1_yhat, NEAus1_pred[seq(j, 228, by = 19)])
}

```

```{r NEAus2_pred}
i <- 14 #lambda choice

NEaus_main <- NEcoefs2[[i]][[1]] #main effects
NEaus_int <- NEcoefs2[[i]][[2]] #interaction effects

model_string <- paste( paste(NEaus_main$Main_Effect, collapse = " + "),
                       paste(NEaus_int$Interact_Effect, collapse = " + "),
                       sep = " + ")

model_string <- paste0("y ~ ", model_string)

y = as.numeric(NE_resp[[2]])
X = cbind(as.matrix(NE_preds[[2]][ ,1:260]),
          as.matrix(NE_preds_q75[[2]][ ,1:104])  )

coef_names <- c(colnames(NE_preds[[2]]), paste0( "IND_", colnames(NE_preds_q75[[2]][ ,1:104]) ) )
colnames(X) <- coef_names

#ridge model
X_df <- as.data.frame(X)
f <- as.formula(model_string)
X_new <- model.matrix(f, X_df)

#from refits
ridge_refit <- NErefit2[[3]][[i]] #ridge fit
refit_cv <- NErefit2[[6]][[i]] #ridge cv

refit_cv$lambda.1se
refit_cv$lambda.min

set.seed(300)
#ridge_cv <- cv.glmnet(X_new, y, alpha = 0.00, nfolds = 5)
#ridge_fit <- glmnet(X_new, y, alpha = 0.00)

#save this for later
plot(refit_cv)
plot(ridge_refit, xvar = "dev")

#TODO: also test predictions with: refit_cv$lambda.min
NEAus2_pred <- predict(ridge_refit, X_new, s = refit_cv$lambda.min, type = "response")

#sort by year
NE2_yhat <- c()
for (j in 1:19) {
  NE2_yhat <- c(NE2_yhat, NEAus2_pred[seq(j, 95, by = 19)])
}

```

```{r NEAus3_pred}
i <- 14 #lambda choice

NEaus_main <- NEcoefs3[[i]][[1]] #main effects
NEaus_int <- NEcoefs3[[i]][[2]] #interaction effects

model_string <- paste( paste(NEaus_main$Main_Effect, collapse = " + "),
                       paste(NEaus_int$Interact_Effect, collapse = " + "),
                       sep = " + ")

model_string <- paste0("y ~ ", model_string)

y = as.numeric(NE_resp[[3]])
X = cbind(as.matrix(NE_preds[[3]][ ,1:260]),
          as.matrix(NE_preds_q75[[3]][ ,1:104])  )

coef_names <- c(colnames(NE_preds[[3]]), paste0( "IND_", colnames(NE_preds_q75[[3]][ ,1:104]) ) )
colnames(X) <- coef_names

#ridge model
X_df <- as.data.frame(X)
f <- as.formula(model_string)
X_new <- model.matrix(f, X_df)

#from refits
ridge_refit <- NErefit3[[3]][[i]] #ridge fit
refit_cv <- NErefit3[[6]][[i]] #ridge cv

refit_cv$lambda.1se
refit_cv$lambda.min

set.seed(300)
#ridge_cv <- cv.glmnet(X_new, y, alpha = 0.00, nfolds = 5)
#ridge_fit <- glmnet(X_new, y, alpha = 0.00)

#save this for later
plot(refit_cv)
plot(ridge_refit, xvar = "dev")

#TODO: also test predictions with: refit_cv$lambda.min
NEAus3_pred <- predict(ridge_refit, X_new, s = refit_cv$lambda.min, type = "response")

#sort by year
NE3_yhat <- c()
for (j in 1:19) {
  NE3_yhat <- c(NE3_yhat, NEAus3_pred[seq(j, 76, by = 19)])
}


```

```{r NEAus4_pred}
i <- 17 #lambda choice

NEaus_main <- NEcoefs4[[i]][[1]] #main effects
NEaus_int <- NEcoefs4[[i]][[2]] #interaction effects

model_string <- paste( paste(NEaus_main$Main_Effect, collapse = " + "),
                       paste(NEaus_int$Interact_Effect, collapse = " + "),
                       sep = " + ")

model_string <- paste0("y ~ ", model_string)

y = as.numeric(NE_resp[[4]])
X = cbind(as.matrix(NE_preds[[4]][ ,1:260]),
          as.matrix(NE_preds_q75[[4]][ ,1:104])  )

coef_names <- c(colnames(NE_preds[[4]]), paste0( "IND_", colnames(NE_preds_q75[[4]][ ,1:104]) ) )
colnames(X) <- coef_names

#ridge model
X_df <- as.data.frame(X)
f <- as.formula(model_string)
X_new <- model.matrix(f, X_df)

#from refits
ridge_refit <- NErefit4[[3]][[i]] #ridge fit
refit_cv <- NErefit4[[6]][[i]] #ridge cv

refit_cv$lambda.1se
refit_cv$lambda.min

set.seed(300)
#ridge_cv <- cv.glmnet(X_new, y, alpha = 0.00, nfolds = 5)
#ridge_fit <- glmnet(X_new, y, alpha = 0.00)

#save this for later
plot(refit_cv)
plot(ridge_refit, xvar = "dev")

#TODO: also test predictions with: refit_cv$lambda.min
NEAus4_pred <- predict(ridge_refit, X_new, s = refit_cv$lambda.min, type = "response")

#sort by year
NE4_yhat <- c()
for (j in 1:19) {
  NE4_yhat <- c(NE4_yhat, NEAus4_pred[seq(j, 209, by = 19)])
}

```

## SE Aus

```{r SEAus1_pred}
i <- 10 #lambda choice

SEaus_main <- SEcoefs1[[i]][[1]] #main effects
SEaus_int <- SEcoefs1[[i]][[2]] #interaction effects

model_string <- paste( paste(SEaus_main$Main_Effect, collapse = " + "),
                       paste(SEaus_int$Interact_Effect, collapse = " + "),
                       sep = " + ")

model_string <- paste0("y ~ ", model_string)

y = as.numeric(SE_resp[[1]])
X = cbind(as.matrix(SE_preds[[1]][ ,1:260]),
          as.matrix(SE_preds_q75[[1]][ ,1:104])  )

coef_names <- c(colnames(SE_preds[[1]]), paste0( "IND_", colnames(SE_preds_q75[[1]][ ,1:104]) ) )
colnames(X) <- coef_names

#ridge model
X_df <- as.data.frame(X)
f <- as.formula(model_string)
X_new <- model.matrix(f, X_df)

#from refits
ridge_refit <- SErefit1[[3]][[i]] #ridge fit
refit_cv <- SErefit1[[6]][[i]] #ridge cv

refit_cv$lambda.1se
refit_cv$lambda.min

set.seed(300)
#ridge_cv <- cv.glmnet(X_new, y, alpha = 0.00, nfolds = 5)
#ridge_fit <- glmnet(X_new, y, alpha = 0.00)

#save this for later
plot(refit_cv)
plot(ridge_refit, xvar = "dev")

#TODO: also test predictions with: refit_cv$lambda.min
SEAus1_pred <- predict(ridge_refit, X_new, s = refit_cv$lambda.min, type = "response")

#sort by year
SE1_yhat <- c()
for (j in 1:19) {
  SE1_yhat <- c(SE1_yhat, SEAus1_pred[seq(j, 133, by = 19)])
}


```

```{r SEAus2_pred}
i <- 14 #lambda choice

SEaus_main <- SEcoefs2[[i]][[1]] #main effects
SEaus_int <- SEcoefs2[[i]][[2]] #interaction effects

model_string <- paste( paste(SEaus_main$Main_Effect, collapse = " + "),
                       paste(SEaus_int$Interact_Effect, collapse = " + "),
                       sep = " + ")

model_string <- paste0("y ~ ", model_string)

y = as.numeric(SE_resp[[2]])
X = cbind(as.matrix(SE_preds[[2]][ ,1:260]),
          as.matrix(SE_preds_q75[[2]][ ,1:104])  )

coef_names <- c(colnames(SE_preds[[2]]), paste0( "IND_", colnames(SE_preds_q75[[2]][ ,1:104]) ) )
colnames(X) <- coef_names

#ridge model
X_df <- as.data.frame(X)
f <- as.formula(model_string)
X_new <- model.matrix(f, X_df)

#from refits
ridge_refit <- SErefit2[[3]][[i]] #ridge fit
refit_cv <- SErefit2[[6]][[i]] #ridge cv

refit_cv$lambda.1se
refit_cv$lambda.min

set.seed(300)
#ridge_cv <- cv.glmnet(X_new, y, alpha = 0.00, nfolds = 5)
#ridge_fit <- glmnet(X_new, y, alpha = 0.00)

#save this for later
plot(refit_cv)
plot(ridge_refit, xvar = "dev")

#TODO: also test predictions with: refit_cv$lambda.min
SEAus2_pred <- predict(ridge_refit, X_new, s = refit_cv$lambda.min, type = "response")


#sort by year
SE2_yhat <- c()
for (j in 1:19) {
  SE2_yhat <- c(SE2_yhat, SEAus2_pred[seq(j, 171, by = 19)])
}

```

```{r SEAus3_pred}
i <- 15 #lambda choice

SEaus_main <- SEcoefs3[[i]][[1]] #main effects
SEaus_int <- SEcoefs3[[i]][[2]] #interaction effects

model_string <- paste( paste(SEaus_main$Main_Effect, collapse = " + "),
                       paste(SEaus_int$Interact_Effect, collapse = " + "),
                       sep = " + ")

model_string <- paste0("y ~ ", model_string)

y = as.numeric(SE_resp[[3]])
X = cbind(as.matrix(SE_preds[[3]][ ,1:260]),
          as.matrix(SE_preds_q75[[3]][ ,1:104])  )

coef_names <- c(colnames(SE_preds[[3]]), paste0( "IND_", colnames(SE_preds_q75[[3]][ ,1:104]) ) )
colnames(X) <- coef_names

#ridge model
X_df <- as.data.frame(X)
f <- as.formula(model_string)
X_new <- model.matrix(f, X_df)

#from refits
ridge_refit <- SErefit3[[3]][[i]] #ridge fit
refit_cv <- SErefit3[[6]][[i]] #ridge cv

refit_cv$lambda.1se
refit_cv$lambda.min

set.seed(300)
#ridge_cv <- cv.glmnet(X_new, y, alpha = 0.00, nfolds = 5)
#ridge_fit <- glmnet(X_new, y, alpha = 0.00)

#save this for later
plot(refit_cv)
plot(ridge_refit, xvar = "dev")

#TODO: also test predictions with: refit_cv$lambda.min
SEAus3_pred <- predict(ridge_refit, X_new, s = refit_cv$lambda.min, type = "response")

#sort by year
SE3_yhat <- c()
for (j in 1:19) {
  SE3_yhat <- c(SE3_yhat, SEAus3_pred[seq(j, 76, by = 19)])
}

```

```{r SEAus4_pred}
i <- 14 #lambda choice

SEaus_main <- SEcoefs4[[i]][[1]] #main effects
SEaus_int <- SEcoefs4[[i]][[2]] #interaction effects

model_string <- paste( paste(SEaus_main$Main_Effect, collapse = " + "),
                       paste(SEaus_int$Interact_Effect, collapse = " + "),
                       sep = " + ")

model_string <- paste0("y ~ ", model_string)

y = as.numeric(SE_resp[[4]])
X = cbind(as.matrix(SE_preds[[4]][ ,1:260]),
          as.matrix(SE_preds_q75[[4]][ ,1:104])  )

coef_names <- c(colnames(SE_preds[[4]]), paste0( "IND_", colnames(SE_preds_q75[[4]][ ,1:104]) ) )
colnames(X) <- coef_names

#ridge model
X_df <- as.data.frame(X)
f <- as.formula(model_string)
X_new <- model.matrix(f, X_df)

#from refits
ridge_refit <- SErefit4[[3]][[i]] #ridge fit
refit_cv <- SErefit4[[6]][[i]] #ridge cv

refit_cv$lambda.1se
refit_cv$lambda.min

set.seed(300)
#ridge_cv <- cv.glmnet(X_new, y, alpha = 0.00, nfolds = 5)
#ridge_fit <- glmnet(X_new, y, alpha = 0.00)

#save this for later
plot(refit_cv)
plot(ridge_refit, xvar = "dev")

#TODO: also test predictions with: refit_cv$lambda.min
SEAus4_pred <- predict(ridge_refit, X_new, s = refit_cv$lambda.min, type = "response")

#sort by year
SE4_yhat <- c()
for (j in 1:19) {
  SE4_yhat <- c(SE4_yhat, SEAus4_pred[seq(j, 228, by = 19)])
}

```

# Prediction Plot

TODO: clean up the density of some of these plots, it's a bit much

```{r setup}
#extract seasons
#TODO: adjust so that we can assign values outside of season (For ploting)
new_resp <- bounded_resp_df[which(bounded_resp_df$week %in% season_weeks, arr.ind = TRUE), ]
new_resp <- new_resp[-c(1:14), ]

#setup vertical year lines
unique_yr <- unique(year(new_resp$time))
year_lines <- c(unique_yr[1:length(unique_yr)])
year_lines <- paste0(year_lines, "0101")
year_lines <- as_date(year_lines)

#year_text <- year_lines
#year_text <- as_date(year_text) + months(6)
year_text <- year_lines + months(6)

xlim_val <- ymd(c("20010829", "20200401"))

temp_SE <- scale(new_resp$SE_Aus_anomaly_co, center = TRUE, scale = FALSE) 
temp_NE <- scale(new_resp$NE_Aus_anomaly_co, center = TRUE, scale = FALSE) 

temp_time <- as.Date(new_resp$time)

```

## NE Aus

```{r NEAus1_viz}
NEAus1_resp <- new_resp[new_resp$week %in% season_weeks[1:12],]

time_shift <- new_resp[which(new_resp$week %in% season_weeks[1:12]) + rep(0:11, 19), ]

temp_NE <- scale(NEAus1_resp$NE_Aus_anomaly_co, center = TRUE, scale = FALSE) 

temp_time <- as.Date(time_shift$time)

NEAus1_df <- data.frame(time = temp_time, true = temp_NE, pred = NE1_yhat)

sqrt(mean((NEAus1_df$true - NEAus1_df$pred)^2))

setwd("~/CO_AUS/Aus_CO-main/Interactions")
  
png(filename = "NE1_preds.png", width = 2500, height = 1000, res = 200)
par(mar = c(3,5,4,1))
plot(x = NEAus1_df$time, y = NEAus1_df$true, pch = 18, 
     col = "black", xlim = xlim_val, cex = 1.33,
     xaxt = "n",  xlab = "",
     ylab = "CO Anomaly", 
     main = "NE Aus Group 1 : Predictions")
points(x = NEAus1_df$time, y = NEAus1_df$pred, pch = 17, 
     col = "magenta3", cex = 1)
abline(v = year_lines[-1], lty = 2)
abline(h = 0, lty = 2)
legend("bottomleft", inset = c(0.00, 0),
       legend = c("True", "Pred"),
       col = c("black", "magenta3"),
       pch = c(18,17),
       pt.cex = c(1.33,1))
text(x = c(ymd("2019-01-01")),
     y=c(30,27.5),
     labels = c("RMSE = 6.124", "cv R^2 = 0.674"),
     col = "grey40")
axis(side = 1, at = year_text, labels = unique_yr, tick = FALSE, cex.axis = 1)
dev.off()
```

```{r NEAus2_viz}
NEAus2_resp <- new_resp[new_resp$week %in% season_weeks[13:17],]

time_shift <- new_resp[which(new_resp$week %in% season_weeks[13:17]) + rep(-2:2, 19), ]

temp_NE <- scale(NEAus2_resp$NE_Aus_anomaly_co, center = TRUE, scale = FALSE) 

temp_time <- as.Date(time_shift$time)

NEAus2_df <- data.frame(time = temp_time, true = temp_NE, pred = NE2_yhat)

sqrt(mean((NEAus2_df$true - NEAus2_df$pred)^2))

setwd("~/CO_AUS/Aus_CO-main/Interactions")
  
png(filename = "NE2_preds.png", width = 2500, height = 1000, res = 200)
par(mar = c(3,5,4,1))
plot(x = NEAus2_df$time, y = NEAus2_df$true, pch = 18, 
     col = "black", xlim = xlim_val, cex = 1.33,
     xaxt = "n",  xlab = "",
     ylab = "CO Anomaly", 
     main = "NE Aus Group 2 : Predictions")
points(x = NEAus2_df$time, y = NEAus2_df$pred, pch = 17, 
     col = "magenta3", cex = 1)
abline(v = year_lines[-1], lty = 2)
abline(h = 0, lty = 2)
legend("bottomleft", inset = c(0.00, 0),
       legend = c("True", "Pred"),
       col = c("black", "magenta3"),
       pch = c(18,17),
       pt.cex = c(1.33,1))
text(x = c(ymd("2019-01-01")),
     y=c(23, 21),
     labels = c("RMSE = 3.571", "cv R^2 = 0.743"),
     col = "grey40")
axis(side = 1, at = year_text, labels = unique_yr, tick = FALSE, cex.axis = 1)
dev.off()

```

```{r NEAus3_viz}
NEAus3_resp <- new_resp[new_resp$week %in% season_weeks[18:21],]

time_shift <- new_resp[which(new_resp$week %in% season_weeks[18:21]) + rep(-1:2, 19), ]

temp_NE <- scale(NEAus3_resp$NE_Aus_anomaly_co, center = TRUE, scale = FALSE) 

temp_time <- as.Date(time_shift$time)

NEAus3_df <- data.frame(time = temp_time, true = temp_NE, pred = NE3_yhat)

sqrt(mean((NEAus3_df$true - NEAus3_df$pred)^2))

setwd("~/CO_AUS/Aus_CO-main/Interactions")
  
png(filename = "NE3_preds.png", width = 2500, height = 1000, res = 200)
par(mar = c(3,5,4,1))
plot(x = NEAus3_df$time, y = NEAus3_df$true, pch = 18, 
     col = "black", xlim = xlim_val, cex = 1.33,
     xaxt = "n",  xlab = "",
     ylab = "CO Anomaly", 
     main = "NE Aus Group 3 : Predictions")
points(x = NEAus3_df$time, y = NEAus3_df$pred, pch = 17, 
     col = "magenta3", cex = 1)
abline(v = year_lines[-1], lty = 2)
abline(h = 0, lty = 2)
legend("bottomleft", inset = c(0.00, 0),
       legend = c("True", "Pred"),
       col = c("black", "magenta3"),
       pch = c(18,17),
       pt.cex = c(1.33,1))
text(x = c(ymd("2018-04-01")),
     y=c(30, 27),
     labels = c("RMSE = 3.434", "cv R^2 = 0.737"),
     col = "grey40")
axis(side = 1, at = year_text, labels = unique_yr, tick = FALSE, cex.axis = 1)
dev.off()
```

```{r NEAus4_viz}
NEAus4_resp <- new_resp[new_resp$week %in% season_weeks[22:32],]

time_shift <- new_resp[which(new_resp$week %in% season_weeks[22:32]) + rep(-10:0, 19), ]

temp_NE <- scale(NEAus4_resp$NE_Aus_anomaly_co, center = TRUE, scale = FALSE) 

temp_time <- as.Date(time_shift$time)

NEAus4_df <- data.frame(time = temp_time, true = temp_NE, pred = NE4_yhat)

sqrt(mean((NEAus4_df$true - NEAus4_df$pred)^2))

setwd("~/CO_AUS/Aus_CO-main/Interactions")
  
png(filename = "NE4_preds.png", width = 2500, height = 1000, res = 200)
par(mar = c(3,5,4,1))
plot(x = NEAus4_df$time, y = NEAus4_df$true, pch = 18, 
     col = "black", xlim = xlim_val, cex = 1.33,
     xaxt = "n",  xlab = "",
     ylab = "CO Anomaly", 
     main = "NE Aus Group 4 : Predictions")
points(x = NEAus4_df$time, y = NEAus4_df$pred, pch = 17, 
     col = "magenta3", cex = 1)
abline(v = year_lines[-1], lty = 2)
abline(h = 0, lty = 2)
legend("bottomleft", inset = c(0.00, 0),
       legend = c("True", "Pred"),
       col = c("black", "magenta3"),
       pch = c(18,17),
       pt.cex = c(1.33,1))
text(x = c(ymd("2019-01-01")),
     y=c(19, 17),
     labels = c("RMSE = 2.613", "cv R^2 = 0.674"),
     col = "grey40")
axis(side = 1, at = year_text, labels = unique_yr, tick = FALSE, cex.axis = 1)
dev.off()
```


## SE Aus

Group 1 has nice spacing, make adjustments to setup for this to work

```{r SEAus1_viz}
SEAus1_resp <- new_resp[new_resp$week %in% season_weeks[1:7], ]

time_shift <- new_resp[which(new_resp$week %in% season_weeks[1:7]) + rep(0:6, 19)*2, ]

temp_SE <- scale(SEAus1_resp$SE_Aus_anomaly_co, center = TRUE, scale = FALSE) 
temp_time <- as.Date(time_shift$time)

SEAus1_df <- data.frame(time = temp_time, true = temp_SE, pred = SE1_yhat)

sqrt(mean((SEAus1_df$true - SEAus1_df$pred)^2))

setwd("~/CO_AUS/Aus_CO-main/Interactions")
  
png(filename = "SE1_preds.png", width = 2500, height = 1000, res = 200)
par(mar = c(3,5,4,1))
plot(x = SEAus1_df$time, y = SEAus1_df$true, pch = 18, 
     col = "black", xlim = xlim_val, cex = 1.33,
     xaxt = "n",  xlab = "",
     ylab = "CO Anomaly", 
     main = "SE Aus Group 1 : Predictions")
points(x = SEAus1_df$time, y = SEAus1_df$pred, pch = 17, 
     col = "magenta3", cex = 1)
abline(v = year_lines[-1], lty = 2)
abline(h = 0, lty = 2)
legend("bottomleft", inset = c(0.00, 0),
       legend = c("True", "Pred"),
       col = c("black", "magenta3"),
       pch = c(18,17),
       pt.cex = c(1.33,1))
text(x = c(ymd("2019-01-01")),
     y=c(22, 20),
     labels = c("RMSE = 5.666", "cv R^2 = 0.487"),
     col = "grey40")
axis(side = 1, at = year_text, labels = unique_yr, tick = FALSE, cex.axis = 1)
dev.off()
```

```{r SEAus2_viz}
SEAus2_resp <- new_resp[new_resp$week %in% season_weeks[8:16], ]

time_shift <- new_resp[which(new_resp$week %in% season_weeks[8:16]) + rep(-5:3, 19), ]

temp_SE <- scale(SEAus2_resp$SE_Aus_anomaly_co, center = TRUE, scale = FALSE) 
temp_time <- as.Date(time_shift$time)

SEAus2_df <- data.frame(time = temp_time, true = temp_SE, pred = SE2_yhat)

sqrt(mean((SEAus2_df$true - SEAus2_df$pred)^2))

setwd("~/CO_AUS/Aus_CO-main/Interactions")
  
png(filename = "SE2_preds.png", width = 2500, height = 1000, res = 200)
par(mar = c(3,5,4,1))
plot(x = SEAus2_df$time, y = SEAus2_df$true, pch = 18, 
     col = "black", xlim = xlim_val, cex = 1.33,
     xaxt = "n",  xlab = "",
     ylab = "CO Anomaly", 
     main = "SE Aus Group 2 : Predictions")
points(x = SEAus2_df$time, y = SEAus2_df$pred, pch = 17, 
     col = "magenta3", cex = 1)
abline(v = year_lines[-1], lty = 2)
abline(h = 0, lty = 2)
legend("bottomleft", inset = c(0.00, 0),
       legend = c("True", "Pred"),
       col = c("black", "magenta3"),
       pch = c(18,17),
       pt.cex = c(1.33,1))
text(x = c(ymd("2019-01-01")),
     y=c(29, 26.5),
     labels = c("RMSE = 4.532", "cv R^2 = 0.601"),
     col = "grey40")
axis(side = 1, at = year_text, labels = unique_yr, tick = FALSE, cex.axis = 1)
dev.off()
```

```{r SEAus3_viz}
SEAus3_resp <- new_resp[new_resp$week %in% season_weeks[17:20], ]

time_shift <- new_resp[which(new_resp$week %in% season_weeks[17:20]) + rep(-2:1, 19), ]

temp_SE <- scale(SEAus3_resp$SE_Aus_anomaly_co, center = TRUE, scale = FALSE) 
temp_time <- as.Date(time_shift$time)

SEAus3_df <- data.frame(time = temp_time, true = temp_SE, pred = SE3_yhat)

sqrt(mean((SEAus3_df$true - SEAus3_df$pred)^2))

setwd("~/CO_AUS/Aus_CO-main/Interactions")
  
png(filename = "SE3_preds.png", width = 2500, height = 1000, res = 200)
par(mar = c(3,5,4,1))
plot(x = SEAus3_df$time, y = SEAus3_df$true, pch = 18, 
     col = "black", xlim = xlim_val, cex = 1.33,
     xaxt = "n",  xlab = "",
     ylab = "CO Anomaly", 
     main = "SE Aus Group 3 : Predictions")
points(x = SEAus3_df$time, y = SEAus3_df$pred, pch = 17, 
     col = "magenta3", cex = 1)
abline(v = year_lines[-1], lty = 2)
abline(h = 0, lty = 2)
legend("bottomleft", inset = c(0.00, 0),
       legend = c("True", "Pred"),
       col = c("black", "magenta3"),
       pch = c(18,17),
       pt.cex = c(1.33,1))
text(x = c(ymd("2018-01-01")),
     y=c(43, 40),
     labels = c("RMSE = 4.315", "cv R^2 = 0.804"),
     col = "grey40")
axis(side = 1, at = year_text, labels = unique_yr, tick = FALSE, cex.axis = 1)
dev.off()
```

```{r SEAus4_viz}
SEAus4_resp <- new_resp[new_resp$week %in% season_weeks[21:32], ]

time_shift <- new_resp[which(new_resp$week %in% season_weeks[21:32]) + rep(-11:0, 19), ]

temp_SE <- scale(SEAus4_resp$SE_Aus_anomaly_co, center = TRUE, scale = FALSE) 
temp_time <- as.Date(time_shift$time)

SEAus4_df <- data.frame(time = temp_time, true = temp_SE, pred = SE4_yhat)
sqrt(mean((SEAus4_df$true - SEAus4_df$pred)^2))

setwd("~/CO_AUS/Aus_CO-main/Interactions")
  
png(filename = "SE4_preds.png", width = 2500, height = 1000, res = 200)
par(mar = c(3,5,4,1))
plot(x = SEAus4_df$time, y = SEAus4_df$true, pch = 18, 
     col = "black", xlim = xlim_val, cex = 1.33,
     xaxt = "n",  xlab = "",
     ylab = "CO Anomaly", 
     main = "SE Aus Group 4 : Predictions")
points(x = SEAus4_df$time, y = SEAus4_df$pred, pch = 17, 
     col = "magenta3", cex = 1)
abline(v = year_lines[-1], lty = 2)
abline(h = 0, lty = 2)
legend("bottomleft", inset = c(0.00, 0),
       legend = c("True", "Pred"),
       col = c("black", "magenta3"),
       pch = c(18,17),
       pt.cex = c(1.33,1))
text(x = c(ymd("2019-01-01")),
     y=c(21, 19),
     labels = c("RMSE = 2.689", "cv R^2 = 0.562"),
     col = "grey40")
axis(side = 1, at = year_text, labels = unique_yr, tick = FALSE, cex.axis = 1)
dev.off()
```


