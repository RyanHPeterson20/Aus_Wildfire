---
title: "new_interaction"
author: "Ryan Peterson"
date: "2025-03-06"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r library}
suppressMessages( library(hierNet))

suppressMessages( library( colorspace)) #for some color alternatives
```

```{r data_functions}
# Data Set-Up
setwd("~/CO_AUS/Aus_CO-main/Interactions")

load( "Data/ne_data.rda")
load( "Data/se_data.rda")
load( "Data/bounded_data.rda")
load( "Data/data_matrix.rda")
load( "Data/lag_list.rda")
load( "Data/data_quantile.rda")

#functions:
source("group_functions.R") #grouping/clustering
```

Goal of this is to include interaction terms into our methodology.

Beginning with:
1. hierNet
2. Adding indicator terms into Will's quadratic fit. 
3. Other hierarchical methods.

#1 HierNet

Notes on HierNet:
- Use weak hierarchy to start
- Slowly build up with increasing "groups" of parameters.

Using different response groupings:
1. Base response clusters (e.g 4 groups)
2. Split response groups (2 groups; early/late)
3. Full response for each region

## Base Response Groups

NE Groups:
1. Weeks 35-46; Index 1-12
2. Weeks 47-51; Index 13-17
3. Weeks 52,1-3; Index 18-21
4. Weeks 4-14; Index 22-32

SE Groups:
1. Weeks 35-41; Index 1-7
2. Weeks 42-50; Index 8-16
3. Weeks 51,52,1,2; Index 17-20
4. Weeks 3-14; Index 21-32

```{r setup}
#set up 

#season years/weeks
season_weeks <- c(35:52, 1:14)
season_years <- unique(bounded_resp_df$year)

seasons <- c()
for (i in 1:(length(season_years)-1)) {
  temp_season <- paste0(season_years[i], "-", season_years[i+1])
  #print(temp_season)  
  seasons <- c(seasons, temp_season)
}
rm(i, temp_season)

#center response data
NEbase_matrix <- scale(resp_matrix[ ,1:32], center = TRUE, scale = FALSE)
SEbase_matrix <- scale(resp_matrix[ ,33:64], center = TRUE, scale = FALSE)

#group response matrices
#NEAus
NEAus_1 <- NEbase_matrix[ ,1:12] #early season
NEAus_2 <- NEbase_matrix[ ,13:17] #primary NE fire season
NEAus_3 <- NEbase_matrix[ ,18:21] #feedback from SE
NEAus_4 <- NEbase_matrix[ ,22:32] #late season

#SEAus
SEAus_1 <- SEbase_matrix[ ,1:7] #early season
SEAus_2 <- SEbase_matrix[ ,8:16] #feedback from NE
SEAus_3 <- SEbase_matrix[ ,17:20] #primary SE fire season
SEAus_4 <- SEbase_matrix[ ,21:32] #late season

NEAus_mat <- list(NEAus_1, NEAus_2, NEAus_3, NEAus_4)
SEAus_mat <- list(SEAus_1, SEAus_2, SEAus_3, SEAus_4)

rm(NEAus_1, NEAus_2, NEAus_3, NEAus_4, SEAus_1, SEAus_2, SEAus_3, SEAus_4)
```

```{r model_data}
#full model
NE_preds <- NElag_grouping(NE_laglist = NE_laglist_std, j = -c(19))
NE_resp <- NEresp_grouping(NEAus_mat = NEAus_mat, j = -c(19))

SE_preds <- SElag_grouping(SE_laglist = SE_laglist_std, j = -c(19))
SE_resp <- SEresp_grouping(SEAus_mat = SEAus_mat, j = -c(19))

#quantile 90 indicator
NE_preds_q90 <- NElag_grouping(NE_laglist = NE_laglist_q90, j = -c(19))
SE_preds_q90 <- SElag_grouping(SE_laglist = SE_laglist_q90, j = -c(19))

#quantile 75 indicator
NE_preds_q75 <- NElag_grouping(NE_laglist = NE_laglist_q75, j = -c(19))
SE_preds_q75 <- SElag_grouping(SE_laglist = SE_laglist_q75, j = -c(19))
```

### Testing (Building-up Model)

Develop hierNet with simpler combinations
-Nino + DMI

```{r test_block}

#TODO: change to for loop over all groups

#testing with NE group 1
y_1 <- cbind(as.numeric(NE_resp[[1]]))
y_1 <- as.numeric(y_1[,1])

#using only nino/dmi
X_1 <- as.matrix(NE_preds[[1]][,1:104]) 

#path -> cv -> fit
test_path <- hierNet.path( X_1, y_1, strong = FALSE, diagonal = TRUE)
test_cv <- hierNet.cv(test_path, X_1, y_1, nfolds = 5)
plot(test_cv)

test_fit <- hierNet(X_1, y_1, lam = test_cv$lamhat, strong = FALSE, diagonal = TRUE)

```

```{r predict}
#TODO: do full season predictions (Create nice in/out of sample preds along with residual plots)
yhat <- predict(test_fit, X_1)

resids <- yhat - y_1
plot(1:216, resids, pch = 16)
abline(h = 0, lty = 2)

plot(1:24, y_1[1:24],  type = "l")
lines(1:24, yhat[1:24], col = "magenta3")
abline(h = 0, lty = 2)

plot(25:36, y_1[25:36],  type = "l", ylim = range(y_1[25:36], yhat[25:36]))
lines(25:36, yhat[25:36], col = "magenta3")
abline(h = 0, lty = 2)
```


```{r var_imp}
var_imp <- hierNet.varimp(test_fit, X_1, y_1)

plot(var_imp[,1], var_imp[,2], pch = 16)
```


```{r coefs}

#TODO: get a good description of interactions
test_coef <- test_fit$bp-test_fit$bn

plot(1:52, test_coef[1:52], pch = 16, col = "red3")
points(1:52, test_coef[53:104], pch = 16, col = "blue3")
abline(h = 0)

set.panel(1,2)
image.plot(test_fit$th[ ,1:52], col = diverge_hsv(256))
image.plot(test_fit$th, col = diverge_hsv(256))
abline(h=0.5, lty = 2)

th_nino <- test_fit$th[1:52, 1:52]
th_dmi <- test_fit$th[53:104, 53:104]

nino_int <- which(th_nino !=0, arr.ind = TRUE)
dmi_int <- which(th_dmi !=0, arr.ind = TRUE)
#TODO: add coefs into the above matrices (change to df)

image.plot(test_fit$th[1:52, 1:52], col = diverge_hsv(256))
image.plot(test_fit$th[53:104, 53:104], col = diverge_hsv(256))

#temp <- (th+t(th))/2
#test_interact <- which(temp !=0, arr.ind = TRUE)


test_int[1:42,]

```


