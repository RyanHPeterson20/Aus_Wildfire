---
title: "IOD_sst_prep"
author: "Ryan Peterson"
date: "2025-08-22"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r library}
#.nc files
suppressMessages(library(ncdf4))
suppressMessages(library(terra))

# date/data mgmt
suppressMessages(library(lubridate))
suppressMessages(library(abind))

#visualization and interpolation
suppressMessages(library(fields))
suppressMessages(library(colorspace))
suppressMessages(library(RColorBrewer))
suppressMessages(library(scales)) #for adjusting opacity
```

Data Prep file for the following reanalysis products:

1. GODAS (NCEP Global Ocean Data Assimilation System from 1980 to 2019)
  a. Resolution:
2. ORA-S5 (ECMWF Ocean Reanalysis System 5 from 1979 to 2018)
  a. Resolution
3. OISST v2 (NOAA Optimum Interpolation SST version 2 from 1982 to 2019)
  a. Resolution
4. SODA3.3.1 (Simple Ocean Data Assimilation version 3.3.1 from 1980 to 2015)
  a. Resolution


Goal: be able to produce flexible (wrt spatial grid and time) sst arrays for each data product

Note: we are moving all the associated EOF prep files to here then moving them elsewhere.

# Set-up

```{r ranges}
#indian ocean region
wide_maxLon <- 120
wide_minLon <- 30
wide_maxLat <- 20
wide_minLat <- -20

#DMI west/WTIO (50, -10) X (70, 10) 
wDMI_maxLon <- 70
wDMI_minLon <- 50
wDMI_maxLat <- 10
wDMI_minLat <- -10

#DMI east/SETIO (90, -10) X (110, 0)
eDMI_maxLon <- 110
eDMI_minLon <- 90
eDMI_maxLat <- 0
eDMI_minLat <- -10

#pIOD (40, -5) X (100, 5)
pIOD_maxLon <- 100
pIOD_minLon <- 40 
pIOD_maxLat <- 5
pIOD_minLat <- -5

```

```{r grid_points}
#setup grid points for 1x1 degree resolution.
#lon.wide <- seq(wide_minLon+0.5, wide_maxLon-0.5, by = 1)
#lat.wide <- seq(wide_minLat+0.5, wide_maxLat-0.5, by = 1)

lon.wide <- seq(wide_minLon, wide_maxLon, by = 1)
lat.wide <- seq(wide_minLat, wide_maxLat, by = 1)

#grid list from 
grid.list <- list(x = lon.wide,
                  y = lat.wide)


#TODO: rm() region boundaries after all the points and ranges are setup
```


# GODAS

```{r GODAS_import}
setwd("~/CO_AUS/Aus_CO-main")

#GODAS data only (yearly .nc 1982-2015)
#1982
nc.GODAS.1982 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1982.nc")

#1983
nc.GODAS.1983 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1983.nc")

#1984
nc.GODAS.1984 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1984.nc")

#1985
nc.GODAS.1985 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1985.nc")

#1986
nc.GODAS.1986 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1986.nc")

#1987
nc.GODAS.1987 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1987.nc")

#1988
nc.GODAS.1988 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1988.nc")

#1989
nc.GODAS.1989 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1989.nc")

#1990
nc.GODAS.1990 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1990.nc")

#1991
nc.GODAS.1991 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1991.nc")

#1992
nc.GODAS.1992 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1992.nc")

#1993
nc.GODAS.1993 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1993.nc")

#1994
nc.GODAS.1994 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1994.nc")

#1995
nc.GODAS.1995 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1995.nc")

#1996
nc.GODAS.1996 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1996.nc")

#1997
nc.GODAS.1997 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1997.nc")

#1998
nc.GODAS.1998 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1998.nc")

#1999
nc.GODAS.1999 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1999.nc")

#2000
nc.GODAS.2000 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2000.nc")

#2001
nc.GODAS.2001 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2001.nc")

#2002
nc.GODAS.2002 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2002.nc")

#2003
nc.GODAS.2003 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2003.nc")

#2004
nc.GODAS.2004 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2004.nc")

#2005
nc.GODAS.2005 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2005.nc")

#2006
nc.GODAS.2006 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2006.nc")

#2007
nc.GODAS.2007 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2007.nc")

#2008
nc.GODAS.2008 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2008.nc")

#2009
nc.GODAS.2009 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2009.nc")

#2010
nc.GODAS.2010 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2010.nc")

#2011
nc.GODAS.2011 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2011.nc")

#2012
nc.GODAS.2012 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2012.nc")

#2013
nc.GODAS.2013 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2013.nc")

#2014
nc.GODAS.2014 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2014.nc")

#2015
nc.GODAS.2015 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2015.nc")

```

```{r additional_GODAS_import}
#include back to 1980
#1980
nc.GODAS.1980 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1980.nc")

#1981
nc.GODAS.1981 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.1981.nc")

#include up to 2019
#2016
nc.GODAS.2016 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2016.nc")

#2017
nc.GODAS.2017 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2017.nc")

#2018
nc.GODAS.2018 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2018.nc")

#2019
nc.GODAS.2019 <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/pottmp.2019.nc")
```


## GODAS Functions

```{r prep_functions}
#sorting/extraction of godas .nc data
godas_prep <- function(nc.data){
  
  #extract lon.lat
  lon.grid.temp <- nc.data[["dim"]][["lon"]][["vals"]]
  lat.grid.temp <- nc.data[["dim"]][["lat"]][["vals"]]
  
  #reorder lon for 
  lon.grid.temp[lon.grid.temp >= 180] <- lon.grid.temp[lon.grid.temp >= 180] - 360
  lon.order.temp <- order(lon.grid.temp)
  
  lon.grid.temp <- lon.grid.temp[lon.order.temp]
  
  #reorder lat
  lat.order.temp <- order(lat.grid.temp, decreasing = TRUE)
  lat.grid.temp <- lat.grid.temp[lat.order.temp]
  
  #times for months
  times.temp <- ncvar_get(nc.data, "time") # days since 1800-01-01 00:00:0.0
  times.temp <- as_datetime("1800-01-01T00:00:00") + days(times.temp)
  
  #temps, as array (lon, lat, level, time)
  #TODO adjust from K to c (K - 273.15)
  sst.temp <- ncvar_get(nc.data, "pottmp")
  sst.temp <- sst.temp[lon.order.temp, lat.order.temp, 1, ] #level: depth 5m
  
  #adjust to C from K (c = K - 273.15)
  sst.temp <- sst.temp - 273.15
  
  #return lon, lat, time, sst
  return(list(
    lon = lon.grid.temp,
    lat = lat.grid.temp,
    time = times.temp,
    sst = sst.temp
  ))
}


```

## GODAS Data Setup

```{r data_cleaning}
#data cleaning 
godas_list <- list(nc.GODAS.1982, nc.GODAS.1983, nc.GODAS.1984, nc.GODAS.1985, nc.GODAS.1986, 
                   nc.GODAS.1987, nc.GODAS.1988, nc.GODAS.1989, nc.GODAS.1990, nc.GODAS.1991,
                   nc.GODAS.1992, nc.GODAS.1993, nc.GODAS.1994, nc.GODAS.1995, nc.GODAS.1996,
                   nc.GODAS.1997, nc.GODAS.1998, nc.GODAS.1999, nc.GODAS.2000, nc.GODAS.2001,
                   nc.GODAS.2002, nc.GODAS.2003, nc.GODAS.2004, nc.GODAS.2005, nc.GODAS.2006,
                   nc.GODAS.2007, nc.GODAS.2008, nc.GODAS.2009, nc.GODAS.2010, nc.GODAS.2011,
                   nc.GODAS.2012, nc.GODAS.2013, nc.GODAS.2014, nc.GODAS.2015)

#get lon, lat, sst, and times
sst.GODAS.new <- NULL
for (i in 1:length(godas_list)) {
  nc.temp <- godas_list[[i]] 
  
  temp.nc.godas <- godas_prep(nc.temp)
  temp.lon <- temp.nc.godas$lon
  temp.lat <- temp.nc.godas$lat
  temp.sst <- temp.nc.godas$sst
  
  #get reduce range (indian ocean region)
  new.lon <- temp.lon[temp.lon <= wide_maxLon & temp.lon >= wide_minLon]
  lon.range <- range(which(temp.lon <= wide_maxLon & temp.lon >= wide_minLon))
  new.lat <- temp.lat[temp.lat <= wide_maxLat & temp.lat >= wide_minLat]
  lat.range <- range(which(temp.lat <= wide_maxLat & temp.lat >= wide_minLat))
  
  new.sst <- temp.sst[lon.range[1]:lon.range[2], lat.range[1]:lat.range[2], ]
  
  #interpolate to 1x1 grid
  sst.godas.interp <- NULL
  for (j in 1:dim(new.sst)[3]) {
    obj.godas <- list(x = new.lon, y = rev(new.lat), z = new.sst[,,j])
  
    interp.out <-  interp.surface.grid(obj.godas, grid.list)
    
    sst.godas.interp <- abind(sst.godas.interp, interp.out$z[ ,ncol(interp.out$z):1 ], along = 3)
  }
  sst.GODAS.new <- abind(sst.GODAS.new, sst.godas.interp, along = 3)
}

rm(nc.GODAS.1982, nc.GODAS.1983, nc.GODAS.1984, nc.GODAS.1985, nc.GODAS.1986, 
                   nc.GODAS.1987, nc.GODAS.1988, nc.GODAS.1989, nc.GODAS.1990, nc.GODAS.1991,
                   nc.GODAS.1992, nc.GODAS.1993, nc.GODAS.1994, nc.GODAS.1995, nc.GODAS.1996,
                   nc.GODAS.1997, nc.GODAS.1998, nc.GODAS.1999, nc.GODAS.2000, nc.GODAS.2001,
                   nc.GODAS.2002, nc.GODAS.2003, nc.GODAS.2004, nc.GODAS.2005, nc.GODAS.2006,
                   nc.GODAS.2007, nc.GODAS.2008, nc.GODAS.2009, nc.GODAS.2010, nc.GODAS.2011,
                   nc.GODAS.2012, nc.GODAS.2013, nc.GODAS.2014, nc.GODAS.2015)


dim(sst.GODAS.new)

setwd("~/CO_AUS/Aus_CO-main/pIOD")
save(sst.GODAS.new, file = "sstGODAS.rda")

```


# ORA-S5

```{r oras_import}
#import some of the associated data
setwd("~/CO_AUS/Aus_CO-main")

#ORAS5
##1982
#sept 1982
nc.ORAS.1982s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198209_CONS_v0.1.nc")
#oct 1982
nc.ORAS.1982o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198210_CONS_v0.1.nc")
#nov 1982
nc.ORAS.1982n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198211_CONS_v0.1.nc")

##1983
#sept 1983
nc.ORAS.1983s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198309_CONS_v0.1.nc")
#oct 1983
nc.ORAS.1983o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198310_CONS_v0.1.nc")
#nov 1983
nc.ORAS.1983n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198311_CONS_v0.1.nc")

##1984
#sept 1984
nc.ORAS.1984s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198409_CONS_v0.1.nc")
#oct 1984
nc.ORAS.1984o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198410_CONS_v0.1.nc")
#nov 1984
nc.ORAS.1984n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198411_CONS_v0.1.nc")

##1985
#sept 1985
nc.ORAS.1985s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198509_CONS_v0.1.nc")
#oct 1985
nc.ORAS.1985o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198510_CONS_v0.1.nc")
#nov 1985
nc.ORAS.1985n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198511_CONS_v0.1.nc")

##1986
#sept 1986
nc.ORAS.1986s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198609_CONS_v0.1.nc")
#oct 1986
nc.ORAS.1986o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198610_CONS_v0.1.nc")
#nov 1986
nc.ORAS.1986n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198611_CONS_v0.1.nc")

##1987
#sept 1987
nc.ORAS.1987s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198709_CONS_v0.1.nc")
#oct 1987
nc.ORAS.1987o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198710_CONS_v0.1.nc")
#nov 1987
nc.ORAS.1987n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198711_CONS_v0.1.nc")

##1988
#sept 1988
nc.ORAS.1988s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198809_CONS_v0.1.nc")
#oct 1988
nc.ORAS.1988o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198810_CONS_v0.1.nc")
#nov 1988
nc.ORAS.1988n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198811_CONS_v0.1.nc")

##1989
#sept 1989
nc.ORAS.1989s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198909_CONS_v0.1.nc")
#oct 1989
nc.ORAS.1989o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198910_CONS_v0.1.nc")
#nov 1989
nc.ORAS.1989n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_198911_CONS_v0.1.nc")

##1990
#sept 1990
nc.ORAS.1990s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199009_CONS_v0.1.nc")
#oct 1990
nc.ORAS.1990o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199010_CONS_v0.1.nc")
#nov 1990
nc.ORAS.1990n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199011_CONS_v0.1.nc")

##1991
#sept 1991
nc.ORAS.1991s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199109_CONS_v0.1.nc")
#oct 1991
nc.ORAS.1991o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199110_CONS_v0.1.nc")
#nov 1991
nc.ORAS.1991n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199111_CONS_v0.1.nc")

##1992
#sept 1992
nc.ORAS.1992s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199209_CONS_v0.1.nc")
#oct 1992
nc.ORAS.1992o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199210_CONS_v0.1.nc")
#nov 1992
nc.ORAS.1992n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199211_CONS_v0.1.nc")

##1993
#sept 1993
nc.ORAS.1993s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199309_CONS_v0.1.nc")
#oct 1993
nc.ORAS.1993o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199310_CONS_v0.1.nc")
#nov 1993
nc.ORAS.1993n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199311_CONS_v0.1.nc")

##1994
#sept 1994
nc.ORAS.1994s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199409_CONS_v0.1.nc")
#oct 1994
nc.ORAS.1994o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199410_CONS_v0.1.nc")
#nov 1994
nc.ORAS.1994n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199411_CONS_v0.1.nc")

##1995
#sept 1995
nc.ORAS.1995s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199509_CONS_v0.1.nc")
#oct 1995
nc.ORAS.1995o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199510_CONS_v0.1.nc")
#nov 1995
nc.ORAS.1995n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199511_CONS_v0.1.nc")

##1996
#sept 1996
nc.ORAS.1996s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199609_CONS_v0.1.nc")
#oct 1996
nc.ORAS.1996o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199610_CONS_v0.1.nc")
#nov 1996
nc.ORAS.1996n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199611_CONS_v0.1.nc")

##1997
#sept 1997
nc.ORAS.1997s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199709_CONS_v0.1.nc")
#oct 1997
nc.ORAS.1997o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199710_CONS_v0.1.nc")
#nov 1997
nc.ORAS.1997n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199711_CONS_v0.1.nc")

##1998
#sept 1998
nc.ORAS.1998s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199809_CONS_v0.1.nc")
#oct 1998
nc.ORAS.1998o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199810_CONS_v0.1.nc")
#nov 1998
nc.ORAS.1998n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199811_CONS_v0.1.nc")

##1999
#sept 1999
nc.ORAS.1999s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199909_CONS_v0.1.nc")
#oct 1999
nc.ORAS.1999o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199910_CONS_v0.1.nc")
#nov 1999
nc.ORAS.1999n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_199911_CONS_v0.1.nc")

##2000
#sept 2000
nc.ORAS.2000s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200009_CONS_v0.1.nc")
#oct 2000
nc.ORAS.2000o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200010_CONS_v0.1.nc")
#nov 2000
nc.ORAS.2000n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200011_CONS_v0.1.nc")

##2001
#sept 2001
nc.ORAS.2001s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200109_CONS_v0.1.nc")
#oct 2001
nc.ORAS.2001o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200110_CONS_v0.1.nc")
#nov 2001
nc.ORAS.2001n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200111_CONS_v0.1.nc")

##2002
#sept 2002
nc.ORAS.2002s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200209_CONS_v0.1.nc")
#oct 2002
nc.ORAS.2002o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200210_CONS_v0.1.nc")
#nov 2002
nc.ORAS.2002n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200211_CONS_v0.1.nc")

##2003
#sept 2003
nc.ORAS.2003s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200309_CONS_v0.1.nc")
#oct 2003
nc.ORAS.2003o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200310_CONS_v0.1.nc")
#nov 2003
nc.ORAS.2003n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200311_CONS_v0.1.nc")

##2004
#sept 2004
nc.ORAS.2004s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200409_CONS_v0.1.nc")
#oct 2004
nc.ORAS.2004o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200410_CONS_v0.1.nc")
#nov 2004
nc.ORAS.2004n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200411_CONS_v0.1.nc")

##2005
#sept 2005
nc.ORAS.2005s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200509_CONS_v0.1.nc")
#oct 2005
nc.ORAS.2005o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200510_CONS_v0.1.nc")
#nov 2005
nc.ORAS.2005n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200511_CONS_v0.1.nc")

##2006
#sept 2006
nc.ORAS.2006s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200609_CONS_v0.1.nc")
#oct 2006
nc.ORAS.2006o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200610_CONS_v0.1.nc")
#nov 2006
nc.ORAS.2006n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200611_CONS_v0.1.nc")

##2007
#sept 2007
nc.ORAS.2007s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200709_CONS_v0.1.nc")
#oct 2007
nc.ORAS.2007o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200710_CONS_v0.1.nc")
#nov 2007
nc.ORAS.2007n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200711_CONS_v0.1.nc")

##2008
#sept 2008
nc.ORAS.2008s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200809_CONS_v0.1.nc")
#oct 2008
nc.ORAS.2008o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200810_CONS_v0.1.nc")
#nov 2008
nc.ORAS.2008n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200811_CONS_v0.1.nc")

##2009
#sept 2009
nc.ORAS.2009s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200909_CONS_v0.1.nc")
#oct 2009
nc.ORAS.2009o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200910_CONS_v0.1.nc")
#nov 2009
nc.ORAS.2009n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_200911_CONS_v0.1.nc")

##2010
#sept 2010
nc.ORAS.2010s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201009_CONS_v0.1.nc")
#oct 2010
nc.ORAS.2010o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201010_CONS_v0.1.nc")
#nov 2010
nc.ORAS.2010n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201011_CONS_v0.1.nc")

##2011
#sept 2011
nc.ORAS.2011s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201109_CONS_v0.1.nc")
#oct 2011
nc.ORAS.2011o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201110_CONS_v0.1.nc")
#nov 2011
nc.ORAS.2011n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201111_CONS_v0.1.nc")

##2012
#sept 2012
nc.ORAS.2012s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201209_CONS_v0.1.nc")
#oct 2012
nc.ORAS.2012o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201210_CONS_v0.1.nc")
#nov 2012
nc.ORAS.2012n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201211_CONS_v0.1.nc")

##2013
#sept 2013
nc.ORAS.2013s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201309_CONS_v0.1.nc")
#oct 2013
nc.ORAS.2013o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201310_CONS_v0.1.nc")
#nov 2013
nc.ORAS.2013n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201311_CONS_v0.1.nc")

##2014
#sept 2014
nc.ORAS.2014s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201409_CONS_v0.1.nc")
#oct 2014
nc.ORAS.2014o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201410_CONS_v0.1.nc")
#nov 2014
nc.ORAS.2014n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201411_CONS_v0.1.nc")

##2015
#sept 2015
nc.ORAS.2015s <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201509_OPER_v0.1.nc")
#oct 2015
nc.ORAS.2015o <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201510_OPER_v0.1.nc")
#nov 2015
nc.ORAS.2015n <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/ORAS5/sosstsst_control_monthly_highres_2D_201511_OPER_v0.1.nc")

#TODO: add in years 2016-2019

```

## ORA-S5 Functions

```{r oras_functions}
array_setup <- function(nc.data, wide.lon, wide.lat){

  #lon/lat matrices [nx, ny] ([lon, lat])
  get.lat <- ncvar_get(nc.data, "nav_lat")
  get.lon <- ncvar_get(nc.data, "nav_lon")
  
  #get sst data
  sst.oras <- ncvar_get(nc.data, "sosstsst")
  
  iod.mask <- get.lat >= wide.lat[1] & get.lat <= wide.lat[2] &
          get.lon >= wide.lon[1] & get.lon <= wide.lon[2]
  
  lat.in <- get.lat[iod.mask]
  lon.in <- get.lon[iod.mask]
  sst.oras.in <- sst.oras[iod.mask]
  
  return(list(lon = lon.in,
              lat = lat.in,
              sst = sst.oras.in))
}


reformat_interpolate <- function(lon.in, lat.in, sst.oras.in, 
                                 grid.list){
  #TODO: adjust raw numbers if needed
  #reformat 
  n <- length(lon.in) /363
  
  seq.list <- split(1:59169, ceiling(seq_along(1:59169) / 363))
  
  #take chunk of 363 reorder, and remove duplicate data manually
  new.order <- c(191:363, 3:190)
  
  #TODO: setup additional matrix just for the sst data
  sst.mat <- matrix(NA, ncol = 3)
  colnames(sst.mat) < c("lon", "lat", "sst")
  for (i in 1:n) {
    lon.temp <- lon.in[seq.list[[i]]]
    lat.temp <- lat.in[seq.list[[i]]]
    sst.temp <- sst.oras.in[seq.list[[i]]]
    
    #temporary matrix setup
    temp.mat <- cbind(lon = lon.temp[new.order], 
                      lat = lat.temp[new.order], 
                      sst = sst.temp[new.order])
    
    sst.mat <- rbind(sst.mat, temp.mat)
  }
  
  sst.df <- as.data.frame(sst.mat[-1,])
  
  get.x <- unique(sst.df$lon)
  get.y <- unique(sst.df$lat)
  
  sst.oras.matrix <- matrix(sst.df$sst, nrow = 361)
  
  #interpolate

  obj.oras <- list(x = get.x, y = get.y, z = sst.oras.matrix)
  
  out.interp <- interp.surface.grid(obj.oras, grid.list) #not currently working (duplicated data)

  return(out.interp$z)
}

```

## ORA-S5 Data Setup

```{r data_clean}

#wide, reduced boundary (Indian Ocean) setup
wide.lon <- c(wide_minLon, wide_maxLon)
wide.lat <- c(wide_minLat, wide_maxLat)

oras_list <- list(nc.ORAS.1982s, nc.ORAS.1982o, nc.ORAS.1982n,
                  nc.ORAS.1983s, nc.ORAS.1983o, nc.ORAS.1983n,
                  nc.ORAS.1984s, nc.ORAS.1984o, nc.ORAS.1984n,
                  nc.ORAS.1985s, nc.ORAS.1985o, nc.ORAS.1985n,
                  nc.ORAS.1986s, nc.ORAS.1986o, nc.ORAS.1986n,
                  nc.ORAS.1987s, nc.ORAS.1987o, nc.ORAS.1987n,
                  nc.ORAS.1988s, nc.ORAS.1988o, nc.ORAS.1988n,
                  nc.ORAS.1989s, nc.ORAS.1989o, nc.ORAS.1989n,
                  nc.ORAS.1990s, nc.ORAS.1990o, nc.ORAS.1990n,
                  nc.ORAS.1991s, nc.ORAS.1991o, nc.ORAS.1991n,
                  nc.ORAS.1992s, nc.ORAS.1992o, nc.ORAS.1992n,
                  nc.ORAS.1993s, nc.ORAS.1993o, nc.ORAS.1993n,
                  nc.ORAS.1994s, nc.ORAS.1994o, nc.ORAS.1994n,
                  nc.ORAS.1995s, nc.ORAS.1995o, nc.ORAS.1995n,
                  nc.ORAS.1996s, nc.ORAS.1996o, nc.ORAS.1996n,
                  nc.ORAS.1997s, nc.ORAS.1997o, nc.ORAS.1997n,
                  nc.ORAS.1998s, nc.ORAS.1998o, nc.ORAS.1998n,
                  nc.ORAS.1999s, nc.ORAS.1999o, nc.ORAS.1999n,
                  nc.ORAS.2000s, nc.ORAS.2000o, nc.ORAS.2000n,
                  nc.ORAS.2001s, nc.ORAS.2001o, nc.ORAS.2001n,
                  nc.ORAS.2002s, nc.ORAS.2002o, nc.ORAS.2002n,
                  nc.ORAS.2003s, nc.ORAS.2003o, nc.ORAS.2003n,
                  nc.ORAS.2004s, nc.ORAS.2004o, nc.ORAS.2004n,
                  nc.ORAS.2005s, nc.ORAS.2005o, nc.ORAS.2005n,
                  nc.ORAS.2006s, nc.ORAS.2006o, nc.ORAS.2006n,
                  nc.ORAS.2007s, nc.ORAS.2007o, nc.ORAS.2007n,
                  nc.ORAS.2008s, nc.ORAS.2008o, nc.ORAS.2008n,
                  nc.ORAS.2009s, nc.ORAS.2009o, nc.ORAS.2009n,
                  nc.ORAS.2010s, nc.ORAS.2010o, nc.ORAS.2010n,
                  nc.ORAS.2011s, nc.ORAS.2011o, nc.ORAS.2011n,
                  nc.ORAS.2012s, nc.ORAS.2012o, nc.ORAS.2012n,
                  nc.ORAS.2013s, nc.ORAS.2013o, nc.ORAS.2013n,
                  nc.ORAS.2014s, nc.ORAS.2014o, nc.ORAS.2014n,
                  nc.ORAS.2015s, nc.ORAS.2015o, nc.ORAS.2015n)
                  
#sst array setup
sst.ORAS.new <- NULL
for (j in 1:length(oras_list)) {
  temp.nc <- oras_list[[j]]
  
  out.temp <- array_setup(temp.nc, wide.lon, wide.lat)
  
  temp.sst <- reformat_interpolate(out.temp$lon, out.temp$lat, 
                     out.temp$sst, grid.list)
  
  sst.ORAS.new <- abind(sst.ORAS.new, temp.sst, along = 3)
}

rm(nc.ORAS.1982s, nc.ORAS.1982o, nc.ORAS.1982n,
    nc.ORAS.1983s, nc.ORAS.1983o, nc.ORAS.1983n,
    nc.ORAS.1984s, nc.ORAS.1984o, nc.ORAS.1984n,
    nc.ORAS.1985s, nc.ORAS.1985o, nc.ORAS.1985n,
    nc.ORAS.1986s, nc.ORAS.1986o, nc.ORAS.1986n,
    nc.ORAS.1987s, nc.ORAS.1987o, nc.ORAS.1987n,
    nc.ORAS.1988s, nc.ORAS.1988o, nc.ORAS.1988n,
    nc.ORAS.1989s, nc.ORAS.1989o, nc.ORAS.1989n,
    nc.ORAS.1990s, nc.ORAS.1990o, nc.ORAS.1990n,
    nc.ORAS.1991s, nc.ORAS.1991o, nc.ORAS.1991n,
    nc.ORAS.1992s, nc.ORAS.1992o, nc.ORAS.1992n,
    nc.ORAS.1993s, nc.ORAS.1993o, nc.ORAS.1993n,
    nc.ORAS.1994s, nc.ORAS.1994o, nc.ORAS.1994n,
    nc.ORAS.1995s, nc.ORAS.1995o, nc.ORAS.1995n,
    nc.ORAS.1996s, nc.ORAS.1996o, nc.ORAS.1996n,
    nc.ORAS.1997s, nc.ORAS.1997o, nc.ORAS.1997n,
    nc.ORAS.1998s, nc.ORAS.1998o, nc.ORAS.1998n,
    nc.ORAS.1999s, nc.ORAS.1999o, nc.ORAS.1999n,
    nc.ORAS.2000s, nc.ORAS.2000o, nc.ORAS.2000n,
    nc.ORAS.2001s, nc.ORAS.2001o, nc.ORAS.2001n,
    nc.ORAS.2002s, nc.ORAS.2002o, nc.ORAS.2002n,
    nc.ORAS.2003s, nc.ORAS.2003o, nc.ORAS.2003n,
    nc.ORAS.2004s, nc.ORAS.2004o, nc.ORAS.2004n,
    nc.ORAS.2005s, nc.ORAS.2005o, nc.ORAS.2005n,
    nc.ORAS.2006s, nc.ORAS.2006o, nc.ORAS.2006n,
    nc.ORAS.2007s, nc.ORAS.2007o, nc.ORAS.2007n,
    nc.ORAS.2008s, nc.ORAS.2008o, nc.ORAS.2008n,
    nc.ORAS.2009s, nc.ORAS.2009o, nc.ORAS.2009n,
    nc.ORAS.2010s, nc.ORAS.2010o, nc.ORAS.2010n,
    nc.ORAS.2011s, nc.ORAS.2011o, nc.ORAS.2011n,
    nc.ORAS.2012s, nc.ORAS.2012o, nc.ORAS.2012n,
    nc.ORAS.2013s, nc.ORAS.2013o, nc.ORAS.2013n,
    nc.ORAS.2014s, nc.ORAS.2014o, nc.ORAS.2014n,
    nc.ORAS.2015s, nc.ORAS.2015o, nc.ORAS.2015n)

sst.ORAS.new <- sst.oras.array

dim(sst.ORAS.new) #[lon, lat, son_months]

setwd("~/CO_AUS/Aus_CO-main/pIOD")
save(sst.ORAS.new, file = "sstORAS.rda")

```


## Get ORA-S5 Land-Sea Mask
(Note: this mask looks very close to those presented in the paper)

```{r oras_lsm}

temp.lsm <- is.na(sst.ORAS.new[,,1])

```


# OISST v2

('default' data product: use as a template for other products )

```{r load_data}
setwd("~/CO_AUS/Aus_CO-main")

#begin easy with monthly OISST
nc.OISST.month <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/sst.mnmean.nc")

#OISST land sea mask
nc.OISST.lsm <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/lsmask.nc")
```

## OISST Data Setup

```{r data_cleaning}
#extract lon, lat
lat.grid <- nc.OISST.month[["dim"]][["lat"]][["vals"]]
lon.grid <- nc.OISST.month[["dim"]][["lon"]][["vals"]]

#reorder lon
lon.grid[lon.grid >= 180] <- lon.grid[lon.grid >= 180] - 360
lon.order <- order(lon.grid)

lon.grid <- lon.grid[lon.order]

#reorder lat (maybe?)
lat.order <- order(lat.grid)
lat.grid <- lat.grid[lat.order]

#time data
times <- ncvar_get(nc.OISST.month, "time") # days since 1800-01-01 00:00:0.0
times <- as_datetime("1800-01-01T00:00:00") + days(times)

#sst data, as array (lon, lat, time)
sst.oisst <- ncvar_get(nc.OISST.month, "sst")
sst.oisst <- sst.oisst[lon.order, lat.order, ]

#TODO: get wider Indian Ocean domain so we can interpolate onto the correct one.
#get reduced indian ocean region
lat.range <- range(which(lat.grid <= (wide_maxLat+1) & lat.grid >= (wide_minLat-1)))
lon.range <- range(which(lon.grid <= (wide_maxLon+1) & lon.grid >= (wide_minLon-1)))

lat.values.oisst <- lat.grid[lat.grid <= (wide_maxLat+1) & lat.grid >=  (wide_minLat-1)]
lon.values.oisst <- lon.grid[lon.grid <= (wide_maxLon+1) & lon.grid >= (wide_minLon-1)]

#get OISST SST reduced matrix
sst.OISST.wide <- sst.oisst[lon.range[1]:lon.range[2], lat.range[1]:lat.range[2], 2:409]

dim(sst.OISST.wide)


#interpolate onto 1.0 x 1.0 grid
sst.OISST.new <- NULL
for (j in 1:dim(sst.OISST.wide)[3]) {
  base.obj <- list(x = lon.values.oisst, y = lat.values.oisst, z = sst.OISST.wide[,,j])

  
  out.interp <- interp.surface.grid(base.obj, grid.list)
  
  #interp.mat <- out.interp$z[ ,ncol(out.interp$z):1 ]
  
  sst.OISST.new <- abind(sst.OISST.new, out.interp$z, along = 3)
}

dim(sst.OISST.new)

#mask land
sst.OISST.new <- apply(sst.OISST.new, 3, function(X) {
  X[temp.lsm] <- NA
  return(X)
})

dim(sst.OISST.new) <- c(91, 41, 408)


setwd("~/CO_AUS/Aus_CO-main/pIOD")
save(sst.OISST.new, file = "sstOISST.rda")
```


# SODA3.3.1

```{r load_data}
setwd("~/CO_AUS/Aus_CO-main")

##SODA3.3.1
#all monthly data in a single file
nc.SODA.month <- nc_open("~/CO_AUS/Aus_CO-main/pIOD/Data/erdSoda331oceanmday_6a77_2294_0698.nc")
```

## SODA Data Setup

```{r data_cleaning}
#and interpolation

#for monthly
lat.grid.soda <- nc.SODA.month[["dim"]][["latitude"]][["vals"]]
lon.grid.soda <- nc.SODA.month[["dim"]][["longitude"]][["vals"]]

#adjust lon order
lon.grid.soda[lon.grid.soda >= 180] <- lon.grid.soda[lon.grid.soda >= 180] - 360
lon.order.soda <- order(lon.grid.soda)

lon.grid.soda <- lon.grid.soda[lon.order.soda]

#adjust lat order
#TODO: double check this, it might be wrong
#lat.order.soda <- order(lat.grid.soda, decreasing = TRUE)
#lat.grid.soda <- lat.grid.soda[lat.order.soda]

#get times
times.soda <- ncvar_get(nc.SODA.month, "time") #seconds since 1970-01-01T00:00:00Z
times.soda <- as_datetime("1970-01-01T00:00:00") + seconds(times.soda)
  
  
sst.soda <- ncvar_get(nc.SODA.month, "temp")
sst.soda <- sst.soda[lon.order.soda, , ]


#TODO: get bounded data for wider data
#SODA range
lat.values.soda <- lat.grid.soda[lat.grid.soda <= wide_maxLat & lat.grid.soda >= wide_minLat]
lat.range.soda <- range(which(lat.grid.soda <= wide_maxLat & lat.grid.soda >= wide_minLat))

lon.values.soda <- lon.grid.soda[lon.grid.soda <= wide_maxLon & lon.grid.soda >= wide_minLon]
lon.range.soda <- range(which(lon.grid.soda <= wide_maxLon & lon.grid.soda >= wide_minLon))

times.soda[25]
times.soda[432]

#get SODA SST reduced matrix 
sst_soda <- sst.soda[lon.range.soda[1]:lon.range.soda[2], lat.range.soda[1]:lat.range.soda[2], ]
sst.soda.wide <- sst_soda[,, 25:432]

#interpolate onto 1.0 x 1.0 grid
sst.SODA.new <- NULL
for (j in 1:dim(sst.soda.wide)[3]) {
  base.obj <- list(x = lon.values.soda, y = lat.values.soda, z = sst.soda.wide[,,j])

  
  out.interp <- interp.surface.grid(base.obj, grid.list)
  
  #interp.mat <- out.interp$z[ ,ncol(out.interp$z):1 ]
  
  sst.SODA.new <- abind(sst.SODA.new, out.interp$z, along = 3)
}

dim(sst.SODA.new)


setwd("~/CO_AUS/Aus_CO-main/pIOD")
save(sst.SODA.new, file = "sstSODA.rda")

```


# SST Anomalies

(produce sst anomalies here)

## Anomaly Functions

```{r functions}
#son average (seasonal mean for each year)
son.avg <- function(sst, son.only = FALSE){
  ##sst as [lon, lat, time]
  A.new <- aperm(sst, perm = c(3, 2, 1))  # reorder data as [time, lat, lon]
  
  #get dimensions from reordered array
  nx <- dim(A.new)[3]
  ny <- dim(A.new)[2] 
  nt <- dim(A.new)[1]
  
  #get SON mean (get 1 sst per year (as son mean))
  if (son.only) {
    #if only provided with 3 months (son) per year
    nyears <- nt %/% 3
    A.temp <- array(A.new, dim = c(3, nyears, ny, nx))
    A.son <- apply(A.temp[1:3, , , ], c(2,3,4), mean, na.rm = TRUE) #already at correct subset
  }else {
    nyears <- nt %/% 12
    #reshape data array
    A.temp <- array(A.new, dim = c(12, nyears, ny, nx))
    A.son <- apply(A.temp[9:11, , , ], c(2,3,4), mean, na.rm = TRUE) #already at correct subset
  }
  
  return(aperm(A.son, perm = c(3, 2, 1))) #return as [lon, lat, time]
}

##son anomalies
#1. compute SON (seasonal) climatology
#2. seasonal means minus seasonal climatology
son.anom <- function(sst){

  climate.mean <- apply(sst, c(1, 2), mean, na.rm = FALSE)
  son.anom <- sweep(sst, MARGIN = c(1, 2), STATS = climate.mean, FUN = "-")

  return(son.anom)
}


##detrend son anomalies
son.detrend <- function(anom, order = 1){
  
}

```


## SON (Seasonal) Anomalies

```{r son_anoms}
#son avg
sst.GODAS.son <- son.avg(sst.GODAS.new)
sst.ORAS.son <- son.avg(sst.ORAS.new, son.only = TRUE)
sst.OISST.son <- son.avg(sst.OISST.new)
sst.SODA.son <- son.avg(sst.SODA.new)

#get son anomalies
sst.GODAS.anom <- son.anom(sst.GODAS.son)
sst.ORAS.anom <- son.anom(sst.ORAS.son)
sst.OISST.anom <- son.anom(sst.OISST.son)
sst.SODA.anom <- son.anom(sst.SODA.son)

#dimension check
dim(sst.GODAS.anom)
dim(sst.ORAS.anom)
dim(sst.OISST.anom)
dim(sst.SODA.anom)


```




## Test Section - SST Anoms (Delete when done)


```{r dtrend}
#testing detrending function


```


```{r}
##son anomalies
#1. compute SON (seasonal) climatology
#2. seasonal means minus seasonal climatology

mean(sst.GODAS.son, na.rm = TRUE)

temp.mean <- apply(sst.GODAS.son, c(1, 2), mean, na.rm = FALSE)


 sweep(sst.GODAS.son, MARGIN = c(1, 2), STATS = temp.mean, FUN = "-")
```

```{r}
#quick son avg check
(sst.GODAS.new[21,2,9] + sst.GODAS.new[21,2,10] +sst.GODAS.new[21,2,11])/3
sst.GODAS.son[21,2,1]

(sst.ORAS.new[21,2,1] + sst.ORAS.new[21,2,2] +sst.ORAS.new[21,2,3])/3
sst.ORAS.son[21,2,1]

```


# Figures

(compare data products)

## Monthly Data Checks

```{r}
#TODO: update range and breaks with all data when done with above data prep
sst.range <- range(sst.GODAS.new, sst.ORAS.new, 
                   sst.OISST.new, sst.SODA.new, na.rm = TRUE)

cols.ryb <- rev(colorRampPalette(brewer.pal(11, "RdYlBu"))(24))
breaks.sst <- seq(sst.range[1], sst.range[2], length.out = length(cols.ryb) + 1)


#GODAS test
sst.godas.test <- sst.GODAS.new[,,10]

imagePlot(list(x = lon.wide, y = lat.wide, z = sst.godas.test), 
           col = cols.ryb, breaks = breaks.sst, zlim = sst.range,
           xlab = "Lon", ylab = "Lat")
title("GODAS", adj = 0)
world(add = TRUE)

#ORAS test
sst.oras.test <- sst.ORAS.new[,,2]

imagePlot(list(x = lon.wide, y = lat.wide, z = sst.oras.test), 
           col = cols.ryb, breaks = breaks.sst, zlim = sst.range,
           xlab = "Lon", ylab = "Lat")
title("ORA-S5", adj = 0)
world(add = TRUE)

#OISST test
sst.oisst.test <- sst.OISST.new[,,10]

imagePlot(list(x = lon.wide, y = lat.wide, z = sst.oisst.test), 
           col = cols.ryb, breaks = breaks.sst, zlim = sst.range,
           xlab = "Lon", ylab = "Lat")
title("OISST", adj = 0)
world(add = TRUE)

#SODA test
sst.soda.test <- sst.SODA.new[,,10]

imagePlot(list(x = lon.wide, y = lat.wide, z = sst.soda.test), 
           col = cols.ryb, breaks = breaks.sst, zlim = sst.range,
           xlab = "Lon", ylab = "Lat")
title("SODA3.3.1", adj = 0)
world(add = TRUE)



```

## SON Mean Checks

```{r}

```

## SON Anomalies

## SON Detrending



