---
title: "IODsstanom_new.rmd"
author: "Ryan Peterson"
date: "2025-08-21"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

```{r library}
#.nc files
suppressMessages(library(ncdf4))
suppressMessages(library(terra))

# date/data mgmt
suppressMessages(library(lubridate))
suppressMessages(library(abind))

#visualization and interpolation
suppressMessages(library(fields))
suppressMessages(library(colorspace))
suppressMessages(library(RColorBrewer))
suppressMessages(library(scales)) #for adjusting opacity

#matlab function (e.g. detrend)
suppressMessages(library(pracma))
```

```{r data_import}
#load in data
setwd("~/CO_AUS/Aus_CO-main/pIOD")
load("sst_base.rda")
load("sst_extend.rda")
load("sst_oras5.rda")
```

```{r functions}
#following the .ncl method for cmip5 model data
#currently only provides SON anoms
sst.anoms <- function(A, son.only = FALSE){
    
  A.new <- aperm(A, perm = c(3, 2, 1))  # reorder data as [time, lat, lon]
  
  #get dimensions from reordered array
  nx <- dim(A.new)[3]
  ny <- dim(A.new)[2] 
  nt <- dim(A.new)[1]
  
  #get SON mean (get 1 sst per year (as son mean))
  if (son.only) {
    #if only provided with 3 mothns (son) per year
    nyears <- nt %/% 3
    A.temp <- array(A.new, dim = c(3, nyears, ny, nx))
    A.son <- apply(A.temp[1:3, , , ], c(2,3,4), mean, na.rm = TRUE) #already at correct subset
  }else {
    nyears <- nt %/% 12
    #reshape data array
    A.temp <- array(A.new, dim = c(12, nyears, ny, nx))
    A.son <- apply(A.temp[9:11, , , ], c(2,3,4), mean, na.rm = TRUE) #already at correct subset
  }
  
  rm(A.temp)
  
  #update time dim
  nt <- dim(A.son)[1]
  
  #remove mean
  var <- matrix(A.son, nrow = nt, ncol = ny * nx) #from earlier work on detrend
  #get full period mean
  var.mean <- colMeans(var) #TODO: visualize this spatially (transform to [lon, lat])
  
  var <- sweep(var, 2, colMeans(var), "-") #TODO: check how this might hold up with irregular spatial masks
  
  #de-trend
  #TODO: figure out how to work with irregular NAs in time/space (some years have different spatial NAs)
  test.na <- which(!is.na(var), arr.ind = TRUE) 
  true.index <- unique(test.na[,2])
  
  A.resid <- matrix(NA, nrow = nt, ncol = ny*nx)
  A.coef <- matrix(NA, nrow = 2, ncol = ny*nx)
  
  var.x <- seq_len(nt) #time "covariates"
  var.y <- var[ ,true.index] #response variable (sst anoms)
  
  #TODO: add in an elif for linear and quadratic
  var.fit <- lm(var.y ~ var.x)
  
  A.resid[,true.index] <- var.fit$residuals
  A.coef[,true.index] <- var.fit$coefficients
  
  return(list(mean = var.mean,
              anom = A.resid,
              coef = A.coef))
}

#pca/eof analysis function:
sst.eof <- function(sst.anom, kmode){
  #sst.anom as [time, lat, lon]
  nt <- dim(sst.anom)[1]
  ny <- dim(sst.anom)[2]
  nx <- dim(sst.anom)[3]
  
  X <- matrix(sst.anom, nrow = nt, ncol = ny * nx)
  
  #get rid of NA's (masked locs)
  keep <- colSums(is.finite(X)) == nt
  X.new  <- X[, keep]
  
  svd.temp <- svd(X.new)
  
  #svd outputs
  U <- svd.temp$u[ ,1:kmode]
  D <- svd.temp$d[1:kmode]
  V <- svd.temp$v[ ,1:kmode]
  
  #outputs
  EOF.temp <- V #EOF spatial pattern
  PC.temp <- U %*% diag(D)
  per.temp <- D^2 / sum(svd.temp$d^2) 
  
  #finalize the spatial eof (pca)
  V_eof <- matrix(NA, nrow = ny * nx, ncol = kmode)
  
  #add in lsm sea data
  V_eof[keep, ] <- EOF.temp
  
  return(list(EOF = V_eof,
              PC = PC.temp,
              percent = per.temp))
}


```

```{r setup}
#setup (land sea mask for OISST data)
lsm.IOD.array <- array(lsm.IOD, dim = dim(sst.OISST.new))

sst.OISST.masked <- ifelse(lsm.IOD.array == 1, sst.OISST.new, NA)

#updated (for up to 2019)
lsm.IOD.array2 <- array(lsm.IOD, dim = dim(sst.OISST.new2))

sst.OISST.masked2 <- ifelse(lsm.IOD.array2 == 1, sst.OISST.new2, NA)

rm(lsm.IOD.array, lsm.IOD.array2)
```

# Main

## SST Anomalies

Outline: 
1. Get SST Anoms for all four data products

```{r get_sstanoms}
#sst anomalies SON, for 
##OISST
sst.anom.oisst <- sst.anoms(sst.OISST.masked)
#GODAS
sst.anom.godas <- sst.anoms(sst.array)
#SODA
sst.anom.soda <- sst.anoms(sst.interp.SODA)
#ORA-S5
sst.anom.oras <- sst.anoms(sst.oras.array, son.only = TRUE)

#get SON average of 3 SST anomalies
sst.anom.avg <- (sst.anom.oisst$anom + sst.anom.godas$anom + sst.anom.soda$anom)/3
#get 'full' son avg for all 4 data product sst anoms

sst.full.avg <- (sst.anom.oisst$anom + sst.anom.godas$anom + 
                   sst.anom.soda$anom + sst.anom.oras$anom  )/4
```

```{r get_yearlyanoms}
#find notable pIOD years to compare to cai et al 2021
#strong years 1994, 1997, 2006 (index: )
#monderate years 1982, 1987, 2015 (index: 1, , 34 )


```



# Test Section

For testing some ideas


